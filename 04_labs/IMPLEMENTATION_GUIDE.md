# Labs検証環境 実装ガイド

このドキュメントは、`04_labs/`配下の設計書を基に、実際に検証環境を構築するための手順をまとめています。

## 目的

- 設計書（`04_labs/*/00_index.md`、各設計ファイル）を実装に落とし込む
- 手を動かして学べる検証環境を段階的に構築する
- 観測点（Proxy/HAR/pcap/ログ）を固定し、再現性を確保する

## 実装の優先順位

### Phase 1: ローカル環境の基盤（最優先）

#### 1.1 Attack Boxの構築
**参照**: `04_labs/01_local/01_attack-box_作業端末設計.md`

**手順**:
1. 仮想化ソフトウェアのインストール（VirtualBox/VMware）
2. Linux VMの作成（Kali Linux推奨、またはUbuntu）
3. 基本ツールのインストール
   - ブラウザ（Firefox/Chrome）
   - テキストエディタ
   - Git
4. 証跡保存場所の作成
   ~~~~
   mkdir -p ~/keda-lab-captures/{har,proxy,pcap,notes}
   ~~~~

**確認ポイント**:
- [ ] VMが正常に起動する
- [ ] ネットワーク接続が可能（NAT）
- [ ] 証跡保存場所が作成されている

#### 1.2 Proxy環境の構築
**参照**: `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`

**手順**:
1. Burp Suite Community Editionのインストール
   - またはOWASP ZAPのインストール
2. ブラウザプロファイルの設定
   - 検証用プロファイルを分離
   - Proxy設定（127.0.0.1:8080等）
3. 証明書のインストール（HTTPS観測のため）
4. プロジェクト設定の固定
   - 保存場所：`~/keda-lab-captures/proxy/`
   - 命名規則：`{対象}_{日時}_{観測点}.burp`

**確認ポイント**:
- [ ] Proxyが正常に動作する
- [ ] HTTPS通信が観測できる
- [ ] リクエスト/レスポンスが記録される

#### 1.3 証跡取得の自動化
**参照**: `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`

**手順**:
1. HAR取得の設定
   - ブラウザのDevToolsでHARエクスポート
   - またはBurp SuiteからHARエクスポート
2. pcap取得の準備（必要時）
   - tcpdump/Wiresharkのインストール
   - キャプチャフィルタの設定
3. ログ保存のルール化
   - 命名規則：`{対象}_{日時}_{観測点}.{拡張子}`
   - メタデータ（対象、条件、観測点）の記録

**確認ポイント**:
- [ ] HARが正常に取得できる
- [ ] pcapが取得できる（必要時）
- [ ] ログの命名規則が統一されている

### Phase 2: 仮想ネットワーク環境

#### 2.1 ネットワーク分離の実装
**参照**: `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`

**手順**:
1. Host-Onlyネットワークの作成
   - VirtualBox: ファイル→設定→ネットワーク→ホストオンリーネットワーク
   - VMware: 編集→仮想ネットワークエディタ
2. ターゲットVMの作成
   - 検証用アプリ（keda_app 等）の導入
   - Host-Onlyネットワークに接続
3. Attack Boxからターゲットへの接続確認

**確認ポイント**:
- [ ] Host-Onlyネットワークが作成されている
- [ ] Attack Boxとターゲットが通信できる
- [ ] 外部ネットワークと分離されている

#### 2.2 スナップショット/巻き戻しの設定
**参照**: `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

**手順**:
1. 初期状態のスナップショット作成
   - ターゲットVM: 検証前の状態
   - Attack Box: 基本設定完了後の状態
2. 命名規則の統一
   - `{VM名}_{状態}_{日時}`
   - 例：`target-initial-20250101`, `target-after-test-20250101`
3. 巻き戻し手順の文書化

**確認ポイント**:
- [ ] スナップショットが作成できる
- [ ] 巻き戻しが正常に動作する
- [ ] 命名規則が統一されている

### Phase 3: ターゲット環境の構築

#### 3.1 Webターゲットの導入
**参照**: `04_labs/03_targets/01_web_targets_検証用アプリ選定.md`

**手順**:
1. KedaLab 自作教材（keda_app）の導入
   - `04_labs/03_targets/04_keda_app_教材Webアプリ（自作）.md` に従う
   - AuthN/AuthZ/API/Config/Logging を「観測→差分→分岐」で回す
2. 各ターゲットの観測ポイントの確認
   - 入口（URL、機能）
   - 境界（認証、認可、入力）
   - 証跡（ログ、レスポンス）

**確認ポイント**:
- [ ] ターゲットアプリが正常に動作する
- [ ] 観測ポイントが明確になっている
- [ ] 証跡が取得できる

#### 3.2 APIターゲットの導入
**参照**: `04_labs/03_targets/02_api_targets_検証用API選定.md`

**手順**:
1. REST APIターゲットの導入
   - 認証/認可の検証に適したAPI
2. GraphQLターゲットの導入（必要時）
   - 過剰取得、認可欠落の検証
3. Webhookターゲットの導入（必要時）
   - 署名検証、再送、到達性の検証

**確認ポイント**:
- [ ] APIが正常に動作する
- [ ] 認証/認可の境界が明確になっている
- [ ] 証跡が取得できる

### Phase 4: クラウド環境（オプション）

#### 4.1 AWS Lab環境の構築
**参照**: `04_labs/04_cloud/01_aws_lab_構成と検証観点.md`

**手順**:
1. AWSアカウントの準備（無料枠を活用）
2. 最小構成の作成
   - EC2インスタンス（必要最小限）
   - S3バケット（公開/非公開の境界確認）
   - IAMロール/ポリシー（権限境界の確認）
3. 監査ログの取得設定
   - CloudTrailの有効化
   - ログの保存場所の固定

**確認ポイント**:
- [ ] AWS環境が正常に動作する
- [ ] 監査ログが取得できる
- [ ] コストが制御されている

#### 4.2 Azure Lab環境の構築
**参照**: `04_labs/04_cloud/02_azure_lab_構成と検証観点.md`

**手順**:
1. Azureアカウントの準備（無料枠を活用）
2. 最小構成の作成
   - VM（必要最小限）
   - ストレージアカウント（公開/非公開の境界確認）
   - ロール/ポリシー（権限境界の確認）
3. 監査ログの取得設定
   - Activity Logの有効化
   - ログの保存場所の固定

**確認ポイント**:
- [ ] Azure環境が正常に動作する
- [ ] 監査ログが取得できる
- [ ] コストが制御されている

## 実装チェックリスト

### ローカル環境
- [ ] Attack Boxが構築されている
- [ ] Proxy環境が動作している
- [ ] 証跡取得が可能になっている
- [ ] 証跡保存場所が統一されている

### 仮想ネットワーク環境
- [ ] Host-Onlyネットワークが作成されている
- [ ] ターゲットVMが構築されている
- [ ] スナップショット/巻き戻しが可能になっている

### ターゲット環境
- [ ] Webターゲットが導入されている
- [ ] APIターゲットが導入されている（必要時）
- [ ] 観測ポイントが明確になっている

### クラウド環境（オプション）
- [ ] AWS/Azure環境が構築されている（必要時）
- [ ] 監査ログが取得できる（必要時）

## トラブルシューティング

### よくある問題

#### Proxyが動作しない
- ブラウザのプロキシ設定を確認
- 証明書のインストールを確認
- ファイアウォールの設定を確認

#### ターゲットVMに接続できない
- ネットワーク設定（Host-Only）を確認
- IPアドレスの確認
- ファイアウォールの設定を確認

#### スナップショットが作成できない
- ディスク容量を確認
- VMの状態（実行中/停止）を確認

## 次のステップ

1. **今すぐ**: Phase 1（ローカル環境の基盤）を実装
2. **今週**: Phase 2（仮想ネットワーク環境）を実装
3. **今月**: Phase 3（ターゲット環境）を実装
4. **必要に応じて**: Phase 4（クラウド環境）を実装

---

**更新履歴**
- 2025-01-XX: 初版作成

