# 04_authz_境界モデル→検証観点チェック
AuthZ を「IDORがあるか」ではなく、境界（所有/ロール/テナント/共有/委任）モデル→差分観測→分岐で、次の一手を決める。

## 目的（このプレイブックで到達する状態）
- 対象のAuthZを、最低でも「所有/ロール/テナント/共有/委任」の5境界で説明できる。
- 越権が疑わしい場合に、**どの境界が効いていないか**を差分観測で絞れる。
- 次に読むtopic と次に回す検証（playbook）を、観測結果から分岐で選べる。

## 前提知識チェックリスト（先に確認）
- 境界モデル：所有/ロール/テナント/共有/委任の5軸で整理
- 差分観測：主体/所有/テナント/共有の順で比較
- 成立条件：何を変えると「通る/漏れる」か

## 前提（対象・範囲・制約）
- 対象：許可範囲の Web UI / API（GraphQL 含む）。
- 制約：影響のある操作（write/admin）は最小限。まず read-only（参照）で差分を取る。
- 前提ツール（最小限）：ブラウザ + Proxy（HAR）、（任意）`curl`。
  - 理由：HARで差分の根拠、curlで主体/所有差の再現がしやすい。
  - 代替：`Invoke-WebRequest` / Postman でも可。
- 参照すべきtopics：
  - `01_topics/02_web/03_authz_00_認可（IDOR BOLA BFLA）境界モデル化.md`

## 入口で確定すること（最小セット）
- 主体（最低2つ）：ユーザーA / ユーザーB（可能ならロール差、難しければ同ロールでよい）。
- リソース（最低2つ）：自分のデータ / 他人のデータ（ID/キー/slug 等で区別できるもの）。
- 操作（最低2つ）：read（参照）/ write（更新）※writeは安全な対象でのみ。
- 完了条件：A/Bの差分（期待拒否 vs 実結果）を、主要リクエスト1〜3本で説明できる。

## 所要時間の目安
- 全体：35〜50分

## 手順（分岐中心：迷うポイントだけ）

### Step 0：最初の5分（必ずやる / 目安: 5分）
- 目的：後で説明できる「比較可能な証跡」を用意する。
- 観測ポイント：
  - 対象機能を1つ選ぶ（例：プロフィール、ファイル、注文、設定、共有）。
  - 主体A/B とリソース（自分/他人）を、先に“名前”で固定する（例：A_myFileId / A_otherFileId）。
- 証跡（最小）：
~~~~
# Windows (PowerShell)

## 補足（運用メモ）
- 前提知識チェック例：境界＝管理主体や責任が切り替わる地点（例：DNS委譲が外部になる）
- 証跡ディレクトリ命名：`{category}_{NN}` を推奨（例：`asm_passive_01`）
- 所要時間：目安。初回は1.5倍程度を想定
- 報告例（最小）：観測/影響/根拠/再現手順を1行ずつ記載
$dir = Join-Path $HOME "keda_evidence\\authz_04"
New-Item -ItemType Directory -Force $dir | Out-Null
Set-Location $dir
"feature: ...`nuserA: ...`nuserB: ...`nresource_ids: ..." | Set-Content -Encoding utf8 00_context.txt

# macOS/Linux (bash)

## 補足（運用メモ）
- 前提知識チェック例：境界＝管理主体や責任が切り替わる地点（例：DNS委譲が外部になる）
- 証跡ディレクトリ命名：`{category}_{NN}` を推奨（例：`asm_passive_01`）
- 所要時間：目安。初回は1.5倍程度を想定
- 報告例（最小）：観測/影響/根拠/再現手順を1行ずつ記載
mkdir -p ~/keda_evidence/authz_04
cd ~/keda_evidence/authz_04
printf "feature: ...\nuserA: ...\nuserB: ...\nresource_ids: ...\n" > 00_context.txt
~~~~
- 次の分岐：
  - 主体A/B と比較対象が揃った → Step 1へ
- 実際の観測例：
  - `A_myOrderId=101 / A_otherOrderId=205`

### Step 1：境界モデルを“文章で”作る（最小 / 目安: 8分）
- 目的：闇雲に試さず、壊しにいく境界を決める。
- 観測ポイント（書くだけでよい）：
  - リソース：何（file/order/project/user…）
  - 操作：何（read/update/delete/share/admin…）
  - 境界候補：所有/ロール/テナント/共有/委任（OAuth scope 等）
  - 拒否点：UIだけで拒否か / サーバで拒否か（理想はサーバ）
- 次の分岐：
  - “主体×操作×リソース” が言語化できた → Step 2へ
- テンプレ（埋めるだけでOK）：
~~~~
主体: A / B
リソース: (例) order
操作: read / update
境界: 所有 / ロール / テナント / 共有 / 委任
拒否点: UIだけ / サーバ側
期待拒否: (例) Aが他人IDを読むと403
~~~~
- 実際の観測例：
  - 「Aが他人注文IDを読む → 403が期待」

### Step 2：差分観測で「効いている境界/効いていない境界」を切り分ける（目安: 12分）
- 目的：越権の成立条件を最短で絞る。
- 観測ポイント（差分が主役）：
  - 主体差：A vs B
  - 所有差：自分ID vs 他人ID
  - テナント差：同一テナント vs 別テナント（可能なら）
  - 共有差：未共有 vs 共有済み（リンク/ゲスト等があるなら）
- 証跡（最小）：
  - HAR（Aで1回、Bで1回。操作は read から）
  - “期待拒否/実結果” の1行メモ（`A:403 expected / got 200` のように）
- 次の分岐（判断基準）：
  - UIでは拒否だが API が通る → Step 3A（UI≠API）
  - 所有者差（自分/他人）で挙動が変わらない → Step 3B（所有境界）
  - テナント差で混ざり/越境が疑われる → Step 3C（テナント境界）
  - 共有リンク/外部ゲストで“広すぎる権限”が疑われる → Step 3D（共有境界）
  - ロール差で本来不可の操作が見える/通る → Step 3E（ロール境界）
- 実際の観測例：
  - `A:403 expected / got 200` をメモ

### Step 3A：分岐A（UI≠API：サーバ側AuthZの抜け/ズレ / 目安: 5分）
- 次の一手：
  - `02_playbooks/05_api_権限伝播→検証観点チェック.md` へ（API側の判定点・伝播を差分で詰める）。

### Step 3B：分岐B（所有者境界：IDOR/BOLAの疑い / 目安: 5分）
- 次の一手（安全優先）：
  - まず read で「存在隠蔽」か「権限不足」かを見分ける（ステータスだけでなく本文の意味）。
  - write をするなら、**安全な対象**で「1項目だけ」変える設計に落とす。

### Step 3C：分岐C（テナント境界：組織跨ぎの疑い / 目安: 5分）
- 次の一手：
  - tenant/org/project を表す識別子が「どこで決まるか」を観測（URL/ヘッダ/トークン/サーバ側）。
  - “認証（AuthN）に紐づく境界”か、“リクエストで上書きできる境界”かを切り分ける。

### Step 3D：分岐D（共有境界：リンク/外部ゲスト/公開範囲 / 目安: 5分）
- 次の一手：
  - 共有の単位（誰に/どの範囲/どの権限/期限）を状態として確定する（Yes/No/Unknown）。
  - SaaS側の共有/監査に接続する（次のplaybook：`02_playbooks/08_saas_信頼→共有→監査ログ_初動.md`）。

### Step 3E：分岐E（ロール境界：管理に近い操作 / 目安: 5分）
- 次の一手：
  - “管理操作の入口” を抽出し、まず read 系で差分を取る（Bだけ見える/通るもの）。
  - 監査ログ/操作ログが取れるなら、必ず証跡とセットで説明力を上げる。
- 実際の観測例：
  - `admin` ロールだけ見えるエンドポイントがある

## よくある失敗と対処法
- 先にwriteを試す → readで差分を固めてから
- 比較対象が揃っていない → A/BとID対応表を先に作る
- UIの見え方だけで判断 → APIのHAR差分で裏取り

## バグバウンティでの注意点
- IDの総当たりや大量アクセスは禁止されがち
- 影響のある操作は検証環境/明示許可がある場合のみ
- 報告は「成立条件」と「拒否点」を明確に書く
## 取得する証跡（目的ベースで最小限）
- 何のため：境界（何が効いていないか）と成立条件（何を変えると通るか）を説明するため。
- 取得対象：主要リクエスト1〜3本（HAR/ログで可）、期待拒否/実結果メモ、主体A/Bと対象ID対応表。
- 見るポイント：拒否点（UI/サーバ）、存在隠蔽の有無、テナント混在兆候、共有状態による挙動差。

## コマンド/リクエスト例（例示は最小限）
~~~~
# 例：read-onlyの差分を作る（値はすべてプレースホルダ）

## 補足（運用メモ）
- 前提知識チェック例：境界＝管理主体や責任が切り替わる地点（例：DNS委譲が外部になる）
- 証跡ディレクトリ命名：`{category}_{NN}` を推奨（例：`asm_passive_01`）
- 所要時間：目安。初回は1.5倍程度を想定
- 報告例（最小）：観測/影響/根拠/再現手順を1行ずつ記載
curl -sS -H "Authorization: Bearer <TOKEN_A>" "https://<BASE>/api/<resource>/<id_A>" -D - -o /dev/null
curl -sS -H "Authorization: Bearer <TOKEN_A>" "https://<BASE>/api/<resource>/<id_B>" -D - -o /dev/null
~~~~
- 何を観測する例か：主体Aで「自分/他人」の read の拒否点を比較する。
- 出力の注目点：ステータスだけでなく、レスポンス本文の意味（隠蔽/権限不足/部分漏洩）。
- 前提が崩れるケース：APIが公開されていない/トークンが取れない（その場合はUI差分とHAR中心で進める）。

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - V4（Access Control）を「境界モデル（所有/ロール/テナント/共有/委任）」として観測し、成立条件を絞る。
- WSTG：
  - Authorization の観点を、差分観測（主体差/所有差/テナント差/共有差）で回す前提を提供する。
- PTES：
  - Vulnerability Analysis：越権の成立条件（どの境界が効かないか）を特定する。
- MITRE ATT&CK：
  - Privilege Escalation / Collection を、越権（AuthZ境界崩壊）の説明補助として用いる。

## 報告（ガイドライン程度：数行で）
- 事実：観測した差分（A/B、所有、テナント、共有）と結果。
- 成立条件：何を変えると許可されたか（境界変数）/ どこで拒否されるべきか（拒否点）。
- 影響：越権/漏洩の範囲（推定は推定と明記）。
- 対策方向性：サーバ側一貫判定、テナント分離、共有権限/期限の最小化、監査強化。

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/02_web/03_authz_00_認可（IDOR BOLA BFLA）境界モデル化.md`
- 関連 playbooks：`02_playbooks/03_authn_観測ポイント（SSO_MFA前提）.md`
- 関連 playbooks：`02_playbooks/05_api_権限伝播→検証観点チェック.md`
