# 06_network_enum_to_post_列挙→侵入後の導線
NW列挙（到達性→サービス→認証→権限）を「結果の羅列」ではなく、観測→分岐→Post初動（経路/権限/材料）へ最短で繋ぐ。

## 目的（このプレイブックで到達する状態）
- “どこまで行けるか（到達性）/何があるか（サービス）/何が必要か（認証）/何ができるか（権限）” を状態で説明できる。
- 侵入後の初動として、次の3点（経路/権限/材料）のどれを優先するかを分岐で決められる。
- 後で説明できる最小証跡（コマンド出力/ログ/設定）を残せる。

## 前提知識チェックリスト（先に確認）
- 到達性：どのセグメントまで届くか
- 認証基盤：AD/LDAP/Kerberos 等の兆候
- 材料：パスワード/鍵/チケット/トークン

## 前提（対象・範囲・制約）
- 対象：許可範囲のIP/セグメント/資産。許可されない探索はしない（まず最小）。
- 制約：スキャン/大量通信はスコープ次第。まず “代表点” の観測で状態を作る。
- 前提ツール（最小限）：OS標準コマンド（Windows/Linux）、（任意）`nmap`/`nc`/`Test-NetConnection`。
  - 理由：到達性/経路/権限の基礎は標準コマンドで十分。
  - 代替：`ping`/`tracert`/`ss` などでも可。
- 参照すべきtopics：
  - `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
  - `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`

## 入口で確定すること（最小セット）
- 現在地点（foothold）の情報：OS/ユーザー/権限/ネットワーク（IP/route/DNS）。
- 射程（到達性）：どのサブネット/代表ホストに届くか（Yes/No/Unknown）。
- 認証基盤の兆候：AD/LDAP/Kerberos/IdP/VPN 等が見えるか（Yes/No/Unknown）。
- 完了条件：代表点（最大3つ）について「到達性/サービス/認証の種類/次の一手」を1行で書ける。

## 所要時間の目安
- 全体：30〜45分

## 手順（分岐中心：迷うポイントだけ）

### Step 0：最初の5分（必ずやる / 目安: 5分）
- 目的：現状（地点/権限/射程）を固定し、証跡を残す。
- 観測ポイント：
  - 自分の権限（低権限か/管理者相当か）
  - IP/route/DNS（どこへ行けそうか）
  - “外へ出る” 通信が許可されているか（スコープ確認）
- 証跡（最小）：
~~~~
# Windows (PowerShell)
$dir = Join-Path $HOME "keda_evidence\\network_06"
New-Item -ItemType Directory -Force $dir | Out-Null
Set-Location $dir
(Get-Date).ToString("s") | Set-Content -Encoding utf8 00_time.txt

# macOS/Linux (bash)
mkdir -p ~/keda_evidence/network_06
cd ~/keda_evidence/network_06
date > 00_time.txt
~~~~
- 次の分岐：
  - 地点情報が取れた → Step 1へ
- 実際の観測例：
  - `whoami /all` で管理者権限がないことを確認

### Step 1：地点（ホスト）と射程（到達性）を確定する（目安: 8分）
- 目的：列挙の前に「どこまでが自分の射程か」を確定する。
- 観測ポイント（OS別の代表例）：
  - Windows：`ipconfig /all`、`route print`、`whoami /all`
  - Linux：`ip a`、`ip r`、`id`
- 次の分岐（判断基準）：
  - 射程が狭い/セグメントが分断されている → Step 2A（経路を優先）
  - 射程が広い/複数セグメントに届きそう → Step 2B（サービス優先度付けへ）
- 実際の観測例：
  - ルートに `10.0.0.0/8` が見える

### Step 2A：分岐A（射程が狭い：まず経路/ピボット / 目安: 5分）
- 目的：次に届く範囲を増やす前提を作る（闇雲にスキャンしない）。
- 次の一手：
  - `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md` を優先して読む。
  - “どこへ届くようになれば勝ちか” を先に決めてから動く。

### Step 2B：分岐B（射程が広い：サービスを役割で優先度付け / 目安: 8分）
- 目的：スキャン結果の羅列ではなく、重要度（認証に近い順）で整理する。
- 観測ポイント（役割で分類）：
  - 認証に近い：AD/LDAP/Kerberos、IdP、VPN、RDP/SSH
  - 共有/運用：SMB/NFS、バックアップ、CI/CD、監視、管理コンソール
  - アプリ/DB：Web/API/DB/メッセージング
- 次の分岐：
  - 認証に近いサービスが見える → Step 3（認証方式と材料へ）
  - 共有（SMB/NFS）や運用基盤が強い → Step 4（権限/材料へ）
- 実際の観測例：
  - 445/389/88 が開いている → 認証基盤優先

### Step 3：認証方式を確定する（材料＝credsの種類を決める / 目安: 8分）
- 目的：何が必要か（パスワード/鍵/チケット/トークン）を先に決める。
- 観測ポイント：
  - 匿名で見えるか/認証が必須か
  - 失敗時の拒否点（どこで拒否されるか）
- 次の分岐（判断基準）：
  - 材料（creds）が足りない → Step 4A（credsへ）
  - ADの兆候が濃い（ドメイン参加/LDAP/Kerberos） → Step 4B（AD地図へ）
- 実際の観測例：
  - `Kerberos` が見える → AD地図へ

### Step 4A：分岐A（材料不足：creds を最優先 / 目安: 5分）
- 次の一手：
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md` へ。
  - “どの認証方式に何が必要か” を確定してから材料探索に入る。

### Step 4B：分岐B（AD濃厚：地図に接続 / 目安: 5分）
- 次の一手：
  - `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md` へ。
  - 以降の列挙は「AD地図を埋める観測」として再編する（資産/信頼/権限境界）。

## 取得する証跡（目的ベースで最小限）
- 何のため：地点/射程/認証基盤/材料不足の状況を説明するため。
- 取得対象：`ip/route/id(or whoami)` の出力、代表到達性チェックの結果、主要サービスの特定根拠メモ。
- 見るポイント：射程（到達性境界）、認証に近いサービスの有無、拒否点、材料（creds）の種類。

## コマンド例（例示は最小限 / OS別）
~~~~
# Windows（地点と射程）
ipconfig /all
route print
whoami /all

# Linux（地点と射程）
ip a
ip r
id
~~~~
- 何を観測する例か：自分の地点（権限/ネットワーク）と射程（どこへ届くか）。
- 出力の注目点：DNS/ドメイン情報、経路、複数NIC/セグメントの有無。
- 前提が崩れるケース：踏み台/コンテナ/限定シェル等で情報が取れない（その場合は取れる範囲でYes/No/Unknown化する）。

## よくある失敗と対処法
- スキャンに寄りすぎる → 代表点だけで状態化する
- OS混在でコマンドが混乱 → OS別に分けて実行
- 影響範囲を広げすぎる → 許可範囲を先に固定

## バグバウンティでの注意点
- ネットワーク探索は許可範囲外になりやすいので要確認
- 大量通信は避ける（代表点のみ）
- 証跡は最小限（コマンド出力の保存）
## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - NW列挙はASVS項目そのものではないが、認証基盤/権限伝播/秘密情報の所在を把握し、Web側検証の前提を支える。
- WSTG：
  - Webの周辺（認証基盤、運用境界）をNW視点で補強し、検証対象を外さない。
- PTES：
  - Intelligence Gathering → Post-Exploitation を、経路/権限/材料の3点で最短接続する。
- MITRE ATT&CK：
  - Discovery / Credential Access / Lateral Movement / Privilege Escalation を、状態（境界崩壊）として説明する補助に使う。

## 報告（ガイドライン程度：数行で）
- 事実：地点（OS/権限/ネットワーク）と射程、認証基盤の兆候。
- 成立条件：どこまで届くか/何が見えるか（根拠）。
- 影響：次に優先すべき（経路/権限/材料）と理由。
- 対策方向性：ネットワーク分離、認証面の最小化、監査強化（詳細はtopicsへ）。

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
- 関連 topics：`01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- 関連 topics：`01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
