# 07_input_to_rce_入力→実行の導線
入力を「ペイロード試行」ではなく、入力→解釈→実行/参照の境界（成立条件）を差分観測で確定し、次の一手を分岐で決める。

## 目的（このプレイブックで到達する状態）
- 入力点（フォーム/API/ファイル/URL 等）のうち、どれが「実行/参照の境界」に繋がるかを説明できる。
- 成立条件を “最小差分” で特定し、影響範囲（権限/環境/到達性）を整理できる。
- 次に読むtopic（SSTI/デシリアライズ/SSRF/コマンド等）を、観測結果から分岐で選べる。

## 前提（対象・範囲・制約）
- 対象：許可された検証範囲の Web アプリ（可能なら検証環境）。
- 制約：まず無害な観測（反射/保存/エラー差分）。影響が大きい試行は避け、最小回数で進める。
- 前提ツール（最小限）：ブラウザ + Proxy（HAR）、（任意）`curl`。
- 参照すべきtopics：
  - 総論：`01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`

## 入口で確定すること（最小セット）
- 入力点（最大3つ）：例）検索、テンプレ、プロフィール、ファイルアップロード、Webhook/外部URL入力。
- “無害なマーカー”：後で追える文字列（例：`keda_probe_<timestamp>`）。
- 観測先：レスポンス（反射/保存）、エラー、ログ（取れるなら）、外部通信（許可範囲なら）。
- 完了条件：入力点ごとに「どこで解釈されそうか（境界候補）」を Yes/No/Unknown で埋められる。

## 手順（分岐中心：迷うポイントだけ）

### Step 0：最初の5分（必ずやる）
- 目的：証跡と差分比較の軸（マーカー）を作る。
- 観測ポイント：
  - 入力点を1つ選び、通常入力（ベースライン）を1回だけ送る。
  - 同じ入力点に、マーカー文字列を含む入力を1回だけ送る（差分を作る）。
- 証跡（最小）：
~~~~
# Windows (PowerShell)
$dir = Join-Path $HOME "keda_evidence\\input_07"
New-Item -ItemType Directory -Force $dir | Out-Null
Set-Location $dir
"base_url: ...`nentry: ...`nmarker: keda_probe_..." | Set-Content -Encoding utf8 00_context.txt

# macOS/Linux (bash)
mkdir -p ~/keda_evidence/input_07
cd ~/keda_evidence/input_07
printf "base_url: ...\nentry: ...\nmarker: keda_probe_...\n" > 00_context.txt
~~~~
- 次の分岐：
  - ベースラインとマーカー差分が取れた → Step 1へ

### Step 1：入力が“どこに出るか”を分類する（反射/保存/無反応/エラー）
- 目的：最初に「到達しているか」を確定する（到達していないと境界検証が外れる）。
- 観測ポイント：
  - 反射：レスポンス本文/HTML/JSONにマーカーが出る
  - 保存：別画面/別ユーザー/後続処理で出る
  - 無反応：どこにも出ない（ただし裏側処理の可能性は残る）
  - エラー：スタック/例外/テンプレ名/ライブラリ名の手掛かりが出る
- 次の分岐（判断基準）：
  - 反射/保存が明確 → Step 2A（テンプレ/HTML/クエリ境界）
  - エラーに実行系の手掛かり → Step 2B（実行境界の候補）
  - 無反応だが外部連携（URL/Webhook/プレビュー）が絡む → Step 2C（SSRF/到達性）

### Step 2A：分岐A（反射/保存：解釈境界の候補）
- 目的：テンプレ/HTML/クエリ等で「解釈」が起きていないかを観測で確定する。
- 次の一手（安全優先）：
  - まずは「エスケープ有無」を観測する（`<` `>` `"` がどう扱われるか）。
  - テンプレ系が疑わしい場合は、無害な算術のような差分で“解釈の兆候”だけを見る。
- 次の分岐：
  - テンプレ解釈の兆候 → `01_topics/02_web/05_input_01_入力→実行境界（テンプレート注入_SSTI）.md`
  - DB/検索の癖が強い → 入力総論（`01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`）へ戻る

### Step 2B：分岐B（エラー手掛かり：実行境界の候補）
- 目的：どの種類の“実行”に近いか（テンプレ/デシリアライズ/コマンド/ファイル）を切り分ける。
- 観測ポイント：
  - テンプレ：テンプレ名/エンジン名（Jinja/Thymeleaf/Handlebars…）の痕跡
  - デシリアライズ：型名/クラス名/復元エラーの痕跡
  - ファイル：パス/拡張子/ストレージ鍵の痕跡
- 次の分岐：
  - デシリアライズ臭が強い → `01_topics/02_web/05_input_02_入力→実行境界（デシリアライズ_型混乱_ガジェット前提）.md`
  - ファイル/パス処理臭が強い → `01_topics/02_web/05_input_11_path_traversal_01_normalization（dotdot_encoding）.md`（必要時）
  - いずれも薄い → Step 3（成立条件の最小化へ）

### Step 2C：分岐C（外部連携/URL入力：SSRF/到達性境界）
- 目的：入力が「外部/内部へ到達する処理」に繋がるかを、スコープ内で確定する。
- 次の一手：
  - “どのタイミングで呼ばれるか” を観測（即時/非同期/プレビュー/バッチ）。
  - 許可範囲の観測先（自分の管理する検証エンドポイント等）で到達性だけを確認する。
- 次の分岐：
  - 到達性が取れた → `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`
  - 到達しない/不明 → Step 3（ログ/ジョブ/内部連携の観測へ）

### Step 3：成立条件を“最小差分”で確定する
- 目的：再現性のある説明に落とす（手当たり次第にしない）。
- 観測ポイント：
  - 変えるのは1点だけ（入力形式/ヘッダ/権限/コンテキストのいずれか）
  - 期待結果（拒否/無害化）と実結果（許可/漏洩/実行兆候）を並べる
- 次の分岐（判断基準）：
  - 影響が出る兆候 → Step 4（影響範囲）
  - 兆候が薄いが“実行前処理”はありそう → `02_playbooks/05_api_権限伝播→検証観点チェック.md`（裏側連携へ）

### Step 4：影響範囲（権限・環境・到達性）を整理する
- 目的：成立した場合の被害の形を、技術的に説明できるようにする。
- 観測ポイント：
  - 実行コンテキスト（どのユーザー/どのサービス/どの環境）
  - 触れる資産（ファイル/秘密情報/ネットワーク到達性）
- 次の一手：
  - 影響が “データ持ち出し” に寄るなら `02_playbooks/09_egress_exfil_出口評価（DNS_HTTP_SMB）.md` へ接続する。

## 取得する証跡（目的ベースで最小限）
- 何のため：入力→解釈→実行/参照の境界と成立条件を説明するため。
- 取得対象：代表リクエスト（ベースライン+差分）、レスポンス差分、エラー要点、（可能なら）関連ログ。
- 見るポイント：反射/保存の有無、解釈の兆候、実行に近い手掛かり、外部連携の発火タイミング。

## コマンド/リクエスト例（例示は最小限）
~~~~
# 例：マーカー差分を作る（値はすべてプレースホルダ）
curl -sS "https://<BASE>/search?q=normal" -D - -o /dev/null
curl -sS "https://<BASE>/search?q=keda_probe_12345" -D - -o /dev/null
~~~~
- 何を観測する例か：ベースラインと差分の「到達性（反射/エラー）」。
- 出力の注目点：レスポンス本文/ヘッダ/ステータスの差、エラーの手掛かり。
- 前提が崩れるケース：SPAで `curl` だけでは差が出ない（HAR中心で進める）。

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - V5（Input Validation）/V6（Secure Coding）を、境界（解釈/実行）と成立条件で説明可能な形に落とす。
- WSTG：
  - Injection / Input Validation を、「観測→分岐→次のtopic」へ変換する。
- PTES：
  - Vulnerability Analysis：成立条件の特定（最小差分）。
- MITRE ATT&CK：
  - Execution / Persistence / Exfiltration を、実行境界が崩れた場合の説明補助に使う。

## 報告（ガイドライン程度：数行で）
- 事実：入力点と差分観測（反射/保存/エラー/外部連携）の結果。
- 成立条件：何を変えると兆候が出るか（最小差分）と、解釈/実行が起きる場所の推定。
- 影響：触れ得る資産/到達性（推定は推定と明記）。
- 対策方向性：入力検証/エスケープ/安全なテンプレ設計/実行禁止、監査強化。

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
- 関連 playbooks：`02_playbooks/02_web_recon_入口→境界→検証方針.md`
- 関連 playbooks：`02_playbooks/05_api_権限伝播→検証観点チェック.md`
