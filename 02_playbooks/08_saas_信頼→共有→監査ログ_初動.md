# 08_saas_信頼→共有→監査ログ_初動
SaaS を「プロダクト個別」ではなく、信頼（IdP/プロビジョニング）→共有（外部/リンク/ゲスト）→監査ログ（追えるか）で状態化し、次の一手を分岐で決める。

## 目的（このプレイブックで到達する状態）
- 対象SaaSごとに、信頼境界（誰が本人性を保証し、誰が権限を配るか）を説明できる。
- 共有/外部連携で「どこへ権限やデータが出るか」を Yes/No/Unknown で埋められる。
- 監査ログで「誰が何をいつ」まで追えるか（取得可否/粒度/保存期間）を確定できる。
- 次に読むtopic（IdP/共有/監査/トークン寿命）と、次に回す検証（playbook）を分岐で選べる。

## 前提知識チェックリスト（先に確認）
- 信頼境界：IdP/ローカルログインのどちらが成立点か
- 共有境界：外部ユーザ/リンク/ゲストの有無
- 監査境界：誰が何をいつ追えるか

## 前提（対象・範囲・制約）
- 対象：許可範囲のSaaS（例：M365/Google/Okta/GitHub/Slack/Atlassian 等）。
- 制約：実際の“共有/外部連携の作成”は影響が大きい。まず設定と監査ログで状態を作る（必要なら検証環境で行う）。
- 前提ツール（最小限）：管理コンソール閲覧、（任意）監査ログAPI、スクショ/設定エクスポート。
  - 理由：SaaSはUI設定と監査ログが一次証跡になるため。
  - 代替：管理者がいない場合は「Yes/No/Unknown」で状態化のみ。
- 参照すべきtopics（必要に応じて寄せる）：
  - `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
  - `01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`
  - `01_topics/04_saas/12_audit_logs_取得と相関（誰が何をいつ）.md`
  - `01_topics/04_saas/15_token_lifetime_更新と失効（SaaS側）.md`

## 入口で確定すること（最小セット）
- 対象SaaS（最大3つ）：本番影響が高いもの/権限が強いものから選ぶ。
- 管理権限：設定が見られるか、監査ログが取れるか（Yes/No/Unknown）。
- 共有の形：外部ユーザ招待/ゲスト/リンク共有/外部アプリ連携の有無（Yes/No/Unknown）。
- 完了条件：各SaaSについて「信頼/共有/監査」を1行ずつ（Yes/No/Unknown）で埋める。

## 所要時間の目安
- 全体：30〜45分

## 手順（分岐中心：迷うポイントだけ）

### Step 0：最初の5分（必ずやる / 目安: 5分）
- 目的：対象を増やさず、状態を作る前提（権限と証跡）を固定する。
- 観測ポイント：
  - 対象SaaSを最大3つに絞る（例：最重要の1つ＋隣接2つ）。
  - 監査ログが「どこで取れるか」を先に確認する（UI/API/外部SIEM）。
  - “外部共有/外部アプリの作成” が許可されているか（スコープ確認。未確認なら作成しない）。
- 証跡（最小）：
~~~~
# Windows (PowerShell)
$dir = Join-Path $HOME "keda_evidence\\saas_08"
New-Item -ItemType Directory -Force $dir | Out-Null
Set-Location $dir
"targets: ...`nadmin_access: ...`nlog_sources: ..." | Set-Content -Encoding utf8 00_context.txt

# macOS/Linux (bash)
mkdir -p ~/keda_evidence/saas_08
cd ~/keda_evidence/saas_08
printf "targets: ...\nadmin_access: ...\nlog_sources: ...\n" > 00_context.txt
~~~~
- 次の分岐：
  - 対象とログ取得経路が決まった → Step 1へ
- 実際の観測例：
  - 「M365 + Google Workspace」だけに絞る

### Step 1：信頼境界（IdP/プロビジョニング/例外）を状態化する（目安: 8分）
- 目的：本人性と権限付与がどこで成立するかを確定する。
- 観測ポイント（Yes/No/Unknownで埋める）：
  - IdP強制：SSO必須か / ローカルログインが残るか
  - プロビジョニング：SCIM/JIT/手動（どれでユーザーが作られるか）
  - 例外パス：break-glass/特権アカウント/例外グループの有無
- 次の分岐（判断基準）：
  - SSO強制なのにローカルログインが残りそう → `01_topics/04_saas/14_sso_bypass_パス（ローカルログイン残存）.md`（topic）
  - IdP/OAuth/スコープが中心 → Step 3（外部連携と委任）
- 実際の観測例：
  - 「ローカルログイン許可」がオンのまま

### Step 2：共有境界（外部ユーザ/ゲスト/リンク）を状態化する（目安: 8分）
- 目的：データと権限が“外に出る経路”を先に見つける。
- 観測ポイント（Yes/No/Unknownで埋める）：
  - 外部ユーザ招待：可能か / ドメイン制限はあるか
  - リンク共有：公開/限定/期限/パスコードの有無
  - ゲスト/外部組織：権限の上限（閲覧のみ/編集可/管理可）
- 次の分岐（判断基準）：
  - 外部共有が広い/制限が薄い → Step 4（監査ログで追えるかを優先）
  - 共有は固いが外部アプリ連携が多い → Step 3へ
- 実際の観測例：
  - 「外部ドメイン制限なし」が有効

### Step 3：外部連携（OAuth同意/アプリ/トークン）を状態化する（目安: 8分）
- 目的：“委任された権限” がどこまで効くかを把握する。
- 観測ポイント（Yes/No/Unknownで埋める）：
  - OAuth同意：ユーザー同意が可能か / 管理者同意が必要か
  - 連携アプリ：誰が作れるか / どんな権限を要求できるか
  - トークン：長寿命（PAT等）があり得るか / 失効やローテーションの仕組みがあるか
- 次の分岐（判断基準）：
  - “長寿命トークン/失効が弱い” が中心 → `01_topics/04_saas/15_token_lifetime_更新と失効（SaaS側）.md`
  - アプリ権限が中心（Consent/Scope） → `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- 実際の観測例：
  - PATが無期限で発行可能

### Step 4：監査ログ（誰が何をいつ）で“追える境界”を確定する（目安: 8分）
- 目的：設定が怪しい/共有が広い場合に、証跡で説明できる状態にする。
- 観測ポイント（Yes/No/Unknownで埋める）：
  - 取得可否：管理コンソール/ API / SIEM で取れるか
  - 粒度：ログイン/管理操作/共有変更/外部連携（どこまで出るか）
  - 保存：保持期間、エクスポート可否、相関キー（user_id/ip/device/app）
- 次の分岐（判断基準）：
  - 重要イベントが取れない/保存が短い → 監査設計が本体（topicへ）：`01_topics/04_saas/12_audit_logs_取得と相関（誰が何をいつ）.md`
  - 取れるが相関できない → 相関キー（ユーザー/端末/アプリ）設計を追加で固める（topicへ）
- 実際の観測例：
  - 管理操作ログが「7日しか残らない」

### Step 5：攻め筋の確定（次の深掘りを最大3つに絞る / 目安: 5分）
- 優先度の付け方：
  1) 例外パス（ローカルログイン残存、break-glass、特権委任）
  2) 外部共有（ゲスト/公開リンク/外部ドメイン）
  3) 外部連携（OAuth同意/長寿命トークン）＋監査の弱さ
- 次に回す検証（playbook）：
  - Web側SSO観測：`02_playbooks/03_authn_観測ポイント（SSO_MFA前提）.md`
  - 共有/外部連携が中心：このplaybookの Step 2/3 を深掘り
- 実際の観測例：
  - 共有制限が弱い → Step 2 を深掘り

## SaaS別の観測ポイント（簡易）
- M365: 外部共有の上限、ゲスト招待制限、監査ログの保持期間
- Google Workspace: 共有リンクの公開範囲、外部アプリ同意の制御
- Okta: ローカルログイン例外、MFA例外グループ、System Logの取得
- GitHub: PATの期限、Org外コラボ制限、監査ログの可視性

## よくある失敗と対処法
- 対象SaaSを増やしすぎる → 最大3つに絞る
- 共有を実際に作成してしまう → まず設定とログで状態化
- 監査ログが取れない → UIスクショで根拠を残す

## バグバウンティでの注意点
- 本番SaaSでの設定変更は原則NG（検証環境で）
- 外部共有の作成は許可確認が必須
- レポートは「設定根拠」「ログ可否」を明確にする
## 取得する証跡（目的ベースで最小限）
- 何のため：信頼/共有/監査の境界を説明するため。
- 取得対象：設定画面のスクショ（SSO/共有/外部連携）、監査ログのサンプル（数件）、保持期間の根拠。
- 見るポイント：例外パス、外部共有の範囲と制限、外部アプリの権限、監査ログの粒度と相関キー。

## コマンド/リクエスト例（例示は最小限）
~~~~
# 例：監査ログAPIがある場合の“疎通”レベル（プロダクトごとに置き換える）
curl -sS -H "Authorization: Bearer <TOKEN>" "https://<AUDIT_API_ENDPOINT>?$top=5"
~~~~
- 何を観測する例か：監査ログが取れるか（取得可否/粒度の当たり）。
- 出力の注目点：イベント種別、actor、target、timestamp、ip/device/app 等の相関キー。
- 前提が崩れるケース：監査ログがUIのみ/契約プラン依存（その場合は UI のエクスポート/スクショで代替）。

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：
  - 認証/セッション/アクセス制御の前提（IdP/例外パス/委任）と、監査（V10）での追跡性を固める。
- WSTG：
  - 認証/認可/設定管理の前提として、SaaSの信頼境界と共有境界を状態化する。
- PTES：
  - Intelligence Gathering → Vulnerability Analysis における “外部依存の境界” を確定する。
- MITRE ATT&CK：
  - Initial Access（Consent/外部連携）/Credential Access（トークン）/Collection（共有）/Defense Evasion（監査不足）の説明補助に使う。

## 報告（ガイドライン程度：数行で）
- 事実：各SaaSの信頼/共有/監査（Yes/No/Unknown）と根拠。
- 成立条件：例外パスや外部共有が成立する条件（誰が/どこで/何をできるか）。
- 影響：外部漏えい/越権/追跡不能のリスク（推定は推定と明記）。
- 対策方向性：SSO強制と例外削減、共有制限、同意/トークン最小化、監査ログ強化。

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- 関連 topics：`01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`
- 関連 topics：`01_topics/04_saas/12_audit_logs_取得と相関（誰が何をいつ）.md`
