# 23_vdp_scope_制約下での低アクティブ観測設計
VDP Scope 制約下での低アクティブ観測設計
“scope（対象/非対象/禁止行為）を行為単位に分解し、迷わず実行できる”

## 目的（この技術で到達する状態）
VDP（Vulnerability Disclosure Program）や契約上の制約下で、過度なスキャン/負荷/認証試行を避けつつ、ASM/OSINTとして「観測→判断→次の一手」を成立させる設計（scope_key_plan）を作れる状態にする。
- scope（対象/非対象/禁止行為）を “行為単位” に分解し、迷わず実行できる
- 低アクティブ（最小リクエスト）でも、攻撃面（endpoint）と境界（資産/信頼/権限）を確度高く確定できる
- 収集物（証跡）と報告物（再現性）の粒度を揃え、VDPで通る形にできる
- 既存トピック（14〜22）で得た成果物を「制約に沿って使い回す」ための接続点を持つ

## 前提（対象・範囲・想定）
- 対象：VDP（Vulnerability Disclosure Program）や契約上の制約下での観測設計。VDP の “scope文章” は曖昧なことが多い。曖昧さは「解釈」ではなく「保守的な運用ルール」で吸収する
- 想定する環境：
  - 低アクティブとは「安全で無害」ではない。最小リクエストでも影響が出る可能性がある（特に認証、ファイル、検索）
  - 重大性の高い兆候（P0）が出た場合は “深追いせず、証跡を整えて報告/確認へ” が原則
- できること/やらないこと（安全に検証する範囲）：
  - できる：低アクティブ（最小リクエスト）でも、攻撃面（endpoint）と境界（資産/信頼/権限）を確度高く確定できる。収集物（証跡）と報告物（再現性）の粒度を揃え、VDPで通る形にできる
  - やらない：本ファイルの目的は “やり方の工夫” であり、禁止行為の回避テクニックではない。過度なスキャン/負荷/認証試行を避ける
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/14_js_sourcemap_公開物から攻撃面抽出（endpoint_key）.md` 以降の既存トピック（14〜22）
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：VDP Scope 制約下での低アクティブ観測設計、scope（対象/非対象/禁止行為）の分解、証跡設計
  - 扱わない（別ユニットへ接続）
    - 各観測トピック → `01_topics/01_asm-osint/` 配下の各ファイル

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）
  - scope を “行為単位” に分解する（解釈の一貫性）
    - scope は「対象URL」だけでなく「許可される行為」が本質。
    - 対象資産：ドメイン/サブドメイン/IP/アプリ/モバイル/メール/クラウド
    - 対象外資産：関連会社/旧ブランド/第三者SaaS（どこまで許可か）
    - 禁止行為：自動スキャン、DoS、認証総当たり、ソーシャル、破壊的操作、データ改変、マルウェア、外部者への影響
    - 許可行為：手動確認、低頻度アクセス、OSINT、限定的な検証（明記がある場合）
    - 行為単位ラベル（例）：
      - passive_osint：検索・DNS・CT・公開ドキュメント
      - low_http_probe：既知URLへの最小HTTP（1回程度、軽量）
      - auth_flow_observe：認証フローの観測（ログイン試行の連打はしない）
      - upload_or_state_change：状態変更を伴う可能性（原則避ける/明示許可が必要）
  - 低アクティブ観測の「最小セット」を定義する
    - 低アクティブは “手数” と “負荷” と “影響” の3軸で設計する。
    - 手数：1資産あたりのリクエスト数上限（例：1〜3）
    - 負荷：サイズ（HEAD優先、GETでも小さいものに限定）
    - 影響：状態変更・メール送信・課金・通知など副作用の可能性
    - 最小セット（例）：
      - DNS/CT（リクエストはDNSのみ）：01_dns/02_tls に相当
      - HTTP（既知URLの1回）：03_http の “観測” のみ（クロール/総当たり禁止）
      - 公開物（GitHub/CI/Docs）：16/17 の “証跡化” のみ（実トークン利用禁止）
      - モバイル/タグ解析：21/22 の “静的抽出” のみ
  - 証跡設計（VDPで通る粒度）を先に決める
    - VDPでは「再現性」と「影響最小」が重要。観測のたびに以下を残す。
    - いつ：日時（JST）
    - どこ：URL/ドメイン/参照元（source_locator）
    - なに：観測した事実（レスポンス要約、DNS値、CT証明書など）
    - どれくらい：リクエスト回数、サイズ、影響（状態変化の有無）
    - なぜ：それがリスクにつながる理由（推定は分離して書く）
    - 次に：追加確認が必要な場合の “許可依頼ポイント”（何をすれば確定するか）
- 境界の観点
  - 資産境界（管理主体・委託先・対象範囲の線引き）：対象資産（ドメイン/サブドメイン/IP/アプリ/モバイル/メール/クラウド）、対象外資産（関連会社/旧ブランド/第三者SaaS（どこまで許可か））
  - 信頼境界（外部連携・第三者・越境ポイント）：禁止行為（自動スキャン、DoS、認証総当たり、ソーシャル、破壊的操作、データ改変、マルウェア、外部者への影響）、許可行為（手動確認、低頻度アクセス、OSINT、限定的な検証（明記がある場合））
  - 権限境界（権限の切替/伝播/委任）：低アクティブとは「安全で無害」ではない。最小リクエストでも影響が出る可能性がある（特に認証、ファイル、検索）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）
  - scope_key_plan（後工程に渡す正規化キー）
    - scope_key_plan = <program> + <asset_set> + <allowed_action_set> + <forbidden_action_set> + <rate_limit_rule> + <evidence_rule> + <escalation_rule>
  - asset_set（例）
    - in_scope_domains / out_of_scope_domains / third_party_excluded
  - rate_limit_rule（例）
    - max_req_per_host=3, no_bruteforce, no_crawl
  - escalation_rule（例）
    - P0 detected -> stop & report, request permission for deeper validation

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - 制約下でも、攻撃面と境界を一定精度で確定でき、報告可能な証跡が揃う
  - “次に何をすれば確定するか” を、許可依頼として具体化できる（VDPとの交渉点）
  - 深追いせずに、重大兆候（P0）を早期に見つけたら止まれる
- 何が“推定”できるか（推定の根拠/前提）
  - 実際の脆弱性確定（多くは追加検証が必要）
- 何は“言えない”か（不足情報・観測限界）
  - 実際の脆弱性確定（多くは追加検証が必要）
  - 影響範囲（本番データ閲覧/改変など）の確証（副作用のある確認は許可が必要）
  - 禁止行為の境界が不明な場合の最終判断（運営への確認が必要）
- よくある状態パターン（正常/異常/境界がズレている等）
  - パターンA：scope文章が曖昧で、どこまで許されるか不明
  - パターンB：P0兆候が出た（重大だが確証のための追加検証が必要）
  - パターンC：低アクティブだと情報が不足する（P1/P2しか集まらない）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”（診断上の優先度付けとして使う）
  - P0（即中断＋報告/許可依頼へ）：secret（鍵/トークン）露出が高確度（16/17）、認証不要で機微情報が見える示唆（03_httpの1回観測で判明）、公開ストレージの疑い（18）で “顧客/バックアップ/ログ” 系が見える示唆
  - P1（低アクティブで継続観測）：stg/dev 面の存在（18/22）や、重要導線の外部依存（21）、API仕様公開（15）で面が大量に見える（ただし総当たり検証はしない）
  - P2（情報整備）：ブランド/類似ドメイン（20）の候補整理、メール基盤（19）の成熟度整理
- 優先度の付け方（時間制約がある場合の順序）
  - P0（即中断＋報告/許可依頼へ）→ P1（低アクティブで継続観測）→ P2（情報整備）の順
- 代表的な攻め筋（この観測から自然に繋がるもの）
  - 攻め筋1：低アクティブで確度が上がる領域に集中する：公開物（GitHub/CI/Docs）からの漏えい（16/17）、仕様公開（15）と静的解析（14/21/22）、DNS/CT（01/02/20）
  - 攻め筋2：低アクティブだと危険/誤判定が増える領域は “許可依頼ポイント” に回す：認証試行の繰り返し、パスワードリセット、メール送信、アップロード、状態変更、負荷の高い検索
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）
  - 低アクティブだと情報が不足する（P1/P2しか集まらない） → 14〜22 の成果物を相互参照して確度を上げる（単体で確証を求めない）、追加行為の候補を “許可依頼” としてまとめる（スキャン許可、検証環境、テストアカウント等）

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：scope文章が曖昧で、どこまで許されるか不明
  - 次の検証：
    - （保守的ルールで固定）“自動化はしない”“1ホスト数リクエストまで”“状態変更はしない” を既定にする。不明な行為は “permission_request_points” に積む（勝手に進めない）。低アクティブで価値の高い OSINT（DNS/CT/公開物/静的解析）に寄せる
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 保守的ルールの適用と、permission_request_points の整理、OSINTでの観測結果
- 仮説B：P0兆候が出た（重大だが確証のための追加検証が必要）
  - 次の検証：
    - 追加検証をしないで止める（副作用や規約違反の回避）。証跡を整える（何がどこに、どの程度の確度で、なぜ危険か）。“確定に必要な最小追加行為” を明文化し、運営へ許可依頼（例：この1回のアクセス/この操作のみ）。可能なら “影響確認は運営側ログ確認” を提案する（こちらで操作しない）
  - 期待する観測：
    - 証跡の整備、許可依頼の明文化、運営側ログ確認の提案
- 仮説C：低アクティブだと情報が不足する（P1/P2しか集まらない）
  - 次の検証：
    - 14〜22 の成果物を相互参照して確度を上げる（単体で確証を求めない）。追加行為の候補を “許可依頼” としてまとめる（スキャン許可、検証環境、テストアカウント等）。24_subdomain_takeover や 25_dnssec のように、DNS系で確度を上げられる領域へ寄せる
  - 期待する観測：
    - 成果物の相互参照、許可依頼のまとめ、DNS系での確度向上

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/01_attack-box_作業端末設計.md`（結果の保存・差分管理）
    - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`（現状確認の最小証跡）
- 取得する証跡（目的ベースで最小限）
  - scope_key_plan（後工程に渡す正規化キー）
    - scope_key_plan = <program> + <asset_set> + <allowed_action_set> + <forbidden_action_set> + <rate_limit_rule> + <evidence_rule> + <escalation_rule>
  - 記録の最小フィールド（推奨）
    - scope_text_locator: scope文章の参照箇所（URL/スクショ）
    - interpretation_rules: 保守的ルール（後述）
    - allowed_actions / forbidden_actions
    - per_asset_limit: 回数/サイズ/時間の上限
    - evidence_template: 何を残すか
    - stop_conditions: 中断条件（P0）
    - permission_request_points: 追加許可が必要な行為一覧
- 観測の取り方（どの視点で差分を見るか）
  - 低アクティブ（最小リクエスト）でも、攻撃面（endpoint）と境界（資産/信頼/権限）を確度高く確定できる
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/vdp_23 2>/dev/null
    cd ~/keda_evidence/vdp_23
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ（契約範囲/社内許可範囲/自前検証環境）
      - 観測は **代表点の抽出** のみ（低アクティブ（最小リクエスト）でも、攻撃面（endpoint）と境界（資産/信頼/権限）を確度高く確定できる）
      - 観測視点（端末/経路/ネットワーク）を記録
  - 相関キー（最低限）を作る（後で必ず効く）
    - Program：program
    - AssetSet：asset_set（in_scope_domains/out_of_scope_domains/third_party_excluded）
    - AllowedActionSet：allowed_action_set
    - ForbiddenActionSet：forbidden_action_set
    - RateLimitRule：rate_limit_rule（max_req_per_host=3, no_bruteforce, no_crawl）
    - EvidenceRule：evidence_rule
    - EscalationRule：escalation_rule（P0 detected -> stop & report, request permission for deeper validation）
    - Timestamp：観測日時（JSTで秒まで）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は“手段”であり“結論”ではない。必ず「何を観測している例か」を添える。

~~~~
# 最小の運用ルール例（制約下の自己ルール：例示のみ）

## 出力例（最小）
- 低アクティブで差分観測のみ実施
# - 既知URLのみ（ディレクトリ総当たり/クローリングしない）

## 出力例（最小）
- 低アクティブで差分観測のみ実施
# - 1ホストあたり最大3リクエスト、サイズは小さいものを優先

## 出力例（最小）
- 低アクティブで差分観測のみ実施
# - 認証試行は連打しない（1回の観測で十分な範囲に限定）

## 出力例（最小）
- 低アクティブで差分観測のみ実施
# - 状態変更（送信/作成/削除/更新）は行わない

## 出力例（最小）
- 低アクティブで差分観測のみ実施
# - P0兆候が出たら即停止し、証跡を整えて報告へ

## 出力例（最小）
- 低アクティブで差分観測のみ実施
~~~~

- この例で観測していること：
  - 低アクティブ（最小リクエスト）でも、攻撃面（endpoint）と境界（資産/信頼/権限）を確度高く確定できる
- 出力のどこを見るか（注目点）：
  - 既知URLのみ（ディレクトリ総当たり/クローリングしない）、1ホストあたり最大3リクエスト、サイズは小さいものを優先、認証試行は連打しない（1回の観測で十分な範囲に限定）、状態変更（送信/作成/削除/更新）は行わない、P0兆候が出たら即停止し、証跡を整えて報告へ
- この例が使えないケース（前提が崩れるケース）：
  - 禁止行為の境界が不明な場合の最終判断（運営への確認が必要）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V1（アーキ/要件）：境界（資産/信頼/権限）を定義し、検証の前提を明確化する。V14（設定）：公開物/設定/ログの露出は低アクティブでも検出可能で、優先度が高い。V2/V3（支える前提）：認証・セッションは副作用が出やすく、制約下では観測設計が重要
  - 該当要件（可能ならID）：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：境界（資産/信頼/権限）を定義し、検証の前提を明確化できないと、以降の検証で“対象外”や“前提違い”を起こし、検証精度が落ちる。
    - 満たす：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）を把握し、以降の検証（認証/認可/API/運用）を「前提崩れ」なく進める土台を作る。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：INFO：公開情報中心で攻撃面を収集し、制約下での検証計画を組む。一般：安全なテスト設計（負荷/副作用/許可）を前提に、手順を選ぶ
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：WSTG各観点へ入る前の“入口確定”として接続
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：Pre-engagement（支える前提）：許可範囲/制約/ルールを明確化し、実施計画に落とす。Intelligence Gathering：低アクティブで価値の高い収集を優先する
  - 前後フェーズとの繋がり（1行）：VDP（Vulnerability Disclosure Program）や契約上の制約下で、過度なスキャン/負荷/認証試行を避けつつ、ASM/OSINTとして「観測→判断→次の一手」を成立させる設計（scope_key_plan）を作れる
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance：公開情報からの収集に集中する設計。Testing/Validation（支える前提）：制約下で“確定に必要な最小行為”を整理して許可依頼する
  - 攻撃者の目的（この技術が支える意図）：Reconnaissance / Discovery として、攻め筋の確率を上げるための境界特定・依存推定。
  - 参照：https://attack.mitre.org/tactics/TA0043/

## 参考（必要最小限）
- OWASP ASVS
  https://github.com/OWASP/ASVS
- OWASP WSTG
  https://owasp.org/www-project-web-security-testing-guide/
- PTES
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Reconnaissance
  https://attack.mitre.org/tactics/TA0043/
- 代表的なVDPの制約パターン（自動スキャン禁止、DoS禁止、ソーシャル禁止 等）
- “証跡中心” の報告設計（再現性・影響最小・確度ラベル）

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/01_asm-osint/16_github_code-search_漏えい（key_token_endpoint）.md`
  - `01_topics/01_asm-osint/17_ci-cd_artifact_公開物（ログ_ビルド成果物）.md`
- 関連 labs / cases：
  - `04_labs/01_local/01_attack-box_作業端末設計.md`

---

## 深掘りリンク（最大8）
- `01_topics/01_asm-osint/18_storage_discovery（S3_GCS_AzureBlob）境界推定.md`
- `01_topics/01_asm-osint/22_mobile_assets_アプリ由来攻撃面（deep-link_API）.md`
- `01_topics/01_asm-osint/21_third-party_外部依存（タグ_分析SDK）洗い出し.md`
- `01_topics/01_asm-osint/15_api_spec_公開（OpenAPI_GraphQLスキーマ）から面抽出.md`
- `01_topics/01_asm-osint/20_brand_assets_関連ドメイン推定（typo_lookalike）.md`
- `01_topics/01_asm-osint/19_email_infra（SPF_DKIM_DMARC）と攻撃面.md`
- `01_topics/01_asm-osint/24_subdomain_takeover_成立条件推定（DNS_CNAME_プロバイダ）.md`
- `01_topics/01_asm-osint/25_dnssec_観測と意味（委譲_検証_誤設定）.md`

---
