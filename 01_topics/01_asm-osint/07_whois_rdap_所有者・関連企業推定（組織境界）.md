# 07_whois_rdap_所有者・関連企業推定（組織境界）
WHOIS/RDAP 所有者・関連企業推定（組織境界）
“組織境界・委託運用・優先度付け”を観測で確定し、次の調査（ASN/BGP、PassiveDNS、CT、第三者依存）へ繋げる

## 目的（この技術で到達する状態）
- WHOIS/RDAPを「登録情報を見る手段」ではなく、**組織境界（owner / operator / vendor / reseller）** を切り分けるための“証跡”として扱える。
- ドメイン/AS（次ステップ）/IP/ネームサーバの情報を束ね、**同一組織っぽさ** と **委託運用っぽさ** を観測差分で説明できる（yes/no/unknownで落とす）。
- サブドメイン列挙（06）で見つけた資産を、WHOIS/RDAPで **優先度付け（重要度・交渉先・責任所在）** し、次の調査（ASN/BGP、PassiveDNS、CT、第三者依存）に繋げられる。

## 前提（対象・範囲・想定）
- 対象：主に「ドメイン名（登録）」と「IP/AS（割り当て）」の所有/運用情報。
- 想定する環境：
  - WHOIS：典型的に“テキスト”で返り、TLD/レジストラ/レジストリで出力が揺れる。GDPR等で登録者情報が赤塗りになりやすい（= 直接の所有者名が取れないケースが増える）。
  - RDAP：HTTP/JSONベースで、ドメイン・IP・ASの登録情報を“構造化”して取れる。レート制限や認証要求がある場合がある（= 取り過ぎない設計が必要）。
  - 登録情報が取れても、それが「運用者」ではない（CDN/ホスティング/代理登録/グループ会社/買収後の名残）。
- できること/やらないこと（安全に検証する範囲）：
  - できる：ドメイン/IP/ASの登録情報の取得、組織境界の推定、優先度付け
  - やらない：レート制限を超える大量取得、認証が必要な情報の強引な取得、登録情報＝運用主体の断定
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`（サブドメイン列挙の結果を優先度付け）
  - `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`（AS/IP側の深掘り）
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：WHOIS/RDAPによる組織境界（owner/operator/vendor/reseller）の推定、関連企業推定、優先度付け
  - 扱わない（別ユニットへ接続）
    - サブドメイン列挙 → `06_subdomain_列挙（passive_active_辞書_優先度）.md`
    - ASN/BGP観測 → `08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
    - PassiveDNS → `09_passive-dns_履歴と再利用（過去資産の掘り起こし）.md`
    - CTログ → `10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（WHOIS/RDAPで見ているもの）
  - “主体”を4種類に分けて観測する（境界モデル）
    - Owner（法的所有者・ブランド主体）：その資産の最終責任を負う組織
    - Operator（運用主体）：インフラ/アプリを運用している主体（委託先を含む）
    - Registrar/Registry（登録業者/管理組織）：登録の窓口/上位管理（必ずしもOwnerではない）
    - Privacy/Proxy/Reseller（代行・秘匿・再販）：Owner情報を覆い隠す層
  - ドメイン（FQDN）→ レジストリ/レジストラ/ネームサーバの確定
    - TLD（.com/.jp 等）：レジストリの支配範囲
    - Registrar（登録業者）：移管/失効/ロック等の手続き主体（ただしOwnerとは限らない）
    - Nameserver（NS）：運用の匂いが強い（自社/クラウドDNS/マネージドDNS）
  - “関連企業推定”は、登録情報の一致ではなく“束”で見る
    - レジストラ一致（同じ窓口で多数ドメイン）
    - NSパターン一致（同一DNS運用基盤）
    - 連絡先ドメイン/abuse先の一貫性（ある場合）
    - 登録更新・有効期限の周期の類似（更新運用の匂い）
    - 同一リダイレクト/同一TLS/同一CDN（別ステップの観測と接続）
- 境界の観点
  - 資産境界（管理主体・委託先・対象範囲の線引き）：“同一ドメイン配下”でも、運用主体が違う（委託/別部門/買収由来）可能性があるため、後続（WHOIS/RDAP・ASN・Cloud推定）と束ねて判断する。
  - 信頼境界（外部連携・第三者・越境ポイント）：NSがクラウドDNS（Route53等）でも、それは「運用経路」であってOwner断定ではない。NSが独自ドメイン配下（ns1.example.com等）なら、運用主体の可能性が上がる（ただし委託もある）。
  - 権限境界（権限の切替/伝播/委任）：サブドメインごとに別の認証/別テナント/別管理画面が存在し得る（`admin.` / `id.` / `api.` など）。
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）
  - 観測のポイントは「誰が出ているか」ではなく、**どの層の情報しか取れていないか** を切り分けること。
  - RDAP/WHOISの“欠落”自体も情報（yes/no/unknown）
    - 登録者が完全に赤塗り：owner推定は別ソース（CT/PassiveDNS/サイト記載/採用情報等）に寄せる
    - Privacy/Proxyが明示：運用実態の推定を優先（CDN/WAF/ホスティング/同居推定へ）
    - レート制限/認証要求：自動化は慎重にし、対象を絞る（“全部取る”はやらない）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - “登録の窓口”と“DNS運用の匂い”は観測できる（Registrar/NS）
  - 赤塗り/Proxy/欠落があるなら、それは「登録情報ではowner確定できない」という確定情報
  - サブドメイン群を「統制されていそう/されてなさそう」に優先度付けできる
- 何が“推定”できるか（推定の根拠/前提）
  - 組織境界が “owner候補A / operator候補B / vendor候補C” として分解できる
  - 出力は「同一と断定」ではなく、強い（複数の束が一致）/中（束が一部一致）/弱い（ほぼ一致なし）のように扱い、次の手を決めるために使う
- 何は“言えない”か（不足情報・観測限界）
  - 登録情報＝運用主体/所有主体（委託・代行・買収・グループ会社で崩れる）
  - 企業の内部構造（事業部/子会社関係）はWHOIS単体では断定できない
- よくある状態パターン（正常/異常/境界がズレている等）
  - パターンA：登録情報が赤塗りでowner断定が難しい（unknownが多い）
  - パターンB：複数束が一致し、同一組織クラスターが強い
  - パターンC：Registrar/NSが明確に分かれ、“別組織運用”が濃厚

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”
  - 登録/運用が事業ごとにバラバラ（統制が弱い領域が混ざる）
  - 古いドメイン/更新が途切れがち（運用放置の可能性）
  - NSが第三者運用へ分散（委託境界が増え、設定差分が出やすい）
- 優先度の付け方（時間制約がある場合の順序）
  - サブドメインが多いほど、全部は追えない。WHOIS/RDAPで「攻め筋の入口」を選別する。
    - 企業ドメイン直下（brand直結） vs サービス委託臭（vendor名が匂う）
    - 複数TLD/国別TLDの分散（地域運用/買収/事業部境界の可能性）
    - 登録/運用が混在（統制の弱い領域＝設定ミスが出やすい“候補”）
- 代表的な攻め筋（この観測から自然に繋がるもの）
  - 攻め筋1：グループ会社/買収由来で“統制の弱い資産群”が混ざっている → PassiveDNS/CTで過去資産と接続し、同一クラスターを探す
  - 攻め筋2：運用委託（CDN/WAF/ホスティング）が境界を作っている → 同居推定（11）・WAF/CDN挙動観測（12）で運用主体を寄せる
  - 攻め筋3：IP側（AS）で見ると“明確に別組織”に分かれる → ASN/BGP（08）でネットワーク境界として確定する
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）
  - 登録情報が赤塗りでowner断定が難しい（unknownが多い） → NS/レジストラ/証明書/外部依存（タグ・SDK）など“運用の束”で同一性を寄せる

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：登録情報が赤塗りでowner断定が難しい（unknownが多い）
  - 次の検証：
    - NS/レジストラ/証明書/外部依存（タグ・SDK）など“運用の束”で同一性を寄せる
    - 08（ASN/BGP）と09（PassiveDNS）を先に進め、過去・ネットワーク境界で補強する
  - 期待する観測（成功/失敗時に何が見えるか）：
    - ownerは断定しないが、運用クラスター（同一っぽい資産群）として扱える
- 仮説B：複数束が一致し、同一組織クラスターが強い
  - 次の検証：
    - 06のサブドメイン一覧を“クラスター単位”で並べ替え、攻撃面の多いクラスターから深掘りする
    - 10（CTログ）や11（同居推定）で外部依存と露出面を増やし、入口を太くする
  - 期待する観測：
    - 「この組織境界に対して、次に何を観測すべきか」が決まる
- 仮説C：Registrar/NSが明確に分かれ、“別組織運用”が濃厚
  - 次の検証：
    - 12（WAF/CDN挙動）で運用境界の差分（ブロック/チャレンジ/例外）を観測する
    - 21（第三者依存）で、タグ/SDK/外部連携の面を洗い出す
  - 期待する観測：
    - owner/operator/vendorを分解したまま、境界ごとに攻め筋を設計できる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/01_attack-box_作業端末設計.md`（収集・整形・差分管理の作業基盤）
    - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`（証跡の最小セット）
- 取得する証跡（目的ベースで最小限）
  - ドメインごとの観測メモ（3点だけでよい）
    - Registrar / NS / RDAPで見える組織（entity/remarks等）
  - “束”の一致/不一致（強/中/弱）
  - unknownの理由（赤塗り・制限・情報欠落）
- 観測の取り方（どの視点で差分を見るか）
  - サブドメイン列挙（06）で見つけた資産を、WHOIS/RDAPで優先度付けする
  - 登録情報の一致ではなく“束”で見る（レジストラ一致、NSパターン一致、連絡先ドメイン/abuse先の一貫性等）
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/whois_07 2>/dev/null
    cd ~/keda_evidence/whois_07
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象ドメインは **許可されたスコープ** のみ（契約範囲/社内許可範囲/自前検証環境）
      - 観測は **代表点の抽出** のみ（レート制限を超える大量取得は前提にしない）
      - 観測視点（端末/経路/ネットワーク）を記録
  - 相関キー（最低限）を作る（後で必ず効く）
    - Domain：対象ドメイン/サブドメイン
    - TLD：レジストリの支配範囲
    - Registrar：登録業者
    - NS：ネームサーバ（運用の匂いが強い）
    - Owner：法的所有者・ブランド主体（推定）
    - Operator：運用主体（推定）
    - Vendor：委託先（推定）
    - Cluster：同一組織クラスター（強/中/弱）
    - Timestamp：観測日時（JSTで秒まで）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は“手段”であり“結論”ではない。必ず「何を観測している例か」を添える。

~~~~
# ドメインWHOIS（出力は揺れる。必要行だけ抜く）
whois example.com | sed -n '1,80p'

# RDAP（構造化。TLD/レジストリによりエンドポイントが異なるので、まずは結果が返る範囲で）
curl -s "https://rdap.org/domain/example.com" | head

# IP/AS側は次ステップ（ASN/BGP）で深掘りするが、入口としてRDAPを確認
curl -s "https://rdap.org/ip/203.0.113.0" | head
~~~~

- この例で観測していること：
  - WHOIS/RDAPによる組織境界（owner/operator/vendor/reseller）の推定、関連企業推定、優先度付け
- 出力のどこを見るか（注目点）：
  - Registrar（登録業者）：移管/失効/ロック等の手続き主体（ただしOwnerとは限らない）
  - NS（ネームサーバ）：運用の匂いが強い（自社/クラウドDNS/マネージドDNS）
  - RDAPで見える組織（entity/remarks等）：owner/operator/vendor/resellerの推定材料
- この例が使えないケース（前提が崩れるケース）：
  - レート制限/認証要求がある場合（自動化は慎重にし、対象を絞る必要がある）
  - GDPR等で登録者情報が赤塗りになっている場合（登録情報ではowner確定できない）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V1（アーキテクチャ/信頼境界）やV14（構成/運用）を評価する際の「外部依存・責任分界」を明確化する前提として接続する
  - 該当要件（可能ならID）：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：組織境界（owner/operator/vendor/reseller）を確定できないと、以降の検証で“対象外”や“前提違い”を起こし、検証精度が落ちる。認証やセッションの例外パス（SSO/回復/委託運用）がどの主体に属するかを、報告でブレなく説明できない。
    - 満たす：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）を把握し、以降の検証（認証/認可/API/運用）を「前提崩れ」なく進める土台を作る。
- WSTG：
  - 該当カテゴリ/テスト観点：WSTG-INFO（Information Gathering）に相当する“資産の帰属・境界”の確定として扱う
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：以降のテスト（AUTHN/AUTHZ/CONFIG）で「どこが対象範囲で、どこが第三者か」を明示するための前提
- PTES：
  - 該当フェーズ：Intelligence Gathering（組織/インフラ情報の収集）
  - 前後フェーズとの繋がり（1行）：対象の“責任境界”を言語化する作業として位置づけ、収集→分析→次の観測（ASN/BGP、PassiveDNS、CT）に繋げるための中間成果物
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance（組織情報・ドメイン/インフラ情報の収集）
  - 攻撃者の目的（この技術が支える意図）：防御側の診断として「境界がどこで増えているか」を説明可能にすること。Reconnaissance / Discovery として、攻め筋の確率を上げるための境界特定・依存推定。

## 参考（必要最小限）
- OWASP ASVS  
  https://github.com/OWASP/ASVS
- OWASP WSTG  
  https://owasp.org/www-project-web-security-testing-guide/
- PTES  
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Reconnaissance  
  https://attack.mitre.org/tactics/TA0043/
- MITRE ATT&CK：Discovery  
  https://attack.mitre.org/tactics/TA0007/

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
  - `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
- 関連 labs / cases：
  - `04_labs/01_local/01_attack-box_作業端末設計.md`

---

## 深掘りリンク（最大8）
- `01_topics/01_asm-osint/09_passive-dns_履歴と再利用（過去資産の掘り起こし）.md`
- `01_topics/01_asm-osint/10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）.md`
- `01_topics/01_asm-osint/11_cohosting_同居推定（共有IP_VHost_CDN収束）.md`
- `01_topics/01_asm-osint/12_waf-cdn_挙動観測（ブロック_チャレンジ_例外）.md`
- `01_topics/01_asm-osint/21_third-party_外部依存（タグ_分析SDK）洗い出し.md`
- `01_topics/01_asm-osint/24_subdomain_takeover_成立条件推定（DNS_CNAME_プロバイダ）.md`
- `02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

---
