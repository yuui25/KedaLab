# 05_cloud_露出面（CDN_WAF_Storage等）推定
Cloud 露出面（CDN/WAF/Storage等）推定
“信頼境界・到達性・優先度”を観測で確定し、次の検証の打ち手を確定する

## 目的（この技術で到達する状態）
- DNS/TLS/HTTP/JS の観測から、外部に露出している “クラウド構成要素” を **状態として** 説明できる。
  - 例：CDN終端、WAFの前段、オブジェクトストレージ配信、API Gateway、外部IdP、外部SaaS
- 露出面を「サービス名当てクイズ」で終えず、次を確定する。
  - 信頼境界：どこが第三者（外部依存）で、どこが自社運用の可能性が高いか
  - 到達性：どこまでが外部から届き、どこで遮断・変換されるか
  - 優先度：Webの `Config/AuthN/AuthZ/API`、SaaSの `共有/外部連携/監査`、NWの `到達性/認証` のどこへ寄せるべきか

## 前提（対象・範囲・想定）
- 対象：許可スコープ内のドメイン/サブドメイン/URL（能動的探索は最小に留める）
- 想定する環境：“クラウド”は単一ではなく、CDN/WAF/Storage/IdP/SaaS が組み合わさり、境界（信頼/権限）が増える
- できること/やらないこと（安全に検証する範囲）：断定よりも、観測根拠を積み上げて “最も確からしい状態” を作る
- 依存する前提知識（必要最小限）：DNS/TLS/HTTP/JS観測と突き合わせて境界を固める。
  - `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
  - `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`
  - `01_topics/01_asm-osint/04_js_フロント由来の攻撃面抽出.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：クラウド構成要素（CDN/WAF/Storage/API Gateway/外部IdP/SaaS）の露出面推定、信頼境界・到達性・優先度の特定
  - 扱わない（別ユニットへ接続）
    - DNS観測 → `01_dns_委譲・境界・解釈.md`
    - TLS観測 → `02_tls_証明書・CT・外部依存推定.md`
    - HTTP観測 → `03_http_観測（ヘッダ/挙動）と意味.md`
    - JS観測 → `04_js_フロント由来の攻撃面抽出.md`
    - Web深掘り → `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
    - SaaS深掘り → `01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（DNS/TLS/HTTP/JSで見ているもの）
  - DNSの観測（依存先と役割の推定）：CNAME/ALIAS の委譲先（CDN/WAF/Storage/ホスティングの兆候）、レコードの階層（サブドメイン分割＝運用分割の兆候）
  - TLS/証明書の観測（終端の外部依存と運用分割）：SANの傾向（どのドメイン群が同じ終端で扱われるか）、証明書の発行/更新の癖（自動更新、残骸、移行の兆候）
  - HTTPの観測（保護レイヤと到達性の推定）：レスポンスヘッダの特徴（キャッシュ・WAF・プロキシの兆候）、リダイレクト、エラー応答（403/429/5xx）と振る舞い差、キャッシュ挙動（HIT/MISS、年齢、vary）とオリジンの見え方
  - JS/フロント資産の観測（外部依存の具体化）：外部ドメイン（storage、api、webhook、analytics 等）、設定（環境差分、バケット名、配信先、regionの手掛かり等）
  - “露出面の型”として整理する（当てるのは最後）：CDN配信、WAF前段、Storage直配信、API Gateway/管理プレーン、外部IdP/SaaS連携
- 境界の観点
  - 資産境界：自社管理のDNSゾーンか、外部管理のDNSか。運用単位（証明書単位の分割は境界の手掛かり）
  - 信頼境界：委譲先＝第三者サービスを跨いでいる可能性。TLS終端がどこにあるか（CDN/WAF/ロードバランサ等の可能性）。CDN/WAFが“解釈・遮断”する地点になっているか。第三者（SaaS/Storage/解析）へデータが流れる可能性
  - 権限境界：共有・委任・トークンの扱いが発生しやすい地点
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）
  - どの型かで、次に深掘りすべき技術（Config/AuthN/AuthZ/API/SaaS）が変わる

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - 「どこに外部依存（信頼境界）があるか」
  - 「どこで遮断/変換が起きるか（到達性）」
  - 「どの構成要素が“攻撃面”として重要か（優先度）」
- 何が“推定”できるか（推定の根拠/前提）
  - ヘッダやCNAMEから、クラウドベンダや製品の可能性（ただし断定はしない）
- 何は“言えない”か（不足情報・観測限界）
  - ヘッダやCNAMEだけで、クラウドベンダや製品を断定すること
  - 露出＝脆弱、設定ミス確定、スコープ確定という断定
- よくある状態パターン（正常/異常/境界がズレている等）
  - パターンA：CDN配信（静的資産中心、キャッシュが効く、オリジンは隠蔽されがち）
  - パターンB：WAF前段（ブロック/チャレンジ/レート制御が見える）
  - パターンC：Storage直配信（オブジェクトURLや配信ドメインが露出）
  - パターンD：API Gateway/管理プレーン（APIの入口が統合され、認証/スロットリングが見える）
  - パターンE：外部IdP/SaaS連携（SSO/監査/共有/外部ゲスト等の境界が増える）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”
  - WAF前段が強い → 入口・権限・連携（AuthZ/API/SaaS）へ寄せる（WAF回避が目的ではない）
  - CDN配信が主 → JS/静的資産の差分観測で API面・設定面を掘る
  - Storage露出が濃い → 共有・外部公開・署名URL・権限設計の論点へ寄せる
  - API Gatewayっぽい → 認証方式/スコープ/レート制御/エラー設計を“境界”として掘る
  - 外部IdP/SaaS依存が濃い → 信頼境界（委任/共有/監査）を掘り、責任分界の論点を作る
- 優先度の付け方（時間制約がある場合の順序）
  - 露出面の整理は、次の意思決定に直結する
- 代表的な攻め筋（この観測から自然に繋がるもの）
  - 攻め筋1：WAF/保護レイヤの特定 → 代表リクエストで、拒否点（どこで拒否されるか）と差分（条件で変わるか）を取る
  - 攻め筋2：Storage/公開資産の特定 → 公開範囲（誰が読めるか）と、URLの性質（推測可能性/期限/署名）を状態で整理する
  - 攻め筋3：API Gateway/委任の特定 → 認証方式（cookie/bearer）と、スコープ/ロールの手掛かりを観測し、差分（主体A/B）で境界が効くか確認する
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）
  - 外部依存が多く、責任分界が重要（第三者跨ぎが支配点） → “誰が管理する構成要素か” を整理し、検証対象（自社設定/連携設定/運用）を切り分ける

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：WAF/保護レイヤが入口の支配点（到達性が手前で決まる）
  - 次の検証：
    - 代表リクエストで、拒否点（どこで拒否されるか）と差分（条件で変わるか）を取る
  - 期待する観測（成功/失敗時に何が見えるか）：
    - Webの入口・権限・連携（AuthZ/API/SaaS）の検証へ繋がる
- 仮説B：Storage/公開資産が攻撃面（共有・外部公開が鍵）
  - 次の検証：
    - 公開範囲（誰が読めるか）と、URLの性質（推測可能性/期限/署名）を状態で整理する
  - 期待する観測：
    - SaaSの共有・外部公開（SaaS/Config）の検証へ繋がる
- 仮説C：API Gateway/委任が鍵（スコープ・認証方式が支配点）
  - 次の検証：
    - 認証方式（cookie/bearer）と、スコープ/ロールの手掛かりを観測し、差分（主体A/B）で境界が効くか確認する
  - 期待する観測：
    - WebのAPI（権限伝播）とSaaS/IdP連携（信頼境界）の検証へ繋がる
- 仮説D：外部依存が多く、責任分界が重要（第三者跨ぎが支配点）
  - 次の検証：
    - “誰が管理する構成要素か” を整理し、検証対象（自社設定/連携設定/運用）を切り分ける
  - 期待する観測：
    - SaaSの共有・外部連携・監査ログの検証へ繋がる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`（HTTP観測）
    - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`（証跡）
- 取得する証跡（目的ベースで最小限）
  - DNS/TLS/HTTP/JS観測の結果を統合した露出面の整理
  - 代表リクエストでの拒否点と差分の記録
- 観測の取り方（どの視点で差分を見るか）
  - DNS/TLS/HTTP/JSの観測結果を突き合わせ、露出面の型を整理する
  - “代表点”で、挙動差（条件差）を観測して確度を上げる
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/cloud_05 2>/dev/null
    cd ~/keda_evidence/cloud_05
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象URLは **許可されたスコープ** のみ（契約範囲/社内許可範囲/自前検証環境）
      - 観測は **代表点の抽出** のみ（大量アクセス・負荷試験は前提にしない）
      - 観測視点（端末/経路/ネットワーク）を記録
  - 相関キー（最低限）を作る（後で必ず効く）
    - URL：対象URL（パス含む）
    - Type：露出面の型（CDN/WAF/Storage/API Gateway/外部IdP/SaaS）
    - TrustBoundary：信頼境界（自社/第三者）
    - Reachability：到達性（外部から届く/遮断・変換される）
    - Priority：優先度（Web Config/AuthN/AuthZ/API、SaaS共有/外部連携/監査、NW到達性/認証）
    - Timestamp：観測日時（JSTで秒まで）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は“手段”であり“結論”ではない。必ず「何を観測している例か」を添える。

~~~~
# 目的：クラウド名当てではなく、境界（信頼/到達性/権限）を決める
#
# 観測 → 状態 → 次の一手（例）
# - DNSの委譲先が外部っぽい → 信頼境界がある → 連携/設定（Config/SaaS）へ寄せる
# - HTTPでWAF的な拒否点が見える → 到達性が手前で決まる → 入口・権限（Web Recon/AuthZ/API）へ寄せる
# - JSにstorageや共有の匂い → 資産境界が外部へ → 共有・外部公開（SaaS/Config）へ寄せる
~~~~

- この例で観測していること：
  - クラウド構成要素（CDN/WAF/Storage/API Gateway/外部IdP/SaaS）の露出面推定、信頼境界・到達性・優先度の特定
- 出力のどこを見るか（注目点）：
  - DNSの委譲先（CNAME/ALIAS）から外部依存の可能性
  - HTTPのレスポンスヘッダから保護レイヤ（キャッシュ・WAF・プロキシ）の兆候
  - JSの外部ドメインから外部依存の具体化
- この例が使えないケース（前提が崩れるケース）：
  - ヘッダやCNAMEだけで、クラウドベンダや製品を断定しようとする（観測根拠を積み上げて“最も確からしい状態”を作る必要がある）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：外部依存（CDN/WAF/Storage等）の“信頼境界”と設定論点を特定し、Config/Secrets/Access Control の検証へ繋げる
  - 該当要件（可能ならID）：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：外部依存（CDN/SaaS/DNSホスティング）を把握できないと、責任分界の想定が崩れ、設定不備の見落としにつながる。クラウド構成要素の露出面を推定できないと、以降の検証で“対象外”や“前提違い”を起こし、検証精度が落ちる。
    - 満たす：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）を把握し、以降の検証（認証/認可/API/運用）を「前提崩れ」なく進める土台を作る。
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering と Configuration の前提として、外部依存・到達性・保護レイヤを観測根拠つきで整理する
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：WSTG各観点へ入る前の“入口確定”として接続
- PTES：
  - 該当フェーズ：Intelligence Gathering → Threat Modeling（境界）→ Vulnerability Analysis（優先度付け）に直結
  - 前後フェーズとの繋がり（1行）：露出面（外部依存・到達性）を整理し、境界（資産/信頼/権限）を確定し、優先度へ反映
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance（事前偵察）、Discovery（環境把握）
  - 攻撃者の目的（この技術が支える意図）：外部依存と到達性を把握し、攻め筋の確率を上げる（列挙より意思決定が主役）。Reconnaissance / Discovery として、攻め筋の確率を上げるための境界特定・依存推定。

## 参考（必要最小限）
- OWASP ASVS  
  https://github.com/OWASP/ASVS
- OWASP WSTG  
  https://owasp.org/www-project-web-security-testing-guide/
- PTES  
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Reconnaissance  
  https://attack.mitre.org/tactics/TA0043/
- MITRE ATT&CK：Discovery  
  https://attack.mitre.org/tactics/TA0007/

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`
- 関連 labs / cases：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`

---

## 深掘りリンク（最大8）
- `01_topics/01_asm-osint/12_waf-cdn_挙動観測（ブロック_チャレンジ_例外）.md`
- `01_topics/01_asm-osint/18_storage_discovery（S3_GCS_AzureBlob）境界推定.md`
- `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
- `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
- `01_topics/02_web/06_config_設定・運用境界（CORS/ヘッダ/Secrets）.md`
- `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- `01_topics/04_saas/02_saas_共有・外部連携・監査ログの勘所.md`
- `02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`

---
