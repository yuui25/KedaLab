# 12_waf-cdn_挙動観測（ブロック_チャレンジ_例外）
WAF/CDN 挙動観測（ブロック/チャレンジ/例外）
“成立点・例外パス・境界”を観測で確定し、次の深掘り（HTTP/TLS/Cloud/Web Recon）を迷わず選ぶ

## 目的（この技術で到達する状態）
- WAF/CDN/ボット対策を「ある/ない」で終わらせず、**成立点（どのリクエスト以降でブロック/チャレンジが成立したか）** と **例外パス（どの条件で素通りするか）** を観測で固定できる。
- 06_subdomain〜11_cohostingで作った入口群を、WAF/CDNの挙動差分でクラスタリングし、次の深掘り（HTTP/TLS/Cloud/Web Recon）を迷わず選べる。
- 「どこがアプリの問題で、どこが外周の問題か」を、**資産境界/信頼境界/権限境界** で説明できる（報告・責任分界に直結）。

## 前提（対象・範囲・想定）
- 対象：インターネットから到達可能なホスト/パス（代表点）に対するHTTP(S)応答の差分。代表ホスト：`/`、`/login`、`/api/*`、`/admin`、エラー系（存在しないパス）。代表手法：通常ブラウザ相当のGET、最小限のヘッダ差分（UA/Accept/Origin等）
- 想定する環境：
  - CDNとWAFは同一事業者・同一エッジで見えることが多く、**「CDNヘッダがある＝WAFが強い」ではない**。
  - 例外は “パス” だけでなく、Host/サブドメイン/メソッド/ヘッダ/クッキー/地域/レート で起きる。
- できること/やらないこと（安全に検証する範囲）：
  - できる：代表点のHTTP(S)応答の差分観測、成立点と例外パスの特定
  - やらない：負荷を上げる試験（大量リクエスト、総当たり、レート検証の過剰反復）はしない。本ユニットは「観測→解釈→次の一手」。回避ノウハウ（バイパス）を目的化しない。
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
  - `01_topics/01_asm-osint/11_cohosting_同居推定（共有IP_VHost_CDN収束）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：WAF/CDN/ボット対策の挙動観測、成立点と例外パスの特定、境界の説明
  - 扱わない（別ユニットへ接続）
    - HTTP観測 → `03_http_観測（ヘッダ/挙動）と意味.md`
    - サブドメイン列挙 → `06_subdomain_列挙（passive_active_辞書_優先度）.md`
    - 同居推定 → `11_cohosting_同居推定（共有IP_VHost_CDN収束）.md`
    - Web深掘り → `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（HTTP(S)で見ているもの）
  - まず “成立点” を固定する（どこからWAF/CDN挙動が変わるか）
    - 入口（トップ/ログイン/API/管理）で、同じ条件でも応答が変わることがある。
    - 成立点の例（観測で確定する）
      - 1リクエスト目から403/チャレンジ
      - ログイン後（Cookie付与後）にだけブロック
      - 特定パス（/api /admin）でのみブロック
      - 特定ヘッダ/メソッドでのみブロック
  - “応答の型” で分類する（判断を速くする）
    - 型A：通常応答（200/30xで通常コンテンツ）
    - 型B：明確なブロック（403/406/429 等、静的ブロックページ）
    - 型C：チャレンジ（JS計算/遅延/リダイレクト多段/人間判定）
    - 型D：アプリ側エラー（500等。外周ではなくアプリ起点の可能性）
    - 型E：到達不可（タイムアウト/接続拒否。NW境界や許可制御の可能性）
  - “ヘッダ差分” を最小セットで取る（運用境界の匂い）
    - CDN/エッジの匂い：キャッシュ関連（Age, Cache-Control, HIT/MISS系のシグナル）、エッジ識別子（リクエストID、PoP、経路ヘッダ）
    - WAF/ボット対策の匂い：ブロック時にのみ現れるヘッダ、ブロックページの一貫性、429/チャレンジ誘導（Set-CookieやJSを伴う等）
    - アプリ境界の匂い：302の遷移先（/login等）や、同一ホスト内での権限境界（ログイン必須）、同一パスでもHostにより挙動が異なる（11_cohostingと接続）
  - “例外パス” を探すのではなく “例外条件” を状態化する
    - 例外が起きやすい条件（観測で yes/no/unknown に落とす）
      - サブドメイン差（api. / admin. / stg. のみ弱い）
      - パス差（/health /status /swagger /graphql など）
      - メソッド差（GETは通るがPOSTで止まる等）
      - 認証状態差（未ログイン/ログイン後で挙動が変わる）
      - IP/地域差（観測地点が変わると型が変わる）
    - このファイルでやること：
      - 例外を“探し切る”のではなく、代表点で差分を取り「例外がありそう/なさそう」を決める。
- 境界の観点
  - 資産境界（管理主体・委託先・対象範囲の線引き）：どのホスト群が同一外周（同一CDN/WAF）に乗っているか（クラスター化）。外周が同一でも、アプリが同一とは限らない（次はHTTP/TLS/機能で分ける）
  - 信頼境界（外部連携・第三者・越境ポイント）：外周（CDN/WAF）が第三者運用なら、責任分界（誰が何を直すか）が変わる。例外条件が運用設計（除外ルール/許可IP/例外ホスト）に起因している可能性を示せる
  - 権限境界（権限の切替/伝播/委任）：ブロック/チャレンジが「重要操作/API」に集中している場合、権限境界保護としての意図がある。逆に重要操作が素通りで、一般ページだけ厳しい場合は“設計のズレ”の可能性を優先観測対象にする
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）
  - 成立点（どのリクエスト以降でブロック/チャレンジが成立したか）
  - 例外条件（どの条件で素通りするか）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - 外周の防御境界が「どの入口で」「どの型（A〜E）で」成立しているか
  - 入口群を、外周挙動でクラスター化できる（同一運用っぽい束）
  - 例外条件が“ありそう/なさそう”を、観測差分として提示できる
- 何が“推定”できるか（推定の根拠/前提）
  - そのベンダ/製品の可能性（ただし断定はしない。ヘッダ偽装・設定で揺れる）
- 何は“言えない”か（不足情報・観測限界）
  - そのベンダ/製品の断定（ヘッダ偽装・設定で揺れる）
  - 例外ルールの全容（観測は代表点のみ）
  - 外周が強い＝安全、外周が弱い＝脆弱、の断定
- よくある状態パターン（正常/異常/境界がズレている等）
  - パターンA：ほぼ全ホストが同一外周に収束し、差分が少ない
  - パターンB：ホスト/パスでブロック型が分かれ、例外条件がありそう
  - パターンC：外周がアプリエラー（型D）を隠しておらず、500等が見える

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”（診断としての意味）
  - `stg/dev/admin/api` など、機能境界が強い入口で外周が弱い/挙動が違う（設計差分の候補）
  - 重要操作だけ別クラスター（別外周・別運用）になっている（境界が増えている）
  - 429/チャレンジが特定条件でだけ出る（例外条件の存在が示唆される）
- 優先度の付け方（時間制約がある場合の順序）
  - 代表点のHTTP(S)応答の差分観測を行い、成立点と例外パスを特定する
- 代表的な攻め筋（この観測から自然に繋がるもの）
  - 攻め筋1：ほぼ全ホストが同一外周に収束し、差分が少ない → 外周は前提として置き、Web側の機能（認証/認可/API/入力境界）で優先度付けする
  - 攻め筋2：ホスト/パスでブロック型が分かれ、例外条件がありそう → 例外が出る境界（ホスト/パス）を固定し、02_webのreconへ渡す（境界モデル化）
  - 攻め筋3：外周がアプリエラー（型D）を隠しておらず、500等が見える → 入力境界（05_input）や設定境界（06_config）へ寄せ、最小差分で再現性を取る
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）
  - 型E（到達不可）や、NW境界っぽい挙動が見える → 08_asn_bgp の境界クラスターと突合し、どのネットワーク境界で到達性が切れているかを説明する

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：差分が少ない（同一外周に収束）
  - 次の検証：
    - 代表点だけを確定証跡として残し、入口の優先度を「機能（login/api/admin）」に寄せる
    - 03_http/02_tls/05_cloud で“同一に見える理由”を補強し、Web側の検証へ進む
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 外周の存在を前提化し、診断の主戦場をアプリ側へ移せる
- 仮説B：ホスト/パスで型B/Cが分かれ、例外条件が疑われる
  - 次の検証：
    - 例外が出る境界（host/path/method/auth状態）を固定し、02_web/01_web_00_recon の入口として採用する
    - 併せて 11_cohosting（同居）で “同一外周でも別運用” の可能性を再評価する
  - 期待する観測：
    - 「どこで境界が破れている可能性があるか」を証跡付きで提示できる
- 仮説C：型E（到達不可）や、NW境界っぽい挙動が見える
  - 次の検証：
    - 08_asn_bgp の境界クラスターと突合し、どのネットワーク境界で到達性が切れているかを説明する
    - NW側の入口（03_network/01_enum）へ接続し、到達性→サービス→認証の順に整理する
  - 期待する観測：
    - “外周の問題”と“NW到達性の問題”を混同せず、次の観測へ繋げられる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`（観測の入口：どこでヘッダ/応答を取るか）
    - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`（HAR/ログの最小証跡）
- 取得する証跡（目的ベースで最小限）
  - `wafcdn_matrix.csv`（代表点の観測表）
    - host, path, method, status, final_url, response_type(A〜E), key_headers(要約), observed_at
  - `wafcdn_clusters.md`
    - クラスターごとの特徴（ブロック型/チャレンジ型/通常型）、代表点、次に回す先（topics）
  - 可能なら `har`（ブラウザ相当）と `raw header`（curl相当）の両方を残す（同じ入口を別視点で再現できる）
  - 代表点×数件の raw header（curl相当）
  - 代表点×数件の HAR（ブラウザ相当：チャレンジがある場合に重要）
  - 観測条件メモ（UA/ログイン状態/実行日時/経路）
- 観測の取り方（どの視点で差分を見るか）
  - 代表点の“応答の型（A〜E）”と“成立点”を素早く揃え、クラスター化の材料を作る
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/wafcdn_12 2>/dev/null
    cd ~/keda_evidence/wafcdn_12
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象URLは **許可されたスコープ** のみ（契約範囲/社内許可範囲/自前検証環境）
      - 観測は **代表点の抽出** のみ（負荷を上げる試験は前提にしない）
      - 観測視点（端末/経路/ネットワーク）を記録
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host：対象ホスト
    - Path：対象パス
    - Method：HTTPメソッド（GET/POST等）
    - Status：HTTPステータスコード
    - ResponseType：応答の型（A:通常 / B:ブロック / C:チャレンジ / D:アプリエラー / E:到達不可）
    - KeyHeaders：主要ヘッダ（要約）
    - Exception：例外条件（サブドメイン差/パス差/メソッド差/認証状態差/IP/地域差）
    - Timestamp：観測日時（JSTで秒まで）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は“手段”であり“結論”ではない。必ず「何を観測している例か」を添える。

~~~~
# 目的：代表点の“応答の型（A〜E）”と“成立点”を素早く揃え、クラスター化の材料を作る

# 代表点（例）：トップ/ログイン/API/存在しないパス
curl -sk -D - -o /dev/null "https://example.com/" \
  | sed -n '1,40p'

curl -sk -D - -o /dev/null "https://example.com/login" \
  | sed -n '1,40p'

curl -sk -D - -o /dev/null "https://api.example.com/v1/health" \
  | sed -n '1,40p'

curl -sk -D - -o /dev/null "https://example.com/this-path-should-not-exist" \
  | sed -n '1,40p'

# 観測メモ（例）：
# - status / Location / Set-Cookie / 代表的なエッジ系ヘッダ（要約）を控え、型（A〜E）に分類する
~~~~

- この例で観測していること：
  - WAF/CDN/ボット対策の挙動観測、成立点と例外パスの特定、境界の説明
- 出力のどこを見るか（注目点）：
  - status：HTTPステータスコード（200/30x/403/406/429/500等）
  - Location：リダイレクト先（/login等）
  - Set-Cookie：セッション境界（属性含む）
  - 代表的なエッジ系ヘッダ：キャッシュ関連（Age, Cache-Control, HIT/MISS系のシグナル）、エッジ識別子（リクエストID、PoP、経路ヘッダ）、ブロック時にのみ現れるヘッダ、ブロックページの一貫性
- この例が使えないケース（前提が崩れるケース）：
  - チャレンジ（型C）がある場合、curlだけでは成立しない（ブラウザ+HARが必要）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V1（アーキテクチャ/信頼境界）として、アプリ手前に存在するCDN/WAF/ボット対策を「第三者境界/運用境界」として確定する。V14（運用/構成）として、例外パス（除外URL/許可IP/特定UA/特定Host）や、環境差分（stg/devのみ弱い等）を“状態”で示す
  - 該当要件（可能ならID）：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：アプリ手前に存在するCDN/WAF/ボット対策を「第三者境界/運用境界」として確定できないと、以降の検証で“対象外”や“前提違い”を起こし、検証精度が落ちる。例外パス（除外URL/許可IP/特定UA/特定Host）や、環境差分（stg/devのみ弱い等）を“状態”で示せないと、報告・責任分界に直結できない。
    - 満たす：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）を把握し、以降の検証（認証/認可/API/運用）を「前提崩れ」なく進める土台を作る。
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering（入口・挙動・境界の把握）として、レスポンス/ヘッダ/リダイレクト/チャレンジの差分から「どこで何がブロックされているか」を観測し、Web側の検証（Authn/Authz/Input/Config）へ接続する
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：WSTG各観点へ入る前の“入口確定”として接続
- PTES：
  - 該当フェーズ：Intelligence Gathering（外周の防御境界の把握）→ Vulnerability Analysis（例外パス/不整合の発見）へ繋げる。目的は回避手順ではなく、境界の確定と優先度付け。
  - 前後フェーズとの繋がり（1行）：WAF/CDN/ボット対策の挙動観測を行い、成立点と例外パスを特定し、次の深掘り（HTTP/TLS/Cloud/Web Recon）を迷わず選べる
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance（到達性/防御境界の把握）
  - 攻撃者の目的（この技術が支える意図）：攻撃者が“探索を調整する”のと同じ論理で、診断側は「どの入口を先に見るべきか」「どの経路で証跡を取るべきか」を決める。Reconnaissance / Discovery として、攻め筋の確率を上げるための境界特定・依存推定。

## 参考（必要最小限）
- OWASP ASVS  
  https://github.com/OWASP/ASVS
- OWASP WSTG  
  https://owasp.org/www-project-web-security-testing-guide/
- PTES  
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Reconnaissance  
  https://attack.mitre.org/tactics/TA0043/
- MITRE ATT&CK：Discovery  
  https://attack.mitre.org/tactics/TA0007/

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`
  - `01_topics/01_asm-osint/05_cloud_露出面（CDN_WAF_Storage等）推定.md`
- 関連 labs / cases：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`

---

## 深掘りリンク（最大8）
- `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
- `01_topics/01_asm-osint/11_cohosting_同居推定（共有IP_VHost_CDN収束）.md`
- `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
- `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
- `02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- `01_topics/02_web/05_input_入力境界（XSS_SQLi_XXE_Deserialization）.md`

---
