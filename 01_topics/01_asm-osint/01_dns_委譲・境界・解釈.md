# 01_dns_委譲・境界・解釈
DNS 委譲・境界・解釈
“ゾーン・権威・外部依存・視点差”を観測で確定し、ASM/OSINTの次の一手を自走で決める

## 目的（この技術で到達する状態）
- DNSのレコード取得を「情報が取れた/取れない」で終わらせず、**委譲・権威・外部依存・境界（資産/信頼）**を推定し、ASM/OSINTの次の一手（追加探索・優先度付け・検証方針）を自走で決められる。
- “見えているDNS”が **どの視点（どのリゾルバ/どの経路/どのゾーン）**の結果かを明確にし、誤った結論（対象外・誤委譲・見落とし）を避けられる。

## 前提（対象・範囲・想定）
- 対象：許可された範囲（自組織/契約スコープ/バグバウンティの許可範囲）に限定する。
- 想定する環境：クラウド/CDN/WAF/SaaS委託を含む現代構成（CNAME委譲・外部DNSホスティング・分割DNSが起き得る）。
- できること/やらないこと（安全に検証する範囲）：第三者への過剰な負荷や、未許可の能動的探索（大量問い合わせ・無差別列挙）は前提にしない。
- 依存する前提知識（必要最小限）：権威DNS/再帰リゾルバ/キャッシュ/委譲（NS）/SOAの概念。
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：DNSの委譲・権威・外部依存・境界（資産/信頼）の観測と解釈
  - 扱わない（別ユニットへ接続）
    - TLS/証明書の観測 → `02_tls_証明書・CT・外部依存推定.md`
    - HTTP観測 → `03_http_観測（ヘッダ/挙動）と意味.md`
    - サブドメイン列挙 → `06_subdomain_列挙（passive_active_辞書_優先度）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（DNSで見ているもの）
  - **ゾーン境界**：どこから先が別管理（別ゾーン）か
  - **権威（Authority）**：その名前に対して誰が最終回答するか（権威DNS）
  - **委譲（Delegation）**：親ゾーン→子ゾーンへ、NSで運用主体が切り替わるポイント
  - **外部依存（Outsourcing）**：CDN/SaaS/クラウドへのCNAME委譲、外部DNSホスティング
- 境界の観点
  - 資産境界：ドメイン配下でも、実体が外部サービスの場合「自社資産」と同一視できない
  - 信頼境界：DNS委譲・CNAME委譲は“信頼の越境点”になりやすい
  - 権限境界：DNS運用（レコード変更権限）とアプリ運用（デプロイ権限）は一致しないことがある
- 重要なレコード/状態（差分が意味を変える）
  - NS / SOA：ゾーンの管理境界と権威を示す
  - A/AAAA：実体（到達先）を示すが、CDN配下では“オリジン”を隠すことがある
  - CNAME：外部依存・委譲先の推定（CDN/SaaS/クラウドの痕跡）
  - TXT（SPF/DMARC等）：運用主体・外部委託・成熟度の推定につながる
  - CAA：証明書発行主体の制約（TLS運用の外部依存推定に接続）
  - 応答コード（NOERROR/NXDOMAIN/SERVFAIL/REFUSED）：存在・権威・ポリシー・障害の示唆
  - TTL：変動性/切替運用/一時的構成の示唆（キャッシュ前提の観測誤差にも影響）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - NS/SOAから、**ゾーンの権威**と**委譲境界**（どこまでが同一ゾーン運用か）
  - CNAMEから、**委譲先のドメイン（外部サービスの匂い）**
  - 応答コードから、**存在/非存在/到達不可/権威側拒否**などの状態
- 何が“推定”できるか（推定の根拠/前提）
  - CNAME先やNSのパターンから、CDN/SaaS/クラウド/外部DNSホスティングの可能性
  - TTL/応答差分から、切替中・分割DNS・地理/ネットワーク差の可能性
- 何は“言えない”か（不足情報・観測限界）
  - A/AAAAが見えても、それがオリジンかCDNエッジかはDNSだけで断定できない（HTTP/TLS側観測と併用が必要）
  - 自分のリゾルバから見えるDNSが、他ネットワーク（社内/海外/別ISP）でも同じとは限らない（split-horizon等）
- よくある状態パターン（正常/異常/境界がズレている等）
  - パターンA：親ゾーンのNSは自社だが、子ゾーンが外部NSに委譲 → 子ゾーンは別運用（信頼越境点）
  - パターンB：A/AAAAなしでCNAMEのみ → 実体は委譲先（外部依存の可能性が高い）
  - パターンC：SERVFAILやREFUSEDが混じる → 権威側の設定/到達性/ポリシーが絡む（観測視点を変える必要）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”
  - 子ゾーン委譲が多い：境界が多い＝管理の綻びが出やすい（ただし断定はしない）
  - CNAME委譲が多い：外部サービス設定の不整合（例：切替途中、残骸、権限分離）が起きやすい
  - TXTが多い：外部委託先が多い/運用が複雑（調査価値が高い）
- 優先度の付け方（時間制約がある場合の順序）
  - DNS観測で決めたいこと（攻撃者の意思決定）
    - 入口候補の棚卸し：どのサブドメイン/子ゾーンが“運用的に弱そうか”
    - 外部依存の特定：委託先/SaaS/CDNの比率が高いほど、境界・設定・責任分界のズレが起きやすい
    - 優先度付け：同じドメインでも「社内運用」「外部委譲」「古い遺物」など濃淡がある
- 代表的な攻め筋（この観測から自然に繋がるもの）
  - 攻め筋1：委譲境界の特定 → 子ゾーンの管理境界が別であることを確認し、深掘り対象を選定
  - 攻め筋2：外部依存の推定 → CNAME委譲先の性質（CDN/WAF/SaaS/ストレージ公開等）を推定し、次の検証（設定/認証/認可/API）へ繋げる
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）
  - CDN/WAF配下：DNSだけで実体を追わず、HTTP/TLSの挙動・証明書・ヘッダ等の観測に寄せる
  - 分割DNSの疑い：リゾルバを変え、`+trace`等で委譲経路を確認し、観測の前提を固める
  - 子ゾーン委譲：親ゾーンの調査と切り分けて扱い、対象境界（スコープ）も再確認する

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：子ゾーンが外部NSに委譲されており、運用主体（管理境界）が別である
  - 次の検証：
    - 子ゾーンのNS/SOAを権威に直接問い合わせ、委譲先と一貫性を確認する
    - その子ゾーンの主要ホストがCNAME委譲かA/AAAA直かを確認する
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 権威DNSに直接聞いた結果と、再帰リゾルバ経由の結果が一致する（または差分があるなら原因が推定できる）
- 仮説B：CNAME委譲先が外部サービスで、構成の残骸/切替途中/責任分界のズレが存在する
  - 次の検証：
    - HTTP/TLS側観測（別topic）で、委譲先サービス特有の応答/証明書/ヘッダを確認する
    - 対象範囲内で、同種の委譲パターンを横断して分布を見る（大量問い合わせではなく、代表点の抽出）
  - 期待する観測：
    - DNS委譲先の性質（CDN/WAF/SaaS/ストレージ公開等）が推定でき、次の検証（設定/認証/認可/API）へ繋がる
- 仮説C：観測しているDNSが視点依存（分割DNS/地理差/キャッシュ差）で、見えていない情報がある
  - 次の検証：
    - 参照リゾルバを変える（公共DNS/社内DNS/権威直）ことで差分を取得する
    - `+trace`で委譲経路を固定し、どの段階で差分が生じるかを特定する
  - 期待する観測：
    - “見えない”理由（ポリシー/到達性/経路/キャッシュ）が説明でき、誤結論を避けられる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/01_attack-box_作業端末設計.md`
    - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`（視点差分検証のため）
    - `04_labs/04_cloud/03_logging_クラウド監査ログの取り方.md`（クラウドDNS/IAM運用の理解に接続）
- 取得する証跡（目的ベースで最小限）
  - 代表ドメイン/代表サブドメインに対する問い合わせ結果（テキストログで十分）
  - 参照リゾルバ/権威直の差分メモ（“どの視点で見たか”を必ず残す）
- 観測の取り方（どの視点で差分を見るか）
  - 同一クエリを「再帰リゾルバ」「権威直」「+trace」で比較し、差分の発生点を特定する
  - NS/SOA/CNAMEの組み合わせから、境界（委譲/外部依存）を図示できる状態にする
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/dns_01 2>/dev/null
    cd ~/keda_evidence/dns_01
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象ドメインは **許可されたスコープ** のみ（契約範囲/社内許可範囲/自前検証環境）
      - 問い合わせは **代表点の抽出** のみ（大量問い合わせ・無差別列挙は前提にしない）
      - 参照リゾルバの種類（公共DNS/社内DNS/権威直）を記録
  - 相関キー（最低限）を作る（後で必ず効く）
    - Domain：対象ドメイン/サブドメイン
    - Resolver：参照リゾルバ（8.8.8.8 / 1.1.1.1 / 社内DNS / 権威直）
    - QueryType：NS / SOA / A / AAAA / CNAME / TXT / CAA
    - ResponseCode：NOERROR / NXDOMAIN / SERVFAIL / REFUSED
    - Authority：権威DNSサーバ（NSレコード）
    - TTL：キャッシュ時間
    - Timestamp：観測日時（JSTで秒まで）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は“手段”であり“結論”ではない。必ず「何を観測している例か」を添える。

~~~~
# ゾーン境界の入口：NS/SOAを確認（どこが権威か、誰が管理しているか）
dig NS example.com
dig SOA example.com

# 委譲経路を固定して確認（どの段階の回答かを明確にする）
dig +trace www.example.com

# 特定の権威DNSへ直接問い合わせ（再帰リゾルバの視点差を避ける）
dig @ns1.example-dns.net A www.example.com
dig @ns1.example-dns.net CNAME www.example.com

# 外部依存の匂い：CNAME/CAA/TXT を確認（委託先や運用の痕跡）
dig CNAME app.example.com
dig CAA example.com
dig TXT example.com
~~~~

- この例で観測していること：
  - NS/SOA：ゾーン境界と権威、委譲の存在
  - +trace：委譲経路と“どこで回答が変わったか”
  - 権威直：キャッシュ/ポリシー差を減らし、権威側の状態を確認
  - CNAME/CAA/TXT：外部依存・運用主体・制約の推定材料
- 出力のどこを見るか（注目点）：
  - AUTHORITY/ADDITIONALの扱い（委譲とグルー情報の関係）
  - NSの分布（同一組織/外部ホスティングの匂い）
  - CNAMEの連鎖（最終的にどこへ委譲されているか）
  - 応答コード（REFUSED/SERVFAIL等）と、その再現条件（視点依存の可能性）
- この例が使えないケース（前提が崩れるケース）：
  - DNSポリシーで外部からの問い合わせが制限されている
  - split-horizon（社内外で回答が異なる）で、外部からは見えない情報がある
  - CDN/WAF配下でDNSだけでは実体が判断できず、HTTP/TLS観測が必要

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：セキュリティアーキテクチャ/設定管理/通信・外部依存の管理（DNSは“設定と境界”の土台）
  - 該当要件（可能ならID）：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：外部依存（CDN/SaaS/DNSホスティング）を把握できないと、責任分界の想定が崩れ、設定不備の見落としにつながる。DNS委譲・CNAME委譲は“信頼の越境点”になりやすく、境界を誤ると以降の検証で“対象外”や“前提違い”を起こし、検証精度が落ちる。
    - 満たす：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）を把握し、以降の検証（認証/認可/API/運用）を「前提崩れ」なく進める土台を作る。
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering（情報収集）として、対象の外形・入口・依存関係・ドメイン/サブドメインの把握を支える。以降の各カテゴリ（Auth/Access Control/API/Config等）へ“入口と仮説”を供給する。
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：DNS観測はWebテストの前提（入口の棚卸し/環境差の把握/外部依存推定）として接続する。
- PTES：
  - 該当フェーズ：Intelligence Gathering（情報収集）、Threat Modeling（脅威モデリングへの入力）
  - 前後フェーズとの繋がり（1行）：DNSで境界と依存を固めることで、Vulnerability Analysisの対象優先度（どこから深掘りするか）を合理化できる。
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance（事前偵察）、Discovery（環境把握）
  - 攻撃者の目的（この技術が支える意図）：対象の外形・依存・境界を把握し、最小コストで“攻め筋の確率”を上げる。Reconnaissance / Discovery として、攻め筋の確率を上げるための境界特定・依存推定。

## 参考（必要最小限）
- OWASP ASVS  
  https://github.com/OWASP/ASVS
- OWASP WSTG  
  https://owasp.org/www-project-web-security-testing-guide/
- PTES  
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Reconnaissance  
  https://attack.mitre.org/tactics/TA0043/
- MITRE ATT&CK：Discovery  
  https://attack.mitre.org/tactics/TA0007/
- RFC 1035（DNSの仕様）  
  https://datatracker.ietf.org/doc/html/rfc1035

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`
- 関連 labs / cases：
  - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`

---

## 深掘りリンク（最大8）
- `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- `01_topics/01_asm-osint/24_subdomain_takeover_成立条件推定（DNS_CNAME_プロバイダ）.md`
- `01_topics/01_asm-osint/25_dnssec_観測と意味（委譲_検証_誤設定）.md`
- `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
- `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
- `02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- `04_labs/01_local/01_attack-box_作業端末設計.md`
- `04_labs/04_cloud/03_logging_クラウド監査ログの取り方.md`

---
