# 04_js_フロント由来の攻撃面抽出
JS フロント由来の攻撃面抽出
“入口・境界・外部依存・権限の手掛かり”を観測で確定し、次の検証の打ち手を確定する

## 目的（この技術で到達する状態）
- JS（フロント資産）から、次を **観測根拠つきで** 作れる状態になる。
  - 入口（攻撃面）：APIエンドポイント、機能単位、管理系導線、外部連携（SaaS/解析/通知/Storage等）
  - 境界：資産境界（自社/第三者）、信頼境界（外部依存）、権限境界（ロール/テナント/管理系の手掛かり）
  - 優先度：AuthN/AuthZ/API/Input/Config のどこに寄せるべきか（仮説A/Bで分岐）
- “JSを眺めた”で終えず、**次の検証の打ち手（何を見て、何を試すか）** を確定する。

## 前提（対象・範囲・想定）
- 対象：許可されたスコープのWebアプリで配布されるJS/CSS/画像等の静的資産（CDN配信含む）
- 想定する環境：UIが薄くても、JSには API面・機能面・依存面が残る。環境差分（prod/stg/dev）や残骸（移行前のAPI/旧ドメイン）が見えることがある。
- できること/やらないこと（安全に検証する範囲）：断定はしない。**「根拠→状態→次の一手」** として扱う。
- 依存する前提知識（必要最小限）：HTTP観測、DNS/TLS観測と突き合わせて境界を固める。
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`
  - `01_topics/01_asm-osint/01_dns_委譲・境界・解釈.md`
  - `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：JS（フロント資産）からの攻撃面抽出、入口（API/機能/管理）の特定、境界（資産/信頼/権限）の手掛かり
  - 扱わない（別ユニットへ接続）
    - HTTP観測 → `03_http_観測（ヘッダ/挙動）と意味.md`
    - API深掘り → `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
    - 認可深掘り → `01_topics/02_web/03_authz_認可（IDOR/BOLA/BFLA）境界モデル化.md`
    - IdP連携 → `01_topics/04_saas/01_idp_連携（SAML/OIDC/OAuth）と信頼境界.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（JSで見ているもの）
  - 資産境界（自社JS / 第三者JS）：自社配布のbundle（app.*.js 等）と第三者スクリプト（分析/広告/チャット等）の切り分け
  - 入口（攻撃面：API/機能/管理）：APIベースURL（https://api.example / /api / graphql 等）、機能を示す識別子（feature flags、route、画面名、権限名）、管理/運用っぽい導線（admin, internal, console, debug 等の手掛かり）
  - 信頼境界（外部依存：SaaS/Storage/CDN/IdP）：外部ドメイン（analytics, cdn, storage, webhook, error-reporting）、IdP/SSO連携の痕跡（issuer、client_id、redirect_uri のような構成要素の手掛かり）
  - 権限境界（ロール/テナント/共有/委任の手掛かり）：role、permission、scope、tenant、org、project、owner、share の語彙、管理系UIの分岐や、権限チェックの痕跡（例：403表示の条件、権限名）
  - “秘密の兆候” と “実行境界の兆候”：APIキー/トークンっぽい文字列、設定JSON、環境変数名、署名/暗号の手掛かり、テンプレ/式評価/デシリアライズ/動的import等、実行境界の匂い
- 境界の観点
  - 資産境界：自社資産は設定/実装/認可の論点が乗る可能性が高い。第三者資産は信頼境界（外部依存）として、設定・連携・データ流出の論点に繋がる
  - 信頼境界：外部依存が強いほど、設定・連携・権限伝播（委任）の論点が増える
  - 権限境界：入口は “何を守るか（資産）” と “どこで権限が切り替わるか（権限境界）” を決める。認可モデル（AuthZ）を作るための「境界変数」の候補
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）
  - 秘密情報：Config/Secrets（運用境界）
  - 実行境界：Input→Execution（入力がどこで解釈・実行され得るか）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - 「このアプリは API中心か／画面中心か」
  - 「外部依存（信頼境界）がどこにあるか」
  - 「権限境界の変数候補（tenant/role/scope/owner）が何か」
  - 「環境差分/残骸の兆候があるか（優先度が上がる“理由”になる）」
- 何が“推定”できるか（推定の根拠/前提）
  - JSに出たURLがAPIエンドポイントの可能性（ただし到達可能・スコープ内・脆弱という断定はしない）
  - 文字列が“本物の秘密”の可能性（兆候として扱い、次工程で観測確認する）
- 何は“言えない”か（不足情報・観測限界）
  - JSに出たURLが必ず到達可能・スコープ内・脆弱という断定
  - 文字列が“本物の秘密”だという断定（兆候として扱い、次工程で観測確認する）
- よくある状態パターン（正常/異常/境界がズレている等）
  - パターンA：API面が厚い → API（権限伝播）を最優先に深掘り
  - パターンB：role/tenant/scope が濃い → AuthZ（境界モデル）を最優先に深掘り
  - パターンC：IdP/redirect/client の痕跡が濃い → SaaS/IdP連携（信頼境界）に寄せる

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”
  - API面が厚い → `API（権限伝播）` を最優先に深掘り
  - role/tenant/scope が濃い → `AuthZ（境界モデル）` を最優先に深掘り
  - IdP/redirect/client の痕跡が濃い → `SaaS/IdP連携（信頼境界）` に寄せる
  - 外部Storage/共有の痕跡が濃い → `SaaS共有・外部連携` と `Config` に寄せる
  - 実行境界の兆候（テンプレ/式/動的評価）がある → `Input→実行境界` の仮説を立てる
- 優先度の付け方（時間制約がある場合の順序）
  - 目的は「列挙」ではなく「勝負所（境界が動く地点）」の特定
- 代表的な攻め筋（この観測から自然に繋がるもの）
  - 攻め筋1：API中心の特定 → 主要API 1〜3本を選び、主体差（ユーザーA/B）と所有差（自分/他人）で差分を取る
  - 攻め筋2：AuthZ中心の特定 → “境界変数” を1つだけ変えたときの拒否点（403/404/差分）を確認する
  - 攻め筋3：IdP/委任中心の特定 → 認証フローの遷移（リダイレクト連鎖）と、セッション材料（cookie/token）の所在を固める
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）
  - 外部依存中心（CDN/WAF/Storage/外部APIが多い） → “どこが第三者か” を状態で確定し、責任分界と設定論点に落とす

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：API中心（UIは薄く、権限はAPIで決まる）
  - 次の検証：
    - 主要API 1〜3本を選び、主体差（ユーザーA/B）と所有差（自分/他人）で差分を取る
  - 期待する観測（成功/失敗時に何が見えるか）：
    - API（権限伝播）の検証へ繋がる
- 仮説B：AuthZ中心（role/tenant/owner の手掛かりが濃い）
  - 次の検証：
    - “境界変数” を1つだけ変えたときの拒否点（403/404/差分）を確認する
  - 期待する観測：
    - AuthZ（境界モデル）の検証へ繋がる
- 仮説C：IdP/委任中心（issuer/client/redirect/scope の兆候）
  - 次の検証：
    - 認証フローの遷移（リダイレクト連鎖）と、セッション材料（cookie/token）の所在を固める
  - 期待する観測：
    - SaaS/IdP連携（信頼境界）の検証へ繋がる
- 仮説D：外部依存中心（CDN/WAF/Storage/外部APIが多い）
  - 次の検証：
    - “どこが第三者か” を状態で確定し、責任分界と設定論点に落とす
  - 期待する観測：
    - Cloud露出面/Configの検証へ繋がる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`（取得点の統一）
    - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`（証跡の最小セット）
- 取得する証跡（目的ベースで最小限）
  - JS/CSS/画像等の静的資産（CDN配信含む）の取得
  - 抽出したAPIエンドポイント、機能単位、管理系導線、外部連携のリスト
- 観測の取り方（どの視点で差分を見るか）
  - 自社配布のbundleと第三者スクリプトの切り分け
  - 環境差分（prod/stg/dev）や残骸（移行前のAPI/旧ドメイン）の確認
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/js_04 2>/dev/null
    cd ~/keda_evidence/js_04
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象URLは **許可されたスコープ** のみ（契約範囲/社内許可範囲/自前検証環境）
      - 観測は **代表点の抽出** のみ（大量アクセス・負荷試験は前提にしない）
      - 観測視点（端末/経路/ネットワーク）を記録
  - 相関キー（最低限）を作る（後で必ず効く）
    - URL：対象URL（パス含む）
    - AssetType：JS/CSS/画像等の種類
    - Source：自社/第三者の切り分け
    - Endpoints：抽出したAPIエンドポイント
    - Boundaries：境界変数候補（role/tenant/scope/owner等）
    - ExternalDeps：外部依存（第三者ドメイン）
    - Timestamp：観測日時（JSTで秒まで）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は“手段”であり“結論”ではない。必ず「何を観測している例か」を添える。

~~~~
# 目的：ツール操作ではなく「何を抽出し、どう解釈し、次に何をするか」を固定する
#
# 抽出したいもの（例）
# - APIのベースURL / パス（/api, /graphql 等）
# - role/tenant/scope/owner 等の境界変数の手掛かり
# - 外部依存（第三者ドメイン）
# - 環境差分（prod/stg/dev）や旧ドメインの残骸
#
# 解釈（状態）
# - API中心 → APIプレイブックへ
# - 境界変数が濃い → AuthZモデル化へ
# - IdP/委任が濃い → SaaS/IdPへ
# - 外部依存が濃い → Cloud露出面/Configへ
~~~~

- この例で観測していること：
  - JS（フロント資産）からの攻撃面抽出、入口（API/機能/管理）の特定、境界（資産/信頼/権限）の手掛かり
- 出力のどこを見るか（注目点）：
  - APIのベースURL / パス（/api, /graphql 等）
  - role/tenant/scope/owner 等の境界変数の手掛かり
  - 外部依存（第三者ドメイン）
  - 環境差分（prod/stg/dev）や旧ドメインの残骸
- この例が使えないケース（前提が崩れるケース）：
  - JSが難読化/圧縮されていて、直接読めない場合（ツールを使う必要があるが、目的は同じ）
  - 動的に生成されるJSの場合（実行時の観測が必要）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：フロント資産に現れる「外部依存」「設定」「秘密情報」「認可境界の手掛かり」を根拠付きで特定し、AuthN/AuthZ/API/Configの検証へ繋げる
  - 該当要件（可能ならID）：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：外部依存（CDN/SaaS/DNSホスティング）を把握できないと、責任分界の想定が崩れ、設定不備の見落としにつながる。JSから攻撃面を抽出できないと、以降の検証で“対象外”や“前提違い”を起こし、検証精度が落ちる。
    - 満たす：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）を把握し、以降の検証（認証/認可/API/運用）を「前提崩れ」なく進める土台を作る。
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering を起点に、API/Authorization/Session/Configuration へ “入口と仮説” を供給する
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：WSTG各観点へ入る前の“入口確定”として接続
- PTES：
  - 該当フェーズ：Intelligence Gathering（外形・依存・入口）→ Threat Modeling（境界）→ Vulnerability Analysis（優先度付け）へ直結
  - 前後フェーズとの繋がり（1行）：JSから機能/API面と依存を復元し、境界（資産/信頼/権限）を整理し、優先度へ反映
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance（事前偵察）、Discovery（環境把握）
  - 攻撃者の目的（この技術が支える意図）：公開資産から機能/API面を復元し、攻め筋の確率を上げる（列挙より意思決定が主役）。Reconnaissance / Discovery として、攻め筋の確率を上げるための境界特定・依存推定。

## 参考（必要最小限）
- OWASP ASVS  
  https://github.com/OWASP/ASVS
- OWASP WSTG  
  https://owasp.org/www-project-web-security-testing-guide/
- PTES  
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Reconnaissance  
  https://attack.mitre.org/tactics/TA0043/
- MITRE ATT&CK：Discovery  
  https://attack.mitre.org/tactics/TA0007/

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`
  - `01_topics/01_asm-osint/05_cloud_露出面（CDN_WAF_Storage等）推定.md`
- 関連 labs / cases：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`

---

## 深掘りリンク（最大8）
- `01_topics/02_web/03_authz_認可（IDOR/BOLA/BFLA）境界モデル化.md`
- `01_topics/02_web/04_api_権限伝播・入力・バックエンド連携.md`
- `01_topics/02_web/06_config_設定・運用境界（CORS/ヘッダ/Secrets）.md`
- `01_topics/04_saas/01_idp_連携（SAML/OIDC/OAuth）と信頼境界.md`
- `02_playbooks/04_authz_境界モデル→検証観点チェック.md`
- `02_playbooks/05_api_権限伝播→検証観点チェック.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃/検知の両面）.md`

---
