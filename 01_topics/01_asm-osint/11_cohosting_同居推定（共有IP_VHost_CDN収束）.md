# 11_cohosting_同居推定（共有IP_VHost_CDN収束）
Cohosting 同居推定（共有IP/VHost/CDN収束）
“資産境界・信頼境界・優先度”を観測で確定し、次の深掘りを効率化する

## 目的（この技術で到達する状態）
- 「同一IPに見える」状態を、**CDN/WAF収束、共有ホスティング、VHost（Hostヘッダ）** のどれで起きているか切り分け、資産境界を誤らない。
- “同居の可能性”を **強/中/弱**（根拠の束）で状態化し、無駄に深掘りしないための優先度（代表点）を決められる。
- 08_asn_bgp（ネットワーク境界）・10_ctlog（SAN/Issuer）・03_http（挙動）と結合し、同居の裏にある **運用主体の違い**（第三者境界）を説明できる。

## 前提（対象・範囲・想定）
- 対象：06_subdomain で得た FQDN→IP（A/AAAA/CNAME）、08_asn_bgp のクラスター（CDN/クラウド/自社ASっぽさ）、10_ctlog のSAN候補（同じ証明書/同じIssuerの束）
- 想定する環境：
  - CDN/WAF配下で多数のFQDNが同一IPへ収束する（= 同一アプリとは限らない）
  - 共有ホスティングで多数のドメインが同一IPに同居する（= 対象外が混ざる可能性が高い）
  - 1つのFQDNが複数IPへ分散（Anycast/地域/冗長）し、観測地点により“同居/非同居”の見え方が変わる
- できること/やらないこと（安全に検証する範囲）：
  - できる：観測（DNS/TLS/HTTP）の最小差分で「同居っぽさ」を束ねる
  - やらない：同居推定を根拠に対象範囲を拡大する（許可境界は別管理）
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
  - `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
  - `01_topics/01_asm-osint/10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）.md`
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ・挙動）と意味.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：同居推定（CDN/WAF収束、共有ホスティング、VHost）、資産境界・信頼境界の特定、優先度付け
  - 扱わない（別ユニットへ接続）
    - DNS観測 → `01_dns_委譲・境界・解釈.md`
    - HTTP観測 → `03_http_観測（ヘッダ/挙動）と意味.md`
    - サブドメイン列挙 → `06_subdomain_列挙（passive_active_辞書_優先度）.md`
    - ASN/BGP → `08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
    - CTログ → `10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（DNS/TLS/HTTPで見ているもの）
  - 同居を3種類に分ける（最初に分類して迷いを減らす）
    - タイプA：CDN/WAF収束（同一CDNのAnycast/エッジで同一IPに見える）
    - タイプB：共有ホスティング収束（同一IPに多数の独立ドメインが同居）
    - タイプC：VHost（Hostヘッダ）収束（同一IP上でHostにより別サイトを返す）
  - “束”で判断する（単一シグナルで断定しない）
    - DNS束：CNAME先が同一（= 同一運用基盤の可能性）、A/AAAAの収束（= 入口の外形）
    - TLS束：実配信証明書のIssuer/中間CAが同一、SANに複数FQDNが同居している（10_ctlogと結合）
    - HTTP束：レスポンスヘッダ（Server/Via/CDN系）やリダイレクト先が同一、エラー挙動（WAFブロック/チャレンジ/404テンプレ）が同一
    - ネットワーク束：Origin AS/プレフィックスが同一（08_asn_bgp）、ただしクラウド/巨大ASでは“同一だから同居”とはしない（ノイズが大きい）
- 境界の観点
  - 資産境界（管理主体・委託先・対象範囲の線引き）：同居クラスターを作り「代表点だけ深掘りする」か「差分が出る点を優先する」か決める
  - 信頼境界（外部連携・第三者・越境ポイント）：同居が第三者基盤（CDN/ホスティング）で起きている場合、責任分界（誰が直すべきか）を説明できる材料になる
  - 権限境界（権限の切替/伝播/委任）：同居の中に `admin/id/api/dev/stg` が含まれる場合、Web側の検証（認証/認可/設定）優先度が上がる。逆に、同居していても“重要機能がない”なら代表点確認で止める判断ができる
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）
  - 結論は断定ではなく「タイプA/B/Cの可能性（強/中/弱）」でよい。

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - 多数のFQDNが「同一運用基盤に収束していそう」か「共有ホスティングとして雑多に同居していそう」かを区別できる
  - 以降の深掘りを、代表点・差分点に絞れる（効率化）
  - 第三者境界（CDN/WAF/ホスティング）を“証跡つき”で説明できる
- 何が“推定”できるか（推定の根拠/前提）
  - 同居クラスターを作り「代表点だけ深掘りする」か「差分が出る点を優先する」か決める
- 何は“言えない”か（不足情報・観測限界）
  - 同居＝同一組織/同一資産の断定（対象外が混ざる可能性がある）
  - 同居の内部構成（どのVHostが何を返すかの全量把握）
- よくある状態パターン（正常/異常/境界がズレている等）
  - パターンA：CDN/WAF収束（タイプA）が強い
  - パターンB：共有ホスティング同居（タイプB）が濃い
  - パターンC：VHost同居（タイプC）が濃い（Hostで明確に挙動が変わる）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”（診断の優先度付けとして使う）
  - 同居クラスター内に `admin/id/auth/api/dev/stg/old` が含まれる
  - 同居の束が揺れている（Issuer/挙動が混在）＝境界が多い＝設定差分が出やすい
  - 重要ホストだけ別クラスター（= 分離境界の存在）
- 優先度の付け方（時間制約がある場合の順序）
  - 同居クラスターを作り「代表点だけ深掘りする」か「差分が出る点を優先する」か決める
- 代表的な攻め筋（この観測から自然に繋がるもの）
  - 攻め筋1：CDN収束が強く、IP同居は“入口の外形”に過ぎない → HTTP/TLS差分でクラスターを細分化し、Web側は機能（認証/認可/API）で優先度付け
  - 攻め筋2：共有ホスティング同居が濃く、対象外が混ざる → スコープを壊さないよう、FQDN起点でのみ追う（IP起点で広げない）
  - 攻め筋3：VHost同居が濃く、Hostによる挙動差が明確 → 代表点で 02_web/01_web_00_recon へ渡し、入口・境界・検証方針を固める
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）
  - CDN/WAF収束が強い → 入口・権限・連携（AuthZ/API/SaaS）へ寄せる（WAF回避が目的ではない）

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：CDN/WAF収束（タイプA）が強い
  - 次の検証：
    - 代表FQDNを少数選び、TLS（Issuer/SAN）とHTTP（ヘッダ/リダイレクト/エラー）で差分が出るか確認
    - 差分が出ないなら、同居クラスターを“まとめ枠”として扱い、Web側の機能優先へ移る
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 「CDN収束で同居に見えるだけ」を証跡つきで説明でき、無駄な深掘りを止められる
- 仮説B：共有ホスティング同居（タイプB）が濃い
  - 次の検証：
    - 同居IPを起点に範囲を増やさず、06_subdomain/10_ctlog由来のFQDNだけを対象に扱う
    - 07_whois_rdap で組織境界（owner/operator）を補強し、対象外混入を早期に疑う
  - 期待する観測：
    - “対象外が混ざる”前提で、スコープ逸脱を避けた運用に切り替えられる
- 仮説C：VHost同居（タイプC）が濃い（Hostで明確に挙動が変わる）
  - 次の検証：
    - `admin/id/api` 等の重要ホストを優先し、02_web/01_web_00_recon で入口・境界・検証方針を確定する
    - 重要ホストが見当たらないなら代表点のみ確認し、優先度を下げる
  - 期待する観測：
    - 同居の“差分がある場所”に時間を寄せられる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/01_attack-box_作業端末設計.md`（結果の保存・差分管理）
    - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`（代表点のHTTP/TLS証跡）
- 取得する証跡（目的ベースで最小限）
  - `cohost_clusters.csv`：
    - cluster_id, fqdn, ip, cname, origin_as, tls_issuer, http_fingerprint（短い要約）
  - `cohost_notes.md`：
    - クラスターごとの判定（タイプA/B/C）、強/中/弱、代表点、次に見るファイル（02_web/01_web_00_recon 等）
  - FQDN→IP/CNAME（DNS）
  - 代表点のTLS（Issuer/SAN）
  - 代表点のHTTP（ヘッダ/最終URL/エラーパターン）
- 観測の取り方（どの視点で差分を見るか）
  - 「同居の束」を作るため、全量ではなく“代表点×少数”で差分を取る（深掘り前提の絞り込み）
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/cohosting_11 2>/dev/null
    cd ~/keda_evidence/cohosting_11
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象FQDNは **許可されたスコープ** のみ（契約範囲/社内許可範囲/自前検証環境）
      - 観測は **代表点の抽出** のみ（同居推定を根拠に対象範囲を拡大しない）
      - 観測視点（端末/経路/ネットワーク）を記録
  - 相関キー（最低限）を作る（後で必ず効く）
    - FQDN：対象FQDN
    - IP：解決されたIPアドレス（A/AAAA）
    - CNAME：CNAME先（同一運用基盤の可能性）
    - OriginAS：Origin AS（08_asn_bgp）
    - TLSIssuer：実配信証明書のIssuer/中間CA
    - HTTPFingerprint：レスポンスヘッダ（Server/Via/CDN系）やリダイレクト先、エラー挙動
    - Type：同居のタイプ（A:CDN/WAF収束 / B:共有ホスティング / C:VHost）
    - Confidence：同居の可能性（強/中/弱）
    - Timestamp：観測日時（JSTで秒まで）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は“手段”であり“結論”ではない。必ず「何を観測している例か」を添える。

~~~~
# 目的：同一IPに収束するFQDN群をまとめ、代表点で“束（DNS/TLS/HTTP）”を取る

# (1) FQDN→IPを集める（既にresolved.txt等がある前提でもよい）
dnsx -l candidates.txt -a -aaaa -cname -silent > resolved.txt

# (2) 代表点のHTTP指紋（ステータス/最終URL/主要ヘッダ）を取る
httpx -l resolved.txt -silent -status-code -follow-redirects -final-url -title > http_fingerprint.txt

# (3) 代表点のTLS（Issuer/SAN）を取る（“同じ証明書運用か”の材料）
# ※対象ホストを少数に絞って実行する（全量で回さない）
echo | openssl s_client -connect login.example.com:443 -servername login.example.com 2>/dev/null \
  | openssl x509 -noout -issuer -dates -ext subjectAltName
~~~~

- この例で観測していること：
  - “同一IP”という見かけの一致を、DNS/TLS/HTTPの束で補強または否定する
- 出力のどこを見るか（注目点）：
  - resolved：CNAME先（同一運用基盤の可能性）、A/AAAAの収束（= 入口の外形）
  - http_fingerprint：レスポンスヘッダ（Server/Via/CDN系）やリダイレクト先、エラー挙動（WAFブロック/チャレンジ/404テンプレ）が同一
  - openssl出力：実配信証明書のIssuer/中間CAが同一、SANに複数FQDNが同居している
- この例が使えないケース（前提が崩れるケース）：
  - 1つのFQDNが複数IPへ分散（Anycast/地域/冗長）し、観測地点により“同居/非同居”の見え方が変わる（unknownとして観測点を増やす）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V1（アーキテクチャ/信頼境界）・V14（運用/構成）を評価する前提として、同一IP/CDN収束の背後にある「同一アプリ/別アプリ」「同一運用主体/別主体」を境界として固定する
  - 該当要件（可能ならID）：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：同一IP/CDN収束の背後にある「同一アプリ/別アプリ」「同一運用主体/別主体」を境界として確定できないと、以降の検証で“対象外”や“前提違い”を起こし、検証精度が落ちる。
    - 満たす：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）を把握し、以降の検証（認証/認可/API/運用）を「前提崩れ」なく進める土台を作る。
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering の一部。サブドメイン列挙（06）で得た入口を、同居（共有）という“運用実態”で束ね、Web側の入口（重要機能/認証/管理）へ優先度付きで渡す
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：WSTG各観点へ入る前の“入口確定”として接続
- PTES：
  - 該当フェーズ：Intelligence Gathering（公開インフラ構造の把握）→ Vulnerability Analysis（境界のズレ/例外パス）へ繋げる。目的は「関連性の断定」ではなく、次の観測の効率化。
  - 前後フェーズとの繋がり（1行）：同居推定を行い、資産境界・信頼境界を特定し、次の深掘りを効率化する
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance（公開インフラ情報の収集）
  - 攻撃者の目的（この技術が支える意図）：攻撃者が“探索面を広げる”のと同じ論理を、診断側は“範囲を絞り、境界を説明する”ために使う。Reconnaissance / Discovery として、攻め筋の確率を上げるための境界特定・依存推定。

## 参考（必要最小限）
- OWASP ASVS  
  https://github.com/OWASP/ASVS
- OWASP WSTG  
  https://owasp.org/www-project-web-security-testing-guide/
- PTES  
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Reconnaissance  
  https://attack.mitre.org/tactics/TA0043/
- MITRE ATT&CK：Discovery  
  https://attack.mitre.org/tactics/TA0007/

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
  - `01_topics/01_asm-osint/08_asn_bgp_ネットワーク境界（AS_プレフィックス_関連性）.md`
- 関連 labs / cases：
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

---

## 深掘りリンク（最大8）
- `01_topics/01_asm-osint/10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）.md`
- `01_topics/01_asm-osint/12_waf-cdn_挙動観測（ブロック_チャレンジ_例外）.md`
- `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`
- `01_topics/01_asm-osint/07_whois_rdap_所有者・関連企業推定（組織境界）.md`
- `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
- `02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- `04_labs/01_local/01_attack-box_作業端末設計.md`
- `01_topics/01_asm-osint/05_cloud_露出面（CDN_WAF_Storage等）推定.md`

---
