# 10_ctlog_証明書拡張観測（SAN_ワイルドカード_中間CA）
CT Log 証明書拡張観測（SAN/ワイルドカード/中間CA）
“DNSに見えない入口・過去資産・運用境界”を観測で確定し、優先度付けできる

## 目的（この技術で到達する状態）
- CTログ（Certificate Transparency）を使い、**DNSに見えない入口**（SAN由来のFQDN）と **過去資産**（失効/更新済み証明書に載っていたSAN）を掘り起こし、優先度付けできる。
- 証明書の“内容”を、CNではなく **SAN / ワイルドカード / Issuer（中間CA）/ 有効期間 / 鍵種別** として観測し、運用境界（自社/委託/クラウド）を yes/no/unknown で状態化できる。
- 02_tls（証明書・外部依存推定）と結合し、「実際に配信されている証明書」と「CTに載っている発行履歴」の差分から、例外パス（古いFQDN・環境系）や委託変更点を説明できる。

## 前提（対象・範囲・想定）
- 対象：ルートドメイン（example.com）と、既知の主要サブドメイン（login/api/id 等）、06_subdomain の結果（現状入口）と、09_passive-dns の結果（履歴入口）
- 想定する環境：
  - 自動発行（ACME）で短命証明書が大量に出る
  - ワイルドカード（*.example.com）でサブドメインがCTに出にくい（= CTだけでは入口が増えない）
  - CDN/WAFの共通証明書/共有SAN（別顧客と混ざる）など、CTの“見え方”にノイズが入る
- できること/やらないこと（安全に検証する範囲）：
  - できる：CTの公開情報を収集し、FQDN候補を作り、現状DNS/HTTPで存在確認する（最小限）
  - やらない：CT由来の候補を根拠に無制限に能動探索する（許可境界を壊さない）
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
  - `01_topics/01_asm-osint/09_passive-dns_履歴と再利用（過去資産の掘り起こし）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：CTログによる証明書拡張観測（SAN/ワイルドカード/中間CA）、DNSに見えない入口の特定、過去資産の特定
  - 扱わない（別ユニットへ接続）
    - TLS観測 → `02_tls_証明書・CT・外部依存推定.md`
    - サブドメイン列挙 → `06_subdomain_列挙（passive_active_辞書_優先度）.md`
    - PassiveDNS → `09_passive-dns_履歴と再利用（過去資産の掘り起こし）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（CTログで見ているもの）
  - “証明書から得たい情報”を5点に固定する
    - SAN（Subject Alternative Name）：実質的な公開FQDN集合（入口候補）
    - ワイルドカード：`*.example.com` があるか（入口増加の期待値が変わる）
    - Issuer / 中間CA：運用・委託の匂い（どのCA製品/中間が使われているか）
    - 有効期間：短命（ACME）か、長命か（運用成熟度の匂い、履歴量の見積もり）
    - 鍵/署名：RSA/ECDSA、署名アルゴリズム（“良し悪し”より、運用一貫性と例外パス発見に使う）
  - CTログは「CN」ではなく「SAN」を起点に候補化する
    - CNは歴史的互換の位置づけで、現代の入口発見はSANが主戦場。
    - SANから得たFQDNは、次の観点で分類して優先度付けする：
      - 機能境界：`id/auth/login/api/admin/console` 等
      - 環境境界：`dev/stg/test/old/backup` 等
      - 組織境界：子会社/ブランド/国別（`jp/us/asia` 等）
      - 第三者境界：`cdn`, `edge`, `s3`, `blob`, `pages` など外部運用臭
  - ワイルドカードは“入口を隠す”可能性がある（観測の解釈）
    - `*.example.com` が主要運用なら、CTにサブドメインがほとんど出ないことがある。
    - その場合の意思決定：
      - CTは「入口追加」よりも、「Issuer/中間CAの委託境界」「運用ポリシー（短命/更新頻度）」「例外（ワイルドカード外の個別SAN）」の検出に寄せる。
  - Issuer/中間CAの“揺れ”は運用境界変化のシグナル
    - 中間CAが複数ある／時期で切り替わる場合：
      - 委託先変更、CDN/WAF切替、部署別運用、買収統合などの可能性がある（断定しない）
    - ここでやることは断定ではなく、クラスターを作ること：
      - クラスターA：Issuer X / 中間CA X1 / 短命
      - クラスターB：Issuer Y / 中間CA Y1 / 長命
      - それぞれに紐づくSAN群を束ね、次の観測（DNS/HTTP/Cloud推定）へ渡す。
  - 「配信されている証明書」と「CTの履歴」の差分を取る
    - 重要：CTは“発行”の履歴であり、“今配っている”とは限らない。
    - 差分の取り方（状態化）：
      - CTにあるSANだが、今はDNS解決しない（過去資産候補）
      - 今配っている証明書のSANが、CTの想定と違う（別運用/別経路/例外パスの可能性）
      - 重要ホスト（login/api/id）のIssuerが他と違う（境界分離の可能性）
- 境界の観点
  - 資産境界（管理主体・委託先・対象範囲の線引き）：SANから得たFQDN候補を、機能境界・環境境界・組織境界・第三者境界で分類して優先度付けする
  - 信頼境界（外部連携・第三者・越境ポイント）：Issuer/中間CAの“揺れ”は運用境界変化のシグナル。委託先変更、CDN/WAF切替、部署別運用、買収統合などの可能性がある（断定しない）
  - 権限境界（権限の切替/伝播/委任）：機能境界（`id/auth/login/api/admin/console` 等）が、過去に存在していたか（= 例外パスの候補）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）
  - SAN：実質的な公開FQDN集合（入口候補）
  - ワイルドカード：`*.example.com` があるか（入口増加の期待値が変わる）
  - Issuer / 中間CA：運用・委託の匂い（どのCA製品/中間が使われているか）
  - 有効期間：短命（ACME）か、長命か（運用成熟度の匂い、履歴量の見積もり）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が“確定”できるか
  - CTに“発行された”証明書に載っていたFQDN候補（SAN）を列挙できる
  - Issuer/中間CAの分布（運用境界の“匂い”）をクラスター化できる
  - 現状DNS/HTTPと突合して、入口候補を「現役/過去/不明」に分類できる
- 何が“推定”できるか（推定の根拠/前提）
  - そのFQDNが必ず対象範囲である（委託/第三者/共有証明書の可能性）
  - CTに出ない＝存在しない（ワイルドカード/内部名/非公開名は見えない）
- 何は“言えない”か（不足情報・観測限界）
  - そのFQDNが必ず対象範囲である（委託/第三者/共有証明書の可能性）
  - CTに出ない＝存在しない（ワイルドカード/内部名/非公開名は見えない）
- よくある状態パターン（正常/異常/境界がズレている等）
  - パターンA：ワイルドカード運用が主で、CTから入口は増えにくい
  - パターンB：CTに環境系SANが出ており、過去資産の残存が疑われる
  - パターンC：Issuer分散が大きく、委託境界が複数ある

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す“狙い目”（診断としての優先度付け）
  - 環境系/管理系のSANが複数出る（例外パスの候補）
  - Issuer/中間CAが分散し、運用境界が多い（設定差分が出やすい）
  - 重要ホストだけIssuerが違う（境界分離の可能性）
- 優先度の付け方（時間制約がある場合の順序）
  - SANから得たFQDN候補を、機能境界・環境境界・組織境界・第三者境界で分類して優先度付けする
- 代表的な攻め筋（この観測から自然に繋がるもの）
  - 攻め筋1：CTからは「ワイルドカード外の個別SAN」「Issuer分散」「短命/長命」を抽出してクラスター化に専念
  - 攻め筋2：SAN候補をDNS解決して yes/no を確定し、解決できるものだけHTTP到達性を最小で確認する
  - 攻め筋3：クラスターごとに代表FQDNを選び、TLS/HTTPの挙動差分（ヘッダ、リダイレクト、サーバ特性）を観測する
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）
  - ワイルドカード運用が主で、CTから入口は増えにくい → 06の辞書戦略/HTTP観測/JS由来（04_js）へ時間を寄せる
  - CTに環境系SANが出ており、過去資産の残存が疑われる → 09（PassiveDNS）と突合し、last_seenが新しい順に現状確認（DNS→HTTP）を行う

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：CTはワイルドカード中心で入口が増えない
  - 次の検証：
    - CTからは「ワイルドカード外の個別SAN」「Issuer分散」「短命/長命」を抽出してクラスター化に専念
    - 入口増加は 06_subdomain（辞書/優先度）と 04_js（フロント由来）へ寄せる
  - 期待する観測（成功/失敗時に何が見えるか）：
    - CTの役割を“入口追加”から“運用境界推定”へ切り替え、無駄な探索を減らす
- 仮説B：CTに環境系/管理系SANが出ている
  - 次の検証：
    - SAN候補をDNS解決して yes/no を確定し、解決できるものだけHTTP到達性を最小で確認する
    - 到達できたものを 02_web/01_web_00_recon に渡し、入口・境界・検証方針を確定する
  - 期待する観測：
    - “CT起点で見つかった入口”として、証跡付きで説明できる
- 仮説C：Issuer/中間CAが複数に分かれ、委託境界が濃い
  - 次の検証：
    - クラスターごとに代表FQDNを選び、TLS/HTTPの挙動差分（ヘッダ、リダイレクト、サーバ特性）を観測する
    - Cloud推定（CDN/WAF/Storage）と束ね、責任分界・修正箇所の切り分け材料にする
  - 期待する観測：
    - 「境界がどこで増えているか」を運用目線で説明できる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/01_attack-box_作業端末設計.md`（結果保存・差分管理）
    - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`（現状確認の最小証跡）
- 取得する証跡（目的ベースで最小限）
  - `ct_raw.json`（取得元と取得日時が分かる形）
  - `ct_san_candidates.txt`（SANから抽出したFQDN候補）
  - `ct_clusters.md`（Issuer/中間CA/短命・長命で束ねたクラスター）
  - `ct_now_resolved.txt`（候補の現状DNS解決結果：yes/no/unknown）
  - 代表ホストの実配信証明書（Issuer/SAN/有効期間：値はそのままで可）
- 観測の取り方（どの視点で差分を見るか）
  - CT（発行履歴）由来の入口候補（SAN）→ 現状DNS解決 → 実配信証明書との差分
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/ctlog_10 2>/dev/null
    cd ~/keda_evidence/ctlog_10
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象ドメインは **許可されたスコープ** のみ（契約範囲/社内許可範囲/自前検証環境）
      - 観測は **代表点の抽出** のみ（CT由来の候補を根拠に無制限に能動探索しない）
      - 観測視点（端末/経路/ネットワーク）を記録
  - 相関キー（最低限）を作る（後で必ず効く）
    - Domain：対象ドメイン/サブドメイン
    - SAN：Subject Alternative Name（実質的な公開FQDN集合）
    - Wildcard：ワイルドカードの有無（`*.example.com` 等）
    - Issuer：証明書発行者（CA）
    - IntermediateCA：中間CA
    - Validity：有効期間（短命/長命）
    - Cluster：クラスター（Issuer/中間CA/短命・長命で束ねたクラスター）
    - CurrentStatus：現状DNS解決（yes/no/unknown）
    - Timestamp：観測日時（JSTで秒まで）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は“手段”であり“結論”ではない。必ず「何を観測している例か」を添える。

~~~~
# 目的：CTからSAN由来のFQDN候補を作り、現状DNS/HTTPへ渡す（“入口追加”の最短ルート）

## 出力例（最小）
- ワイルドカード増加は資産拡大の兆候
# 注意：CT取得は提供元により形式が異なる。ここでは「取得→候補化→現状確認」の形を示す。

## 出力例（最小）
- ワイルドカード増加は資産拡大の兆候

# (1) 例：crt.sh からJSON取得（大量取得は避け、対象ドメインを絞る）

## 出力例（最小）
- ワイルドカード増加は資産拡大の兆候
curl -s "https://crt.sh/?q=%25.example.com&output=json" > ct_raw.json

# (2) 候補化：name_value（SAN相当）を抜き出して正規化（重複除去）

## 出力例（最小）
- ワイルドカード増加は資産拡大の兆候
jq -r '.[].name_value' ct_raw.json \
  | tr '\n' '\n' \
  | sed 's/\*\.//g' \
  | sort -u > ct_san_candidates.txt

# (3) 現状DNS確認：解決できる候補だけ次へ回す（yes/no）

## 出力例（最小）
- ワイルドカード増加は資産拡大の兆候
dnsx -l ct_san_candidates.txt -a -aaaa -cname -silent > ct_now_resolved.txt

# (4) 代表ホストの“実配信証明書”を取り、Issuer/SANをCTと突合する（差分観測）

## 出力例（最小）
- ワイルドカード増加は資産拡大の兆候
echo | openssl s_client -connect login.example.com:443 -servername login.example.com 2>/dev/null \
  | openssl x509 -noout -issuer -subject -dates -ext subjectAltName
~~~~

- この例で観測していること：
  - CT（発行履歴）由来の入口候補（SAN）→ 現状DNS解決 → 実配信証明書との差分
- 出力のどこを見るか（注目点）：
  - `ct_san_candidates.txt`：環境系/管理系/ID基盤/API系の命名
  - `ct_now_resolved.txt`：現役入口の候補（次はHTTP観測へ）
  - openssl出力：Issuer/中間CAの匂い、SANの一致/不一致、有効期間
- この例が使えないケース（前提が崩れるケース）：
  - CTの入手経路が無い/制限が強い：PassiveDNS（09）・JS由来（04_js）・検索/公開資料へ寄せる
  - ワイルドカード運用が主で、CTから入口は増えにくい：06の辞書戦略/HTTP観測/JS由来（04_js）へ時間を寄せる

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V1（アーキテクチャ/信頼境界）とV14（運用・構成）を評価する前提として、証明書発行の実態（委託先CA/中間CA/発行ポリシー）と、公開されているFQDN集合（SAN）を“境界情報”として固定する
  - 該当要件（可能ならID）：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：証明書発行の実態（委託先CA/中間CA/発行ポリシー）と、公開されているFQDN集合（SAN）を確定できないと、以降の検証で“対象外”や“前提違い”を起こし、検証精度が落ちる。
    - 満たす：外部依存・設定・通信・境界（ASM/OSINTは“前提の崩れ”を潰す役）を把握し、以降の検証（認証/認可/API/運用）を「前提崩れ」なく進める土台を作る。
- WSTG：
  - 該当カテゴリ/テスト観点：Information Gathering の一部として、サブドメイン列挙（06）やHTTP観測（03）に追加の入口（SAN由来）を供給し、外部依存（CDN/ホスティング/委託）を推定する材料にする
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：WSTG各観点へ入る前の“入口確定”として接続
- PTES：
  - 該当フェーズ：Intelligence Gathering（公開情報からの入口拡張）→ Vulnerability Analysis（委託境界・残存資産・例外パスの疑い）へ繋げる
  - 前後フェーズとの繋がり（1行）：CTログを使い、DNSに見えない入口（SAN由来のFQDN）と過去資産を掘り起こし、優先度付けできる
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Reconnaissance（公開情報の収集）
  - 攻撃者の目的（この技術が支える意図）：診断として「公開入口（FQDN）の追加」「委託境界（CA/中間CA/発行主体）の推定」「時系列（過去→現在）」を説明可能にすること。Reconnaissance / Discovery として、攻め筋の確率を上げるための境界特定・依存推定。

## 参考（必要最小限）
- OWASP ASVS
  https://github.com/OWASP/ASVS
- OWASP WSTG
  https://owasp.org/www-project-web-security-testing-guide/
- PTES
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Reconnaissance
  https://attack.mitre.org/tactics/TA0043/
- MITRE ATT&CK：Discovery
  https://attack.mitre.org/tactics/TA0007/
- Certificate Transparency（CT）
  https://www.certificate-transparency.org/

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/01_asm-osint/02_tls_証明書・CT・外部依存推定.md`
  - `01_topics/01_asm-osint/06_subdomain_列挙（passive_active_辞書_優先度）.md`
- 関連 labs / cases：
  - `04_labs/01_local/01_attack-box_作業端末設計.md`

---

## 深掘りリンク（最大8）
- `01_topics/01_asm-osint/09_passive-dns_履歴と再利用（過去資産の掘り起こし）.md`
- `01_topics/01_asm-osint/05_cloud_露出面（CDN_WAF_Storage等）推定.md`
- `01_topics/01_asm-osint/12_waf-cdn_挙動観測（ブロック_チャレンジ_例外）.md`
- `01_topics/01_asm-osint/04_js_フロント由来の攻撃面抽出.md`
- `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
- `02_playbooks/01_asm_passive-recon_資産境界→優先度付け.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `01_topics/01_asm-osint/03_http_観測（ヘッダ/挙動）と意味.md`

---
