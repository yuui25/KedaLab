# 05_input_14_prototype_pollution_02_sinks（authz_template_rce）
Prototype Pollution の sink を分解する。認可（authz）・テンプレ・実行（RCE）へ"効く"条件を、分岐点として確定する

---

## 目的（この技術で到達する状態）
- Prototype Pollution の評価を「sourceがある」から「実害がある」へ進めるために、次を説明できる。
  1) どの"判断点（sink）"が汚染に影響されるか（認可/テンプレ/実行）
  2) 影響が出る成立条件（データフロー、共有性、参照方法、列挙方法）を分解できる
  3) 侵害評価を、RCE偏重ではなく「最短の実害（権限逸脱/情報漏えい/DoS）」で確定できる
- 報告に落とす形（必須）：
  - 「危険キーが到達する経路（source）」＋「影響する分岐点（sink）」＋「分岐が変わる観測結果」＋「修正の設計要件」

## 前提（対象・範囲・想定）
- 対象：許可された範囲のWebアプリ/環境のみ。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - Node.js、Python、Ruby等のサーバサイド実装が一般的。
- できること/やらないこと（安全に検証する範囲）：
  - やらないこと：破壊的試験や過剰負荷。実害再現（任意コマンド実行）を最初のゴールにしない。
- 依存する前提知識（必要最小限）：
  - `05_input_14_prototype_pollution_01_sources（merge_parse）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - sink（影響点）の分類と、成立条件の詰め方
    - 認可（AuthZ）sink：ロール/テナント/オブジェクトスコープ/feature flag/ガード分岐
    - テンプレ sink：テンプレ変数解決、エスケープ/サニタイズ分岐、ヘルパ/フィルタ解決
    - RCE sink：危険API（プロセス起動、テンプレ評価、動的ロード等）の"オプション/引数"が汚染の影響を受けるケース
  - 扱わない（別ユニットへ接続）：
    - source（parse/merge/set）の作り方 → `05_input_14_prototype_pollution_01_sources（merge_parse）.md`
    - "具体的な攻撃文字列"の列挙（本プロジェクトは境界と成立根拠を優先）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 分岐が変わった証拠（ステータス、レスポンスボディ差分、件数差分）
  - 参照が継承プロパティを拾った兆候（返却JSONに想定外キー、バリデーション差分）
  - 共有性の兆候（別エンドポイントでも同じ差分、時間差で影響が残る）
  - 危険APIの条件が揃っている兆候（ジョブ/変換/プレビュー/外部連携、ログの痕跡）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：汚染がどのオブジェクトに到達するか
  - 信頼境界（外部連携・第三者・越境ポイント）：共有オブジェクトへの混入
  - 権限境界（権限の切替/伝播/委任）：認可判定、テンプレ評価、実行APIのオプションへの影響
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 認可sink：同一セッション/同一ユーザで挙動が「許可/拒否」で変わる（401/403→200）
  - テンプレsink：表示文言、属性値、リンク先などが変化する
  - RCE sink：外部通信が増える/変わる、エラーログに実行環境情報が出る

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - どの"判断点（sink）"が汚染に影響されるか（認可/テンプレ/実行）
  - 分岐が変わる観測結果（ステータス、レスポンス差分、ログ）
- 何が"推定"できるか（推定の根拠/前提）：
  - 影響が出る成立条件（データフロー、共有性、参照方法、列挙方法）
  - 実害の半径（同テナント内だけか、越境するか）
- 何は"言えない"か（不足情報・観測限界）：
  - すべてのsinkを網羅した断定（観測範囲に依存）
  - RCEの実害評価（許可された検証環境でのみ実施）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：sourceのみ成立 → 危険キーが通るが、影響点が見つからない → "潜在リスク"として残る（優先度は下がるが、修正は推奨）
  - パターンB：sink（認可/テンプレ）が成立 → 実害（権限逸脱、情報漏えい、表示改変）が観測できる → 高優先度（再現性が高い）
  - パターンC：sink（RCE）が成立 → 危険APIの引数/オプションが影響を受けることを観測で固めた上で、実害評価は"許可された検証環境"でのみ実施

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - 認可判定に使われるオブジェクト（最優先：成立条件が単純で、影響が明確で、再現が安定）
  - テンプレ変数解決に使われるオブジェクト（次優先：表示改変・情報露出）
  - 危険APIのオプションオブジェクト（最後：成立条件が重い）
- 優先度の付け方（時間制約がある場合の順序）：
  1) まず認可sinkを当てに行く（管理画面、admin API、重要操作）
  2) 次にテンプレsink（サーバレンダリング画面、メールテンプレ、PDF/HTMLエクスポート）
  3) RCEは最後（成立条件が重いので、観測で"可能性"を潰す）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：認可sinkで権限逸脱（同一セッション/同一ユーザで挙動が「許可/拒否」で変わる）
  - 攻め筋2：テンプレsinkで情報漏えい（表示文言、属性値、リンク先などが変化する）
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 共有性（グローバルmerge）を疑い、時間差/別エンドポイントの観測設計を組む

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：認可sinkが見つかった
  - 次の検証：
    - 影響半径を確定（同テナント内だけか、越境するか）
    - 重要操作（承認/権限変更/エクスポート/招待）へ到達するか
    - 監査ログに principal/tenant の矛盾が出ないか（検知の余地）
    - `03_authz_*` の境界モデルに落として所見化
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 実害（権限逸脱、情報漏えい）が観測できる
- 仮説B：認可sinkは見つからないが、テンプレ差分が出る
  - 次の検証：
    - 表示改変/情報露出を"確実な影響"として固める
    - XSSへ接続する場合、`05_input_06_xss_*` の境界（反射/格納/DOM）で成立条件を整理
  - 期待する観測：
    - 表示改変や情報露出など、確実に再現できる影響で所見化できる
- 仮説C：差分が出ない（sinkが不明）
  - 次の検証：
    - 共有性（グローバルmerge）を疑い、時間差/別エンドポイントの観測設計を組む（安全最小で）
    - source側へ戻り、別入力面（query/body/form/import/ws）での到達性を再点検する
    - 依存・設定差分（parser/merge実装）を特定して、再現条件を詰める
  - 期待する観測：
    - 潜在リスクとして残る（優先度は下がるが、修正は推奨）

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/05_input/14_prototype_pollution_sinks_authz_template/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - HTTPログ/har、サーバログ、レスポンス差分
  - 認可ガードの参照したキー、参照元オブジェクト、判定結果
  - テンプレcontext構築の方法（merge/allowlist）
- 観測の取り方（どの視点で差分を見るか）：
  - メモに必ず残す項目：sinkの種類（認可/テンプレ/実行）、分岐が変わった証拠、共有性の有無、影響半径
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/prototype_pollution_sinks 2>/dev/null
    cd ~/keda_evidence/prototype_pollution_sinks
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（破壊的試験や過剰負荷は行わない）
      - 実害再現（任意コマンド実行）を最初のゴールにしない。まずは「オプションが変わっている」ことを観測で固める
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、sinkの種類（認可/テンプレ/実行）、分岐が変わった証拠、共有性、影響半径

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# ここでは"攻撃文字列"ではなく、sinkの確認観点だけを書く。
# - 認可：ガードが参照するプロパティが own か inherited か
# - テンプレ：context構築が merge か allowlist か
# - 実行：危険APIの options を入力で変更できる設計か
~~~~

- この例で観測していること：
  - sinkの種類と成立条件の確認
- 出力のどこを見るか（注目点）：
  - ステータス（403→200、404→200）、レスポンスボディ差分、ログ
- この例が使えないケース（前提が崩れるケース）：
  - sourceが成立していない場合、sinkまで到達しない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：認可、入力検証、データ保護
  - 該当要件（可能ならID）：認可判定、テンプレ評価、実行APIのオプション
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：入力が「キーとして構造に入る」ことで、**認可判定・テンプレ評価・実行APIのオプション**など"意味のある分岐点（sink）"が外部入力により間接的に操作される。
    - 満たす：allowlist（キー/構造）＋安全なmerge/set＋共有オブジェクト不使用＋`hasOwnProperty`等の境界固定により、汚染がセキュリティ判断点へ届かない。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：入力検証だけでなく、「サーバ側の状態遷移・認可・テンプレ処理」に対し、**同一リクエストで"結果だけ変わる"差分**を作り、汚染が"判断点"に到達しているかを検証する。
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：sink（影響点）の特定と成立条件の詰め方
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析〜侵害評価
  - 前後フェーズとの繋がり（1行）：`05_input_14_prototype_pollution_01_sources` で source（到達経路）を固めた後、ここで sink（影響点）を確定して、報告を「成立根拠（到達）＋影響（分岐）」として完成させる。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：T1190（公開アプリ脆弱性悪用）を入口に、sink次第で目的が分岐する。認可：Privilege Escalation / Defense Evasion（権限判定の迂回）。テンプレ：Execution（スクリプト実行に接続する場合）。RCE：Execution（サーバ実行）＋Lateral Movement / Credential Accessへ連鎖し得る（ただし成立条件が厳しいため、条件を分解して評価）。
  - 攻撃者の目的（この技術が支える意図）：sink（影響点）の特定と成立条件の詰め方
  - 参照：https://attack.mitre.org/tactics/TA0001/（Initial Access）

## 参考（必要最小限）
- PortSwigger の定義と解説（概念、サーバサイドの成立条件）
- OWASP の予防策整理（防御設計の方向性）

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`05_input_14_prototype_pollution_01_sources（merge_parse）.md`
- 関連 topics：`03_authz_01_境界モデル（オブジェクト_ロール_テナント）.md`
- 関連 labs：`04_labs/02_web/05_input/14_prototype_pollution_sinks_authz_template/`（追加候補）

---

## 深掘りリンク（最大8）
- `05_input_14_prototype_pollution_01_sources（merge_parse）.md`
- `03_authz_00_認可（IDOR BOLA BFLA）境界モデル化.md`
- `03_authz_01_境界モデル（オブジェクト_ロール_テナント）.md`
- `03_authz_05_mass-assignment_モデル結合境界.md`
- `05_input_06_xss_01_反射_境界モデル.md`
- `05_input_06_xss_02_格納_境界モデル.md`
- `05_input_06_xss_03_DOM_境界モデル.md`
- `04_api_09_error_model_情報漏えい（例外_スタック）.md`

---
