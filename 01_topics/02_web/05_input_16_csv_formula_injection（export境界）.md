# 05_input_16_csv_formula_injection（export境界）

## このファイルで扱う概念
- CSVの出力境界とスプレッドシートの式解釈。

## 危険性を一言で
- 文字列が式として評価される。

## 最小限の成立判断（目安）
- 先頭文字の差分で評価が変わる。

## 観測例（差分のイメージ）
- A: 文字列表示、B: 式として解釈される。

## 観測が取れない場合の代替
- 出力CSVの先頭文字を確認する。

## 時間制約下の最小観測点
- `=`, `+`, `-`, `@` の先頭扱い。

## 対策の優先順位
1) 先頭文字の無害化
2) 引用符での囲い
3) 出力専用ドメイン

## 具体例（無害化と挙動差）
- 先頭に `'` や `\t` を付与
- Excel/Sheets/LibreOfficeで先頭記号の扱いが異なる
CSV Formula Injection：exportが「データ移送」から「端末での解釈・実行」へ境界を跨ぐ

---

## 目的（この技術で到達する状態）
- CSV式注入を「Excelの小技」ではなく、**export境界の脆弱性**として説明できる。
  1) 入力→保存→export→開封→実行/参照 のデータフローを描ける
  2) どのフィールドが危険（セル/列/ヘッダ）で、どこで無害化すべきかを決められる
  3) 実害を"業務フロー"で確定できる（誰が開くか、どの端末か、権限は何か）
  4) 修正方針を、アプリ側（出力エスケープ/フォーマット）と運用側（手順/注意喚起）に分けて提案できる

## 前提（対象・範囲・想定）
- 対象：許可された範囲のWebアプリ/環境のみ。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CSV/TSV等の表形式エクスポート機能を持つアプリが一般的。
- できること/やらないこと（安全に検証する範囲）：
  - やらないこと：実行/外部通信を起こす方向ではなく、"数式として扱われる"ことを確認できる最小差分（表示や形式の差）を根拠にする。
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/04_api_08_file_export_エクスポート境界（CSV_PDF）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - CSV/TSV等の表形式エクスポートにおける式注入（数式解釈の悪用）
    - 対象となる"解釈器"：Excel、Google Sheets、LibreOffice等（ただし実害の成立条件は環境に依存する）
  - 扱わない（別ユニットへ接続）：
    - "具体的な数式ペイロードの列挙"は最小限（本プロジェクトは境界と成立根拠を優先）
    - マクロ（VBA）そのものの悪用は別系統（ただし運用上同時に議論されやすいので接続は書く）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - CSV出力の構造（値の配置とエスケープ、引用符、区切り、改行の扱い）
  - 先頭文字がそのまま出るか（前置の無害化があるか）
  - 開封環境の前提（どのツールで開く運用か、自動処理があるか）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：入力→保存→export の経路
  - 信頼境界（外部連携・第三者・越境ポイント）：サーバは「ただ出力しただけ」でも、クライアント側が"実行"する
  - 権限境界（権限の切替/伝播/委任）：誰が開くか（管理者/CS/監査/営業/経理など、エクスポートを行うロール）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 出力時に無害化されていないか（先頭文字の扱い、引用符で囲われるかどうか、改行/区切り/引用符のエスケープ）
  - どの環境で開くか（社内端末/VDI/サンドボックス、Google Sheets/Excel）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - その値が export に乗るか（入力 → 保存 → export の経路があること）
  - 出力時に無害化されていないか（先頭文字、引用、正規化）
- 何が"推定"できるか（推定の根拠/前提）：
  - 実害の半径（開封者端末、社内ネットワーク、業務改ざん）
  - 想定運用で開封されること（役割、頻度、環境）
- 何は"言えない"か（不足情報・観測限界）：
  - すべての環境での実害評価（環境により変わる点は条件として明示する）
  - すべての入力面を網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：ユーザ入力が管理者CSVに乗る（典型） → 一般ユーザが入力した値が管理者向けエクスポートに乗る構図
  - パターンB：exportはあるが、入力は限定（管理者のみ） → インポート経由（外部連携）で混入できないか
  - パターンC：CSVが"別システムへインポート"される → BI/ETL/CRMへ取り込まれ、そこで再解釈・再出力される

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - 外部入力 × 高頻度 × 同期処理 × 共有ワーカの組み合わせ
  - ユーザ名、表示名、会社名、部署名、メールアドレス、電話番号、住所、備考、コメント、チケット本文、商品名/SKU、請求書の品目、自由入力のメタ情報
- 優先度の付け方（時間制約がある場合の順序）：
  1) 定例作業で開封される（毎日・毎週の定例業務なら攻撃価値が上がる）
  2) 管理者/CS/監査/営業/経理など、エクスポートを行うロールが開く
  3) 社内端末（ドメイン参加、プロキシ、社内ネットワーク到達）で開く
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：セル値（フィールド値）として出力される → もっとも典型。ユーザ入力がそのままセルに入る
  - 攻め筋2：列ヘッダ（カラム名）として出力される → "カスタムフィールド名"をユーザが設定できる製品で起きやすい
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - インポート経由（外部連携）で混入できないか
  - 監査/経理など別部門に渡る運用がないか（人的境界が広いほど影響が増える）

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：ユーザ入力が管理者CSVに乗る（典型）
  - 次の検証：
    - "どのロールが開封するか"の業務確認を所見に組み込み、優先度を上げる
    - 同じ入力が他のexport（請求、ログ、監査）にも波及しないかを棚卸し
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 技術的成立（セルが式扱い）＋運用成立（誰かが開く）で"脆弱性としての実害"が確定する
- 仮説B：exportはあるが、入力は限定（管理者のみ）
  - 次の検証：
    - インポート経由（外部連携）で混入できないか
    - 監査/経理など別部門に渡る運用がないか（人的境界が広いほど影響が増える）
  - 期待する観測：
    - 外部連携経由での混入可能性が示される

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/05_input/16_csv_formula_injection_export_boundary/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - CSV出力ファイル、開封環境の前提、出力の構造（値の配置とエスケープ）
- 観測の取り方（どの視点で差分を見るか）：
  - メモに必ず残す項目：入力フィールド、export対象、出力構造、先頭文字の扱い、開封環境、実害の半径
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/csv_formula_injection 2>/dev/null
    cd ~/keda_evidence/csv_formula_injection
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（実行/外部通信を起こす方向ではなく、"数式として扱われる"ことを確認できる最小差分）
      - 実害が必要な場合でも、社内ルール/VDP/契約範囲に従い、隔離環境でのみ実施する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、入力フィールド、export対象、出力構造、先頭文字、開封環境、実害の半径

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# ここでは「どの値がCSVにどう出力されるか」を見る。

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：入出力検証、データ保護
  - 該当要件（可能ならID）：出力時エスケープ、数式として解釈される条件の遮断、受領者の想定（運用フロー）を含むリスク評価、ダウンロード認可・監査、代替形式（XLSX/PDF）や安全モード案内
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：CSV/Spreadsheetは「保存されたデータが、別実行環境（表計算ソフト）で解釈される」典型例。export境界としては、(1) 出力時エスケープ、(2) "数式として解釈される条件"の遮断、(3) 受領者の想定（運用フロー）を含むリスク評価、(4) ダウンロード認可・監査、(5) 代替形式（XLSX/PDF）や安全モード案内が中心。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：入出力のテストとして、保存された値が export に乗るか、列/ヘッダ/セルのどこに入るか、また「ダウンロード後に何で開かれるか（Excel/Google Sheets/LibreOffice）」を前提に再現性を確認する。
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：export境界の特定と成立条件の詰め方
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：侵害評価
  - 前後フェーズとの繋がり（1行）：侵害評価はサーバ側RCEではなく「人（運用担当者）の端末で発火」する。したがって、(1) どのロールがエクスポートを行うか（管理/監査/CS）、(2) どの端末/ネットワークで開くか（社内端末、VDI、制限）、(3) その結果の影響（情報漏えい、ワークフロー改ざん、横展開）を"業務フロー"として示す。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：初期侵入：T1566（Phishing）の近縁だが、アプリのエクスポート機能が配布チャネルになる。実行：T1204（User Execution：ユーザがファイルを開く）
  - 攻撃者の目的（この技術が支える意図）：その後：社内ネットワークへの到達、認証情報・データの窃取などへ波及し得る（ただし環境依存なので成立条件を分解して評価）。
  - 参照：https://attack.mitre.org/tactics/TA0001/（Initial Access）

## 参考（必要最小限）
- CSV Formula Injection の定義と解説
- export境界の脆弱性としての説明
- Excel、Google Sheets、LibreOffice等の解釈器の違い

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`04_api_08_file_export_エクスポート境界（CSV_PDF）.md`
- 関連 topics：`03_authz_08_file_access_ダウンロード認可（署名URL）.md`
- 関連 labs：`04_labs/02_web/05_input/16_csv_formula_injection_export_boundary/`（追加候補）

---

## 深掘りリンク（最大8）
- `05_input_12_file_upload_03_execution_chain（preview_processor_rce）.md`
- `05_input_09_ssrf_04_saas_features（webhook_preview_pdf）.md`
- `05_input_15_regex_dos（ReDoS_検証）.md`
- `04_api_08_file_export_エクスポート境界（CSV_PDF）.md`
- `03_authz_08_file_access_ダウンロード認可（署名URL）.md`
- `04_api_09_error_model_情報漏えい（例外_スタック）.md`
- `06_config_03_セキュリティヘッダ（CSP_HSTS_Frame_Referrer）.md`
- `02_playbooks/05_api_権限伝播→検証観点チェック.md`

---
