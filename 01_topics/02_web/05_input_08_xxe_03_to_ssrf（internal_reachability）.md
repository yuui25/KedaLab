# 05_input_08_xxe_03_to_ssrf（internal_reachability）

## このファイルで扱う概念
- XXEからSSRFへ到達する経路と証拠化。

## 危険性を一言で
- XML解析が内部ネットワーク到達性に転化する。

## 最小限の成立判断（目安）
- 内部向けの到達差分が再現できる。

## 観測例（差分のイメージ）
- A: 外部のみ、B: 内部先への到達ログが出る。

## 観測が取れない場合の代替
- 解析環境のネットワーク制約を構成で確認する。

## 時間制約下の最小観測点
- 内部到達の有無と、経路（resolver/egress）の特定。

## 対策の優先順位
1) XXEの根本無効化
2) 内部ネットワークの遮断
3) 到達ログの監視

## 目的（この技術で到達する状態）
- XXEを「ファイル読み取り」だけで終わらせず、**内部到達性（internal reachability）を借りるSSRF連鎖**として、成立根拠・観測設計・防御設計を説明できる。
- 実務で次を即断できる
  - どの経路（API/アップロード/変換/ジョブ）が、どの実行環境（フロント/ワーカー/別ネットワーク）でXMLをパースしているか
  - その実行環境が「内部に出られる」「外部に出られる」「DNSだけ」「プロキシ必須」など、到達性の現実
  - "XXEがBlindでも"内部到達性は成立し得ることを、証拠（OOB/ログ/差分）で確定する方法
- 次のファイル群（SSRF：到達性、URLトリック、プロトコル、SaaS機能）へ地続きに接続できる。

## 前提（対象・範囲・想定）
- 対象：XML入力を扱う境界、XMLパース地点、API/ファイル/サードパーティ処理、XMLを扱う経路（API、ファイル、生成・変換）、どの経路（API/アップロード/変換/ジョブ）が、どの実行環境（フロント/ワーカー/別ネットワーク）でXMLをパースしているか
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - SSRFは「サーバ側アプリに意図しない場所へリクエストさせる」脆弱性。内部限定サービスやメタデータ等、ユーザから到達できない領域へアクセスできる点が本質、XXEは「XML処理に干渉して、サーバがアクセスできる外部/内部システムと相互作用できる」ことが多い。つまりXXEは、SSRFの入口になり得る、重要：XXEの"入口"を閉じるのが第一優先（DTD無効化等）。SSRF側の防御は多層（残余リスク低減）として扱う
- できること/やらないこと（安全に検証する範囲）：
  - できること：どの経路（API/アップロード/変換/ジョブ）が、どの実行環境（フロント/ワーカー/別ネットワーク）でXMLをパースしているか、その実行環境が「内部に出られる」「外部に出られる」「DNSだけ」「プロキシ必須」など、到達性の現実、"XXEがBlindでも"内部到達性は成立し得ることを、証拠（OOB/ログ/差分）で確定する方法
  - やらないこと：影響実証は最小限（成立根拠の確定まで）。高負荷/外部到達/大量出力は避ける
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/05_input_08_xxe_01_parser（doctype_entity）.md`
  - `01_topics/02_web/05_input_08_xxe_02_blind（oob）.md`
  - `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - XML入力を扱う境界、XMLパース地点、API/ファイル/サードパーティ処理、XMLを扱う経路（API、ファイル、生成・変換）、どの経路（API/アップロード/変換/ジョブ）が、どの実行環境（フロント/ワーカー/別ネットワーク）でXMLをパースしているか
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：
    - 入力→パーサ境界（XXEの前提）：XMLパース地点が存在し、DOCTYPE/DTD/ENTITY を受理し得る（または経路差分で設定漏れがある）、経路差分が本命：メインAPIは安全でも、アップロード/変換/プレビュー/ジョブで別パーサが動く
  - 信頼境界（外部連携・第三者・越境ポイント）：
    - パーサ→リゾルバ境界（外部参照解決）："外部参照を解決する（resolve）"機能が生きていることが、SSRF連鎖の直接条件、ここは「レスポンスに出る/出ない」ではなく、「取りに行くか」が焦点（Blindでも内部到達性は成立し得る）、実行環境境界（どのネットワークから出るか）：もっとも実務的な差分：**XMLをパースする実行環境がどこか**、フロント（Web/API）か、ワーカー（変換/プレビュー/バッチ）か、その環境が属するネットワーク（DMZ/内部/クラウドサブネット）、同じ入力でも、処理系が違うと到達性が別物になる（= 再現性・影響が激変する）
  - 権限境界（権限の切替/伝播/委任）：
    - ネットワーク到達性境界（internal reachability）：WSTGが述べる通り、SSRFの重要点は「サーバが内部のバックエンドに到達できる」という信頼関係。ここが"借用"される、内部到達性は、次の3軸で"現実"が決まる、名前解決（内部DNS/外部DNS/固定リゾルバ/分割DNS）、ルーティング（プライベートレンジ、リンクローカル、NAT、セグメント分離）、制御（プロキシ強制、宛先ホワイトリスト、FW/SG/NACL、WAFではなくNW側）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 到達対象（内部の種類）：内部管理系：管理UI、監視、CI/CD、社内API、認証基盤など（公開されない前提）、内部データ系：検索/メッセージ/キュー/DB相当のフロント（HTTPで喋るものが特に危険）、クラウドメタデータ等：クラウド環境で「インスタンスにだけ見える情報」を提供する系、代表例として、XXE→SSRFでメタデータから資格情報に到達するシナリオが学習用に提示されている、到達手段（解決器が使うプロトコル/経路）：HTTP(S)（最頻）：内部HTTPサービスに到達しやすい、それ以外：実装や制約で揺れる（ここは"推測しないで観測"が鉄則）、重要：XXEの入口はXMLだが、到達性評価はSSRFと同様に「サーバがどこへリクエストできるか」で判断する、観測方法（証拠の取り方）：In-band（レスポンス反映）：最強だが、XXEはBlindになりやすい、OOB（DNS/HTTP等）：Blindでも成立根拠を取れる（前ファイルの主題）、差分（タイムアウト/エラー/副作用ログ）：補助だが、環境制約下では重要になる

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 内部到達性が"外部入力で変化した"こと：同一操作で「参照解決を試みる入力」だけを変えたときに、内部向けアクセスが発生する、または、内部向けアクセスに起因する差分（例外/時間/ログ）が出る、これを相関（request_id/job_id/時刻窓）で固める、到達先が"ユーザから到達できない領域"であること：ここがSSRFの核心（内部限定の信頼関係を借りている）、WSTGの説明（バックエンドの非公開アドレス/限定到達）に沿って整理すると、報告が強くなる、入口がXXEであること（CWE-611の観点）：CWE-611は、外部実体参照を不適切に制限した場合に「ローカルファイル読み取り等」を引き起こし得ると述べる。これを"参照解決器が危険な既定値で動く"根拠として用いる、報告では「SSRFがある」だけでなく、「XMLパーサ設定不備（CWE-611相当）が入口」と因果で結ぶ
- 何が"推定"できるか（推定の根拠/前提）：
  - 内部到達性は「到達できた/できない」ではなく、**どの種類の内部へ、どの手段で、どの証拠で**を固定して評価する、到達対象（内部の種類）、到達手段（解決器が使うプロトコル/経路）、観測方法（証拠の取り方）
- 何は"言えない"か（不足情報・観測限界）：
  - 実務の落とし穴（ここを潰すと深さが出る）："メイン経路は安全"の罠（変換/プレビュー/ジョブ）、egress制約で"観測できない"問題、"到達できるが読めない"問題
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：内部到達性が"外部入力で変化した"こと → 同一操作で「参照解決を試みる入力」だけを変えたときに、内部向けアクセスが発生する、または、内部向けアクセスに起因する差分（例外/時間/ログ）が出る、これを相関（request_id/job_id/時刻窓）で固める
  - パターンB：到達先が"ユーザから到達できない領域"であること → ここがSSRFの核心（内部限定の信頼関係を借りている）、WSTGの説明（バックエンドの非公開アドレス/限定到達）に沿って整理すると、報告が強くなる
  - パターンC：入口がXXEであること（CWE-611の観点） → CWE-611は、外部実体参照を不適切に制限した場合に「ローカルファイル読み取り等」を引き起こし得ると述べる。これを"参照解決器が危険な既定値で動く"根拠として用いる、報告では「SSRFがある」だけでなく、「XMLパーサ設定不備（CWE-611相当）が入口」と因果で結ぶ

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - "XMLを受け取る面"を探す（表のUIではなく、連携・アップロード・変換・プレビューに寄る）、成立根拠としてまず狙うのは「DOCTYPEを受理するか」、受理される＝攻撃面として優先度が上がる（外部参照/OOB/DoSへ伸びる）、次に「外部参照を解決するか」は、環境依存が大きいので観測（DNS/HTTP egress）で確定する（次ファイルで深掘り）
- 優先度の付け方（時間制約がある場合の順序）：
  - まず見る：入力→パーサ境界（XXEの前提）、パーサ→リゾルバ境界（外部参照解決）、次に見る：実行環境境界（どのネットワークから出るか）、最後に見る：ネットワーク到達性境界（internal reachability）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：XXEを「ファイル読み取り」だけで終わらせず、**内部到達性（internal reachability）を借りるSSRF連鎖**として、成立根拠・観測設計・防御設計を説明できる、実務で次を即断できる、どの経路（API/アップロード/変換/ジョブ）が、どの実行環境（フロント/ワーカー/別ネットワーク）でXMLをパースしているか、その実行環境が「内部に出られる」「外部に出られる」「DNSだけ」「プロキシ必須」など、到達性の現実、"XXEがBlindでも"内部到達性は成立し得ることを、証拠（OOB/ログ/差分）で確定する方法
  - 攻め筋2：次のファイル群（SSRF：到達性、URLトリック、プロトコル、SaaS機能）へ地続きに接続できる、XXE→SSRFは、攻撃者が「被害者サーバの到達性」を借りて内部資源へアクセスする連鎖。内部サービス探索・メタデータ/資格情報の露出など、後続行動（横展開/クラウド権限奪取）へ接続し得る
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 実務の落とし穴（ここを潰すと深さが出る）："メイン経路は安全"の罠（変換/プレビュー/ジョブ）、egress制約で"観測できない"問題、"到達できるが読めない"問題

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：（内部到達性が"外部入力で変化した"こと）
  - 次の検証：同一操作で「参照解決を試みる入力」だけを変えたときに、内部向けアクセスが発生する、または、内部向けアクセスに起因する差分（例外/時間/ログ）が出る、これを相関（request_id/job_id/時刻窓）で固める
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：内部到達（または内部向け相互作用）が相関付きで確認できた、OOBログ（DNS/HTTP）：時刻・宛先・回数（相関キー）、アプリログ：request_id/job_id、例外、処理開始・完了時刻、ネットワークログ：プロキシ/FW/DNS（あれば）
    - 失敗：観測点不足（ログ/相関不可、非同期で追えない）→追加観測（どのログが要るか）を必ず提案
- 仮説B：（到達先が"ユーザから到達できない領域"であること）
  - 次の検証：ここがSSRFの核心（内部限定の信頼関係を借りている）、WSTGの説明（バックエンドの非公開アドレス/限定到達）に沿って整理すると、報告が強くなる
  - 期待する観測：
    - 成功：到達先が"ユーザから到達できない領域"であること、ここがSSRFの核心（内部限定の信頼関係を借りている）、WSTGの説明（バックエンドの非公開アドレス/限定到達）に沿って整理すると、報告が強くなる
    - 失敗：実務の落とし穴（ここを潰すと深さが出る）："メイン経路は安全"の罠（変換/プレビュー/ジョブ）、egress制約で"観測できない"問題、"到達できるが読めない"問題
- 仮説C：（入口がXXEであること（CWE-611の観点））
  - 次の検証：CWE-611は、外部実体参照を不適切に制限した場合に「ローカルファイル読み取り等」を引き起こし得ると述べる。これを"参照解決器が危険な既定値で動く"根拠として用いる、報告では「SSRFがある」だけでなく、「XMLパーサ設定不備（CWE-611相当）が入口」と因果で結ぶ
  - 期待する観測：
    - 成功：入口がXXEであること（CWE-611の観点）、CWE-611は、外部実体参照を不適切に制限した場合に「ローカルファイル読み取り等」を引き起こし得ると述べる。これを"参照解決器が危険な既定値で動く"根拠として用いる、報告では「SSRFがある」だけでなく、「XMLパーサ設定不備（CWE-611相当）が入口」と因果で結ぶ
    - 失敗：全経路でDTD/外部参照解決が無効であることを観測で裏取りできた

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - 参照ファイル：`04_labs/02_web/05_input/08_xxe_to_ssrf_internal_reachability/`
- 取得する証跡（目的ベースで最小限）：
  - OOBログ（DNS/HTTP）：時刻・宛先・回数（相関キー）、アプリログ：request_id/job_id、例外、処理開始・完了時刻、ネットワークログ：プロキシ/FW/DNS（あれば）
- 観測の取り方（どの視点で差分を見るか）：
  - 目的："内部到達性"の差分を再現する、差分軸（学びが深くなる構成）：経路差分：同期API（即時）／非同期ジョブ（ワーカー）、実行環境差分：フロントは外向き遮断／ワーカーはプロキシ経由のみ許可、など、設定差分：DTD禁止（安全）／DTD許可（危険）、観測差分：OOB（DNS/HTTP）＋ アプリログ（request_id/job_id）＋ プロキシログ、成果物："同じ入力でも、どの実行環境がパースするかで到達性が変わる"ことを図示できる、これを、そのまま本番診断の相関設計（何を見るべきか）に転用する

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 目的：XXE→SSRFは「内部到達性を借りる」連鎖であり、成立根拠は"相関できる観測"で取る。

# 実務の形：

# - 1リクエストに対して request_id / job_id を確保

# - DNS/HTTP（プロキシ含む）の到達ログを、同じ時刻窓で相関

# - DOCTYPE無し/有り 等の差分比較で「外部参照解決が走った」ことを確定する

~~~~

- この例で観測していること：入力→パーサ境界（XXEの前提）、パーサ→リゾルバ境界（外部参照解決）、実行環境境界（どのネットワークから出るか）、ネットワーク到達性境界（internal reachability）
- 出力のどこを見るか（注目点）：OOBログ（DNS/HTTP）：時刻・宛先・回数（相関キー）、アプリログ：request_id/job_id、例外、処理開始・完了時刻、ネットワークログ：プロキシ/FW/DNS（あれば）、内部到達（または内部向け相互作用）が相関付きで確認できた
- この例が使えないケース（前提が崩れるケース）：XML入力を扱う境界が存在しない場合、またはXMLパースが発生しない場合

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V5 Validation, Sanitization and Encoding
  - 該当要件（可能ならID）：V5.1.1、V5.1.2、V5.2.1
  - このファイルの内容が「満たす/破れる」ポイント：
    - 満たす/破れる点：XMLパーサが外部参照を解決できる状態は、アプリが"意図せずURLフェッチ機能"を持つのと同義。内部ネットワーク・メタデータ・管理系など「ユーザから直アクセスできない領域」に到達し得るため、入力→実行境界として閉じる（DTD/外部実体/外部サブセット/参照解決器の無効化が本体）
- WSTG：
  - 該当カテゴリ/テスト観点：WSTG-INPV-07 Testing for XML Injection、WSTG-INPV-08 Testing for SSRF
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：
    - SSRFテスト観点：アプリサーバが内部到達性を持つこと自体がリスクで、非公開アドレス/限定ホストへのアクセスが成立するかを評価する。XXE由来SSRFは「XML入力→パーサ→外部参照解決」が入口である点が差分
- PTES：
  - 該当フェーズ：Vulnerability Analysis、Exploitation、Reporting
  - 前後フェーズとの繋がり（1行）：XMLを扱う経路ごとに"どの実行環境が外へ/内へ出られるか"をモデル化（フロント/ワーカー/変換基盤/プロキシ/DNS）、到達性（internal reachability）の成立根拠は、(A)OOB観測、(B)内部応答の反映、(C)タイムアウト差分、(D)内部副作用ログ、のいずれかで「内部へ出た」を確定する（再現条件を固定する）、修正は"SSRF対策"ではなく、まずXXEの入口（パーサ設定）を閉じる。残余リスクとして、変換基盤のegress制御・ネットワーク分離・監視の多層化を提示する
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Discovery、Initial Access
  - 攻撃者の目的（この技術が支える意図）：XXE→SSRFは、攻撃者が「被害者サーバの到達性」を借りて内部資源へアクセスする連鎖。内部サービス探索・メタデータ/資格情報の露出など、後続行動（横展開/クラウド権限奪取）へ接続し得る

## 参考（必要最小限）
- OWASP XXE Prevention Cheat Sheet（DTD無効化が最も安全）
- OWASP XML Security Cheat Sheet（XML起点のSSRFの位置づけ）
- CWE-611（外部実体参照制限不備の影響）
- OWASP WSTG：SSRFテスト（内部バックエンド到達性の観点）
- PortSwigger：XXE / SSRF（XXEがバックエンドと相互作用し得る点、SSRFの定義）
- OWASP SSRF Prevention Cheat Sheet（防御観点の整理）

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/05_input_08_xxe_01_parser（doctype_entity）.md`
- `01_topics/02_web/05_input_08_xxe_02_blind（oob）.md`
- `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`

---

## 深掘りリンク（最大8）
- `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
- `01_topics/02_web/05_input_08_xxe_01_parser（doctype_entity）.md`
- `01_topics/02_web/05_input_08_xxe_02_blind（oob）.md`
- `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`
- `01_topics/02_web/04_api_00_権限伝播・入力・バックエンド連携.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `04_labs/02_web/05_input/08_xxe_to_ssrf_internal_reachability/`
