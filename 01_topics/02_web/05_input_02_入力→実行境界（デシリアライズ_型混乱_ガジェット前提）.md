# 05_input_02_入力→実行境界（デシリアライズ_型混乱_ガジェット前提）

## 目的（この技術で到達する状態）
- 「JSONを受けている＝危険」ではなく、**どこで“デシリアライズ（復元）”が走るか**を観測→差分で確定できる。
- エラーや挙動差を、**型・復元処理・検証位置（入力前/復元後）**として説明できる。
- 実務で重要な判断（成立・不成立・不明）を、**証跡（通信・ログ・例外）に基づいて**出せる。

## 前提（対象・範囲・想定）
- 対象：API（JSON/XML等）、メッセージング、ファイルアップロード、セッション保存、ジョブ投入など「構造化データ」を受け取る機能。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - 観測点（固定）：Proxyログ（Content-Type、ボディ構造、レスポンス差分（Status/Body/Headers））、必要時（アプリ例外ログ、入口ログ、クラウド監査ログ（例外の相関））
  - デシリアライズは"入力の復元（構造化→オブジェクト化）"が境界になり、検証は実装依存が強いので根拠設計が重要。入力処理の境界として、構造化データ（JSON/XML/Binary等）がどこで"型"を持つか、どこで"復元処理"が走るかを観測→差分で確定する。
- できること/やらないこと（安全に検証する範囲）：
  - できること：どこで"デシリアライズ（復元）"が走るかを観測→差分で確定できる、エラーや挙動差を、型・復元処理・検証位置（入力前/復元後）として説明できる
  - やらないこと：内部ライブラリや復元器の具体（実装/ログが必要）、影響の最大範囲（副作用の根拠が必要。無ければ unknown とする）
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
  - `01_topics/02_web/04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## 観測ポイント（何を見ているか：復元処理の境界）
### 1) “復元処理”が発生し得る入口
- APIボディ（JSON/XML/フォームの入れ子）
- Cookie/セッション保存（サーバが状態を復元する設計）
- ジョブ投入（メッセージを復元して処理する）
- ファイル（CSV/Excel/PDF/独自形式）→サーバ側でパースして構造化する

### 2) まず確定するヘッダ・形式
- `Content-Type`（例：application/json 等）
- 文字コード/圧縮
- 送信形（JSONの入れ子、配列、オブジェクト）
- “型”を示唆する要素の有無（特定フィールド名、メタ情報、バージョン）

### 3) 復元の“結果”が見えるサイン
- エラーの種類が変わる（構文エラー／型エラー／検証エラー）
- 例外時のレスポンスが一貫する（同じ箇所で落ちる）
- 同じ入力でも、出力や副作用が変わる（処理分岐が型に依存している）

## 意味→判断→次の一手（デシリアライズを“境界”として扱う）
### 1) 重要なのは「復元前に検証しているか」「復元後に検証しているか」
- 意味：復元後にしか効かない検証（例：型チェック）がある一方、復元自体が危険領域になる場合がある。
- 判断：
  - 構文エラーで落ちる＝復元前の境界に到達している
  - 型エラーで落ちる＝復元後の型境界に到達している
  - 検証エラー（業務ルール違反）＝さらに後段（ビジネス境界）に到達している
- 次の一手：
  - **エラーの層（構文→型→業務）を並べる**。同じ入口で差分を作り、どの層まで到達できるかを確定する。

### 2) “型混乱”は、値ではなく「構造の差分」で起きる
- 意味：危険性の手触りは「文字列が危ない」ではなく、「文字列/数値/配列/オブジェクト」のような構造差分で現れることが多い。
- 判断：
  - 値を変えても同じ結果だが、構造を変えると結果が変わる＝型境界が存在する可能性
- 次の一手：
  - まずは**構造だけ**を最小変更（例：単値↔配列、null、入れ子）し、挙動差をProxyで保存する。

### 3) 影響説明は“実行”より前に「到達範囲」と「副作用」で固める
- 意味：この領域は実装依存が強く、推測で過大評価しやすい。
- 判断：
  - 例外や挙動差があっても、即「重大」と断言しない（根拠が足りないなら unknown）
- 次の一手：
  - 到達範囲（どの処理まで進むか）と副作用（DB更新、ジョブ生成、外部通知など）を、ケースに事実として残す。

## 失敗パターンの読み替え（誤判定を防ぐ）
- 400（Bad Request）：構文/パース境界で止まっている可能性（復元前）
- 422（Validation Error）等：復元後の検証境界で止まっている可能性
- 500（例外）：復元処理や型処理で落ちている可能性（ただし再現性とログ根拠が必要）
- 200だが結果が欠ける：型の解釈違いで処理分岐が変わっている可能性（差分で追う）

## 手を動かす検証（最小：差分セット）
> ここは危険な実行手順ではなく、「境界を特定する差分」の型だけを固定する。

~~~~
# 目的：復元処理（デシリアライズ）の境界を、構造差分で特定する

# 差分セット（最小）
# A) 正常リクエスト（基準）をProxyで保存（Content-Type/ボディ/レスポンス）
# B) 構造だけを最小変更（例：単値↔配列、null、入れ子の有無）して送る
# C) フィールドの順序・未知フィールド追加など、復元処理がどう扱うか差分を見る
# D) 例外が出る場合：再現性・時刻・リクエストID（あれば）を記録し、ログと相関する

# 記録すべきもの
# - 入口（エンドポイント/機能）
# - 形式（Content-Type）
# - 変更点（構造差分の要約）
# - 結果（Status/Bodyの差分）
# - 結論（成立・不成立・不明）と根拠（Proxyログ/例外ログの場所）
~~~~
- この例で観測していること：
  - 復元処理（デシリアライズ）の境界を、構造差分で特定する
- 出力のどこを見るか（注目点）：
  - どの入口で復元処理の境界に到達しているか（構文→型→業務の層）、構造差分で挙動が変わるか（型境界が存在するか）、例外の再現性があるか（境界が安定しているか）
- この例が使えないケース（前提が崩れるケース）：
  - 構造化データを受け取らない機能の場合：この観測は適用できない

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：400が多く、何が原因か分からない
- 次に試すこと
  - 基準リクエストと、構造差分の1点変更を並べ、どの層で落ちるか（構文/型/検証）を分類する
- 期待する観測
  - “どの境界まで到達するか”を yes/no/unknown で言える

### 仮説B：500が出るが偶発かもしれない
- 次に試すこと
  - 同条件で再現性を確認し、時刻・リクエストID・ログ相関を揃える（根拠が無いなら unknown）
- 期待する観測
  - 条件依存として説明できる、または観測不足として次の一手が定義できる

### 仮説C：結果が欠けたり、処理分岐が変わる
- 次に試すこと
  - 返却データの差分（項目が落ちる/増える）を記録し、型解釈や条件分岐の可能性として整理する
- 期待する観測
  - 値ではなく構造が境界になっていることを、差分で示せる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - `04_labs/02_web/05_input/02_deserialization_type_confusion/`
- 取得する証跡（目的ベースで最小限）：
  - Proxyログ（Content-Type、ボディ構造、レスポンス差分（Status/Body/Headers））
  - 必要時：アプリ例外ログ、入口ログ、クラウド監査ログ（例外の相関）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
~~~~
# 目的：復元処理（デシリアライズ）の境界を、構造差分で特定する

# 差分セット（最小）
# A) 正常リクエスト（基準）をProxyで保存（Content-Type/ボディ/レスポンス）
# B) 構造だけを最小変更（例：単値↔配列、null、入れ子の有無）して送る
# C) フィールドの順序・未知フィールド追加など、復元処理がどう扱うか差分を見る
# D) 例外が出る場合：再現性・時刻・リクエストID（あれば）を記録し、ログと相関する

# 記録すべきもの
# - 入口（エンドポイント/機能）
# - 形式（Content-Type）
# - 変更点（構造差分の要約）
# - 結果（Status/Bodyの差分）
# - 結論（成立・不成立・不明）と根拠（Proxyログ/例外ログの場所）
~~~~
- この例で観測していること：
  - 復元処理（デシリアライズ）の境界を、構造差分で特定する
- 出力のどこを見るか（注目点）：
  - どの入口で復元処理の境界に到達しているか（構文→型→業務の層）、構造差分で挙動が変わるか（型境界が存在するか）、例外の再現性があるか（境界が安定しているか）
- この例が使えないケース（前提が崩れるケース）：
  - 構造化データを受け取らない機能の場合：この観測は適用できない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V1（アーキテクチャ、設計、脅威モデリング）、V5（入力検証、サニタイズ、エンコーディング）、V12（ファイルとリソース）
  - 該当要件（可能ならID）：V1.1（アーキテクチャ設計）、V5.1（入力検証）、V12.1（ファイルアップロード）
  - このファイルの内容が「満たす/破れる」ポイント：V5（復元処理に入る前後の検証、エラーハンドリング、許容する形式の限定）、V12（ファイル/リソース由来のパース・復元処理の安全性（境界の明確化））。デシリアライズは"入力の復元（構造化→オブジェクト化）"が境界になり、検証は実装依存が強いので根拠設計が重要。
- WSTG：
  - 該当カテゴリ/テスト観点：Input Validation Testing、Injection Testing
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：入力処理の境界として、構造化データ（JSON/XML/Binary等）がどこで"型"を持つか、どこで"復元処理"が走るかを観測→差分で確定する。入力の形式・構造を変えた差分検証で、復元境界の位置を確定する。
- PTES：
  - 該当フェーズ：Vulnerability Analysis、Exploitation
  - 前後フェーズとの繋がり（1行）：Vulnerability Analysis（成立条件の切り分け）→ Exploitation（最小再現）→ Reporting（根拠提示）。推測で危険度を断言しやすい領域のため、unknown を許容し観測点を増やす。推測ではなく、層（構文/型/業務）と証跡で結論を構造化する。
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：TA0002（Execution）、TA0003（Persistence）、TA0004（Privilege Escalation）
  - 攻撃者の目的（この技術が支える意図）：Execution / Persistence / Privilege Escalation へ接続し得る（ただし本リポジトリでは"実行手順"ではなく、境界の位置・成立条件・証跡の取り方に限定）。実行境界に到達し得る領域のため、まず"境界の位置"と"到達範囲"を記録する（行動手順ではなく判断材料）。

## 参考（必要最小限）
- `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
- `01_topics/02_web/04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
- `01_topics/02_web/05_input_01_入力→実行境界（テンプレート注入_SSTI）.md`
- `01_topics/02_web/04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`

---

## 深掘りリンク（最大8）
- 関連 topics：
  - `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
  - `01_topics/02_web/05_input_01_入力→実行境界（テンプレート注入_SSTI）.md`
  - `01_topics/02_web/05_input_13_deserialization_01_json（polymorphism_typehint）.md`
  - `01_topics/02_web/05_input_13_deserialization_02_yaml（anchors_tags）.md`
  - `01_topics/02_web/05_input_13_deserialization_03_xml（object_mapping）.md`
  - `01_topics/02_web/04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`
- 関連 labs / cases：
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
