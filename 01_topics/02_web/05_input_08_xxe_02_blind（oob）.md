# 05_input_08_xxe_02_blind（oob）

## 目的（この技術で到達する状態）
- Blind XXEを「見えないから分からない」から脱却し、次の4層で"成立根拠"を作れるようにする。
  1) Parser境界：DOCTYPE/DTD/ENTITY が受理される（前ファイル）
  2) Resolver境界：外部参照（外部実体/外部サブセット/URI解決）を試みる
  3) Egress境界：DNS/HTTP/Proxyなど、外向き相互作用が出る（あるいは抑止される）
  4) 観測境界：アプリ応答ではなく、外部ログ（DNS/HTTP）・例外差分・時間差分・副作用で証拠化する
- 実務で「再現性のある報告」に必要な要素（相関キー、ログ源、環境条件、例外経路のスコープ）を固定できる。
- 次ファイル（XXE→SSRF連鎖）に地続きで進められる（Blind/OOBで得た"到達性の現実"を、そのまま内部到達性評価へ使う）。

## 前提（対象・範囲・想定）
- 対象：XML入力を扱う境界、XMLパース地点、API/ファイル/サードパーティ処理、XMLを扱う経路（API、ファイル、生成・変換）、同期レスポンスにXML評価結果を出さない（例：在庫チェック、配送見積、検証API、構文チェック、取り込みAPI（登録だけ））、非同期で処理される（例：キュー投入→ワーカー変換→DB保存、プレビュー生成、監査ログ投入）、変換/正規化レイヤが間にある（例：XML→オブジェクト→別フォーマット、XSLT、テンプレ変換、署名検証（SAML周辺）、SVG/Officeプレビュー）
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - Blindになる典型（返らない設計が多すぎる）：同期レスポンスにXML評価結果を出さない、非同期で処理される、変換/正規化レイヤが間にある、したがって「レスポンスで読めない」は"仕様"であり、脆弱性否定にならない、OOBが"本命"になる理由（攻撃者目線）：返らないなら、外へ出る痕跡（DNS/HTTP）だけで成立を確定できる、さらに、OOBは「内部到達性の現実（DNSだけ出る/HTTPはプロキシ必須）」という"環境情報"を取れる、これが次の一手（内部探索・SSRF連鎖・防御回避）を決める
- できること/やらないこと（安全に検証する範囲）：
  - できること：Parser境界（DOCTYPE/DTD/ENTITY が受理される）、Resolver境界（外部参照（外部実体/外部サブセット/URI解決）を試みる）、Egress境界（DNS/HTTP/Proxyなど、外向き相互作用が出る（あるいは抑止される））、観測境界（アプリ応答ではなく、外部ログ（DNS/HTTP）・例外差分・時間差分・副作用で証拠化する）
  - やらないこと：影響実証は最小限（成立根拠の確定まで）。高負荷/外部到達/大量出力は避ける
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/05_input_08_xxe_01_parser（doctype_entity）.md`
  - `01_topics/02_web/05_input_08_xxe_03_to_ssrf（internal_reachability）.md`
  - `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - XML入力を扱う境界、XMLパース地点、API/ファイル/サードパーティ処理、XMLを扱う経路（API、ファイル、生成・変換）、同期レスポンスにXML評価結果を出さない、非同期で処理される、変換/正規化レイヤが間にある
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：
    - Parser境界（前提）：DOCTYPE/DTD が拒否されるなら、Blind/OOB以前に"成立の前提"が崩れる、ただし「メインAPIは拒否するが、ファイル処理/変換/旧機能で別パーサが生きている」が最頻、ここで"経路差分（同じ機能でも別エンドポイント/別処理系）"を探すのが実務の勝ち筋
  - 信頼境界（外部連携・第三者・越境ポイント）：
    - Resolver境界（外部参照を"解決しに行くか"）：Blind XXEで最重要なのは「展開して返すか」ではなく、まず「取りに行くか」、典型の"取りに行く口"：外部実体（一般実体 / パラメータ実体）、外部サブセット（DTD外部参照）、XInclude（XML仕様の外部取り込み。利用している場合は別口になる）、ライブラリ独自のリゾルバ（カタログ、URIリライタ、プロキシ透過）、重要：Resolverは"アプリの意図"ではなく"パーサの設定と実装"で決まる、例：外部一般実体を止めても、外部サブセットが生きている、例：検証（validation）有効時のみ外部を取りに行く、など実装差分がある（言語/ライブラリで揺れる）
    - Egress境界（外へ出られるか）：OOBが観測できない原因の大半は"脆弱性が無い"ではなく"出られない/観測できない"、パターン分類（診断の分岐に使う）：DNSだけ出る（HTTPは遮断 or プロキシ必須）、HTTPは出るがDNSが社内解決に固定（外部ドメインが引けない）、直IP宛は遮断、FQDNのみ許可、SNIやHostで制限、egressはホワイトリスト制（特定ドメインのみ）、ワーカー環境だけ外へ出る（フロントは出ない）／逆もある、ここで得られる"環境の現実"は、報告で「再現条件」として必須
  - 権限境界（権限の切替/伝播/委任）：
    - 観測境界（成立根拠をどう残すか）：Blindで勝つには、最初から「証跡が残る観測設計」にする、OOBログ：DNS/HTTP（観測点のタイムスタンプが最重要）、アプリログ：request_id、job_id、ワーカーID、例外スタック（可能なら）、ネットワークログ：プロキシ、FW、DNSリゾルバログ（組織の運用次第で入手可能性が変わる）、差分：DOCTYPE無し/有り、外部参照無し/有り、で"同一条件比較"を作る
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - OOB相互作用で成立を確定（検出の王道）：外部観測点に「ターゲット環境からの到達」を残す、XMLパーサが外部参照解決を試みた（Resolver境界が開いている）、どの経路（同期/非同期、どの環境）で解決が走ったか（時刻相関で推定できる）、egressの現実（DNSのみ/HTTP不可/プロキシ経由など）が見える、よくある落とし穴（薄くなる原因）："いつ飛んだか"の相関が取れていない（非同期だと数十秒〜数分ズレる）、複数インスタンスでリトライが走り、ログが複数回になる（逆に根拠になるが整理が必要）、DNSキャッシュ（負のキャッシュ含む）で"1回しか出ない/出たり出なかったり"が起きる、監視点がHTTPのみで、実際はDNSだけ出ている（観測点ミスマッチ）
  - エラー差分で"解決を試みた痕跡"を取る（OOB不可の次善策）：アプリ応答（またはログ）から、外部参照解決が試行された証拠を得る、典型の材料：参照解決失敗の例外（名前解決失敗、接続拒否、タイムアウト）、DTD禁止/外部実体禁止の明示エラー（逆に"対策が効いている"根拠になる）、注意：エラーは環境差（WAF、ゲートウェイ、例外隠蔽）で消える、"エラーが出ない＝安全"ではない（非同期で握りつぶす設計がある）
  - 時間差分・副作用（最弱根拠なので補助に留める）：外部解決タイムアウトで遅延が出る場合がある、副作用：内部向けアクセス（内部DNS、メタデータ、内部HTTP）により別の監視に痕跡が出る場合がある、ただし誤判定が多いので、OOB/エラー差分が取れるなら主根拠にしない

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - OOB相互作用で成立を確定（検出の王道）：外部観測点に「ターゲット環境からの到達」を残す、XMLパーサが外部参照解決を試みた（Resolver境界が開いている）、どの経路（同期/非同期、どの環境）で解決が走ったか（時刻相関で推定できる）、egressの現実（DNSのみ/HTTP不可/プロキシ経由など）が見える
- 何が"推定"できるか（推定の根拠/前提）：
  - エラー差分で"解決を試みた痕跡"を取る（OOB不可の次善策）：アプリ応答（またはログ）から、外部参照解決が試行された証拠を得る、典型の材料：参照解決失敗の例外（名前解決失敗、接続拒否、タイムアウト）、DTD禁止/外部実体禁止の明示エラー（逆に"対策が効いている"根拠になる）
- 何は"言えない"か（不足情報・観測限界）：
  - 時間差分・副作用（最弱根拠なので補助に留める）：外部解決タイムアウトで遅延が出る場合がある、副作用：内部向けアクセス（内部DNS、メタデータ、内部HTTP）により別の監視に痕跡が出る場合がある、ただし誤判定が多いので、OOB/エラー差分が取れるなら主根拠にしない、よくある落とし穴（薄くなる原因）："いつ飛んだか"の相関が取れていない（非同期だと数十秒〜数分ズレる）、複数インスタンスでリトライが走り、ログが複数回になる（逆に根拠になるが整理が必要）、DNSキャッシュ（負のキャッシュ含む）で"1回しか出ない/出たり出なかったり"が起きる、監視点がHTTPのみで、実際はDNSだけ出ている（観測点ミスマッチ）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：OOB相互作用で成立を確定（検出の王道） → 外部観測点に「ターゲット環境からの到達」を残す、XMLパーサが外部参照解決を試みた（Resolver境界が開いている）、どの経路（同期/非同期、どの環境）で解決が走ったか（時刻相関で推定できる）、egressの現実（DNSのみ/HTTP不可/プロキシ経由など）が見える
  - パターンB：エラー差分で"解決を試みた痕跡"を取る（OOB不可の次善策） → アプリ応答（またはログ）から、外部参照解決が試行された証拠を得る、典型の材料：参照解決失敗の例外（名前解決失敗、接続拒否、タイムアウト）、DTD禁止/外部実体禁止の明示エラー（逆に"対策が効いている"根拠になる）、注意：エラーは環境差（WAF、ゲートウェイ、例外隠蔽）で消える、"エラーが出ない＝安全"ではない（非同期で握りつぶす設計がある）
  - パターンC：時間差分・副作用（最弱根拠なので補助に留める） → 外部解決タイムアウトで遅延が出る場合がある、副作用：内部向けアクセス（内部DNS、メタデータ、内部HTTP）により別の監視に痕跡が出る場合がある、ただし誤判定が多いので、OOB/エラー差分が取れるなら主根拠にしない

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - "XMLを受け取る面"を探す（表のUIではなく、連携・アップロード・変換・プレビューに寄る）、成立根拠としてまず狙うのは「DOCTYPEを受理するか」、受理される＝攻撃面として優先度が上がる（外部参照/OOB/DoSへ伸びる）、次に「外部参照を解決するか」は、環境依存が大きいので観測（DNS/HTTP egress）で確定する（次ファイルで深掘り）
- 優先度の付け方（時間制約がある場合の順序）：
  - まず見る：Parser境界（DOCTYPE/DTD/ENTITY が受理される）、Resolver境界（外部参照（外部実体/外部サブセット/URI解決）を試みる）、次に見る：Egress境界（DNS/HTTP/Proxyなど、外向き相互作用が出る（あるいは抑止される））、最後に見る：観測境界（アプリ応答ではなく、外部ログ（DNS/HTTP）・例外差分・時間差分・副作用で証拠化する）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：Blind XXEを「見えないから分からない」から脱却し、次の4層で"成立根拠"を作れるようにする、Parser境界：DOCTYPE/DTD/ENTITY が受理される（前ファイル）、Resolver境界：外部参照（外部実体/外部サブセット/URI解決）を試みる、Egress境界：DNS/HTTP/Proxyなど、外向き相互作用が出る（あるいは抑止される）、観測境界：アプリ応答ではなく、外部ログ（DNS/HTTP）・例外差分・時間差分・副作用で証拠化する
  - 攻め筋2：実務で「再現性のある報告」に必要な要素（相関キー、ログ源、環境条件、例外経路のスコープ）を固定できる、次ファイル（XXE→SSRF連鎖）に地続きで進められる（Blind/OOBで得た"到達性の現実"を、そのまま内部到達性評価へ使う）
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 実務の"詰め方"チェックリスト（薄さを防ぐ）：パース地点の確定（XXEの前提）、非同期性の確定（時刻相関が生命線）、egressの現実を確定（DNS/HTTP/Proxy）、設定漏れのスコープ確定（修正提案の質が決まる）

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：（OOB相互作用で成立を確定（検出の王道））
  - 次の検証：外部観測点に「ターゲット環境からの到達」を残す、XMLパーサが外部参照解決を試みた（Resolver境界が開いている）、どの経路（同期/非同期、どの環境）で解決が走ったか（時刻相関で推定できる）、egressの現実（DNSのみ/HTTP不可/プロキシ経由など）が見える
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：OOB相互作用が相関付きで確認できた、OOBログ：時刻、宛先、種別（DNS/HTTP）、回数、アプリログ：request_id/job_id、例外有無、ネットワークログ：プロキシ/FW/DNS（可能なら）
    - 失敗：よくある落とし穴（薄くなる原因）："いつ飛んだか"の相関が取れていない（非同期だと数十秒〜数分ズレる）、複数インスタンスでリトライが走り、ログが複数回になる（逆に根拠になるが整理が必要）、DNSキャッシュ（負のキャッシュ含む）で"1回しか出ない/出たり出なかったり"が起きる、監視点がHTTPのみで、実際はDNSだけ出ている（観測点ミスマッチ）
- 仮説B：（エラー差分で"解決を試みた痕跡"を取る（OOB不可の次善策））
  - 次の検証：アプリ応答（またはログ）から、外部参照解決が試行された証拠を得る、典型の材料：参照解決失敗の例外（名前解決失敗、接続拒否、タイムアウト）、DTD禁止/外部実体禁止の明示エラー（逆に"対策が効いている"根拠になる）
  - 期待する観測：
    - 成功：エラー差分で"解決を試みた痕跡"を取る（OOB不可の次善策）、アプリ応答（またはログ）から、外部参照解決が試行された証拠を得る、典型の材料：参照解決失敗の例外（名前解決失敗、接続拒否、タイムアウト）、DTD禁止/外部実体禁止の明示エラー（逆に"対策が効いている"根拠になる）
    - 失敗：エラーは環境差（WAF、ゲートウェイ、例外隠蔽）で消える、"エラーが出ない＝安全"ではない（非同期で握りつぶす設計がある）
- 仮説C：（時間差分・副作用（最弱根拠なので補助に留める））
  - 次の検証：外部解決タイムアウトで遅延が出る場合がある、副作用：内部向けアクセス（内部DNS、メタデータ、内部HTTP）により別の監視に痕跡が出る場合がある
  - 期待する観測：
    - 成功：時間差分・副作用（最弱根拠なので補助に留める）、外部解決タイムアウトで遅延が出る場合がある、副作用：内部向けアクセス（内部DNS、メタデータ、内部HTTP）により別の監視に痕跡が出る場合がある
    - 失敗：ただし誤判定が多いので、OOB/エラー差分が取れるなら主根拠にしない

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - 参照ファイル：`04_labs/02_web/05_input/08_xxe_blind_oob/`
- 取得する証跡（目的ベースで最小限）：
  - OOBログ：DNS/HTTP（観測点のタイムスタンプが最重要）、アプリログ：request_id、job_id、ワーカーID、例外スタック（可能なら）、ネットワークログ：プロキシ、FW、DNSリゾルバログ（組織の運用次第で入手可能性が変わる）、差分：DOCTYPE無し/有り、外部参照無し/有り、で"同一条件比較"を作る
- 観測の取り方（どの視点で差分を見るか）：
  - 目的：Blind/OOBを「検出できる」「検出できない」両方の状態で再現し、判断軸を固定する、最小構成（現実寄り）：経路：同期API（レスポンスに出ない）＋ 非同期ジョブ（キュー→ワーカー）、パーサ差分：安全設定（DTD禁止）／危険設定（DTD許可＋外部参照解決）、egress差分：DNSのみ許可／HTTPはプロキシ必須／完全遮断、観測：DNSログ、プロキシログ、アプリログ（request_id/job_id）、成果物（keda-lab的に残す）："観測点が無いとunknownになる"ケースも含めた、判断の分岐図、例外経路（アップロード→変換）で設定漏れが起きるデモ（実務の最頻）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 目的：Blind/OOBの本体は「外部参照解決」が生きていること。
# 対策は入力フィルタではなく、XMLパーサ設定で DTD/外部実体/外部サブセットを止めること。
# 例（概念）：
# - DOCTYPE を禁止
# - 外部一般実体 / 外部パラメータ実体 を無効化
# - 参照解決器（XmlResolver等）を null/無効化
# - 実体展開の上限（安全処理）を有効化
~~~~

- この例で観測していること：Parser境界（DOCTYPE/DTD/ENTITY が受理される）、Resolver境界（外部参照（外部実体/外部サブセット/URI解決）を試みる）、Egress境界（DNS/HTTP/Proxyなど、外向き相互作用が出る（あるいは抑止される））、観測境界（アプリ応答ではなく、外部ログ（DNS/HTTP）・例外差分・時間差分・副作用で証拠化する）
- 出力のどこを見るか（注目点）：OOBログ：DNS/HTTP（観測点のタイムスタンプが最重要）、アプリログ：request_id、job_id、ワーカーID、例外スタック（可能なら）、ネットワークログ：プロキシ、FW、DNSリゾルバログ（組織の運用次第で入手可能性が変わる）、差分：DOCTYPE無し/有り、外部参照無し/有り、で"同一条件比較"を作る
- この例が使えないケース（前提が崩れるケース）：XML入力を扱う境界が存在しない場合、またはXMLパースが発生しない場合

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V5 Validation, Sanitization and Encoding
  - 該当要件（可能ならID）：V5.1.1、V5.1.2、V5.2.1
  - このファイルの内容が「満たす/破れる」ポイント：
    - 満たす/破れる点：XML入力の"解釈機構"が外部資源（DNS/HTTP/ファイル）へ到達しないこと（DTD/外部実体/外部サブセット/実体展開/参照解決器の無効化）、Blind/OOBは「レスポンスに出ない」ことを安全根拠にできない。外向き相互作用（OOB）を"成立根拠"として取れるため、対策はパーサ設定＋egress制御＋監視の多層で閉じる
- WSTG：
  - 該当カテゴリ/テスト観点：WSTG-INPV-07 Testing for XML Injection
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：
    - Input Validation Testing（XML関連）として、(1) XMLパース地点の特定、(2) DOCTYPE/ENTITYが受理されるか、(3) 外部参照解決の有無、(4) 例外経路（アップロード/変換/ジョブ）での設定漏れ、を観測で確定する
- PTES：
  - 該当フェーズ：Vulnerability Analysis、Exploitation、Reporting
  - 前後フェーズとの繋がり（1行）：XMLを扱う経路・パーサ・実行コンテキスト（同期/非同期、ワーカー、プロキシ、DNS）をモデル化、Blindはレスポンス差分が弱いので、OOB（DNS/HTTPなど）・エラー差分・時間差分・副作用（内部アクセス）を"証拠"として設計する（再現条件を固定する）、原因を「(A)パーサ設定」「(B)参照解決器」「(C)egress」「(D)監視/ログ」の4分解で提示し、修正は(A)(B)が主、(C)(D)は多層化として提案する
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Discovery、Initial Access
  - 攻撃者の目的（この技術が支える意図）：Blind XXEは"入力→パーサ→外部相互作用"という実行境界の破綻で、外向き通信（DNS/HTTP）を伴う検知・探索の典型。目的は情報取得そのものより、内部到達性（SSRF連鎖・内部探索）や環境指紋化（プロキシ/名前解決/ネットワーク分離の把握）へ繋がる

## 参考（必要最小限）
- OWASP Cheat Sheet（XXE Prevention / XML Security）
- OWASP Community（XXE Processing）
- PortSwigger（Blind XXE / OAST / Error-based）
- JPCERT/CC（Java向けのXXE防止指針：外部実体の扱いと前提）

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/05_input_08_xxe_01_parser（doctype_entity）.md`
- `01_topics/02_web/05_input_08_xxe_03_to_ssrf（internal_reachability）.md`
- `01_topics/02_web/04_api_09_error_model_情報漏えい（例外_スタック）.md`

---

## 深掘りリンク（最大8）
- `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
- `01_topics/02_web/05_input_08_xxe_01_parser（doctype_entity）.md`
- `01_topics/02_web/05_input_08_xxe_03_to_ssrf（internal_reachability）.md`
- `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`
- `01_topics/02_web/04_api_09_error_model_情報漏えい（例外_スタック）.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `04_labs/02_web/05_input/08_xxe_blind_oob/`
