# 06_config_05_cache_control_機微レスポンスの境界
Cache-Control（機微レスポンスの境界）：認証が正しくても"キャッシュ"が第三者影響を作る

---

## 目的（この技術で到達する状態）
- 機微レスポンスが **どのキャッシュ層（ブラウザ/共有/中継生成）に残り得るか**を境界で説明できる。
- 実務で頻出の事故パターンを、観測→意味→次の一手で所見化できる。
  - 200だけでなく、302/401/403/404/500 の"例外レスポンス"がキャッシュされる
  - CDNがHTMLを最適化（圧縮/正規化）し、Vary不足で混線する
  - "ログアウト後に戻る"など、ブラウザ側の保存（履歴/端末共有）が事故になる

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CDN → WAF → Reverse Proxy（Nginx/Envoy等）→ App（Spring/Node/Rails等）
  - 個人化HTML（氏名/通知/履歴）、テナント依存（B2Bでサブドメイン/ヘッダ/tenant_idで分岐）、権限依存（adminボタン、内部メニュー）、エクスポート（CSV/PDF、請求書、本人確認）
- できること/やらないこと（安全に検証する範囲）：
  - やる：認証前後/権限差/テナント差で同一URLが返る場合のキャッシュ挙動、3xx/4xx/5xxのキャッシュ、共有キャッシュ兆候（Age等）、Varyの適切性を検証する
  - やらないこと：キャッシュ汚染（Poisoning）の攻撃連鎖は別トピックへ接続
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - Cache-Control/Expires/Pragma/Vary等を、機微レスポンスの境界として扱う
    - ブラウザキャッシュ境界：同一端末・同一プロファイル内の共有（端末共有で事故る）
    - 共有キャッシュ境界：CDN/社内Proxy等で**別ユーザに配布**され得る（重大度が跳ね上がる）
    - 中継生成境界：CDN/WAF/Proxyがエラーやリダイレクトを生成し、それ自体をキャッシュし得る
  - 扱わない（別ユニットへ接続）：
    - キャッシュ汚染（Poisoning）の攻撃連鎖 → `05_input_19_cache_poisoning_02_unkeyed（headers_params）.md` / `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - "同じURL"で状態差を作る（最小差分セット）：未ログイン（302/401）→ ログイン（200）→ 権限不足（403）で同一URLの挙動差、テナント差（別サブドメイン/別tenant_id）で同一パスの挙動差、エラー（500）を最小回数で誘発し、ヘッダと生成主体を記録
  - 重点ヘッダ（最小）：`Cache-Control` / `Expires` / `Pragma`、`Vary`（特にOrigin/Authorization/Accept-Encoding等）、共有キャッシュ兆候（環境依存：`Age` / `Via` / `X-Cache` / `CF-Cache-Status` 等）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：どのキャッシュ層（ブラウザ/共有/中継生成）に残り得るか
  - 信頼境界（外部連携・第三者・越境ポイント）：CDN/社内Proxy等で**別ユーザに配布**され得る（重大度が跳ね上がる）
  - 権限境界（権限の切替/伝播/委任）：認証前後/権限差/テナント差で同一URLが返る場合のキャッシュ挙動
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 機微に `public` / `s-maxage`：共有キャッシュ境界で事故り得る（第三者影響の可能性）
  - 機微に `no-store` / `private`：少なくともHTTPキャッシュ再利用を抑止する意思がある（次は適用漏れ/例外の確認）
  - 3xx/4xx/5xxで制御が抜ける：例外経路が"配布"され、混線や可用性事故に繋がり得る

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 機微に `public` / `s-maxage`：共有キャッシュ境界で事故り得る（第三者影響の可能性）
  - 機微に `no-store` / `private`：少なくともHTTPキャッシュ再利用を抑止する意思がある（次は適用漏れ/例外の確認）
  - 3xx/4xx/5xxで制御が抜ける：例外経路が"配布"され、混線や可用性事故に繋がり得る
- 何が"推定"できるか（推定の根拠/前提）：
  - どのキャッシュ層（ブラウザ/共有/中継生成）に残り得るか
  - 共有してよい範囲（匿名・静的・個人化なし）を明文化できるか
- 何は"言えない"か（不足情報・観測限界）：
  - すべてのキャッシュ層での挙動の完全な確定（観測範囲に依存）
  - すべての例外レスポンスを網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：機微に `no-store` / `private`（健全） → 少なくともHTTPキャッシュ再利用を抑止する意思がある（次は適用漏れ/例外の確認）
  - パターンB：機微に `public` / `s-maxage`（境界が崩れている） → 共有キャッシュ境界で事故り得る（第三者影響の可能性）
  - パターンC：3xx/4xx/5xxで制御が抜ける（例外経路が"配布"される） → 混線や可用性事故に繋がり得る

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - 認証突破より、配布層の混線の方が早い場合がある（特にB2B/多層CDN）
  - 狙われやすい条件：認証前後で同一URL（/dashboard等）、テナント差がHost/ヘッダ依存、エラー/リダイレクトがキャッシュされる（"一時的に全員がログインできない"等の事故）
- 優先度の付け方（時間制約がある場合の順序）：
  1) 認証前後で同一URL（/dashboard等） → 最優先で重大
  2) テナント差がHost/ヘッダ依存 → 信頼境界が崩れる可能性
  3) エラー/リダイレクトがキャッシュされる → 可用性事故に繋がり得る
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：機微は本来no-store/privateで閉じるべき（止血優先） → 機微ページ/管理/エクスポート/API（個人化）を分類し、no-store/privateの適用漏れを特定。3xx/4xx/5xxも含めて一貫適用（例外テンプレで抜けないようにする）。CDN側の上書き（cache everything等）設定有無を確認
  - 攻め筋2：性能要件で共有キャッシュが必要（設計勝負） → 共有してよい範囲（匿名・静的・個人化なし）を明文化。キー設計（Vary/正規化/Host扱い）を仕様化し、監視（hit/miss、bypass理由）を要件化。攻撃面としてはCache Poisoning観点へ接続し、混線が起きないことを"証跡"で固める
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - CDN/Proxyの設定（ルール/例外/正規化）をアプリと一致させる

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：機微は本来no-store/privateで閉じるべき（止血優先）
  - 成立条件：
    - 機微ページ/管理/エクスポート/API（個人化）が存在する
  - 次の検証：
    - 機微ページ/管理/エクスポート/API（個人化）を分類し、no-store/privateの適用漏れを特定
    - 3xx/4xx/5xxも含めて一貫適用（例外テンプレで抜けないようにする）
    - CDN側の上書き（cache everything等）設定有無を確認
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：機微に `no-store` / `private` が適用されている
    - 失敗：機微に `public` / `s-maxage` が適用されている（共有キャッシュ境界で事故り得る）
- 仮説B：性能要件で共有キャッシュが必要（設計勝負）
  - 成立条件：
    - 性能要件で共有キャッシュが必要な場合
  - 次の検証：
    - 共有してよい範囲（匿名・静的・個人化なし）を明文化
    - キー設計（Vary/正規化/Host扱い）を仕様化し、監視（hit/miss、bypass理由）を要件化
    - 攻撃面としてはCache Poisoning観点へ接続し、混線が起きないことを"証跡"で固める
  - 期待する観測：
    - 成功：共有してよい範囲（匿名・静的・個人化なし）を明文化できる
    - 失敗：共有キャッシュが必要だが、適切な設計ができていない

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/05_cache_control_sensitive_boundary/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - "同じURL"で状態差を作る（最小差分セット）：未ログイン（302/401）→ ログイン（200）→ 権限不足（403）で同一URLの挙動差、テナント差（別サブドメイン/別tenant_id）で同一パスの挙動差、エラー（500）を最小回数で誘発し、ヘッダと生成主体を記録
  - 重点ヘッダ（最小）：`Cache-Control` / `Expires` / `Pragma`、`Vary`（特にOrigin/Authorization/Accept-Encoding等）、共有キャッシュ兆候（環境依存：`Age` / `Via` / `X-Cache` / `CF-Cache-Status` 等）
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1："同じURL"で状態差を作る（最小差分セット）
  - 視点2：重点ヘッダ（最小）を観測
  - 視点3：共有キャッシュ兆候（環境依存）を観測
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/cache_control_sensitive 2>/dev/null
    cd ~/keda_evidence/cache_control_sensitive
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小差分セット** のみ（未ログイン（302/401）→ ログイン（200）→ 権限不足（403）で同一URLの挙動差）
      - 認証前後/権限差/テナント差で同一URLが返る場合のキャッシュ挙動、3xx/4xx/5xxのキャッシュ、共有キャッシュ兆候（Age等）、Varyの適切性を検証する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、同一URL、状態差（未ログイン/ログイン/権限不足）、テナント差、エラー（500）、重点ヘッダ（Cache-Control/Expires/Pragma/Vary）、共有キャッシュ兆候

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 最小差分で見る：
# 1) 未ログイン(302/401) と ログイン(200) と 権限不足(403) を同一URLで比較
# 2) Cache-Control / Vary / Age等を記録
# 3) 例外レスポンス（3xx/4xx/5xx）でも制御が抜けていないか確認
~~~~

- この例で観測していること：
  - 最小差分で見る（未ログイン(302/401) と ログイン(200) と 権限不足(403) を同一URLで比較）
- 出力のどこを見るか（注目点）：
  - Cache-Control / Vary / Age等、例外レスポンス（3xx/4xx/5xx）でも制御が抜けていないか確認
- この例が使えないケース（前提が崩れるケース）：
  - 認証前後/権限差/テナント差で同一URLが返らない場合、観測できない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用
  - 該当要件（可能ならID）：機微レスポンスが共有キャッシュ（CDN/Proxy）に残ると、認証・認可が正しくても"配布層"で境界が破れ、誤配布・混線・情報漏えいが起き得る。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：機微レスポンスが共有キャッシュ（CDN/Proxy）に残ると、認証・認可が正しくても"配布層"で境界が破れ、誤配布・混線・情報漏えいが起き得る。
    - 満たす：機微はno-store/privateを原則とし、共有してよい範囲はキー（Vary/正規化）と運用（例外統制/監視）込みで仕様化する。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：認証前後/権限差/テナント差で同一URLが返る場合のキャッシュ挙動、3xx/4xx/5xxのキャッシュ、共有キャッシュ兆候（Age等）、Varyの適切性を検証する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：脆弱性分析（キャッシュ設計不備）→ 侵害評価（第三者影響の可能性）→ 報告（配布境界・運用要件として提案）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：T1190に接続し得るが、焦点は"配布境界の破綻"
  - 攻撃者の目的（この技術が支える意図）：T1190に接続し得るが、焦点は"配布境界の破綻"。Impact（誤配布/混線）やDefense Evasion（再現性低下）を支える前提として扱う。
  - 参照：https://attack.mitre.org/tactics/TA0001/（Initial Access）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- キャッシュ汚染（Poisoning）：`05_input_19_cache_poisoning_02_unkeyed（headers_params）.md` / `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 関連 topics：`05_input_19_cache_poisoning_02_unkeyed（headers_params）.md`
- 関連 topics：`05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`

---

## 深掘りリンク（最大8）
- `05_input_19_cache_poisoning_02_unkeyed（headers_params）.md`
- `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
- `05_input_18_http_request_smuggling_04_observable_signals（timing_error_cache）.md`

---
