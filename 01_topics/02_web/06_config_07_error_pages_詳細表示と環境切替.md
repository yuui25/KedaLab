# 06_config_07_error_pages_詳細表示と環境切替
エラーページ（詳細表示と環境切替）：例外は"情報境界"と"防御例外"が同時に抜ける場所

---

## 目的（この技術で到達する状態）
- 4xx/5xxを「情報漏えい」だけで終わらせず、**例外経路がセキュリティ制御の例外になっていないか**まで診断できる。
- 実務で使える形で、以下を所見化できる。
  - どの条件（環境/パラメータ/Accept/Host/UA）で詳細が出るか
  - エラー時にヘッダ（CSP/Frame等）やCache-Controlが抜けていないか
  - 追跡のための相関キー（request_id/trace_id）を確実に取る

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CDN → WAF → Reverse Proxy（Nginx/Envoy等）→ App（Spring/Node/Rails等）
  - フレームワークのデバッグ表示が本番に混入（設定/環境変数の誤り）
  - 特定パス（/admin）だけ別テンプレで詳細が出る
  - 特定ヘッダ（Accept: text/html）で詳細ページが返る（APIはJSONで隠れている等）
- できること/やらないこと（安全に検証する範囲）：
  - やる：エラー処理の情報漏えい、例外時のセキュリティヘッダ/キャッシュ制御、生成主体（App/Edge）の切り分けを検証する
  - やらないこと：エラーを意図的に大量に発生させることはしない
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - 詳細エラーの露出（スタック/内部パス/環境名/依存）
    - 例外時の"防御抜け"（ヘッダ・キャッシュ・認可の分断）
    - 生成主体の切り分け（App/Proxy/WAF/CDN）
  - 扱わない（別ユニットへ接続）：
    - エラーの詳細な仕様説明（本プロジェクトは境界と成立根拠を優先）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - ステータス別に"同じページ"を作る：正常（200）と異常（500）で、ヘッダとボディ差分を取る、未ログイン/権限不足（401/403）でも同様に取る（例外テンプレで抜けやすい）
  - 例外時の"必須確認"：`Cache-Control` が機微に対して適切か（エラーキャッシュ事故）、`Content-Security-Policy` / Frame制御が抜けていないか、request_id/trace_id が返ってくるか（ログ側と繋がるか）
- 境界の観点：
  - 情報境界（管理主体・委託先・対象範囲の線引き）：内部構成、依存、ルーティング、設定キーが漏れる
  - 防御境界（外部連携・第三者・越境ポイント）：例外時にヘッダ/キャッシュ制御が抜けると、Clickjackingや誤配布の条件が生まれる
  - 監査境界（権限の切替/伝播/委任）：相関キーが無い/ログが追えないと、検知と再現が破綻する
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 生成主体が変わる（実務の分岐点）：App生成（例外名/スタック/テンプレ名が見える）、Proxy/WAF/CDN生成（独自のエラーページ、キャッシュやブロックの痕跡が混ざる）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 詳細が出る：内部推定が可能になり、次の検証が具体化する（ただし断定はしない）
  - 例外時にヘッダ/キャッシュが抜ける：**例外パスが攻撃者の入口**になり得る
  - 相関キーが無い：再現性と監査が弱く、運用上のリスクが高い
- 何が"推定"できるか（推定の根拠/前提）：
  - どの条件（環境/パラメータ/Accept/Host/UA）で詳細が出るか
  - 生成主体（App/Proxy/WAF/CDN）の切り分け
- 何は"言えない"か（不足情報・観測限界）：
  - すべてのエラー条件を網羅した断定（観測範囲に依存）
  - すべての例外パスを網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：詳細が出る（内部推定が可能になる） → 次の検証が具体化する（ただし断定はしない）
  - パターンB：例外時にヘッダ/キャッシュが抜ける（例外パスが攻撃者の入口） → **例外パスが攻撃者の入口**になり得る
  - パターンC：相関キーが無い（再現性と監査が弱い） → 運用上のリスクが高い

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - 詳細エラーから技術スタック/依存/内部URLを拾い、攻撃面を最短で絞る
  - 例外パス（特定入力で落ちる）を入口に、別の制御（WAF/ヘッダ/キャッシュ）が抜ける条件を探す
- 優先度の付け方（時間制約がある場合の順序）：
  1) 例外時にヘッダ/キャッシュが抜ける（例外パスが攻撃者の入口） → 最優先で重大
  2) 詳細が出る（内部推定が可能になる） → 次の検証が具体化する（ただし断定はしない）
  3) 相関キーが無い（再現性と監査が弱い） → 運用上のリスクが高い
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：アプリ側の設定/例外処理が原因（アプリ修正中心） → どの条件で詳細が出るかを固定（環境差・特定ヘッダ等）。共通エラーハンドラの適用範囲（管理/SSO/API）を確認。相関IDを返し、詳細は保護ログへ集約する設計を要求
  - 攻め筋2：エッジ生成が原因（CDN/WAF/Proxy運用中心） → エッジ生成エラーがキャッシュされ得るか（Cache-Control/Age等）。ルール例外と一致していないか（特定パスだけ挙動が違う）。直オリジン到達で別のエラーが出ないか（資産境界のズレ）
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 生成主体が変わる（実務の分岐点）：App生成（例外名/スタック/テンプレ名が見える）、Proxy/WAF/CDN生成（独自のエラーページ、キャッシュやブロックの痕跡が混ざる）

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：アプリ側の設定/例外処理が原因（アプリ修正中心）
  - 成立条件：
    - アプリ側の設定/例外処理が原因で詳細が出る、または例外時にヘッダ/キャッシュが抜ける
  - 次の検証：
    - どの条件で詳細が出るかを固定（環境差・特定ヘッダ等）
    - 共通エラーハンドラの適用範囲（管理/SSO/API）を確認
    - 相関IDを返し、詳細は保護ログへ集約する設計を要求
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：どの条件で詳細が出るかを固定できる
    - 失敗：アプリ側の設定/例外処理が適切に制御されている
- 仮説B：エッジ生成が原因（CDN/WAF/Proxy運用中心）
  - 成立条件：
    - エッジ生成が原因で詳細が出る、または例外時にヘッダ/キャッシュが抜ける
  - 次の検証：
    - エッジ生成エラーがキャッシュされ得るか（Cache-Control/Age等）
    - ルール例外と一致していないか（特定パスだけ挙動が違う）
    - 直オリジン到達で別のエラーが出ないか（資産境界のズレ）
  - 期待する観測：
    - 成功：エッジ生成が原因であることを特定できる
    - 失敗：エッジ生成が適切に制御されている

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/07_error_pages_boundary/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - ステータス別に"同じページ"を作る：正常（200）と異常（500）で、ヘッダとボディ差分を取る、未ログイン/権限不足（401/403）でも同様に取る（例外テンプレで抜けやすい）
  - 例外時の"必須確認"：`Cache-Control` が機微に対して適切か（エラーキャッシュ事故）、`Content-Security-Policy` / Frame制御が抜けていないか、request_id/trace_id が返ってくるか（ログ側と繋がるか）
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：ステータス別に"同じページ"を作る
  - 視点2：例外時の"必須確認"
  - 視点3：生成主体の切り分け（App/Proxy/WAF/CDN）
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/error_pages 2>/dev/null
    cd ~/keda_evidence/error_pages
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（エラーを意図的に大量に発生させることはしない）
      - エラー処理の情報漏えい、例外時のセキュリティヘッダ/キャッシュ制御、生成主体（App/Edge）の切り分けを検証する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、ステータス（200/401/403/500）、ヘッダとボディ差分、例外時の必須確認（Cache-Control/CSP/Frame/request_id/trace_id）、生成主体（App/Proxy/WAF/CDN）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# エラー観測の要点：
# - 200/403/500でヘッダ差分（CSP/Frame/Cache-Control）を取る
# - ボディの詳細（スタック/内部パス/環境名）を記録
# - request_id/trace_id（相関キー）を必ず確保
~~~~

- この例で観測していること：
  - エラー観測の要点（200/403/500でヘッダ差分（CSP/Frame/Cache-Control）を取る、ボディの詳細（スタック/内部パス/環境名）を記録、request_id/trace_id（相関キー）を必ず確保）
- 出力のどこを見るか（注目点）：
  - ヘッダ差分（CSP/Frame/Cache-Control）、ボディの詳細（スタック/内部パス/環境名）、request_id/trace_id（相関キー）
- この例が使えないケース（前提が崩れるケース）：
  - エラーが発生しない場合、観測できない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用、エラー処理
  - 該当要件（可能ならID）：詳細エラー（スタック/設定/内部URL）が公開境界に出ると情報漏えいになる。さらに例外時にヘッダ/キャッシュ/認可が抜けると"防御例外"が入口になる。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：詳細エラー（スタック/設定/内部URL）が公開境界に出ると情報漏えいになる。さらに例外時にヘッダ/キャッシュ/認可が抜けると"防御例外"が入口になる。
    - 満たす：本番は安全なエラー（汎用メッセージ）を返し、詳細は保護されたログ基盤へ。例外時もヘッダ/キャッシュ制御を一貫させ、相関IDで追跡可能にする。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment、Error Handling
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：エラー処理の情報漏えい、例外時のセキュリティヘッダ/キャッシュ制御、生成主体（App/Edge）の切り分けを検証する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：脆弱性分析（設定/例外処理）→ 侵害評価（漏えい情報を材料に攻撃面を絞る）→ 報告（環境切替と例外統制）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Discovery（内部技術/構成の把握）
  - 攻撃者の目的（この技術が支える意図）：Discoveryを強く支える（内部技術/構成の把握）。条件が揃うとT1190の探索効率を上げる。
  - 参照：https://attack.mitre.org/tactics/TA0007/（Discovery）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 関連 topics：`06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- 関連 topics：`06_config_05_cache_control_機微レスポンスの境界.md`

---

## 深掘りリンク（最大8）
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_05_cache_control_機微レスポンスの境界.md`
- `06_config_06_debug_endpoints（actuator_swagger）露出.md`
- `06_config_08_logging_pii_secret（マスキング_相関）.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
- `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`

---
