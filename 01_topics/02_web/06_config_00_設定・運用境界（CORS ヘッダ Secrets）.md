# 06_config_00_設定・運用境界（CORS ヘッダ Secrets）
設定（CORS/HTTPヘッダ/Secrets/ログ/デバッグ/クラウド設定等）を、単なる項目チェックではなく **境界（信頼・権限・資産）の崩れ方**として理解し、検証の優先度を自分で決められる

---

## 目的（この技術で到達する状態）
- 設定（CORS/HTTPヘッダ/Secrets/ログ/デバッグ/クラウド設定等）を、単なる項目チェックではなく **境界（信頼・権限・資産）の崩れ方**として理解し、検証の優先度を自分で決められる。
- 「設定ミスかどうか」を断定する前に、**観測で状態を確定し、影響を説明できる**（何が可能になり、何ができないか）。
- Webだけでなく、ASM/OSINT（DNS/TLS/HTTP）で見える設定兆候を、Web/NWの検証計画へ繋げられる。

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CDN/WAF、SaaS連携、SPA+API、クラウド（AWS/Azure）前提
  - 設定は「ヘッダだけ」「コードだけ」ではなく、複数レイヤで成立する（CDN→LB→アプリ→API）
- できること/やらないこと（安全に検証する範囲）：
  - やる：観測で状態を確定し、影響を説明できる（何が可能になり、何ができないか）
  - やらないこと：設定項目の網羅列挙（チェックリスト化）はしない、"落とし穴"章は作らない、報告テンプレの肥大化はしない（必要な説明枠だけ）
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/03_http_観測（ヘッダ 挙動）と意味.md`
  - `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
  - `01_topics/02_web/04_api_00_権限伝播・入力・バックエンド連携.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - CORS（ブラウザ境界の制御）
    - HTTPセキュリティヘッダ（境界の補助・誤設定の兆候）
    - Secrets（漏洩と誤用：資産境界の崩壊）
    - デバッグ/管理露出（運用境界の崩壊）
    - クラウド設定（露出面と越境点）
  - 扱わない（別ユニットへ接続）：
    - CORSの詳細 → `06_config_01_CORSと信頼境界（Origin_資格情報_プリフライト）.md`
    - Secrets管理の詳細 → `06_config_02_Secrets管理と漏えい経路（JS_ログ_設定_クラウド）.md`
    - セキュリティヘッダの詳細 → `06_config_03_security_headers（CSP_HSTS_XFO等）.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - CORS（ブラウザ境界の制御）：Access-Control-Allow-Origin、Access-Control-Allow-Credentials、Access-Control-Allow-Headers / Methods、Vary: Origin の有無（キャッシュ境界）
  - HTTPセキュリティヘッダ：Content-Security-Policy（CSP）、Strict-Transport-Security（HSTS）、X-Frame-Options / frame-ancestors、X-Content-Type-Options、Referrer-Policy、Permissions-Policy
  - Secrets：フロント配布物（JS/Sourcemap/設定JSON）に埋め込まれたキー、リポジトリ/Artifact/ログに出るトークン、例外画面/エラー応答に含まれる内部情報
  - デバッグ/管理露出：debug=true で挙動が変わる、stack trace が出る、/metrics /health /actuator 等の管理系入口、例外時に内部パス/クラス名/SQL等が露出
  - クラウド設定：ストレージ公開（バケット/コンテナ）、CDNオリジン/キャッシュ設定（Vary、認証の扱い）、ログ/監査（どこまで追跡できるか）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：どの階層が設定を決定するか（CDN/WAF/アプリ）、資産境界（公開/非公開、管理主体）のズレ
  - 信頼境界（外部連携・第三者・越境ポイント）：どの "Origin" から、どの "認証状態" で、どの "API" を呼べる可能性があるか、信頼境界（第三者サービス/マネージド機能）への越境点
  - 権限境界（権限の切替/伝播/委任）：そのキー/トークンで「何が可能か」（呼べるAPI、権限、対象範囲、期限）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - CORS：認証がCookieの場合、CORS設定が"信頼境界"を崩す可能性を優先して検証する。反対にトークン（Bearer）が主体なら、CORSは影響が限定される場合がある（ただし例外あり）
  - HTTPセキュリティヘッダ："弱い=脆弱"ではなく、「どの攻撃面が開きやすいか」を示すシグナル。入力系（XSS等）や埋め込み（クリックジャック等）と結びつく場合のみ優先度を上げる（一般論で終えない）
  - Secrets："公開キー"のように前提上公開でも問題ないものもあるため、断定せず用途を観測で判断する

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - "どの境界が設定で支えられ/崩されているか" の当たり（信頼・権限・資産）
  - 観測された設定が、どの攻撃面（CORS/埋め込み/入力/Secrets/運用露出）に効くか
  - 次に深掘りするべき領域（AuthN/AuthZ/API/Input/ASM/Cloud）への優先度
- 何が"推定"できるか（推定の根拠/前提）：
  - どのレイヤで設定が入っているか（CDN/WAF/アプリ）
  - Secretsが"実害"に繋がるか（権限/期限/対象範囲）
- 何は"言えない"か（不足情報・観測限界）：
  - "安全/危険"の断定（特にSecretsは用途次第）
  - 設定の意図（運用ポリシー）までは外形だけでは分からない
  - 全攻撃面の網羅（代表入口から広げる必要がある）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：設定が適切に設定されている（健全） → 境界が守られている
  - パターンB：設定が不適切または欠如している（境界が崩れている可能性） → 観測された設定が、どの攻撃面に効くかを特定し、優先度を付ける
  - パターンC：設定の意図が不明（外形だけでは分からない） → 追加観測で強くなる

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - Secrets（使えた瞬間に資産/権限境界が崩れる）
  - CORS（ブラウザ越境で認証状態が使える場合、信頼境界が崩れる）
  - 管理露出/デバッグ（攻め筋が急に短縮される）
  - クラウド露出（ストレージ/キャッシュ/オリジン）
- 優先度の付け方（時間制約がある場合の順序）：
  1) Secrets（使えた瞬間に資産/権限境界が崩れる） → 最優先で重大
  2) CORS（ブラウザ越境で認証状態が使える場合、信頼境界が崩れる） → 認証がCookieの場合、CORS設定が"信頼境界"を崩す可能性を優先して検証する
  3) 管理露出/デバッグ（攻め筋が急に短縮される） → 内部構造推定に繋がる情報が整理でき、次の topics（API/Input/ASM）へ最短で繋がる
  4) クラウド露出（ストレージ/キャッシュ/オリジン） → 資産境界（公開/管理主体）を固め、ケース化の素材にする
  5) ヘッダ類（単体では結論にせず、他領域と接続して意味を出す）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：CORS → AuthN（Cookie前提）と接続して成立条件を確定する
  - 攻め筋2：Secrets → API（どの権限で何ができるか）に接続して最小確認する
  - 攻め筋3：デバッグ露出 → ASM/OSINT（依存推定）に接続して次の検証を短縮する
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 設定は「ヘッダだけ」「コードだけ」ではなく、複数レイヤで成立する（CDN→LB→アプリ→API）ため、どのレイヤで設定が入っているかを特定する

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：CORSが"認証状態"と結びついて信頼境界を崩す可能性がある
  - 成立条件：
    - 認証がCookieの場合、CORS設定が"信頼境界"を崩す可能性がある
  - 次の検証：
    - 未ログインでCORS応答を観測、ログイン後に同APIでCORS応答を観測（Allow-Credentials、Origin反映など）
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功："どのOriginから、どの認証で、どのAPIが呼べる可能性があるか" が説明できる
    - 失敗：CORS設定が適切で、信頼境界が守られている
- 仮説B：Secretsが露出しているが、実害に繋がるか不明
  - 成立条件：
    - フロント配布物（JS/Sourcemap/設定JSON）に埋め込まれたキー、リポジトリ/Artifact/ログに出るトークン、例外画面/エラー応答に含まれる内部情報が観測される
  - 次の検証：
    - キーの用途を推定（どのサービス/どのAPIに向くか）、許可範囲で最小のread-only確認（呼べるか/拒否か/範囲はどこまでか）
  - 期待する観測：
    - 成功："使える/使えない" と "使える場合の境界（範囲/期限/権限）" が状態で説明できる
    - 失敗：Secretsが"公開キー"のように前提上公開でも問題ないもの、または使えない
- 仮説C：デバッグ/管理露出があり、攻め筋短縮に直結する
  - 成立条件：
    - debug=true で挙動が変わる、stack trace が出る、/metrics /health /actuator 等の管理系入口、例外時に内部パス/クラス名/SQL等が露出
  - 次の検証：
    - 通常時の応答を観測、エラー条件（安全な範囲）で応答を観測し、内部情報が出るか差分を取る
  - 期待する観測：
    - 成功：内部構造推定に繋がる情報が整理でき、次の topics（API/Input/ASM）へ最短で繋がる
    - 失敗：デバッグ/管理露出が適切に制御されている

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
    - `04_labs/01_local/03_capture_証跡取得（pcap_harl_log）.md`
- 取得する証跡（目的ベースで最小限）：
  - レスポンスヘッダ一式、CORSプリフライト/実リクエスト時の差分（必要時）、エラー時の応答（スタック/内部情報の有無）、HAR/Proxyログ/検証メモ（条件/結果/意味/次の手）
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：代表入口を1つ選び、同じ条件で次を取る（レスポンスヘッダ一式、CORSプリフライト/実リクエスト時の差分、エラー時の応答）
  - 視点2：観測された設定が、どの攻撃面（CORS/埋め込み/入力/Secrets/運用露出）に効くかを特定
  - 視点3：次に深掘りするべき領域（AuthN/AuthZ/API/Input/ASM/Cloud）への優先度を決定
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/config_boundary 2>/dev/null
    cd ~/keda_evidence/config_boundary
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **代表入口の抽出** のみ（設定項目の網羅列挙（チェックリスト化）はしない）
      - 設定の意図（運用ポリシー）までは外形だけでは分からないため、断定せず用途を観測で判断する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、観測対象（CORS/HTTPセキュリティヘッダ/Secrets/デバッグ/クラウド設定）、攻撃面、優先度

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 例：ヘッダ観測（CORS/CSP/HSTS 等の状態を見る入口）
curl -i "https://example.com/"

# 例：CORSの観測（概念例：Origin を付けて応答差を見る）
curl -i -H "Origin: https://attacker.example" "https://example.com/api/me"
~~~~

- この例で観測していること：
  - レスポンスヘッダ一式、CORSプリフライト/実リクエスト時の差分、エラー時の応答（スタック/内部情報の有無）
- 出力のどこを見るか（注目点）：
  - Access-Control-Allow-Origin、Access-Control-Allow-Credentials、Access-Control-Allow-Headers / Methods、Vary: Origin の有無、Content-Security-Policy（CSP）、Strict-Transport-Security（HSTS）、X-Frame-Options / frame-ancestors、X-Content-Type-Options、Referrer-Policy、Permissions-Policy
- この例が使えないケース（前提が崩れるケース）：
  - 設定が複数レイヤで成立する（CDN→LB→アプリ→API）場合、どのレイヤで設定が入っているかを特定する必要がある

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用
  - 該当要件（可能ならID）：設定・運用（ヘッダ、CORS、Secrets、管理露出、クラウド設定）を"境界"として扱い、満たす/破れる点を観測で説明できる状態にする
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：設定・運用は「実装が正しくても破れる」領域。境界（資産/信頼/権限）が設定でどう崩れるかを説明できる状態にする
    - 満たす：設定・運用（ヘッダ、CORS、Secrets、管理露出、クラウド設定）を"境界"として扱い、満たす/破れる点を観測で説明できる状態にする
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：Configuration/Deployment 周りの観点を、観測（ヘッダ/挙動/公開情報）→意味→次の一手へ落とす。設定は他テスト（AuthN/AuthZ/API/Input）の成立条件を左右する前提である。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：Intelligence Gathering、Vulnerability Analysis
  - 前後フェーズとの繋がり（1行）：Intelligence Gathering で見えた設定兆候（ヘッダ/露出面）を観測し、攻め筋を短縮する。Vulnerability Analysis で境界崩壊の可能性が高いもの（Secrets/CORS/管理露出）から優先する。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Discovery（露出面/設定把握）、Initial Access（設定ミス由来の入口）、Collection（情報取得の足場）
  - 攻撃者の目的（この技術が支える意図）：Initial Access/Discovery/Collection を支える"露出面・境界崩壊"として位置づける。技術名貼り付けではなく「攻撃者の目的に対して、どの境界が設定で崩れるか」を説明できる状態にする。
  - 参照：https://attack.mitre.org/tactics/TA0007/（Discovery）

## 参考（必要最小限）
- `01_topics/01_asm-osint/03_http_観測（ヘッダ 挙動）と意味.md`
- `01_topics/01_asm-osint/05_cloud_露出面（CDN WAF Storage等）推定.md`
- `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
- `01_topics/02_web/04_api_00_権限伝播・入力・バックエンド連携.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_01_CORSと信頼境界（Origin_資格情報_プリフライト）.md`
- 関連 topics：`06_config_02_Secrets管理と漏えい経路（JS_ログ_設定_クラウド）.md`
- 関連 topics：`06_config_03_security_headers（CSP_HSTS_XFO等）.md`

---

## 深掘りリンク（最大8）
- `06_config_01_CORSと信頼境界（Origin_資格情報_プリフライト）.md`
- `06_config_02_Secrets管理と漏えい経路（JS_ログ_設定_クラウド）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `01_topics/01_asm-osint/03_http_観測（ヘッダ 挙動）と意味.md`
- `01_topics/01_asm-osint/05_cloud_露出面（CDN WAF Storage等）推定.md`
- `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
- `01_topics/02_web/04_api_00_権限伝播・入力・バックエンド連携.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`

---
