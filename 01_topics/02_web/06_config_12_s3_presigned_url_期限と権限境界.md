# 06_config_12_s3_presigned_url_期限と権限境界
S3 Presigned URL（期限と権限境界）：URLは"権限トークン"なので、漏えい前提で設計する

---

## 目的（この技術で到達する状態）
- Presigned URLを「一時URL」ではなく、**能力（capability）＝権限そのもの**として境界で扱える。
- 実務で頻出の事故（期限長すぎ、PUT許可、ログ/Referer漏えい、テナント分離不備）を観測→意味→次の一手で所見化できる。

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - AWS S3等のストレージサービスを使用している環境
  - Presigned URLは"見られたら使える"（回収が難しい）
- できること/やらないこと（安全に検証する範囲）：
  - やる：アクセス制御（IDOR/テナント分離）、情報漏えい（URL/ログ/Referer）、期限と失効、ダウンロード/アップロードの権限境界を検証する
  - やらないこと：AWS詳細仕様の網羅は目的にしない
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - 期限（被害期間）と権限（GET/PUT、対象キー、条件）
    - 発行APIの認可（所有者/テナント/権限）
    - 漏えい経路（ログ/Referer/キャッシュ/フロント保存）
  - 扱わない（別ユニットへ接続）：
    - AWS詳細仕様の網羅は目的にしない

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 期限（Expires）が業務最小か：長いほど漏えい時の被害期間が延びる（回収できない前提で評価）
  - 権限の粒度（GET/PUTと対象キー）：GET（漏えい（閲覧））、PUT（改ざん（アップロード差し替え、なりすまし））、対象キーが推測可能/ユーザ入力で組み立て（テナント境界と衝突しやすい）
  - 発行APIの認可（ここが本質）：署名URLがあるから認可不要は誤設計、発行前に、所有者/テナント/ロール/対象ファイルの妥当性を検証しているか
  - 漏えい経路（最も現実的に起きる）：Referer（外部遷移/外部埋め込みでURLが送られる可能性）、ログ（アクセスログ・分析ログ・エラーログにURL全文が残る）、キャッシュ（ブラウザ/CDNで保持される（Cache-Controlと連動））、フロント保存（localStorage等で長期化）
- 境界の観点：
  - 権限境界（権限の切替/伝播/委任）：URLが権限を運ぶ（認可をURLに"埋め込む"形になる）
  - 信頼境界（外部連携・第三者・越境ポイント）：URLがブラウザや外部基盤へ出ると"外部"に権限が渡る
  - 運用境界（管理主体・委託先・対象範囲の線引き）：回収が難しいため、短寿命と再発行設計が重要
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 期限が長い：漏えい時の被害期間が長い（重大度が上がる）
  - PUTが発行される：改ざん方向のリスクが増える（発行認可がより重要）
  - URLがログ/Refererに残る：入手容易性が上がり、現実的に悪用されやすい
  - 発行APIの認可が弱い：IDOR/テナント分離不備に直結し得る（優先度を上げる）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 期限が長い：漏えい時の被害期間が長い（重大度が上がる）
  - PUTが発行される：改ざん方向のリスクが増える（発行認可がより重要）
  - URLがログ/Refererに残る：入手容易性が上がり、現実的に悪用されやすい
  - 発行APIの認可が弱い：IDOR/テナント分離不備に直結し得る（優先度を上げる）
- 何が"推定"できるか（推定の根拠/前提）：
  - 期限（被害期間）と権限（GET/PUT、対象キー、条件）
  - 発行APIの認可（所有者/テナント/権限）
- 何は"言えない"か（不足情報・観測限界）：
  - すべてのPresigned URLを網羅した断定（観測範囲に依存）
  - すべての漏えい経路を網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：期限が短い・最小権限で設計されている（健全） → 漏えい時の被害期間が短い
  - パターンB：期限が長い（境界が崩れている） → 漏えい時の被害期間が長い（重大度が上がる）
  - パターンC：URLがログ/Refererに残る（漏えい経路が存在） → 入手容易性が上がり、現実的に悪用されやすい

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - ブラウザで拾う（開発者ツール、履歴、共有、画面コピー）
  - ログで拾う（分析基盤、エラーログ、APM）
  - Refererで拾う（外部遷移や外部埋め込みがあると現実的）
- 優先度の付け方（時間制約がある場合の順序）：
  1) 発行APIの認可が弱い（IDOR/テナント分離不備に直結し得る） → 最優先で重大
  2) PUTが発行される（改ざん方向のリスクが増える） → 発行認可がより重要
  3) 期限が長い（漏えい時の被害期間が長い） → 重大度が上がる
  4) URLがログ/Refererに残る（入手容易性が上がる） → 現実的に悪用されやすい
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：短寿命・最小権限で設計されている（設計は成立） → 期限切れ時の再発行が安全か（再認可・レート制限・監査）。URLをログ/Refererに残さない（マスキング/Referrer-Policy/配布方式）。PUTは対象キー固定＋制約（可能なら）で被害範囲をさらに縮める
  - 攻め筋2：期限が長い/配布が雑で漏えい前提に耐えない → 期限短縮を最優先（回収不能の穴埋め）。発行APIの認可を重点検証（所有者/テナント/対象）。ログ・Referer・キャッシュの漏えい経路を閉じる要件をセットで出す
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 一度外部へ出たURLは、期限内なら第三者が利用できる可能性がある

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：短寿命・最小権限で設計されている（設計は成立）
  - 成立条件：
    - 短寿命・最小権限で設計されている
  - 次の検証：
    - 期限切れ時の再発行が安全か（再認可・レート制限・監査）
    - URLをログ/Refererに残さない（マスキング/Referrer-Policy/配布方式）
    - PUTは対象キー固定＋制約（可能なら）で被害範囲をさらに縮める
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：期限切れ時の再発行が安全（再認可・レート制限・監査）
    - 失敗：期限が長い/配布が雑で漏えい前提に耐えない
- 仮説B：期限が長い/配布が雑で漏えい前提に耐えない
  - 成立条件：
    - 期限が長い/配布が雑で漏えい前提に耐えない
  - 次の検証：
    - 期限短縮を最優先（回収不能の穴埋め）
    - 発行APIの認可を重点検証（所有者/テナント/対象）
    - ログ・Referer・キャッシュの漏えい経路を閉じる要件をセットで出す
  - 期待する観測：
    - 成功：期限短縮を最優先（回収不能の穴埋め）できる
    - 失敗：期限が短い/配布が適切で漏えい前提に耐えられる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/12_s3_presigned_url_boundary/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - 期限（Expires）が業務最小か、権限の粒度（GET/PUTと対象キー）、発行APIの認可（所有者/テナント/ロール/対象ファイルの妥当性を検証しているか）、漏えい経路（Referer/ログ/キャッシュ/フロント保存）
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：期限（Expires）が業務最小か
  - 視点2：権限の粒度（GET/PUTと対象キー）
  - 視点3：発行APIの認可（所有者/テナント/ロール/対象ファイルの妥当性を検証しているか）
  - 視点4：漏えい経路（Referer/ログ/キャッシュ/フロント保存）
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/presigned_url 2>/dev/null
    cd ~/keda_evidence/presigned_url
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（AWS詳細仕様の網羅は目的にしない）
      - アクセス制御（IDOR/テナント分離）、情報漏えい（URL/ログ/Referer）、期限と失効、ダウンロード/アップロードの権限境界を検証する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、期限（Expires）、権限の粒度（GET/PUTと対象キー）、発行APIの認可、漏えい経路（Referer/ログ/キャッシュ/フロント保存）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# Presigned URLの評価は3点だけ：
# 1) 期限（被害期間）
# 2) 権限（GET/PUT、対象キーの固定/推測性）
# 3) 漏えい経路（ログ/Referer/キャッシュ/フロント保存）
# そして本質：
# - 発行APIの認可（所有者/テナント/ロール）が正しいか
~~~~

- この例で観測していること：
  - Presigned URLの評価（期限（被害期間）、権限（GET/PUT、対象キーの固定/推測性）、漏えい経路（ログ/Referer/キャッシュ/フロント保存）、発行APIの認可（所有者/テナント/ロール）が正しいか）
- 出力のどこを見るか（注目点）：
  - 期限（Expires）、権限（GET/PUT、対象キー）、漏えい経路（ログ/Referer/キャッシュ/フロント保存）、発行APIの認可
- この例が使えないケース（前提が崩れるケース）：
  - Presigned URLが使用されていない場合、観測できない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用、アクセス制御
  - 該当要件（可能ならID）：署名URLを認可の代替にすると、発行前検証（所有者/テナント/権限）が崩れる。期限が長いと漏えい時の被害期間が長い。URLがログ/Referer/キャッシュに残ると、権限トークンが拡散する。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：署名URLを認可の代替にすると、発行前検証（所有者/テナント/権限）が崩れる。期限が長いと漏えい時の被害期間が長い。URLがログ/Referer/キャッシュに残ると、権限トークンが拡散する。
    - 満たす：発行前の認可を徹底し、短寿命・最小権限（GET/PUT分離、対象キー固定）で被害半径を抑える。URLの漏えい経路（ログ/Referer/キャッシュ）を閉じる。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment、Access Control
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：アクセス制御（IDOR/テナント分離）、情報漏えい（URL/ログ/Referer）、期限と失効、ダウンロード/アップロードの権限境界を検証する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：脆弱性分析（設計/運用欠陥）→ 侵害評価（発行APIの認可、漏えい面）→ 報告（期限/配布/ログの要件）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Collection（URL入手）とImpact（漏えい/改ざん）
  - 攻撃者の目的（この技術が支える意図）：Collection（URL入手）とImpact（漏えい/改ざん）に接続し得る。URLが入手できる現実的経路（ログ/Referer/共有）を前提に評価する。
  - 参照：https://attack.mitre.org/tactics/TA0009/（Collection）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 関連 topics：`06_config_05_cache_control_機微レスポンスの境界.md`
- 関連 topics：`06_config_08_logging_pii_secret（マスキング_相関）.md`

---

## 深掘りリンク（最大8）
- `06_config_05_cache_control_機微レスポンスの境界.md`
- `06_config_08_logging_pii_secret（マスキング_相関）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_11_secrets_rotation_運用（回収_失効）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
- `05_input_10_open_redirect（遷移先信頼境界）.md`

---
