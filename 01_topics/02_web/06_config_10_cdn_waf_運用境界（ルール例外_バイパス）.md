# 06_config_10_cdn_waf_運用境界（ルール例外_バイパス）

## このファイルで扱う概念
- CDN/WAFの運用例外と直オリジン境界。

## 危険性を一言で
- 例外運用で防御が迂回される。

## 最小限の成立判断（目安）
- CDN経由/直オリジンで差分が再現する。

## 観測例（差分のイメージ）
- A: WAF遮断、B: 直オリジンで通る。

## 観測が取れない場合の代替
- DNS/証明書/ネットワークで直到達可否を確認する。

## 時間制約下の最小観測点
- 直オリジンの公開有無。

## 対策の優先順位
1) 直オリジン非公開
2) 例外の最小化
3) 監視

## 具体例（直オリジン確認）
- DNSでオリジンが解決可能
- 証明書SANでオリジン名が判別
CDN/WAF運用境界（ルール例外・バイパス）：防御は"例外運用"で壊れる

---

## 目的（この技術で到達する状態）
- CDN/WAFを「あるから安全」ではなく、**適用範囲と例外条件がどこで境界を破るか**を観測で固められる。
- 実務で頻出の分断を所見化できる。
  - webhook/upload/callback等の例外パス
  - 誤検知回避でのルール無効化
  - 直オリジン到達（DNS/証明書/ネットワーク）でWAF外し

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CDN → WAF → Reverse Proxy（Nginx/Envoy等）→ App（Spring/Node/Rails等）
  - webhook/upload/callback等の例外パス、誤検知回避でのルール無効化、直オリジン到達（DNS/証明書/ネットワーク）でWAF外し
- できること/やらないこと（安全に検証する範囲）：
  - やる：境界装置の存在確認、適用範囲、例外パス、直オリジン到達、応答差分（ヘッダ/エラー/キャッシュ）を検証する
  - やらないこと："守りの責務分離"（WAFは補助、アプリが本体）を崩さない評価
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - 適用範囲（ホスト/パス/メソッド）と例外運用（期限/理由/監査）
    - 直オリジン到達・別ホストでの保護外入口
    - "守りの責務分離"（WAFは補助、アプリが本体）を崩さない評価
  - 扱わない（別ユニットへ接続）：
    - WAF/CDNの詳細な仕様説明（本プロジェクトは境界と成立根拠を優先）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 応答差分で"適用外"を疑う：同じ入力でも、パス/ホストでブロック挙動が変わる、エラーページやヘッダ（WAF由来、CDNキャッシュ兆候）で生成主体を推定
  - 例外条件を固定する：特定パスだけ通る、特定ヘッダがあると通る（内部連携ヘッダ等）、特定IP帯が許可（社内/パートナー）
  - 直オリジン到達の可能性：DNS/証明書の取り回しで、オリジンが露出しやすい（現実によくある）、"CDNで閉じている"前提が崩れると、保護が消える
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：どこまでがCDN/WAF配下か（サブドメイン/別ホスト/直IP）
  - 信頼境界（外部連携・第三者・越境ポイント）：外部連携の入口（webhook等）に例外が集中する
  - 権限境界（権限の切替/伝播/委任）：管理/重要操作が例外になっていないか（最悪パターン）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 適用範囲が分断：攻撃者は"守りが薄い入口"に集中できる
  - 例外が恒久：運用上の負債として固定化される（優先度を上げる）
  - 直オリジン疑い：CDN/WAFを前提にした防御が無効化され得る

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 適用範囲が分断：攻撃者は"守りが薄い入口"に集中できる
  - 例外が恒久：運用上の負債として固定化される（優先度を上げる）
  - 直オリジン疑い：CDN/WAFを前提にした防御が無効化され得る
- 何が"推定"できるか（推定の根拠/前提）：
  - どこまでがCDN/WAF配下か（サブドメイン/別ホスト/直IP）
  - 外部連携の入口（webhook等）に例外が集中する
- 何は"言えない"か（不足情報・観測限界）：
  - すべての例外パスを網羅した断定（観測範囲に依存）
  - すべての直オリジン到達を網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：適用範囲が一貫している（健全） → CDN/WAFが適切に適用されている
  - パターンB：適用範囲が分断（境界が崩れている） → 攻撃者は"守りが薄い入口"に集中できる
  - パターンC：例外が恒久（運用上の負債として固定化される） → 優先度を上げる

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - "ブロックされる入力"から、例外条件（パス/ホスト/ヘッダ）を探す
  - webhook/upload/callbackのような例外入口から、入力検証や認可の弱い面を狙う
  - 直オリジンがあれば、境界装置を迂回して同じアプリを叩く
- 優先度の付け方（時間制約がある場合の順序）：
  1) 直オリジン疑い（CDN/WAFを前提にした防御が無効化され得る） → 最優先で重大
  2) 適用範囲が分断（攻撃者は"守りが薄い入口"に集中できる） → 信頼境界が崩れる可能性
  3) 例外が恒久（運用上の負債として固定化される） → 優先度を上げる
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：例外はパス単位（最頻出） → 例外パスの理由（誤検知/要件）を確認し、期限・監査・代替策（ルール調整）を要求。例外パスはアプリ側防御（入力検証/認可/レート制限/監査）を強化する要件に落とす
  - 攻め筋2：直オリジン/別ホストが存在（重大） → 直オリジン遮断（許可元をCDNに限定、ネットワークACL等）を最優先。"同一アプリ"の証跡（挙動/ヘッダ/エラー差分）を揃え、影響半径を所見化
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 運用は必ず例外を作る（誤検知・連携・性能・可用性）

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：例外はパス単位（最頻出）
  - 成立条件：
    - 例外はパス単位で存在する
  - 次の検証：
    - 例外パスの理由（誤検知/要件）を確認し、期限・監査・代替策（ルール調整）を要求
    - 例外パスはアプリ側防御（入力検証/認可/レート制限/監査）を強化する要件に落とす
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：例外パスの理由（誤検知/要件）を確認できる
    - 失敗：例外パスが適切に制御されている
- 仮説B：直オリジン/別ホストが存在（重大）
  - 成立条件：
    - 直オリジン/別ホストが存在する
  - 次の検証：
    - 直オリジン遮断（許可元をCDNに限定、ネットワークACL等）を最優先
    - "同一アプリ"の証跡（挙動/ヘッダ/エラー差分）を揃え、影響半径を所見化
  - 期待する観測：
    - 成功：直オリジン/別ホストが存在することを特定できる
    - 失敗：直オリジン/別ホストが適切に遮断されている

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/10_cdn_waf_exceptions_boundary/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - 応答差分で"適用外"を疑う：同じ入力でも、パス/ホストでブロック挙動が変わる、エラーページやヘッダ（WAF由来、CDNキャッシュ兆候）で生成主体を推定
  - 例外条件を固定する：特定パスだけ通る、特定ヘッダがあると通る（内部連携ヘッダ等）、特定IP帯が許可（社内/パートナー）
  - 直オリジン到達の可能性：DNS/証明書の取り回しで、オリジンが露出しやすい（現実によくある）、"CDNで閉じている"前提が崩れると、保護が消える
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：応答差分で"適用外"を疑う
  - 視点2：例外条件を固定する
  - 視点3：直オリジン到達の可能性
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/cdn_waf_exceptions 2>/dev/null
    cd ~/keda_evidence/cdn_waf_exceptions
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（"守りの責務分離"（WAFは補助、アプリが本体）を崩さない評価）
      - 境界装置の存在確認、適用範囲、例外パス、直オリジン到達、応答差分（ヘッダ/エラー/キャッシュ）を検証する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、パス/ホスト、ブロック挙動、エラーページやヘッダ（WAF由来、CDNキャッシュ兆候）、例外条件（特定パス/特定ヘッダ/特定IP帯）、直オリジン到達

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# CDN/WAFは「あるか」より「どこで効かないか」。

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用
  - 該当要件（可能ならID）：WAF/CDNの例外運用（パス除外、直オリジン、特定ヘッダ/特定IP許可）で保護が分断され、同じアプリでも"守りが薄い入口"が生まれる。ヘッダ信頼（X-Forwarded-*等）を誤ると権限境界が崩れる。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：WAF/CDNの例外運用（パス除外、直オリジン、特定ヘッダ/特定IP許可）で保護が分断され、同じアプリでも"守りが薄い入口"が生まれる。ヘッダ信頼（X-Forwarded-*等）を誤ると権限境界が崩れる。
    - 満たす：適用範囲を仕様化し、例外は期限・理由・監査を持つ。直オリジン到達を遮断し、アプリ側の入力検証/認可と二重化する。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：境界装置の存在確認、適用範囲、例外パス、直オリジン到達、応答差分（ヘッダ/エラー/キャッシュ）を検証する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：情報収集、脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：情報収集（配布経路）→ 脆弱性分析（例外/分断）→ 侵害評価（保護外入口からの成立）→ 報告（運用要件）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Defense Evasion（境界装置回避）
  - 攻撃者の目的（この技術が支える意図）：Defense Evasion（境界装置回避）を支える前提。T1190の成功率を上げる環境要因になり得る。
  - 参照：https://attack.mitre.org/tactics/TA0005/（Defense Evasion）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 関連 topics：`06_config_06_debug_endpoints（actuator_swagger）露出.md`
- 関連 topics：`06_config_07_error_pages_詳細表示と環境切替.md`

---

## 深掘りリンク（最大8）
- `06_config_06_debug_endpoints（actuator_swagger）露出.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_05_cache_control_機微レスポンスの境界.md`
- `05_input_18_http_request_smuggling_04_observable_signals（timing_error_cache）.md`
- `05_input_19_cache_poisoning_02_unkeyed（headers_params）.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`

---
