# 06_config_06_debug_endpoints（actuator_swagger）露出

## このファイルで扱う概念
- debug endpointの露出境界。

## 危険性を一言で
- 内部情報が直接参照できる。

## 最小限の成立判断（目安）
- 直オリジン到達の差分が再現する。

## 観測例（差分のイメージ）
- A: CDN経由のみ、B: 直オリジンに到達。

## 観測が取れない場合の代替
- DNS/証明書/ネットワークで直到達可否を確認する。

## 時間制約下の最小観測点
- 直オリジンの公開有無。

## 対策の優先順位
1) 非公開化
2) 認証/制限
3) 監視

## 具体例（直オリジン確認）
- DNSにオリジンが露出
- 証明書のSANでオリジン名が判別
Debug Endpoints露出（/actuator / swagger等）：内部観測面が公開境界に出ると攻撃面が一気に具体化する

---

## 目的（この技術で到達する状態）
- "見えるだけ"と"操作できる"を分け、**露出がどの境界を破るか**を判断できる。
- 実務で頻出の露出（Spring Actuator、Swagger/OpenAPI、GraphQL introspection等）を、観測→意味→次の一手で所見化できる。

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CDN → WAF → Reverse Proxy（Nginx/Envoy等）→ App（Spring/Node/Rails等）
  - Spring Boot Actuator：`/actuator/*`（health/info/metrics だけのつもりが env, heapdump 等が混ざる）
  - Swagger/OpenAPI：`/swagger-ui` `/v3/api-docs` `/openapi.json`
  - GraphQL：`/graphql` introspection
  - Metrics：`/metrics` `/prometheus`
  - 管理UI：`/admin` `/console`
- できること/やらないこと（安全に検証する範囲）：
  - やる：管理/デバッグ/仕様公開エンドポイントの発見、認証・認可、返却情報の過多、直オリジン到達の有無を検証する
  - やらないこと：製品手順や網羅列挙は目的にしない
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - 露出の分類（情報/仕様/操作）
    - 認証・認可の分断（UIだけ守る、APIだけ抜ける）
    - 直オリジン/別ホスト/例外ルールでの露出（運用境界）
  - 扱わない（別ユニットへ接続）：
    - 製品手順や網羅列挙は目的にしない

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - "同名の入口"が複数ある：Swagger UIは閉じているが、`/v3/api-docs` が匿名で返る、`health` はOKでも `env` / `heapdump` が残っている
  - 直オリジン/別ホストの疑い：CDN経由では403だが、別サブドメイン/別IPで200
  - 認可の責務分離が崩れている：UIはSSOで守るが、APIはトークン無しでも叩ける／ロール判定が欠落
- 境界の観点：
  - 信頼境界（外部連携・第三者・越境ポイント）：内部用の観測情報が外部へ出る（内部URL/依存/環境名）
  - 権限境界（権限の切替/伝播/委任）：操作系が露出すると"機能"として侵害になる（ログ閲覧/設定変更/ジョブ起動）
  - 資産境界（管理主体・委託先・対象範囲の線引き）：CDN/WAFで閉じても、直オリジン・別ホストで残ると意味がない
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 情報露えい型（読むだけでも痛い）：依存ライブラリ/バージョン、ビルド情報、環境名、内部エンドポイント一覧、外部連携先の痕跡
  - 仕様公開型（攻撃面の地図を渡す）：OpenAPI/Swagger：入力点、パラメータ、認証方式、管理APIの存在が見える、GraphQL schema：型・フィールド・管理操作の入口が見える
  - 操作型（直接Impact）：設定変更、ログレベル変更、キャッシュクリア、ジョブ起動、シャットダウン等

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 仕様公開が見える：攻撃面の探索コストが下がる（認可不備の発見確率が上がる）
  - 情報露えいが濃い：内部構成・依存が推定でき、次の検証が具体化する
  - 操作系が可能：設定不備が直接侵害経路になり得る（優先度を最大級に上げる）
- 何が"推定"できるか（推定の根拠/前提）：
  - 403でも安心できない：別ホスト/直オリジン/例外ルールで残っている可能性がある
- 何は"言えない"か（不足情報・観測限界）：
  - すべての露出エンドポイントを網羅した断定（観測範囲に依存）
  - すべての操作系の成立条件を網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：仕様公開が見える（攻撃面の探索コストが下がる） → 認可不備の発見確率が上がる
  - パターンB：情報露えいが濃い（内部構成・依存が推定できる） → 次の検証が具体化する
  - パターンC：操作系が可能（設定不備が直接侵害経路になり得る） → 優先度を最大級に上げる

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - Swagger/OpenAPI → 管理APIや"想定外の機能"を最短で洗い出す
  - Actuator/env/log/trace系 → 内部URL、秘密の痕跡、環境差を拾う
  - health/metrics → 生存確認と構成推定（別ホスト発見の足掛かり）
- 優先度の付け方（時間制約がある場合の順序）：
  1) 操作系が可能（設定不備が直接侵害経路になり得る） → 最優先で重大
  2) 仕様公開が見える（攻撃面の探索コストが下がる） → 認可不備の発見確率が上がる
  3) 情報露えいが濃い（内部構成・依存が推定できる） → 次の検証が具体化する
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：露出は"地図"としての価値（認可検証へ繋げる） → 仕様公開から「管理/一般」「テナント境界」を抽出し、認可検証の優先度表を作る。"UIだけ守る"の分断を疑い、API単体での認可を観測する
  - 攻め筋2：操作系が露出（直接侵害の可能性） → 成立条件（認証要否、ロール、ネットワーク境界）を最小回数で確定し、影響半径を所見化。対策は「消す」だけでなく、隔離（別ドメイン/VPN/mTLS）＋監査ログを要求する
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - CDN/WAFで閉じても、直オリジン・別ホストで残ると意味がない

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：露出は"地図"としての価値（認可検証へ繋げる）
  - 成立条件：
    - 仕様公開が見える（攻撃面の探索コストが下がる）
  - 次の検証：
    - 仕様公開から「管理/一般」「テナント境界」を抽出し、認可検証の優先度表を作る
    - "UIだけ守る"の分断を疑い、API単体での認可を観測する
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：仕様公開から「管理/一般」「テナント境界」を抽出できる
    - 失敗：仕様公開が見えない、または適切に保護されている
- 仮説B：操作系が露出（直接侵害の可能性）
  - 成立条件：
    - 操作系が可能（設定不備が直接侵害経路になり得る）
  - 次の検証：
    - 成立条件（認証要否、ロール、ネットワーク境界）を最小回数で確定し、影響半径を所見化
    - 対策は「消す」だけでなく、隔離（別ドメイン/VPN/mTLS）＋監査ログを要求する
  - 期待する観測：
    - 成功：成立条件（認証要否、ロール、ネットワーク境界）を確定できる
    - 失敗：操作系が適切に保護されている

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/06_debug_endpoints_exposure/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - "同名の入口"が複数ある：Swagger UIは閉じているが、`/v3/api-docs` が匿名で返る、`health` はOKでも `env` / `heapdump` が残っている
  - 直オリジン/別ホストの疑い：CDN経由では403だが、別サブドメイン/別IPで200
  - 認可の責務分離が崩れている：UIはSSOで守るが、APIはトークン無しでも叩ける／ロール判定が欠落
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：露出の分類（情報/仕様/操作）
  - 視点2：認証・認可の分断（UIだけ守る、APIだけ抜ける）
  - 視点3：直オリジン/別ホスト/例外ルールでの露出（運用境界）
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/debug_endpoints 2>/dev/null
    cd ~/keda_evidence/debug_endpoints
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **代表エンドポイントの抽出** のみ（製品手順や網羅列挙は目的にしない）
      - 管理/デバッグ/仕様公開エンドポイントの発見、認証・認可、返却情報の過多、直オリジン到達の有無を検証する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、露出の分類（情報/仕様/操作）、認証・認可の分断、直オリジン/別ホスト/例外ルール

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# まずは分類：

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用
  - 該当要件（可能ならID）：デバッグ/管理/仕様公開が公開境界に露出すると、情報漏えい（内部構成/依存/エンドポイント）や不正操作（設定変更/ログ閲覧/ジョブ起動）が起こり得る。UIのみ認証でAPIが守られていないと権限境界が崩れる。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：デバッグ/管理/仕様公開が公開境界に露出すると、情報漏えい（内部構成/依存/エンドポイント）や不正操作（設定変更/ログ閲覧/ジョブ起動）が起こり得る。UIのみ認証でAPIが守られていないと権限境界が崩れる。
    - 満たす：管理面は公開境界から隔離（ネットワーク/別ドメイン/mTLS等）し、認可統一・監査ログ・例外統制で運用する。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：管理/デバッグ/仕様公開エンドポイントの発見、認証・認可、返却情報の過多、直オリジン到達の有無を検証する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：情報収集、脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：情報収集（攻撃面抽出）→ 脆弱性分析（設定不備）→ 侵害評価（操作系の成立）→ 報告（隔離/統制の要求）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Discovery（内部機能/構成の把握）
  - 攻撃者の目的（この技術が支える意図）：Discovery（内部機能/構成の把握）に直結し、条件が揃うとT1190へ接続。操作系が露出する場合はImpactへ繋がり得る。
  - 参照：https://attack.mitre.org/tactics/TA0007/（Discovery）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 関連 topics：`06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- 関連 topics：`06_config_07_error_pages_詳細表示と環境切替.md`

---

## 深掘りリンク（最大8）
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_08_logging_pii_secret（マスキング_相関）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
- `05_input_19_cache_poisoning_02_unkeyed（headers_params）.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `05_input_10_open_redirect（遷移先信頼境界）.md`

---
