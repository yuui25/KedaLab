# 05_input_17_email_header_injection（SMTP境界）
Email Header Injection：SMTPの"宛先（エンベロープ）"と"ヘッダ（メッセージ）"の境界を壊し、情報漏えい・誘導・運用逸脱を起こす

---

## 目的（この技術で到達する状態）
- 「メールヘッダ注入」を、次の形で説明・検証・報告できる。
  1) メール送信の二層（SMTPエンベロープ / メッセージヘッダ）を区別できる
  2) 入力がヘッダ値に入る"構造破壊点（CRLF）"をモデル化できる
  3) 実害を"業務フロー"として確定できる（誰が受け取る/何が漏れる/何が誤誘導される）
  4) 修正を「生成方式（ライブラリ/API）」「入力制約」「認可・宛先拘束」「監査」に分けて提案できる

## 前提（対象・範囲・想定）
- 対象：許可された範囲のWebアプリ/環境のみ。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - メール送信機能を持つアプリが一般的（SMTP直送 / SES・SendGrid等API / 社内MTA中継）。
- できること/やらないこと（安全に検証する範囲）：
  - やらないこと：追加宛先の実害検証（第三者に送る）は行わない（契約・ルール違反になり得る）。目的は「ヘッダ構造が壊れる」証拠を取ること（raw header）。
- 依存する前提知識（必要最小限）：
  - `01_topics/01_asm-osint/19_email_infra（SPF_DKIM_DMARC）と攻撃面.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - Email Header Injection（CRLF Injection in email headers）
    - 例：From/To/Cc/Bcc/Reply-To/Subject/Message-ID/Headers（X-*）等の"ヘッダ行"が外部入力で壊れる
    - 影響：追加宛先、返信先改変、ヘッダ改ざん、MIME解釈変更、情報漏えい、運用逸脱
  - 扱わない（別ユニットへ接続）：
    - 一般的なCRLF Injection（HTTPヘッダ分割） → `05_input_20_crlf_injection_*`
    - メール本文テンプレのHTML XSS → `05_input_06_xss_*`（メールクライアントは別実行環境）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - メール送信の二層（SMTPエンベロープ / メッセージヘッダ）
  - 入力がヘッダ値に入る"構造破壊点（CRLF）"
  - 受信した生メール（raw source）でのヘッダ構造
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：メール送信経路（SMTP直送 / SES・SendGrid等API / 社内MTA中継）
  - 信頼境界（外部連携・第三者・越境ポイント）：アプリ→外部（MTA/メールAPI）→人間（受信者）の境界を跨ぐ
  - 権限境界（権限の切替/伝播/委任）：送信対象（招待・パスワードリセット・問い合わせ返信・監査通知）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - ヘッダ値に改行が混入し、次行が新しいヘッダとして解釈される（ヘッダ追加）
  - 改行後が空白/タブで始まると「前ヘッダの継続行」として扱われる（ヘッダ折り返し）
  - 実装が「ヘッダTo/Cc/Bcc」から配送先（RCPT）を組み立てている（エンベロープ宛先に波及）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 入力がヘッダ値に入る"構造破壊点（CRLF）"をモデル化できる
  - 受信した生メール（raw）で、当該入力がヘッダ行に入り、改行の扱いが不適切であることを確認した
- 何が"推定"できるか（推定の根拠/前提）：
  - 実害を"業務フロー"として確定できる（誰が受け取る/何が漏れる/何が誤誘導される）
  - 影響の成立条件（本案件で確認できた範囲）
- 何は"言えない"か（不足情報・観測限界）：
  - すべての環境での実害評価（環境により変わる点は条件として明示する）
  - すべての入力面を網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：ヘッダ構造破壊が観測できた（高優先度） → その入力が「追加宛先」「Reply-To」「MIME解釈」など"どの分岐点"に影響するかを確定
  - パターンB：プロバイダが拒否して実害は出ない（設計上の弱さは残る） → アプリ側での拒否/正規化がないなら、将来の送信方式変更や別経路（バッチ/別サービス）で再燃する

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - ユーザ入力がヘッダへ直接入る（問い合わせフォーム / サポート返信、招待メール / 共有リンク / プロジェクト通知）
  - ヘッダ相当の項目をアプリが提供している（"カスタムヘッダ"機能、CSV等からの一括送信）
- 優先度の付け方（時間制約がある場合の順序）：
  1) エンベロープ宛先に波及（最重要：情報漏えい） → 本来の送信先以外へ配送される（招待・請求・通知の漏えい）
  2) ヘッダ追加（追加宛先、返信先改変、Content-Type改変）
  3) ヘッダ折り返し（既存ヘッダ値の"延長"として不正文字列が入る）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：Subject（件名）、From表示名（name部分）、Reply-To、CC（UIがある場合）、カスタムヘッダ（X-タグ等）への入力
  - 攻め筋2：改行相当の混入が「拒否/除去/通過」どれかを観測
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - API送信かSMTP直送か（実害の重み） → メールAPIの場合、プロバイダ側でヘッダ値の改行を拒否することがある（=アプリが脆弱でもブロックされる）

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：ヘッダ構造破壊が観測できた（高優先度）
  - 次の検証：
    - その入力が「追加宛先」「Reply-To」「MIME解釈」など"どの分岐点"に影響するかを確定
    - 宛先拘束（エンベロープ固定）があるかを確認し、情報漏えい成立の有無で重大度を決める
    - 同じ入力が他通知（招待/請求/監査）にも流用されていないか棚卸し
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 受信した生メールのヘッダに "想定外ヘッダ行" が現れる（raw source で確認）
- 仮説B：プロバイダが拒否して実害は出ない（設計上の弱さは残る）
  - 次の検証：
    - アプリ側での拒否/正規化がないなら、将来の送信方式変更や別経路（バッチ/別サービス）で再燃する
    - "プロバイダ依存の安全性"として改善提案を残す（アプリで明示ガード）
  - 期待する観測：
    - メールAPIの場合、プロバイダ側でヘッダ値の改行を拒否することがある（=アプリが脆弱でもブロックされる）

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/05_input/17_email_header_injection_boundary/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - 受信した生メール（raw source）、ヘッダ抜粋、Message-ID、日時、送信ログ（request_id）
- 観測の取り方（どの視点で差分を見るか）：
  - メモに必ず残す項目：入力項目、ヘッダ値の変化、改行の扱い、送信方式（API/SMTP直送）、実害の分岐点
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/email_header_injection 2>/dev/null
    cd ~/keda_evidence/email_header_injection
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（追加宛先の実害検証（第三者に送る）は行わない）
      - 受信確認は、必ず自分が管理するメールアドレス（検証用）で行う
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、入力項目、ヘッダ値、改行の扱い、送信方式、実害の分岐点

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 目的：生メール（raw）でヘッダ構造が壊れるかを確認する。
# - 入力が Subject/From表示名/Reply-To 等に入ることをまず確認
# - 改行相当の混入が「拒否/除去/通過」どれかを観測
# - 宛先（配送先）がエンベロープ固定か、ヘッダ由来かを切り分ける
~~~~

- この例で観測していること：
  - 入力がヘッダ値に入る"構造破壊点（CRLF）"をモデル化できる
- 出力のどこを見るか（注目点）：
  - 受信した生メール（raw source）でのヘッダ構造、ヘッダ抜粋、Message-ID
- この例が使えないケース（前提が崩れるケース）：
  - メール送信機能がない場合、観測できない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：入出力検証、データ保護
  - 該当要件（可能ならID）：ヘッダ生成をライブラリに委譲、ヘッダ値の改行禁止、エンベロープ（SMTP RCPT）とヘッダ（To/Cc/Bcc）を分離し、送信先はサーバ側の許可リスト/認可で拘束する
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：メール送信は「アプリ→外部（MTA/メールAPI）→人間（受信者）」の境界を跨ぐ。入力が **ヘッダ値として扱われる** と、CRLF混入で"ヘッダ行の構造"が壊れ、追加ヘッダ・宛先増殖・本文解釈変更などへ波及する。
    - 満たす：ヘッダ生成をライブラリに委譲、ヘッダ値の改行禁止、エンベロープ（SMTP RCPT）とヘッダ（To/Cc/Bcc）を分離し、送信先はサーバ側の許可リスト/認可で拘束する。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：入力検証だけでなく、連携（メール送信・通知・招待）機能で「ユーザ入力がどのヘッダ/どのテンプレ変数に入るか」を追い、受信した生メール（raw source）で構造破壊が起きるかを確認する。
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：メールヘッダ注入の特定と成立条件の詰め方
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：情報収集、脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：情報収集でメール送信経路（SMTP直送 / SES・SendGrid等API / 社内MTA中継）、送信対象（招待・パスワードリセット・問い合わせ返信・監査通知）を棚卸し。脆弱性分析でエンベロープ（宛先指定）とメッセージ（ヘッダ/本文）で「入力が入る場所」を分解し、CRLFの遮断点を特定。侵害評価で実害はサーバRCEではなく、(1) 追加宛先での情報漏えい、(2) Reply-To等改変によるフィッシング補助、(3) MIME/Content-Type改変によるクライアント側解釈変更、(4) 運用・監査逸脱。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：初期侵入/横展開への接続：メールはT1566（Phishing）の媒介になり得るが、本件は「アプリ機能が攻撃者の配布経路になる」点が本質。実行：T1204（User Execution：受信者がメールを開く/リンクを踏む）
  - 攻撃者の目的（この技術が支える意図）：影響：情報漏えい（宛先追加）、信頼境界の破壊（通知フローの改ざん）、業務妨害（大量送信誘発）など。
  - 参照：https://attack.mitre.org/tactics/TA0001/（Initial Access）

## 参考（必要最小限）
- Email Header Injection（CRLF Injection in email headers）の定義と解説
- SMTPエンベロープとメッセージヘッダの違い
- RFC準拠のメール生成ライブラリ/メールAPI

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`05_input_20_crlf_injection_01_response_splitting（header_body）.md`
- 関連 topics：`01_topics/01_asm-osint/19_email_infra（SPF_DKIM_DMARC）と攻撃面.md`
- 関連 labs：`04_labs/02_web/05_input/17_email_header_injection_boundary/`（追加候補）

---

## 深掘りリンク（最大8）
- `05_input_20_crlf_injection_01_response_splitting（header_body）.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `05_input_06_xss_01_反射_境界モデル.md`
- `05_input_06_xss_02_格納_境界モデル.md`
- `03_authz_01_境界モデル（オブジェクト_ロール_テナント）.md`
- `04_api_09_error_model_情報漏えい（例外_スタック）.md`
- `01_topics/01_asm-osint/19_email_infra（SPF_DKIM_DMARC）と攻撃面.md`
- `04_api_08_file_export_エクスポート境界（CSV_PDF）.md`

---
