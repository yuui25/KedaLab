# 05_input_08_xxe_01_parser（doctype_entity）

## このファイルで扱う概念
- XMLパーサのDOCTYPE/Entity処理と解釈境界。

## 危険性を一言で
- 外部実体の解決で、内部情報や内部ネットワークに到達する。

## 最小限の成立判断（目安）
- DOCTYPE有無で A/B 差分が再現する。

## 観測例（差分のイメージ）
- A: 通常処理、B: 解析エラーや応答差分が出る。

## 観測が取れない場合の代替
- パーサ設定（DOCTYPE/Entity無効化）を設定ファイルで確認する。

## 時間制約下の最小観測点
- DOCTYPE許可の有無と、外部解決の可否。

## 対策の優先順位
1) DOCTYPE/Entityを無効化
2) 代替フォーマットの採用
3) 解析環境の隔離

## 目的（この技術で到達する状態）
- XXEを「XMLに悪い文字が入る」ではなく、**パーサが持つ仕様機能（DTD/ENTITY/外部参照/展開）が“実行”として働く境界**だと説明できる。
- 実務判断として、次を即断できる
  - どの入力経路が XML パースに到達しているか（API/ファイル/埋め込みフォーマット）
  - そこで使われるパーサが「DOCTYPEを許す／外部実体を解決する／実体を展開する」状態か
  - “外部実体の解決”が内部到達性（SSRF/ファイル参照/DoS）に繋がる根拠を、観測で確定できる
- 次ファイル（Blind/OOB、to SSRF）へ地続きで繋げるために、まず **Parserの成立条件（doctype/entity）** を固定する。

---

## 前提（対象・範囲・想定）
- 対象：XML入力を扱う境界、XMLパース地点、API/ファイル/サードパーティ処理、XMLを扱う経路：API（`Content-Type: application/xml` / `text/xml`、SOAP / XML-RPC / 古い連携API）、ファイル（直球：`.xml`、埋め込み：`.svg`（XML）、Office（docx/xlsx/pptxの中身はXML）、一部のePub、設定ファイル、RSS/Atom など）、生成・変換（"受け取りはJSON"でも、バックエンドでXML変換（テンプレ/マッピング）しているケースがある）
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - XXEは、アプリがXMLを解析する際に、DTD/外部実体参照（External Entity）を"機能として"有効にしていると成立する、重要な切り分け：「DOCTYPE/DTD を解釈する」＝ 文法宣言を受理する、「外部実体を解決（resolve）する」＝ URI/ファイル等へアクセスして内容を取りに行く、「実体を展開（expand）する」＝ 取り込んだ内容を文書ツリーに混入させる／評価する、実務で事故りやすいのは「外部実体は無効にしたつもり」でも、DTDが生きている（DoSや内部参照が残る）、一部のパーサ／経路だけ設定が漏れている（例：アップロード処理・変換処理の別ライブラリ）、"外部参照をする別機能"（XInclude、テンプレ変換、SVG等）で別ルートが残る、など
- できること/やらないこと（安全に検証する範囲）：
  - できること：どの入力経路が XML パースに到達しているか（API/ファイル/埋め込みフォーマット）、そこで使われるパーサが「DOCTYPEを許す／外部実体を解決する／実体を展開する」状態か、"外部実体の解決"が内部到達性（SSRF/ファイル参照/DoS）に繋がる根拠を、観測で確定できる、次ファイル（Blind/OOB、to SSRF）へ地続きで繋げるために、まず **Parserの成立条件（doctype/entity）** を固定する
  - やらないこと：影響実証は最小限（成立根拠の確定まで）。高負荷/外部到達/大量出力は避ける
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
  - `01_topics/02_web/05_input_08_xxe_02_blind（oob）.md`
  - `01_topics/02_web/05_input_08_xxe_03_to_ssrf（internal_reachability）.md`
  - `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`
  - `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
  - `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`

## 主要パーサの設定例（最小・要点）
### Java (JAXP)
```java
DocumentBuilderFactory f = DocumentBuilderFactory.newInstance();
f.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
f.setFeature("http://xml.org/sax/features/external-general-entities", false);
f.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
f.setXIncludeAware(false);
```

### .NET (XmlReader)
```csharp
var settings = new XmlReaderSettings {
  DtdProcessing = DtdProcessing.Prohibit,
  XmlResolver = null
};
```

### libxml2 (C/CLI)
```c
// 例: 外部アクセス禁止（NOENTは使わない）
xmlReadFile(path, NULL, XML_PARSE_NONET);
```

### Node.js（代表例）
```js
// 例: DTD/ENTITYを受け付けない設定を持つパーサを選ぶ
// fast-xml-parser: { processEntities: false }
```

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - XML入力を扱う境界、XMLパース地点、API/ファイル/サードパーティ処理、XMLを扱う経路：API（`Content-Type: application/xml` / `text/xml`、SOAP / XML-RPC / 古い連携API）、ファイル（直球：`.xml`、埋め込み：`.svg`（XML）、Office（docx/xlsx/pptxの中身はXML）、一部のePub、設定ファイル、RSS/Atom など）、生成・変換（"受け取りはJSON"でも、バックエンドでXML変換（テンプレ/マッピング）しているケースがある）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：
    - 入力境界：XMLが入ってくる"現実の経路"（API、ファイル、生成・変換）、ここでは「XMLっぽい場所」ではなく、**"XMLパースが発生する場所"を資産境界として特定**する
  - 信頼境界（外部連携・第三者・越境ポイント）：
    - パーサ境界：DOCTYPE/DTD を受理するか、DOCTYPE（DTD）を受理できる状態は、入力の中に「文法宣言（＝実体宣言）」を持ち込める状態、DTDが有効だと、以下が開く：ENTITY宣言（一般実体/パラメータ実体）、実体展開（DoSの入口）、外部参照（外部サブセット、SYSTEM識別子等）の入口
    - 実体境界：外部実体の「解決」と「展開」を分離して考える、解決（resolve）：OSファイル、HTTP(S)、その他URIスキーム（ライブラリ依存）へアクセスし得る、ここが「到達性（SSRF/FS）」の境界、展開（expand）：解決した内容が文書として混入する／ログやレスポンスに出る／後段処理に渡る、ここが「データ流出」「二次解釈（テンプレ等）」の境界、重要：**"解決できるが展開しない"** でも、Blind/OOB で成立し得る（次ファイルで扱う）
  - 権限境界（権限の切替/伝播/委任）：
    - リソース境界：実体展開DoS（Billion Laughs等）、DTD/ENTITY を許すだけで、外部参照が無くても"展開爆発"でCPU/メモリを消費し得る、つまり「外部実体だけ無効」では DoS 経路が残る可能性がある（パーサ設定の粒度が重要）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - "XMLパースしている"証拠を取る：レスポンスヘッダ/ボディ、エラーメッセージ、ログ（可能なら）で、XMLパーサ由来の例外が出るか、同一入力で、XMLが壊れている場合のエラー、XMLが通る場合の挙動、の差分を作り、パース地点を確定する
  - DOCTYPEの受理可否（このファイルの主題）：DOCTYPEを含む入力を与え、次を観測する、明示的に拒否するエラー（"DOCTYPE禁止/DTD無効"系）、何も言わず通る（= DTDが生きている可能性）、"通った"だけでは外部実体解決まで確定しないが、**危険側の前提が揃った**と判断できる
  - 実体展開（DoS方向）の兆候：解析時間・レスポンス遅延・CPU高騰（ラボで再現しやすい）、ここは本番で過負荷を与えないように、必ず"影響を制御した検証"に落とす（labs連動）
  - 例外パスの探索（設定漏れを見つける）：同じXMLでも経路が違うとパーサが違う、直接API送信、ファイルアップロード→サムネイル/プレビュー→変換、インポート/エクスポート、"一箇所で安全"を証明しても、全体の安全にはならない（境界は経路ごとに存在する）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - DOCTYPE/DTD が拒否される（＝文法宣言を持ち込めない）、外部一般実体/外部パラメータ実体が無効、XInclude等の外部取り込み機能も無効、または到達先が厳格に制限、変換/検証/プレビュー等の別経路でも同じ設定が適用されている（"一箇所だけ対策"ではない）
- 何が"推定"できるか（推定の根拠/前提）：
  - DOCTYPEが受理される、かつ、外部実体が解決される、または、実体展開DoSが成立する、または、一部経路で設定が漏れている（アップロード→変換で別パーサ）、この状態は "入力→実行境界" が開いている、と評価する
- 何は"言えない"か（不足情報・観測限界）：
  - 外部一般実体だけ無効で、DTD自体は有効（DoSが残る）、メインAPIは安全だが、バッチ/管理UI/ファイル処理で別ライブラリが使われ設定漏れ、例外処理/ログ出力により、内部情報が"差分"として観測できてしまう（成立根拠の補助になる）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：安全側（推奨） → DOCTYPE/DTD が拒否される（＝文法宣言を持ち込めない）、外部一般実体/外部パラメータ実体が無効、XInclude等の外部取り込み機能も無効、または到達先が厳格に制限、変換/検証/プレビュー等の別経路でも同じ設定が適用されている（"一箇所だけ対策"ではない）
  - パターンB：XXE成立の前提が揃う（危険） → DOCTYPEが受理される、かつ、外部実体が解決される、または、実体展開DoSが成立する、または、一部経路で設定が漏れている（アップロード→変換で別パーサ）、この状態は "入力→実行境界" が開いている、と評価する
  - パターンC：一見安全に見えるが、境界が部分的に残る（実務で多い） → 外部一般実体だけ無効で、DTD自体は有効（DoSが残る）、メインAPIは安全だが、バッチ/管理UI/ファイル処理で別ライブラリが使われ設定漏れ、例外処理/ログ出力により、内部情報が"差分"として観測できてしまう（成立根拠の補助になる）

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - "XMLを受け取る面"を探す（表のUIではなく、連携・アップロード・変換・プレビューに寄る）、成立根拠としてまず狙うのは「DOCTYPEを受理するか」、受理される＝攻撃面として優先度が上がる（外部参照/OOB/DoSへ伸びる）
- 優先度の付け方（時間制約がある場合の順序）：
  - まず見る：XML入力を扱う境界、XMLパース地点、API/ファイル/サードパーティ処理、XMLを扱う経路（API、ファイル、生成・変換）、次に見る：DOCTYPE/DTD を受理するか、外部実体の「解決」と「展開」を分離して考える、最後に見る：実体展開DoS（Billion Laughs等）の兆候
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：XXEを「XMLに悪い文字が入る」ではなく、**パーサが持つ仕様機能（DTD/ENTITY/外部参照/展開）が"実行"として働く境界**だと説明できる、実務判断として、次を即断できる、どの入力経路が XML パースに到達しているか（API/ファイル/埋め込みフォーマット）、そこで使われるパーサが「DOCTYPEを許す／外部実体を解決する／実体を展開する」状態か、"外部実体の解決"が内部到達性（SSRF/ファイル参照/DoS）に繋がる根拠を、観測で確定できる
  - 攻め筋2：次に「外部参照を解決するか」は、環境依存が大きいので観測（DNS/HTTP egress）で確定する（次ファイルで深掘り）、次ファイル（Blind/OOB、to SSRF）へ地続きで繋げるために、まず **Parserの成立条件（doctype/entity）** を固定する
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 実務で事故りやすいのは「外部実体は無効にしたつもり」でも、DTDが生きている（DoSや内部参照が残る）、一部のパーサ／経路だけ設定が漏れている（例：アップロード処理・変換処理の別ライブラリ）、"外部参照をする別機能"（XInclude、テンプレ変換、SVG等）で別ルートが残る、など

---

## 次に試すこと（仮説A/B：条件で次の手が変わる）
### 仮説A：DOCTYPEが拒否される（安全側に見える）
- 次の一手
  1) 同一アプリ内で別経路（アップロード/変換/管理機能）を探索し、そこでも同様に拒否されるか確認
  2) XMLでなく “XML内包フォーマット”（SVG/Office等）が処理される経路がないか（次の入力経路探索）
  3) 例外処理で情報露出（パーサ/ライブラリ/設定）が出ていないかを確認（攻撃面の推定に使える）
- 期待する状態：どの経路でも一貫して DTD/外部参照を無効化できている

### 仮説B：DOCTYPEが受理される（危険側の前提が揃う）
- 次の一手
  1) 外部実体“解決”が起きるか（DNS/HTTP egress）を観測して確定（次ファイル：Blind/OOB）
  2) 外部参照が無くても成立する DoS（展開爆発）が残っていないかをラボで検証
  3) どのパーサ/ライブラリが使われているかを特定し、無効化設定の適用箇所（全経路）を洗い出す
- 期待する状態：修正は「入力フィルタ」ではなく「パーサ設定」で閉じる

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/` ）：
  - 参照ファイル：`04_labs/02_web/05_input/08_xxe_parser_doctype_entity_boundary/`
- 取得する証跡（目的ベースで最小限）：
  - アプリログ（パーサ例外の種類、拒否理由）、外向き通信ログ（DNS/HTTP）、リソース（CPU/メモリ、応答時間）、レスポンスヘッダ/ボディ、エラーメッセージ
- 観測の取り方（どの視点で差分を見るか）：
  - ターゲット：代表的パーサを複数用意（Java / .NET / libxml2系 / Node等）、切替軸：DOCTYPE許可/禁止、外部実体解決の可否、展開の可否、XIncludeの可否、観測点：アプリログ（パーサ例外の種類、拒否理由）、外向き通信ログ（DNS/HTTP）、リソース（CPU/メモリ、応答時間）、巻き戻し：スナップショット/コンテナ再起動で再現性を担保

---

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 目的：DOCTYPEが受理されるか（DTDが生きているか）を"差分"で確認する

# - 成功/失敗ではなく、エラー種別・応答差分・ログ差分を証拠化する

# 例：XML入力を送れる箇所に対し、DOCTYPEを含むXMLを与えて挙動を見る（ラボ推奨）

# <!DOCTYPE r [ <!ENTITY x "test"> ]>

# <r>&x;</r>

~~~~

- この例で観測していること：DOCTYPE/DTD を受理するか、外部実体の「解決」と「展開」を分離して考える、実体展開DoS（Billion Laughs等）の兆候、例外パスの探索（設定漏れを見つける）
- 出力のどこを見るか（注目点）：レスポンスヘッダ/ボディ、エラーメッセージ、ログ（可能なら）で、XMLパーサ由来の例外が出るか、同一入力で、XMLが壊れている場合のエラー、XMLが通る場合の挙動、の差分を作り、パース地点を確定する、明示的に拒否するエラー（"DOCTYPE禁止/DTD無効"系）、何も言わず通る（= DTDが生きている可能性）、解析時間・レスポンス遅延・CPU高騰（ラボで再現しやすい）
- この例が使えないケース（前提が崩れるケース）：XML入力を扱う境界が存在しない場合、またはXMLパースが発生しない場合

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：V5 Validation, Sanitization and Encoding
  - 該当要件（可能ならID）：V5.1.1、V5.1.2、V5.2.1
  - このファイルの内容が「満たす/破れる」ポイント：
    - 満たす/破れる点：XXEを「XMLに悪い文字が入る」ではなく、**パーサが持つ仕様機能（DTD/ENTITY/外部参照/展開）が"実行"として働く境界**だと説明できる、実務判断として、次を即断できる、どの入力経路が XML パースに到達しているか（API/ファイル/埋め込みフォーマット）、そこで使われるパーサが「DOCTYPEを許す／外部実体を解決する／実体を展開する」状態か、"外部実体の解決"が内部到達性（SSRF/ファイル参照/DoS）に繋がる根拠を、観測で確定できる、XML入力を扱う境界で「DTD/外部実体/実体展開/外部参照（URI解決）」を無効化し、サーバが "XMLの仕様機能" を通じて外部資源（FS/HTTP等）へ到達しないことを保証する。単に入力バリデーションではなく「パーサ設定＝実行境界の制御」として扱う
- WSTG：
  - 該当カテゴリ/テスト観点：WSTG-INPV-07 Testing for XML Injection
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：
    - XXEは Input Validation Testing の一部として扱い、(1) XMLパース地点の発見、(2) DOCTYPE/ENTITY が受理されるか、(3) 外部実体の解決・展開が起きるか、(4) 例外/応答差分/外向き通信などの観測で成立根拠を確定する
- PTES：
  - 該当フェーズ：Vulnerability Analysis、Exploitation、Reporting
  - 前後フェーズとの繋がり（1行）：XMLを扱う経路（API/ファイル/サードパーティ処理）を列挙し、パーサの種類・設定・実体解決器（resolver）の到達性を境界としてモデル化、成立根拠は「DOCTYPE/ENTITY を解釈する」「外部実体を解決する」「展開によりデータが混入する」など、パーサ挙動の差分で証拠化（次ファイルで OOB/Blind に拡張）、アプリ不備ではなく"安全でない既定値＋設定漏れ"として是正案（設定と設計）に落とす
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Discovery、Initial Access
  - 攻撃者の目的（この技術が支える意図）：外部実体の解決は、攻撃者にとって内部資源探索（Discovery）や内部サービス到達（SSRF連鎖）を可能にする前段になり得る。技術ユニットとしては「入力→パーサ→外部参照」の実行境界を閉じる前提

## 参考（必要最小限）
- OWASP WSTG：Testing for XML Injection（WSTG-INPV-07）
- OWASP XXE Prevention Cheat Sheet
- PortSwigger：XML External Entity (XXE) injection
- W3C：XML 1.0 Specification（DTD/ENTITYの仕様根拠）

## リポジトリ内リンク（最大3つまで）
- `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
- `01_topics/02_web/05_input_08_xxe_02_blind（oob）.md`
- `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`

---

## 深掘りリンク（最大8）
- `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
- `01_topics/02_web/05_input_08_xxe_02_blind（oob）.md`
- `01_topics/02_web/05_input_08_xxe_03_to_ssrf（internal_reachability）.md`
- `01_topics/02_web/05_input_09_ssrf_01_reachability（internal_localhost_metadata）.md`
- `01_topics/02_web/04_api_00_権限伝播・入力・バックエンド連携.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`
- `04_labs/01_local/03_capture_証跡取得（pcap/har/log）.md`
- `04_labs/02_web/05_input/08_xxe_parser_doctype_entity_boundary/`
