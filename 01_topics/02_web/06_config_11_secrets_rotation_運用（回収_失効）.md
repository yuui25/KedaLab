# 06_config_11_secrets_rotation_運用（回収_失効）
Secrets Rotation運用（回収・失効）：漏えいは起きる前提で"有効期間"と"回収線"を設計する

---

## 目的（この技術で到達する状態）
- ローテーションを「回す」だけで終わらせず、**回収（revocation）と失効反映（反映遅延）まで含めた実効性**を評価できる。
- 実務で多い秘密（JWT署名鍵、APIキー、Webhook署名鍵、DB資格情報）を分類し、優先度を付けられる。

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - JWT署名鍵（JWKS）をキャッシュしていて、旧鍵がしばらく有効
  - 外部連携（Webhook/パートナー）が旧鍵を持ち続け、切替が段階的になる
  - "秘密がどこにあるか"の棚卸し不足（CI/CD、環境変数、コード、ログ）
- できること/やらないこと（安全に検証する範囲）：
  - やる：秘密管理、トークン寿命、失効、ログ/クライアント露出、外部連携鍵の扱いを検証する
  - やらないこと：秘密を意図的に漏えいさせることはしない
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_02_Secrets管理と漏えい経路（JS_ログ_設定_クラウド）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - 秘密の分類（長期鍵/短期トークン/署名鍵/外部連携鍵）
    - 世代管理（kid等）、重なり期間、失効反映（キャッシュ/JWKS）
    - 漏えい経路（ログ/設定/クライアント）と組み合わせた運用要件化
  - 扱わない（別ユニットへ接続）：
    - 秘密の詳細な管理方法（本プロジェクトは境界と成立根拠を優先）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 世代管理があるか（kid等）→ 段階切替が可能か
  - 旧鍵の受け入れ期間（重なり）→ 長すぎないか
  - 失効反映の遅延要因（JWKSキャッシュ、CDNキャッシュ、アプリ内キャッシュ）
  - 秘密の露出経路（ログ/エラー/クライアント/設定）→ 露出があるなら優先度を上げる
- 境界の観点：
  - 権限境界（権限の切替/伝播/委任）：秘密＝権限（API操作/署名/認証）を付与する手段
  - 信頼境界（外部連携・第三者・越境ポイント）：外部連携に配布した秘密は回収が難しい
  - 運用境界（管理主体・委託先・対象範囲の線引き）：失効反映が遅いと、対応が間に合わない
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 回収線が無い：漏えい後の被害が継続する（インシデント対応が成立しない）
  - 反映遅延が長い：回収しても現場で効かない（運用境界の欠陥）
  - 露出経路がある：ローテーション不備は重大度を大きく押し上げる

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 回収線が無い：漏えい後の被害が継続する（インシデント対応が成立しない）
  - 反映遅延が長い：回収しても現場で効かない（運用境界の欠陥）
  - 露出経路がある：ローテーション不備は重大度を大きく押し上げる
- 何が"推定"できるか（推定の根拠/前提）：
  - 秘密の分類（長期鍵/短期トークン/署名鍵/外部連携鍵）
  - 世代管理（kid等）、重なり期間、失効反映（キャッシュ/JWKS）
- 何は"言えない"か（不足情報・観測限界）：
  - すべての秘密を網羅した断定（観測範囲に依存）
  - すべての回収線を網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：回収線がある（健全） → 漏えい後の被害が継続しない（インシデント対応が成立する）
  - パターンB：回収線が無い（境界が崩れている） → 漏えい後の被害が継続する（インシデント対応が成立しない）
  - パターンC：反映遅延が長い（運用境界の欠陥） → 回収しても現場で効かない

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - まず秘密の入手（ログ/設定/外部連携/バックアップ）を狙う
  - 回収が弱いと、短期の侵害が長期の継続アクセスに変わる
  - 外部連携鍵は回収が難しく、長期的に悪用されやすい
- 優先度の付け方（時間制約がある場合の順序）：
  1) 認証・署名（最優先：被害半径が最大） → JWT署名鍵、セッション署名/暗号鍵、リフレッシュトークン保護鍵
  2) 外部連携（回収が難しい） → Webhook署名鍵、パートナーAPIキー、通知/決済/IdP連携鍵
  3) インフラ（漏えい時に横展開しやすい） → DB資格情報、ストレージ鍵、クラウドIAM（権限設計と密結合）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：ローテーションは可能だが運用が未整備 → 世代管理（kid）＋重なり期間＋監査ログを要件化。失効反映時間（SLO）を決め、キャッシュTTLを合わせる。緊急回収手順（誰が/どこで/何を/順番）を最小限で整備
  - 攻め筋2：ローテーションが難しい（外部依存・古い設計） → 短寿命化（トークン寿命、権限最小化）で被害期間を短縮。露出経路の削減を優先（ログ/クライアント/設定）。外部連携は切替窓（両鍵受け入れ）を設計し、最終期限を必須化
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 回収できない秘密は"漏えいした瞬間に詰む"

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：ローテーションは可能だが運用が未整備
  - 成立条件：
    - ローテーションは可能だが運用が未整備
  - 次の検証：
    - 世代管理（kid）＋重なり期間＋監査ログを要件化
    - 失効反映時間（SLO）を決め、キャッシュTTLを合わせる
    - 緊急回収手順（誰が/どこで/何を/順番）を最小限で整備
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：世代管理（kid）＋重なり期間＋監査ログを要件化できる
    - 失敗：ローテーションが適切に運用されている
- 仮説B：ローテーションが難しい（外部依存・古い設計）
  - 成立条件：
    - ローテーションが難しい（外部依存・古い設計）
  - 次の検証：
    - 短寿命化（トークン寿命、権限最小化）で被害期間を短縮
    - 露出経路の削減を優先（ログ/クライアント/設定）
    - 外部連携は切替窓（両鍵受け入れ）を設計し、最終期限を必須化
  - 期待する観測：
    - 成功：短寿命化（トークン寿命、権限最小化）で被害期間を短縮できる
    - 失敗：ローテーションが適切に設計されている

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/11_secrets_rotation_revocation/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - 世代管理があるか（kid等）→ 段階切替が可能か、旧鍵の受け入れ期間（重なり）→ 長すぎないか、失効反映の遅延要因（JWKSキャッシュ、CDNキャッシュ、アプリ内キャッシュ）、秘密の露出経路（ログ/エラー/クライアント/設定）→ 露出があるなら優先度を上げる
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：秘密の分類（長期鍵/短期トークン/署名鍵/外部連携鍵）
  - 視点2：世代管理（kid等）、重なり期間、失効反映（キャッシュ/JWKS）
  - 視点3：漏えい経路（ログ/設定/クライアント）と組み合わせた運用要件化
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/secrets_rotation 2>/dev/null
    cd ~/keda_evidence/secrets_rotation
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（秘密を意図的に漏えいさせることはしない）
      - 秘密管理、トークン寿命、失効、ログ/クライアント露出、外部連携鍵の扱いを検証する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、秘密の分類（長期鍵/短期トークン/署名鍵/外部連携鍵）、世代管理（kid等）、重なり期間、失効反映（キャッシュ/JWKS）、漏えい経路（ログ/設定/クライアント）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# ローテーション評価の要点：
# - 世代管理（kid）があるか
# - 旧鍵がいつまで受け入れられるか（重なり）
# - 失効反映の遅延要因（キャッシュ/JWKS）
# - 秘密の露出経路（ログ/エラー/クライアント）
~~~~

- この例で観測していること：
  - ローテーション評価の要点（世代管理（kid）があるか、旧鍵がいつまで受け入れられるか（重なり）、失効反映の遅延要因（キャッシュ/JWKS）、秘密の露出経路（ログ/エラー/クライアント））
- 出力のどこを見るか（注目点）：
  - 世代管理（kid）、旧鍵の受け入れ期間（重なり）、失効反映の遅延要因（キャッシュ/JWKS）、秘密の露出経路（ログ/エラー/クライアント）
- この例が使えないケース（前提が崩れるケース）：
  - ローテーションが設定されていない場合、観測できない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用、鍵管理
  - 該当要件（可能ならID）：秘密が長期有効で回収できないと、漏えい後の被害期間が無期限化する。失効反映が遅い（キャッシュ/JWKS等）とインシデント対応が成立しない。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：秘密が長期有効で回収できないと、漏えい後の被害期間が無期限化する。失効反映が遅い（キャッシュ/JWKS等）とインシデント対応が成立しない。
    - 満たす：ローテーション（世代管理）＋回収（revocation）＋失効反映（TTL/キャッシュ）を運用要件として持ち、監査ログと最小権限で被害半径を抑える。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：秘密管理、トークン寿命、失効、ログ/クライアント露出、外部連携鍵の扱いを検証する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：脆弱性分析（秘密管理/運用欠陥）→ 侵害評価（継続利用可能性）→ 報告（回収線と運用手順の要求）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Credential Access/Collection
  - 攻撃者の目的（この技術が支える意図）：Credential Access/Collectionの後段で"継続利用"を支える。回収不能はImpactを増幅する前提。
  - 参照：https://attack.mitre.org/tactics/TA0006/（Credential Access）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_02_Secrets管理と漏えい経路（JS_ログ_設定_クラウド）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_02_Secrets管理と漏えい経路（JS_ログ_設定_クラウド）.md`
- 関連 topics：`06_config_08_logging_pii_secret（マスキング_相関）.md`
- 関連 topics：`06_config_12_s3_presigned_url_期限と権限境界.md`

---

## 深掘りリンク（最大8）
- `06_config_02_Secrets管理と漏えい経路（JS_ログ_設定_クラウド）.md`
- `06_config_08_logging_pii_secret（マスキング_相関）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_12_s3_presigned_url_期限と権限境界.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `06_config_04_csp_実務設計（report-only_違反収集）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`

---
