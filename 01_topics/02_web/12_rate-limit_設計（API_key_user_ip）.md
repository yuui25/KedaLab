# 12_rate-limit_設計（API_key_user_ip）

## 基本概念の要約
- 多層キーで制限する境界

## 実装例（ツール）
- curlやPostmanで429の再現を確認する
"何を守りたいか"から逆算し、キー設計・閾値・段階制御・例外・監視までを境界として固定する

---

## 目的（この技術で到達する状態）
- レート制限を "429を返す仕組み" ではなく、**権限境界・信頼境界・可用性境界**として説明できる。
- 守る対象を4系統（認証/重要操作/探索/リソース消費）に分解できる。
- キー（API key / user / IP / tenant / device）を、攻撃者の回避戦術を踏まえて組み合わせ設計できる。
- 認証前後、BFF/API、同期/非同期で"どこで制限すべきか"をHop別に決められる。
- 閾値・窓・バースト・段階（soft→hard）を、ユーザ体験とセキュリティの両面で言語化できる。
- 診断では「回避可能性」「例外パス」「副作用（正規ユーザ巻き込み）」を観測で確定できる。

## 前提（対象・範囲・想定）
- 対象：レート制限の設計（API key / user / IP / tenant / device）
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CDN/WAF/LB/Ingress等のエッジ、BFF、API Gateway、各マイクロサービス
  - 認証前後の境界（匿名→ログイン後）、重要操作（step-up）
  - 探索（検索/一覧/ID推測）、重い処理（エクスポート/集計/アップロード等）
- できること/やらないこと（安全に検証する範囲）：
  - できる：許可されたスコープ内での観測（429の確認、閾値の確認）、回避可能性の確認
  - やらない：実際のDoS攻撃、許可されていない対象への検証
- 依存する前提知識（必要最小限）：
  - HTTP/HTTPSの基本、レート制限の基本概念、APIの基本構造
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - API key / user / IP を中心としたレート制限の設計（多層キー、閾値、段階制御）
    - 認証前後の境界（匿名→ログイン後）と、重要操作（step-up）との接続
    - 探索（検索/一覧/ID推測）と、重い処理（エクスポート/集計/アップロード等）の制限
    - 例外・運用（バックオフィス、信頼ネットワーク、アラート、監査ログ）
  - 扱わない（別ユニットへ接続）：
    - ブルートフォース全般 → `02_authn_12_bruteforce_rate-limit_lockout（例外パス）.md`
    - API権限伝播 → `04_api_01_権限伝播モデル（フロント_バックエンド_ジョブ）.md`
    - ログ設計 → `11_logging_tracing_相関IDと証跡設計.md`

---


## “キー設計”の中心：API key / user / IP をどう組み合わせるか
### 1) 単一キーの限界（事故が出る型）
- IPのみ
  - 企業/学校/カフェなどで正規ユーザが同時に使うと簡単に誤爆（DoS自己発生）
  - 攻撃者は分散で回避しやすい
- userのみ
  - 認証前に使えない（ログイン/OTPの入口を守れない）
  - アカウント回しで回避される
- API keyのみ
  - 漏えい/共有/テストキー流出で破綻
  - keyを回されると回避される

### 2) 多層キー（現実解：回避と巻き込みを同時に抑える）
- 匿名（認証前）
  - primary：IP（ただし“硬すぎない”）
  - secondary：IP + UA/JA3/Device cookie（可能なら）で補助（同一IP誤爆を軽減）
  - per-endpoint：ログイン/OTP/回復などは別枠で強め
- 認証後（ユーザが確定）
  - primary：user_id（最も意味が安定）
  - secondary：tenant_id（マルチテナントで必須）
  - tertiary：IP（異常検知、分散回避の補助）
- API（B2B/サービス間）
  - primary：api_key（顧客単位、契約単位）
  - secondary：tenant_id（契約テナントと一致させる）
  - tertiary：source_ip（許可リストや異常検知に利用）

### 3) “キーの正規化”がないと回避される
- 同じ利用者でもキーがぶれると、攻撃者は簡単に回避できる
  - 例：X-Forwarded-For の扱いが曖昧 → 任意IP注入で回避
  - 例：IPv6/IPv4や、プロキシ経由の実IPの取り扱いが統一されない
- 結論：IP基準を使うなら「信頼できる境界で確定した client_ip」を使う（アプリ層でヘッダを盲信しない）

---

## 制限の“形”を選ぶ（閾値だけでなく窓・バースト・段階が本体）
### 1) 窓の概念（実務で必要な最低限）
- 短期（秒〜分）：バースト抑止、総当たり速度抑止
- 中期（分〜時間）：探索・列挙の抑止、OTP連打・疲労攻撃の抑止
- 長期（時間〜日）：API乱用、スクレイピング、コスト爆発の抑止

### 2) バーストと平常時を分ける（ユーザ体験のため）
- 例：短時間だけ突発的に増える操作（ページング/検索/画面遷移）を許容しつつ、平均は抑える
- 設計の言語化：
  - “瞬間的にXは許すが、Yを超えると遅延・CAPTCHA・一時遮断へ移行”

### 3) 段階制御（soft→hard）が“運用可能性”を作る
- soft（減速・追加確認）
  - 429で即拒否ではなく、遅延、チャレンジ、追加確認（CAPTCHA/step-up）へ
- hard（拒否・一時ブロック）
  - 連続超過で短時間ブロック、さらに長期でアカウント保護（ロックは慎重）
- 設計のコツ
  - “正規ユーザ救済”の導線（再試行待ち時間表示、サポート/解除フロー）が無いと事故になる

---

## どこで止めるか（Hop別の設計：Edge / BFF / API / Worker）
### 1) Edge（CDN/WAF/LB/Ingress）
- 強い理由
  - 高トラフィックをアプリに入れずに止められる（可用性保護）
- 弱い理由
  - user_id や tenant_id を知らない（匿名前提になりがち）
- 使い分け
  - 匿名の入口（ログイン、OTP、回復、検索の粗い抑止）はEdgeが強い
  - ただし “重要操作” はアプリ/認可判定点で監査ログとセットで止める方が意味が残る

### 2) BFF（フロント専用バックエンド）
- 強い理由
  - ユーザセッションを理解し、UI単位で制限を設計できる
- 弱い理由
  - BFFを迂回してAPIを直叩きされると意味が薄い
- 使い分け
  - BFFだけに依存せず、API側でも同等の制限を持つ（“二重化”が現実解）

### 3) API（権限判定点の近く）
- 強い理由
  - user_id/tenant_id/action を理解した上で制限できる
  - 監査ログ（誰が何をしたか）と結び付けられる
- 弱い理由
  - ここでしか止めないと、上流での負荷遮断ができず可用性が弱い
- 使い分け
  - 重要操作・探索（列挙）・重い処理はAPIで必ず守る

### 4) Worker/Job（非同期）
- 強い理由
  - “処理コスト”の爆発を直接止められる（エクスポート/メール/生成系）
- 弱い理由
  - ユーザの意図と実行の時間がずれる（誤爆しやすい）
- 使い分け
  - “投入時”にも制限、“実行時”にもコスト制限（キュー深さ、同時実行、ユーザ単位）をかけ、相関IDで監査する

---

## 守る対象別：設計の定石（API key / user / IPの使い分け）
### 1) ログイン（認証前/認証後の境界が切り替わる）
- 認証前
  - IP中心＋（可能なら）デバイス/UA補助
  - アカウント探索（存在確認）を抑えるため、失敗応答の差分を減らしつつ速度も抑える
- 認証後
  - user中心（同一ユーザの失敗連打を止める）
- 追加
  - ログイン成功後に「失敗カウンタをどう扱うか」（すぐリセットか、しばらく保持か）を仕様化しないと回避される

### 2) OTP/MFA（疲労攻撃と誤爆の両方が起きる）
- user中心（主体が明確）
- IP補助（同一ユーザへの多元連打の検知）
- 段階制御（連打で拒否＋別チャネル確認/step-up強化）
- 監査ログ（誰が何回挑戦したか）が必須

### 3) APIキー利用（B2B/SDK/自動処理）
- api_key中心（契約単位の公平性）
- tenant中心（顧客・組織境界）
- IP補助（異常/漏えい時の封じ込め）
- 例外：サーバ間通信（mTLS等）なら、IP/証明書主体で強く制限しても誤爆しにくい

### 4) 検索/一覧（探索・列挙の主戦場）
- user中心（ログイン後はここが主）
- tenant中心（他テナントの誤爆回避）
- IP補助（分散回避の検知）
- “APIパラメータ”による増幅（大きいlimit、複雑なfilter）を別枠で制限（コストベース）

### 5) エクスポート/重い処理（コスト境界）
- user/tenant中心＋ジョブ枠（同時実行数/日次回数）
- API key利用なら api_key中心
- Worker側でコスト上限（時間/件数/サイズ）を設け、異常時は打ち切る
- 監査ログ：誰がどの条件で何件出したか（情報漏えいにも直結）

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - レート制限の応答：429の有無、返るまでの回数/時間（閾値）、どの単位でカウントしているか（IP/user/key/tenant/device）
  - リセットの条件：時間窓、成功でリセット、別エンドポイントで共有
  - 回避可能性：IP分散、アカウント回し、APIキー回し、パス違い（別エンドポイント）で避けられるか
  - ログ/相関：429発生時の trace_id / request_id / principal / tenant / ip / api_key（マスク）/ endpoint / action / decision
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：
    - 認証系：ログイン、パスワードリセット、MFA/OTP、回復コード、magic link、招待受諾
    - 重要操作系：権限付与、連携追加、支払い/承認、エクスポート、削除
    - 探索（列挙）系：検索、一覧、フィルタ、GraphQL、ID推測
    - リソース消費系：画像/動画処理、PDF生成、エクスポート、重い集計、メール送信、Webhook送信
  - 信頼境界（外部連携・第三者・越境ポイント）：
    - IPは"利用者"の良い近似である場合もあるが、現実には崩れる：NAT/企業プロキシ/モバイル回線で多数が同一IPになる（正規ユーザ巻き込み）、攻撃者はIP分散できる（回避される）
    - user はログイン後には強いが、認証前には使えない
    - API key はB2B/API利用では強いが、漏えい/共有/回しで崩れる
    - tenant はマルチテナントで必須（他テナントへの巻き込み回避）
    - device は補助（偽装され得るが、巻き込み抑止に効くことがある）
    - "キーの正規化"がないと回避される：X-Forwarded-For の扱いが曖昧 → 任意IP注入で回避、IPv6/IPv4や、プロキシ経由の実IPの取り扱いが統一されない
  - 権限境界（権限の切替/伝播/委任）：
    - 匿名（認証前）は強めに、認証後は"ユーザ単位"を主にする
    - step-up（再認証/MFA）後は、重要操作に限定して "別枠の制限" をかける（連打対策、疲労攻撃対策）
    - どこで止めるか（Hop別の設計）：Edge（CDN/WAF/LB/Ingress）、BFF（フロント専用バックエンド）、API（権限判定点の近く）、Worker/Job（非同期）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - キー設計：単一キー（IPのみ/userのみ/API keyのみ） vs 多層キー（primary/secondary/tertiary）
  - 制限の"形"：閾値、窓（短期/中期/長期）、バースト、段階制御（soft→hard）
  - 例外パス：ログイン本体は強いが、パスワードリセット/招待/OTP開始が弱い、BFFは強いが、API直叩きが弱い、v1は強いが、v2/旧UIが弱い
  - 副作用（正規ユーザの巻き込み）：IPのみ制限の誤爆（NAT環境）、429がUIで適切に扱われない（無限リトライでさらに悪化）、モバイル/SDKのリトライが指数バックオフになっていない（増幅）

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 429が返るか、返るまでの回数/時間（閾値）、どの単位でカウントしているか（IP/user/key/tenant/device）
  - リセットの条件（時間窓、成功でリセット、別エンドポイントで共有）
  - 回避可能性（IP分散、アカウント回し、APIキー回し、パス違い（別エンドポイント）で避けられるか）
  - 例外パス（ログイン本体は強いが、パスワードリセット/招待/OTP開始が弱い、BFFは強いが、API直叩きが弱い、v1は強いが、v2/旧UIが弱い）
- 何が"推定"できるか（推定の根拠/前提）：
  - レート制限の有効性（回避可能性と誤爆のバランス）
  - 正規ユーザの巻き込みの可能性（IPのみ制限の誤爆（NAT環境）、429がUIで適切に扱われない（無限リトライでさらに悪化））
  - 重要操作/重い処理への制限の有無（エクスポート/生成/通知に制限がなくコスト爆発の可能性）
- 何は"言えない"か（不足情報・観測限界）：
  - 実際の攻撃成功の有無（観測だけでは確定できない）
  - 正規ユーザへの影響の程度（誤爆の実際の発生率）
  - 例外（社内IP/管理者）の適切性（境界の崩壊の有無）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：レート制限が適切に設計されている（多層キー、段階制御、例外パスもカバー）
    - 正常：回避可能性と誤爆のバランスが取れている
  - パターンB："ログインだけ"守って満足する（回復/OTP/招待が穴）
    - 異常：例外パス経由の突破が可能
  - パターンC：IP制限だけで企業ユーザを落とす（誤爆で業務停止）
    - 境界がズレている：正規ユーザの巻き込みが発生
  - パターンD：429だけ返してUIが無限リトライ（自爆DoS）
    - 異常：副作用（正規ユーザの巻き込み）が発生
  - パターンE："重い処理"に制限がなくコスト爆発（エクスポート/生成/通知）
    - 異常：リソース消費系への制限が不足
  - パターンF：X-Forwarded-For をそのまま信じてIP回避される（信頼境界の崩壊）
    - 異常："キーの正規化"がないと回避される

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - ブルートフォース/クレデンシャルスタッフィング：レート制限が"ログインだけ"や"IPだけ"に偏っている場合
  - OTP/MFA疲労：OTP/MFAの制限が弱い場合
  - APIキー悪用：API key を平文表示・ログに混入し二次被害（鍵漏えいで乱用）
  - 高負荷での可用性毀損：レート制限が弱すぎる場合
  - 例外パス（パスワードリセット/招待/検索/エクスポート）経由の突破：例外パスが弱い場合
- 優先度の付け方（時間制約がある場合の順序）：
  1. 例外パス（ログイン本体は強いが、パスワードリセット/招待/OTP開始が弱い）の確認
  2. 回避可能性（IP分散、アカウント回し、APIキー回し、パス違い（別エンドポイント））の確認
  3. 重要操作/重い処理への制限の有無（エクスポート/生成/通知）の確認
  4. ログ/相関（429発生時の trace_id / request_id / principal / tenant / ip / api_key（マスク）/ endpoint / action / decision）の確認
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：ブルートフォース/クレデンシャルスタッフィング
    - 成立条件：レート制限が"ログインだけ"や"IPだけ"に偏っている
    - 結果：回避可能性が高い
  - 攻め筋2：OTP/MFA疲労
    - 成立条件：OTP/MFAの制限が弱い
    - 結果：疲労攻撃が可能
  - 攻め筋3：APIキー悪用
    - 成立条件：API key を平文表示・ログに混入し二次被害（鍵漏えいで乱用）
    - 結果：鍵漏えいで乱用される
  - 攻め筋4：例外パス経由の突破
    - 成立条件：例外パス（パスワードリセット/招待/検索/エクスポート）が弱い
    - 結果：例外パス経由の突破が可能
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 単一キー（IPのみ/userのみ/API keyのみ）の場合：回避可能性が高いため、多層キーへの移行が必要
  - 例外（社内IP/管理者）を広げすぎている場合：攻撃者に悪用される（境界の崩壊）
  - X-Forwarded-For をそのまま信じている場合：任意IP注入で回避される（信頼境界の崩壊）

## 次に試すこと（仮説A/Bの分岐と検証）
> ここが最重要。条件が違うと次の手が変わる形で書く。

- 仮説A：レート制限の"キー設計"が問題（単一キー/回避可能性）
  - 成立条件：IPのみ/userのみ/API keyのみの単一キー、または"キーの正規化"がない
  - 次の検証：
    1) 多層キー（primary/secondary/tertiary）への移行
    2) "キーの正規化"（信頼できる境界で確定した client_ip を使う、アプリ層でヘッダを盲信しない）
    3) 回避可能性（IP分散、アカウント回し、APIキー回し、パス違い（別エンドポイント））の確認
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：回避可能性と誤爆のバランスが取れている
    - 失敗：回避可能性が高い、または正規ユーザの巻き込みが発生
- 仮説B：レート制限の"例外パス"が問題（守っているつもりの穴）
  - 成立条件：ログイン本体は強いが、パスワードリセット/招待/OTP開始が弱い、BFFは強いが、API直叩きが弱い、v1は強いが、v2/旧UIが弱い
  - 次の検証：
    1) "守る対象の同型操作"が別パスで残っていないかが重要（境界は機能で切る）
    2) 例外パス（パスワードリセット/招待/検索/エクスポート）への制限追加
    3) BFFだけに依存せず、API側でも同等の制限を持つ（"二重化"が現実解）
  - 期待する観測：
    - 成功：例外パスも適切にカバーされている
    - 失敗：例外パス経由の突破が可能
- 仮説C：レート制限の"副作用"が問題（正規ユーザの巻き込み）
  - 成立条件：IPのみ制限の誤爆（NAT環境）、429がUIで適切に扱われない（無限リトライでさらに悪化）、モバイル/SDKのリトライが指数バックオフになっていない（増幅）
  - 次の検証：
    1) 段階制御（soft→hard）の導入（429で即拒否ではなく、遅延、チャレンジ、追加確認（CAPTCHA/step-up）へ）
    2) "正規ユーザ救済"の導線（再試行待ち時間表示、サポート/解除フロー）の追加
    3) モバイル/SDKのリトライが指数バックオフになっているか確認
  - 期待する観測：
    - 成功：正規ユーザの巻き込みが最小化される
    - 失敗：誤爆で業務停止、または自爆DoSが発生

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/12_rate_limit_01_key_design_api_key_user_ip/`（候補）
    - `04_labs/02_web/12_rate_limit_02_login_otp_recovery_exception_paths/`（候補）
    - `04_labs/02_web/12_rate_limit_03_cost_based_limits_export_generation/`（候補）
- 取得する証跡（目的ベースで最小限）：
  - レート制限の応答：429の有無、返るまでの回数/時間（閾値）、どの単位でカウントしているか（IP/user/key/tenant/device）
  - リセットの条件：時間窓、成功でリセット、別エンドポイントで共有
  - 回避可能性：IP分散、アカウント回し、APIキー回し、パス違い（別エンドポイント）で避けられるか
  - ログ/相関：429発生時の trace_id / request_id / principal / tenant / ip / api_key（マスク）/ endpoint / action / decision
- 観測の取り方（どの視点で差分を見るか）：
  - 入口（制限があるか）だけで終えない：429が返るか、返るまでの回数/時間（閾値）、どの単位でカウントしているか（IPかuserかkeyか）、リセットの条件（時間窓、成功でリセット、別エンドポイントで共有）
  - 回避可能性：IP分散、アカウント回し、APIキー回し、パス違い（別エンドポイント）で避けられるか
  - 例外パス：ログイン本体は強いが、パスワードリセット/招待/OTP開始が弱い、BFFは強いが、API直叩きが弱い、v1は強いが、v2/旧UIが弱い
  - 副作用（正規ユーザの巻き込み）：IPのみ制限の誤爆（NAT環境）、429がUIで適切に扱われない（無限リトライでさらに悪化）、モバイル/SDKのリトライが指数バックオフになっていない（増幅）
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/rate_limit 2>/dev/null
    cd ~/keda_evidence/rate_limit
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **代表点の抽出** のみ（全エンドポイントを網羅しない）
      - 実際のDoS攻撃は **行わない**（目的は観測であり、攻撃ではない）
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host（対象ドメイン）
    - Path（対象パス）
    - Time（観測時刻）
    - Rate-Limit-Key（IP/user/key/tenant/device）
    - Rate-Limit-Threshold（閾値）
    - Rate-Limit-Window（時間窓）
    - Rate-Limit-Response（429の有無）
    - Principal（ユーザ/サービス）
    - Tenant（組織）
    - Request-ID（相関キー）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 観測のポイント（診断/運用共通）

## 基本概念の要約
- 多層キーで制限する境界

## 実装例（ツール）
- curlやPostmanで429の再現を確認する
# - 429の有無だけでなく、閾値・窓・単位（IP/user/api_key）を確定する

## 基本概念の要約
- 多層キーで制限する境界

## 実装例（ツール）
- curlやPostmanで429の再現を確認する
# - 回避（IP分散/回し）と誤爆（NAT）を同時に評価する

## 基本概念の要約
- 多層キーで制限する境界

## 実装例（ツール）
- curlやPostmanで429の再現を確認する
# - 重要操作/重い処理はAPI/Worker側で必ず制限し、監査ログで追えるようにする

## 基本概念の要約
- 多層キーで制限する境界

## 実装例（ツール）
- curlやPostmanで429の再現を確認する
~~~~

- この例で観測していること：
  - 429の有無だけでなく、閾値・窓・単位（IP/user/api_key）を確定する
  - 回避（IP分散/回し）と誤爆（NAT）を同時に評価する
  - 重要操作/重い処理はAPI/Worker側で必ず制限し、監査ログで追えるようにする
- 出力のどこを見るか（注目点）：
  - レート制限の応答：429の有無、返るまでの回数/時間（閾値）、どの単位でカウントしているか（IP/user/key/tenant/device）
  - リセットの条件：時間窓、成功でリセット、別エンドポイントで共有
  - 回避可能性：IP分散、アカウント回し、APIキー回し、パス違い（別エンドポイント）で避けられるか
  - ログ/相関：429発生時の trace_id / request_id / principal / tenant / ip / api_key（マスク）/ endpoint / action / decision
- この例が使えないケース（前提が崩れるケース）：
  - 許可されていないスコープへの検証（倫理・法的問題）
  - 実際のDoS攻撃（目的は観測であり、攻撃ではない）
  - 個別のWAF/SIEM/APM製品の選定・操作手順（本リポジトリの方針上、製品紹介で終えない）

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：レート制限、ブルートフォース対策
  - 該当要件（可能ならID）：レート制限、ブルートフォース対策
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：レート制限が"ログインだけ"や"IPだけ"に偏ると、(1) ブルートフォース/クレデンシャルスタッフィング、(2) OTP/MFA疲労、(3) APIキー悪用、(4) 高負荷での可用性毀損、(5) 例外パス（パスワードリセット/招待/検索/エクスポート）経由の突破、が現実に起きる。さらに、制限が強すぎると正規ユーザを落とし、弱すぎると攻撃を止められない。**"誰を" "どの境界で" "何を単位に"**制限するかが設計課題になる。
    - 満たす：レート制限を「認証」「重要操作」「探索（列挙）」「リソース消費」の4系統に分け、キー（API key / user / IP / tenant / device）を多層で組み合わせる。さらに、段階制御（soft→hard）、例外（信頼経路/バックオフィス）、検知（相関ID/監査ログ）とセットで"運用できる制限"にする。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：レート制限、ブルートフォース対策
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：
    - 単に429が返るかではなく、(1) どの単位でカウントされているか、(2) 認証前後で制限が変わるか、(3) エラー/リトライで増幅しないか、(4) 分散回避（IP分散/キー回し/アカウント回し）に耐えるか、(5) "本当に守りたい資産（ログイン/OTP/検索/エクスポート）"に効いているか、を観測して境界を確定する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：Vulnerability Analysis、Exploitation、Reporting
  - 前後フェーズとの繋がり（1行）：
    - Vulnerability Analysisで"列挙可能性/総当たり耐性/DoS耐性"を評価し、Exploitationは「現実的な速度で成立するか」「どの回避で突破できるか」を"最小の実験"で示す。Reportingは、レート制限を"設計要件"として（キー設計・閾値・段階制御・例外・監視）まで落とす。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Credential Access（T1110）、Impact（T1499）
  - 攻撃者の目的（この技術が支える意図）：
    - レート制限は、攻撃者の "速度" と "ノイズ" を制約する防御。回避（分散・低速化・キー回し）を前提に、(a) アカウント探索、(b) 認証情報攻撃、(c) API乱用、(d) 可用性妨害 の各行為を、検知（ログ/相関ID）と合わせて抑える。
    - ATT&CKへの接続は「何がどれだけの速度で可能か」を観測で固めてから言語化する。
  - 参照：https://attack.mitre.org/tactics/TA0006/（Credential Access）、https://attack.mitre.org/tactics/TA0040/（Impact）

## 参考（必要最小限）
- OWASP: Rate Limiting Cheat Sheet - https://cheatsheetseries.owasp.org/cheatsheets/Rate_Limiting_Cheat_Sheet.html
- RFC 6585: Additional HTTP Status Codes - https://tools.ietf.org/html/rfc6585#section-4
- Google: Rate Limiting Strategies - https://cloud.google.com/architecture/rate-limiting-strategies-techniques

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/02_web/02_authn_12_bruteforce_rate-limit_lockout（例外パス）.md`（ブルートフォース全般）
  - `01_topics/02_web/11_logging_tracing_相関IDと証跡設計.md`（ログ設計）
  - `01_topics/02_web/03_authz_06_privileged_action_重要操作（承認_送金_権限）.md`（重要操作の境界）
- 関連 playbooks：
  - （該当するplaybookがあれば記載）
- 関連 labs / cases：
  - `04_labs/02_web/12_rate_limit_01_key_design_api_key_user_ip/`（候補）
  - `04_labs/02_web/12_rate_limit_02_login_otp_recovery_exception_paths/`（候補）
  - `04_labs/02_web/12_rate_limit_03_cost_based_limits_export_generation/`（候補）

---

## 深掘りリンク（最大8）
- `01_topics/02_web/02_authn_12_bruteforce_rate-limit_lockout（例外パス）.md`
- `01_topics/02_web/11_logging_tracing_相関IDと証跡設計.md`
- `01_topics/02_web/10_authn_to_authz_接続（claims_権限伝播）.md`
- `01_topics/02_web/03_authz_06_privileged_action_重要操作（承認_送金_権限）.md`
- `01_topics/02_web/02_authn_16_step-up_再認証境界（重要操作_再確認）.md`
- `01_topics/02_web/04_api_03_rest_filters_検索・ソート・ページング境界.md`
- `01_topics/02_web/04_api_02_graphql_境界（schema_introspection_query_cost）.md`
- `01_topics/02_web/04_api_06_idempotency_レースと二重実行境界.md`

