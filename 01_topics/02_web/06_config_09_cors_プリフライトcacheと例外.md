# 06_config_09_cors_プリフライトcacheと例外

## このファイルで扱う概念
- プリフライトのキャッシュ境界。

## 危険性を一言で
- Max-Ageで誤った許可が継続する。

## 最小限の成立判断（目安）
- Max-Ageと挙動差分が再現する。

## 観測例（差分のイメージ）
- A: 変更即時反映、B: キャッシュで継続。

## 観測が取れない場合の代替
- `Access-Control-Max-Age`の値とTTLを比較する。

## 時間制約下の最小観測点
- Max-Ageの値とキャッシュ挙動。

## 対策の優先順位
1) Max-Age最小化
2) 例外パス削減
3) 監視

## 具体例（反映遅延）
- 設定変更後もブラウザが旧許可を使用
CORS（プリフライトcacheと例外）：OPTIONSと反映遅延が"許可/拒否"を不安定にする

---

## 目的（この技術で到達する状態）
- CORSを「緩い/厳しい」ではなく、**プリフライト（OPTIONS）とそのキャッシュ、例外レスポンスで許可境界がどう揺れるか**で説明できる。
- 実務で使える判断ができる。
  - どの条件でプリフライトになるか（メソッド/ヘッダ/Content-Type）
  - `Access-Control-Max-Age` が運用上の反映遅延になる点
  - エラー/リダイレクト/認証前でCORSヘッダが抜ける"例外運用"の危険性

## 前提（対象・範囲・想定）
- 対象：ブラウザからAPIを呼ぶ構成（SPA/フロント分離）または外部サイトからアクセスされ得るAPI。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CDN → WAF → Reverse Proxy（Nginx/Envoy等）→ App（Spring/Node/Rails等）
  - CORSは"ブラウザ制御"。サーバ認可を代替しない
- できること/やらないこと（安全に検証する範囲）：
  - やる：CORS設定、プリフライト挙動、エラー/リダイレクト時のヘッダ、Varyの適切性、許可の反射や例外ルールを検証する
  - やらないこと：典型的な設定ミスの網羅は主目的にしない（ここでは"運用で壊れる点"に集中）
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_01_CORSと信頼境界（Origin_資格情報_プリフライト）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - プリフライトとMax-Age（反映遅延の運用境界）
    - 例外パスでのCORSヘッダ不整合
    - `Vary: Origin` を含む混線防止の観点
  - 扱わない（別ユニットへ接続）：
    - 典型的な設定ミスの網羅は主目的にしない（ここでは"運用で壊れる点"に集中）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - プリフライト（OPTIONS）の一貫性：リクエスト（Origin / Access-Control-Request-Method / Access-Control-Request-Headers）、レスポンス（Allow-Origin / Allow-Credentials / Allow-Methods / Allow-Headers / Max-Age）、例外（OPTIONSにだけ別挙動（WAFやGatewayが特別扱い）になっていないか）
  - `Access-Control-Max-Age`（運用で効く）：大きすぎると、修正してもユーザのブラウザに"古い許可"が残る可能性、小さすぎると、頻繁なOPTIONSで性能影響→運用が例外を作り始める
  - `Vary: Origin`（混線防止）：共有キャッシュが関与する場合、Vary不足は致命傷になり得る、"たまたま動く"状態は運用で破綻する
- 境界の観点：
  - ブラウザ境界（外部連携・第三者・越境ポイント）：プリフライト結果がブラウザ内で再利用される（Max-Age）
  - 運用境界（管理主体・委託先・対象範囲の線引き）：許可変更（修正/ロールアウト）がすぐ反映されない
  - 例外境界（権限の切替/伝播/委任）：401/403/500/302でヘッダが抜けると、フロントが危険な回避策を取りがち
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - プリフライトが揺れる：環境（WAF/CDN/Gateway）で例外処理が入っている可能性
  - Max-Ageが大きい：許可変更の反映遅延が発生し得る（運用リスク）
  - 例外レスポンスでヘッダが抜ける：CORSが"設計"ではなく"偶然"になっている

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - プリフライトが揺れる：環境（WAF/CDN/Gateway）で例外処理が入っている可能性
  - Max-Ageが大きい：許可変更の反映遅延が発生し得る（運用リスク）
  - 例外レスポンスでヘッダが抜ける：CORSが"設計"ではなく"偶然"になっている
- 何が"推定"できるか（推定の根拠/前提）：
  - どの条件でプリフライトになるか（メソッド/ヘッダ/Content-Type）
  - `Access-Control-Max-Age` が運用上の反映遅延になる点
- 何は"言えない"か（不足情報・観測限界）：
  - すべてのプリフライト条件を網羅した断定（観測範囲に依存）
  - すべての例外パスを網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：プリフライトが一貫している（健全） → 環境（WAF/CDN/Gateway）で例外処理が入っていない
  - パターンB：プリフライトが揺れる（境界が崩れている） → 環境（WAF/CDN/Gateway）で例外処理が入っている可能性
  - パターンC：例外レスポンスでヘッダが抜ける（CORSが"設計"ではなく"偶然"） → CORSが"設計"ではなく"偶然"になっている

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - CORSを"サーバ認可の穴"としてではなく、"ブラウザで読める条件"として評価する
  - 例外パス（エラー/リダイレクト/認証前）に挙動差があると、誤設定の入口になる
- 優先度の付け方（時間制約がある場合の順序）：
  1) 例外レスポンスでヘッダが抜ける（CORSが"設計"ではなく"偶然"） → 最優先で重大
  2) プリフライトが揺れる（境界が崩れている） → 環境（WAF/CDN/Gateway）で例外処理が入っている可能性
  3) Max-Ageが大きい（許可変更の反映遅延が発生し得る） → 運用リスク
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：設定は概ね正しいが、例外パスで崩れる → 401/403/500/302の各レスポンスでCORSヘッダが一貫しているか確認。OPTIONSがWAF/Gatewayで別扱いされていないか（ログ/設定確認）
  - 攻め筋2：Max-Ageが運用に合っていない（反映遅延 or 性能劣化） → 変更反映のSLO（どれくらいで効くべきか）を決める。重要APIは保守的に、匿名APIは性能寄り、など"範囲"で分ける
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - CORSが緩いと、ブラウザ上で"読める"条件が増える。しかし、本質はサーバ側の認可（CORSで守る設計は現実に破綻しやすい）。だからこそ、CORSは「正しく動く」＋「運用で揺れない」を目標にする

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：設定は概ね正しいが、例外パスで崩れる
  - 成立条件：
    - 設定は概ね正しいが、例外パスで崩れる
  - 次の検証：
    - 401/403/500/302の各レスポンスでCORSヘッダが一貫しているか確認
    - OPTIONSがWAF/Gatewayで別扱いされていないか（ログ/設定確認）
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：401/403/500/302の各レスポンスでCORSヘッダが一貫している
    - 失敗：例外パスでCORSヘッダが抜けている
- 仮説B：Max-Ageが運用に合っていない（反映遅延 or 性能劣化）
  - 成立条件：
    - Max-Ageが運用に合っていない（反映遅延 or 性能劣化）
  - 次の検証：
    - 変更反映のSLO（どれくらいで効くべきか）を決める
    - 重要APIは保守的に、匿名APIは性能寄り、など"範囲"で分ける
  - 期待する観測：
    - 成功：変更反映のSLO（どれくらいで効くべきか）を決められる
    - 失敗：Max-Ageが運用に合っている

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/09_cors_preflight_cache_exceptions/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - プリフライト（OPTIONS）の一貫性：リクエスト（Origin / Access-Control-Request-Method / Access-Control-Request-Headers）、レスポンス（Allow-Origin / Allow-Credentials / Allow-Methods / Allow-Headers / Max-Age）、例外（OPTIONSにだけ別挙動（WAFやGatewayが特別扱い）になっていないか）
  - `Access-Control-Max-Age`（運用で効く）、`Vary: Origin`（混線防止）
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：プリフライト（OPTIONS）の一貫性
  - 視点2：`Access-Control-Max-Age`（運用で効く）
  - 視点3：`Vary: Origin`（混線防止）
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/cors_preflight_cache 2>/dev/null
    cd ~/keda_evidence/cors_preflight_cache
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（典型的な設定ミスの網羅は主目的にしない）
      - CORS設定、プリフライト挙動、エラー/リダイレクト時のヘッダ、Varyの適切性、許可の反射や例外ルールを検証する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、プリフライト（OPTIONS）の一貫性、`Access-Control-Max-Age`、`Vary: Origin`、例外レスポンス（401/403/500/302）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# CORSは「通常リクエスト」だけ見ても不十分。

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用
  - 該当要件（可能ならID）：CORSの許可が過剰（反射/ワイルドカード/credentials混在）だとブラウザ境界が崩れ、同一ユーザ権限での読み取りが起き得る。プリフライトや例外レスポンスで挙動が揺れると、運用で"危険な回避実装"を誘発する。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：CORSの許可が過剰（反射/ワイルドカード/credentials混在）だとブラウザ境界が崩れ、同一ユーザ権限での読み取りが起き得る。プリフライトや例外レスポンスで挙動が揺れると、運用で"危険な回避実装"を誘発する。
    - 満たす：必要最小限の許可（Origin/Methods/Headers/Credentials）を一貫運用し、プリフライト（OPTIONS）と例外パス（エラー/リダイレクト）まで含めて設計する。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：CORS設定、プリフライト挙動、エラー/リダイレクト時のヘッダ、Varyの適切性、許可の反射や例外ルールを検証する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：脆弱性分析（設定/運用）→ 侵害評価（ブラウザからの読み取り可能性）→ 報告（許可範囲と運用要件）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Collection（同一ユーザ権限での情報収集）
  - 攻撃者の目的（この技術が支える意図）：Collection（同一ユーザ権限での情報収集）を支える前提になり得る。ただしサーバ認可が本質で、断定は成立確認後。
  - 参照：https://attack.mitre.org/tactics/TA0009/（Collection）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_01_CORSと信頼境界（Origin_資格情報_プリフライト）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_01_CORSと信頼境界（Origin_資格情報_プリフライト）.md`
- 関連 topics：`06_config_05_cache_control_機微レスポンスの境界.md`
- 関連 topics：`06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`

---

## 深掘りリンク（最大8）
- `06_config_01_CORSと信頼境界（Origin_資格情報_プリフライト）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_05_cache_control_機微レスポンスの境界.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `05_input_19_cache_poisoning_02_unkeyed（headers_params）.md`
- `05_input_19_cache_poisoning_03_poisoned_object（stored_response）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`

---
