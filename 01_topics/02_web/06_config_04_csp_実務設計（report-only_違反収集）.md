# 06_config_04_csp_実務設計（report-only_違反収集）
CSP実務設計（Report-Only → 強制）：壊さず観測し、例外を増やさず強くする

---

## 目的（この技術で到達する状態）
- CSPを「付ける」ではなく、**現実の制約（第三者タグ/SPA/SSR/SSO/管理画面）を踏まえて強化できる運用**に落とす。
- 診断員として以下を説明できる状態にする。
  - 何が原因で強いCSPが壊れるか（inline / eval / 外部オリジン / connect）
  - Report-Onlyと違反収集で、実害ゼロで"現状依存"を棚卸しする方法
  - 例外を"場当たり"にせず、**適用範囲とテンプレ統制**で閉じる方法

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CDN → WAF → Reverse Proxy（Nginx/Envoy等）→ App（Spring/Node/Rails等）
  - 第三者タグ（分析/CS/広告）がscript-srcを汚し、`unsafe-inline` で妥協しがち
  - SPA/SSRの混在でHTML生成点が複数あり、**一部ページだけCSPが抜ける**
  - 管理画面・プレビュー・埋め込み機能が例外になりやすい（攻撃価値が高いのに弱くなる）
- できること/やらないこと（安全に検証する範囲）：
  - やる：Report-Onlyで壊さず観測し、違反をカテゴリ分解して段階的に強制へ移行する。レポート収集はアクセス制御・最小化・保持統制されたログとして扱う
  - やらないこと：CSPの詳細網羅ではなく、実務で詰まる論点（inline/eval/第三者/例外パス）に集中
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - CSPの段階導入（Report-Only運用、違反収集、強制移行の判断）
    - 違反レポートの"運用境界"（PII/内部URLの持ち出し、集計、保持）
    - ディレクティブの詳細網羅ではなく、実務で詰まる論点（inline/eval/第三者/例外パス）に集中
  - 扱わない（別ユニットへ接続）：
    - キャッシュ汚染（Poisoning）の攻撃連鎖 → `05_input_19_cache_poisoning_*.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - Report-Onlyが当たっているページ範囲（管理/SSO/エラーを含むか）
  - 違反の内訳が取れているか（inline/eval/外部/connect）
  - レポートがどこに送られているか（第三者SaaSなら信頼境界）
  - 例外がパス単位で増えていないか（/adminだけCSP弱い、/previewだけ無い）
- 境界の観点：
  - 信頼境界：許可する外部オリジン（script/img/connect/frame等）の最小化
  - 権限境界：管理/重要操作ページの実行自由度を落とす（XSS後の被害半径を抑える）
  - 資産境界：ヘッダ付与主体（App/Proxy/CDN）と適用漏れが起きる場所を固定する
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - CSPは「強くするほど壊れる」ので、観測→収束→強制の順でしか進まない
  - 違反をカテゴリ分解する（inline（nonce/hash無し）、eval系（unsafe-evalが必要）、外部オリジン（許可リスト不足/過剰）、connect-src（API/WS/SSE/IdP等））

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - Report-Only違反が多い：現状依存が多い（=強化は段階導入が必須）
  - 違反が管理画面に集中：最優先で強制対象（攻撃価値が高い）
  - 違反収集が無統制：CSP強化以前に、ログ/データ境界が破れている
- 何が"推定"できるか（推定の根拠/前提）：
  - 何が原因で強いCSPが壊れるか（inline / eval / 外部オリジン / connect）
  - 例外を"場当たり"にせず、**適用範囲とテンプレ統制**で閉じる方法
- 何は"言えない"か（不足情報・観測限界）：
  - すべての違反を網羅した断定（観測範囲に依存）
  - すべての例外パスを網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：Report-Only違反が多い（現状依存が多い） → 強化は段階導入が必須
  - パターンB：違反が管理画面に集中（最優先で強制対象） → 攻撃価値が高い
  - パターンC：違反収集が無統制（CSP強化以前に、ログ/データ境界が破れている） → レポート収集はアクセス制御・最小化・保持統制されたログとして扱う必要がある

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - CSPが無い/弱い：XSS後の自由度が高い（入力点探索の価値が上がる）
  - CSPが強いが例外がある：例外ページ（プレビュー/埋め込み/管理の一部）を狙う
  - reportingが雑：レポート基盤が内部情報の収集面になり得る（内部URL、機能名、環境名）
- 優先度の付け方（時間制約がある場合の順序）：
  1) CSPが無い/弱い：XSS後の自由度が高い（入力点探索の価値が上がる） → 最優先で重大
  2) CSPが強いが例外がある：例外ページ（プレビュー/埋め込み/管理の一部）を狙う → 攻撃価値が高い
  3) reportingが雑：レポート基盤が内部情報の収集面になり得る（内部URL、機能名、環境名） → 信頼境界が破れている
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：CSP未導入/形骸化（まず観測を作る） → Report-Onlyを代表テンプレに導入し、違反カテゴリを収集する。"どこが壊れるか"を数でなくカテゴリで見える化（収束できる形にする）。レポート基盤のアクセス制御・最小化を同時に要件化する
  - 攻め筋2：導入済みだが例外運用で崩壊している → 例外パスを固定（/admin, /callback, /error, /preview）。例外を"テンプレ/ミドルウェア"で統制し、場当たりヘッダ上書きを止める。強制は管理/重要操作から（価値の高い場所に投資）
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - SPA/SSRの混在でHTML生成点が複数あり、**一部ページだけCSPが抜ける**

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：CSP未導入/形骸化（まず観測を作る）
  - 成立条件：
    - CSPが未導入または形骸化（unsafe-*固定、適用漏れ）している
  - 次の検証：
    - Report-Onlyを代表テンプレに導入し、違反カテゴリを収集する
    - "どこが壊れるか"を数でなくカテゴリで見える化（収束できる形にする）
    - レポート基盤のアクセス制御・最小化を同時に要件化する
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：違反をカテゴリ分解できる（inline/eval/外部/connect）
    - 失敗：CSPが適切に設定されている
- 仮説B：導入済みだが例外運用で崩壊している
  - 成立条件：
    - CSPは導入済みだが、例外運用で崩壊している
  - 次の検証：
    - 例外パスを固定（/admin, /callback, /error, /preview）
    - 例外を"テンプレ/ミドルウェア"で統制し、場当たりヘッダ上書きを止める
    - 強制は管理/重要操作から（価値の高い場所に投資）
  - 期待する観測：
    - 成功：例外を"テンプレ/ミドルウェア"で統制できる
    - 失敗：例外運用が適切に統制されている

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/04_csp_report_only_rollout/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - Report-Onlyが当たっているページ範囲（管理/SSO/エラーを含むか）、違反の内訳が取れているか（inline/eval/外部/connect）、レポートがどこに送られているか（第三者SaaSなら信頼境界）、例外がパス単位で増えていないか（/adminだけCSP弱い、/previewだけ無い）
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：フェーズ0：棚卸し（"何が動いているか"を先に知る）
    - 代表ページを固定（公開トップ、ログイン、一般機能、管理機能、エラー、SSOコールバック）
    - 外部依存を列挙（どの外部オリジンから script/img/connect しているか（現状の事実））
  - 視点2：フェーズ1：Report-Only導入（壊さない観測）
    - Report-Onlyを"全面"ではなく、**代表テンプレから**当てる（適用漏れの検出にもなる）
    - 違反をカテゴリ分解する（inline（nonce/hash無し）、eval系（unsafe-evalが必要）、外部オリジン（許可リスト不足/過剰）、connect-src（API/WS/SSE/IdP等））
  - 視点3：フェーズ2：強制（Enforce）を"価値が高い場所から"
    - 先に強制すべき：管理/重要操作ページ（被害半径が大きい）
    - 公開トップは段階導入でもよい（広告/タグが多い現場があるため）
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/csp_report_only 2>/dev/null
    cd ~/keda_evidence/csp_report_only
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **代表ページの抽出** のみ（CSPの詳細網羅ではなく、実務で詰まる論点（inline/eval/第三者/例外パス）に集中）
      - 違反レポートの"運用境界"（PII/内部URLの持ち出し、集計、保持）を考慮する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、代表ページ、違反カテゴリ（inline/eval/外部/connect）、レポート送信先、例外パス

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# CSPの現実的な進め方（要点）
# 1) Report-Onlyで壊さず観測
# 2) 違反を inline / eval / 外部 / connect に分類
# 3) 管理/重要操作ページから強制へ
# 4) 例外はテンプレ単位で統制（パス単位で増やさない）
# 5) reportingはログ：アクセス制御・最小化・保持を要件化
~~~~

- この例で観測していること：
  - CSPの段階導入（Report-Only運用、違反収集、強制移行の判断）
- 出力のどこを見るか（注目点）：
  - Report-Onlyが当たっているページ範囲、違反の内訳（inline/eval/外部/connect）、レポートがどこに送られているか、例外がパス単位で増えていないか
- この例が使えないケース（前提が崩れるケース）：
  - CSPが未導入の場合、Report-Onlyも適用できない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用
  - 該当要件（可能ならID）：CSPが未導入/形骸化（unsafe-*固定、適用漏れ）だとXSSの実行自由度が高い。違反レポートが無統制だと、内部URL/PIIが"ログ基盤"へ流れ、別の信頼境界を破る。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：CSPが未導入/形骸化（unsafe-*固定、適用漏れ）だとXSSの実行自由度が高い。違反レポートが無統制だと、内部URL/PIIが"ログ基盤"へ流れ、別の信頼境界を破る。
    - 満たす：Report-Onlyで壊さず観測し、違反をカテゴリ分解して段階的に強制へ移行する。レポート収集はアクセス制御・最小化・保持統制されたログとして扱う。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：CSPの適用範囲、unsafe-inline/unsafe-evalの有無、例外パス（管理/エラー/SSO）での抜け、Report-Only運用と違反内容を確認する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：脆弱性分析（設定/運用）→ 侵害評価（XSS成立条件の評価）→ 報告（現実的なロールアウト計画：観測→収束→強制）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：T1190の後段（Executionの成立条件）を狭める"環境コントロール"
  - 攻撃者の目的（この技術が支える意図）：T1190の後段（Executionの成立条件）を狭める"環境コントロール"。また、違反収集基盤はDiscovery/Collectionの信頼境界になり得る。
  - 参照：https://attack.mitre.org/tactics/TA0001/（Initial Access）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_03_security_headers（CSP_HSTS_XFO等）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- 関連 topics：`06_config_07_error_pages_詳細表示と環境切替.md`
- 関連 topics：`06_config_08_logging_pii_secret（マスキング_相関）.md`

---

## 深掘りリンク（最大8）
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_08_logging_pii_secret（マスキング_相関）.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `05_input_06_xss_01_反射_境界モデル.md`
- `05_input_06_xss_02_格納_境界モデル.md`
- `05_input_06_xss_03_DOM_境界モデル.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`

---
