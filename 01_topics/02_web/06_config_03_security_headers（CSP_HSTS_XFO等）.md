# 06_config_03_security_headers（CSP_HSTS_XFO等）

## このファイルで扱う概念
- セキュリティヘッダの適用境界。

## 危険性を一言で
- 例外パスでヘッダが欠落すると防御が崩れる。

## 最小限の成立判断（目安）
- 正常/例外でヘッダ差分が再現する。

## 観測例（差分のイメージ）
- A: HSTS/CSPあり、B: エラーページで欠落。

## 観測が取れない場合の代替
- 生成主体ごとのヘッダ設定を確認する。

## 時間制約下の最小観測点
- 3xx/4xx/5xx のヘッダ有無。

## 対策の優先順位
1) 全経路で一貫付与
2) 例外パスの統一
3) 監視

## 具体例（設定値）
- HSTS: `max-age=31536000; includeSubDomains`
- X-Frame-Options: `DENY` または `SAMEORIGIN`
- Referrer-Policy: `no-referrer` / `strict-origin-when-cross-origin`
セキュリティヘッダ（CSP / HSTS / Frame等）：ブラウザ境界を"仕様化"し、例外運用で崩れない状態にする

---

## 目的（この技術で到達する状態）
- 「ヘッダが付いている/いない」ではなく、**どの境界（資産/信頼/権限）を閉じるために、どのレスポンスに何を付けるか**を決められる。
- 実務でよく起きる"形だけの導入"を避け、以下を説明できる状態にする。
  - 例外パス（/admin, /callback, /error, 3xx/4xx/5xx）での抜けを**差分観測**で潰す
  - CDN/WAF/Reverse Proxyでの上書き・削除を前提に、**付与主体**を特定する
  - CSP/Frame/Referrer等が、XSS/Clickjacking/URL漏えいの**成立条件**をどう変えるかを言語化する

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - CDN → WAF → Reverse Proxy（Nginx/Envoy等）→ App（Spring/Node/Rails等）
  - "ヘッダ付与はエッジで一括"の方針が多いが、例外（管理・SSO・ファイル配信）が増えると崩れやすい
- できること/やらないこと（安全に検証する範囲）：
  - やる：セキュリティヘッダの有無だけでなく、ページ種別（認証前後/管理/エラー/リダイレクト/静的）と生成主体（App/Edge）で差分を取り、例外条件を特定する
  - やらないこと："ヘッダ一覧"ではなく、適用範囲で要求する。実務で問題になるのは、ヘッダの"欠落"より **適用範囲の分断**（重要ページだけ抜ける、エラーだけ抜ける、エッジだけ違う）
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - Transport境界：HSTS（Strict-Transport-Security）
    - 埋め込み境界：Frame（Clickjacking）
    - 実行境界：CSP（Content-Security-Policy）
    - URL送信境界：Referrer-Policy
    - 解釈境界：X-Content-Type-Options（nosniff）
    - 権限デバイス境界：Permissions-Policy
    - 分離境界（採用時のみ）：COOP/COEP/CORP
  - 扱わない（別ユニットへ接続）：
    - CSPの段階導入・違反収集 → `06_config_04_csp_実務設計（report-only_違反収集）.md`
    - キャッシュ境界（機微レスポンス） → `06_config_05_cache_control_機微レスポンスの境界.md`

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 代表ページ×ステータスで差分を取る（最低限）：HTML（`/` `/login` `/account` `/admin`）、API（`/api/*` の代表（200/401/403））、例外（404/500（アプリ生成かエッジ生成かも見る））、遷移（302（ログイン誘導/SSOコールバック））
  - 生成主体の切り分け：オリジン直（可能なら）とCDN経由でヘッダ差分、エラーページの見た目/ヘッダでWAF/Proxy生成を疑う
  - 観測対象：CSP, HSTS, frame-ancestors/XFO, Referrer-Policy, nosniff
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：どの層がレスポンスを生成/加工しているか（App/Proxy/CDN）
  - 信頼境界（外部連携・第三者・越境ポイント）：外部オリジン（分析SDK/広告/外部API/IdP/ストレージ）をどこまで許すか
  - 権限境界（権限の切替/伝播/委任）：管理/重要操作ページで、埋め込み・実行・送信をどこまで許すか
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - セキュリティヘッダ＝「ブラウザが何を許す/拒否するか」をレスポンス単位で宣言するもの
  - 実務で問題になるのは、ヘッダの"欠落"より **適用範囲の分断**（重要ページだけ抜ける、エラーだけ抜ける、エッジだけ違う）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 一貫して付く：少なくとも"方針"は実装されている（次は強度/例外運用の評価）
  - ページ/ステータスで抜ける：**例外パスが攻撃者の入口**になり得る（優先度を上げる）
  - エッジとオリジンで差分：対策要求はアプリ修正だけでは閉じない（運用境界の問題）
- 何が"推定"できるか（推定の根拠/前提）：
  - どの層で設定が入っているか（CDN/WAF/アプリ）
  - 付与主体（原則：Reverse Proxyで一括（テンプレ分断を避ける）、例外：アプリがnonce等を生成するCSPはアプリ側）
- 何は"言えない"か（不足情報・観測限界）：
  - 設定の意図（運用ポリシー）までは外形だけでは分からない
  - 全攻撃面の網羅（代表入口から広げる必要がある）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：一貫して付く（健全） → 少なくとも"方針"は実装されている（次は強度/例外運用の評価）
  - パターンB：ページ/ステータスで抜ける（境界が崩れている） → **例外パスが攻撃者の入口**になり得る（優先度を上げる）
  - パターンC：エッジとオリジンで差分（運用境界の問題） → 対策要求はアプリ修正だけでは閉じない

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - "管理/重要操作"でFrameが弱い → Clickjacking成立確認へ（1回の操作で重大影響が出る画面が狙われる）
  - CSPが弱い/未適用 → 入力点探索を優先（XSS成立後の自由度が高い）
  - Referrerが緩い → 外部遷移・外部埋め込み・外部JSからの情報送信面を狙う（URLにトークンが乗る設計は特に危険）
  - ヘッダ分断（例外パス）→ "最初から守っていない場所"を狙う（WAF例外・別テンプレ等）
- 優先度の付け方（時間制約がある場合の順序）：
  1) "管理/重要操作"でFrameが弱い → Clickjacking成立確認へ（1回の操作で重大影響が出る画面が狙われる）
  2) CSPが弱い/未適用 → 入力点探索を優先（XSS成立後の自由度が高い）
  3) Referrerが緩い → 外部遷移・外部埋め込み・外部JSからの情報送信面を狙う（URLにトークンが乗る設計は特に危険）
  4) ヘッダ分断（例外パス）→ "最初から守っていない場所"を狙う（WAF例外・別テンプレ等）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：ヘッダはあるが"例外パス"で抜ける（最頻出） → 3xx/4xx/5xxで同じヘッダが付くかを差分観測、/admin, /callback, /error 等の"例外テンプレ"を重点確認、CDN/WAF/Proxyのルール例外（パス除外）と一致していないかを見る
  - 攻め筋2：ヘッダは一律だが"現実要件"で弱くせざるを得ない → 何が要件で緩いのかを特定（第三者タグ、埋め込み、SSO、ファイル配信）、緩い部分を"範囲限定"できるか（管理画面だけ強化、外部タグはサブドメイン隔離等）、CSPはReport-Only導入へ（別ファイルへ接続）
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 生成主体の切り分け：オリジン直（可能なら）とCDN経由でヘッダ差分、エラーページの見た目/ヘッダでWAF/Proxy生成を疑う

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：ヘッダはあるが"例外パス"で抜ける（最頻出）
  - 成立条件：
    - ページ/ステータスで抜ける、エッジとオリジンで差分が観測される
  - 次の検証：
    - 3xx/4xx/5xxで同じヘッダが付くかを差分観測
    - /admin, /callback, /error 等の"例外テンプレ"を重点確認
    - CDN/WAF/Proxyのルール例外（パス除外）と一致していないかを見る
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：**例外パスが攻撃者の入口**になり得る（優先度を上げる）
    - 失敗：一貫して付く：少なくとも"方針"は実装されている（次は強度/例外運用の評価）
- 仮説B：ヘッダは一律だが"現実要件"で弱くせざるを得ない
  - 成立条件：
    - ヘッダは一貫して付くが、強度が弱い、または現実要件で緩くせざるを得ない
  - 次の検証：
    - 何が要件で緩いのかを特定（第三者タグ、埋め込み、SSO、ファイル配信）
    - 緩い部分を"範囲限定"できるか（管理画面だけ強化、外部タグはサブドメイン隔離等）
    - CSPはReport-Only導入へ（別ファイルへ接続）
  - 期待する観測：
    - 成功：緩い部分を"範囲限定"できる（管理画面だけ強化、外部タグはサブドメイン隔離等）
    - 失敗：ヘッダは適切に設定されている

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/03_security_headers_split_by_status_path/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - 代表ページ×ステータスで差分を取る（最低限）：HTML（`/` `/login` `/account` `/admin`）、API（`/api/*` の代表（200/401/403））、例外（404/500）、遷移（302）
  - 生成主体の切り分け：オリジン直（可能なら）とCDN経由でヘッダ差分、エラーページの見た目/ヘッダでWAF/Proxy生成を疑う
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：代表ページ×ステータスで差分を取る（最低限）
  - 視点2：生成主体の切り分け（オリジン直（可能なら）とCDN経由でヘッダ差分、エラーページの見た目/ヘッダでWAF/Proxy生成を疑う）
  - 視点3：例外パスでの抜け（=攻撃者の入口）を特定する
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/security_headers 2>/dev/null
    cd ~/keda_evidence/security_headers
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **代表ページ×ステータスで差分を取る（最低限）** のみ
      - セキュリティヘッダの有無だけでなく、ページ種別（認証前後/管理/エラー/リダイレクト/静的）と生成主体（App/Edge）で差分を取り、例外条件を特定する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、代表ページ、ステータス、生成主体（App/Proxy/CDN）、観測対象（CSP, HSTS, frame-ancestors/XFO, Referrer-Policy, nosniff）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 重要：同一Hostで「ページ種別×ステータス」を揃えて差分を見る

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用
  - 該当要件（可能ならID）：CSP/HSTS/Frame/Referrer/Permissions等を「適用範囲」と「例外統制」込みで仕様化し、App/Proxy/CDNのどこで付与するかも含めて一貫性を担保する
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：ブラウザ境界（実行/埋め込み/送信/混在）が未規定だと、XSSやClickjacking、機微URLの外部送信、混在コンテンツ等の"成立条件"が緩む。例外パス（エラー/リダイレクト/管理画面）でヘッダが抜けると、対策が実質無効化される。
    - 満たす：CSP/HSTS/Frame/Referrer/Permissions等を「適用範囲」と「例外統制」込みで仕様化し、App/Proxy/CDNのどこで付与するかも含めて一貫性を担保する。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：セキュリティヘッダの有無だけでなく、ページ種別（認証前後/管理/エラー/リダイレクト/静的）と生成主体（App/Edge）で差分を取り、例外条件を特定する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：脆弱性分析（設定/運用の不備）→ 侵害評価（成立条件の確認：Clickjacking/XSS/情報送信）→ 報告（適用範囲とロールアウト設計の要求）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：T1190（公開アプリ悪用）
  - 攻撃者の目的（この技術が支える意図）：T1190（公開アプリ悪用）における"成立しやすさ"の環境要因。特にExecution（XSS）やDefense Evasion（例外パスでの抜け）を支える前提として位置づく。
  - 参照：https://attack.mitre.org/tactics/TA0001/（Initial Access）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- CSPの段階導入・違反収集：`06_config_04_csp_実務設計（report-only_違反収集）.md`
- キャッシュ境界（機微レスポンス）：`06_config_05_cache_control_機微レスポンスの境界.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 関連 topics：`06_config_04_csp_実務設計（report-only_違反収集）.md`
- 関連 topics：`06_config_05_cache_control_機微レスポンスの境界.md`

---

## 深掘りリンク（最大8）
- `06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- `06_config_04_csp_実務設計（report-only_違反収集）.md`
- `06_config_05_cache_control_機微レスポンスの境界.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `06_config_12_s3_presigned_url_期限と権限境界.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`

---
