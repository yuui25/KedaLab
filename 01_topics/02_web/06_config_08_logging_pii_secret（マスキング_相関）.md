# 06_config_08_logging_pii_secret（マスキング_相関）

## このファイルで扱う概念
- ログのPII/Secretsマスキングと相関境界。

## 危険性を一言で
- ログに機密が残ると長期的に漏えいする。

## 最小限の成立判断（目安）
- ログ差分でマスキング有無が再現する。

## 観測例（差分のイメージ）
- A: マスク、B: 生値が記録される。

## 観測が取れない場合の代替
- ログ形式と正規化処理を確認する。

## 時間制約下の最小観測点
- 改行/制御文字の混入可否。

## 対策の優先順位
1) マスキング
2) 入力正規化
3) 監視

## 具体例（ログ注入）
- 改行でログが分割される
- JSONログが崩れる
ログ（PII/Secret：マスキングと相関）：監査のためのログが"漏えい面"と"追跡不能"を同時に作る

---

## 目的（この技術で到達する状態）
- ログを「残す/残さない」ではなく、**何を残すべきで、何を残すと壊れるか**を境界で説明できる。
- 実務で"すぐ使える"判断ができる。
  - どこにPII/secretが混入しやすいか（URL/ヘッダ/例外/外部連携）
  - マスキングは復元不能か、相関できる形か（目的で使い分け）
  - request_id/trace_idで、LB→Proxy→App→外部APIまで追えるか
  - ログ注入で構造が壊れ、監査が破綻しないか

## 前提（対象・範囲・想定）
- 対象：許可範囲のWeb/API/関連サブドメイン/クラウド露出面。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - Appログ → 集約（SIEM/APM/クラウドログ）、WAF/CDNログ → 別基盤（運用チーム/SOC）、監査ログ → 長期保管（規制対応）
  - この時点で、ログは"第三者影響"を持つ資産になっている
- できること/やらないこと（安全に検証する範囲）：
  - やる：ログ/エラーによる情報漏えい、ログ注入耐性、監査ログの適切性（過剰/不足）とアクセス制御を評価する
  - やらないこと：ログを意図的に大量に生成することはしない
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - アクセスログ/アプリログ/監査ログ/WAF・CDNログ/トレーシングの"設計要件"
    - PII/secretの最小化・マスキング・相関
    - ログ注入（改行/構造破壊）を監査境界として扱う（CRLF/下流影響と接続）
  - 扱わない（別ユニットへ接続）：
    - ログの詳細な仕様説明（本プロジェクトは境界と成立根拠を優先）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 混入ポイント（現実で刺さる順）：URL/Query（認証コード、招待トークン、検索語、presigned URL、エラーパラメータ）、ヘッダ（Authorization、Cookie、X-Api-Key、Referer（外部遷移で増える））、例外（例外スタックに環境変数/接続先/設定キーが混ざる、外部APIエラーのレスポンスをそのままログに吐く）、監査ログの"過剰"（誰が何をしたかは必要だが、入力値や秘密を丸ごと残すと逆効果）
  - 相関設計（現実で回る最小セット）：request_id / trace_id（全層で共通（LB/Proxy/App））、user_id / tenant_id（直接PIIではなく内部ID（必要に応じてハッシュ化））、action（操作名）/ result（成功/失敗）/ target（対象ID）
- 境界の観点：
  - 情報境界（管理主体・委託先・対象範囲の線引き）：PII/秘密/内部URLがログへ混入すると漏えい面になる
  - 監査境界（権限の切替/伝播/委任）：相関不能・構造破壊で追跡不能になる
  - 権限境界（権限の切替/伝播/委任）：ログ閲覧権限は"攻撃価値が高い権限"になり得る（内部横断）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - secretがログに残る：漏えい時の被害が"横展開"に拡大（回収・失効運用が必須）
  - 相関キーが弱い：追跡不能で、運用リスクが高い（検知・復旧が遅れる）
  - 構造破壊が起きる：監査の信頼境界が崩れる（誤検知/追跡不能）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - secretがログに残る：漏えい時の被害が"横展開"に拡大（回収・失効運用が必須）
  - 相関キーが弱い：追跡不能で、運用リスクが高い（検知・復旧が遅れる）
  - 構造破壊が起きる：監査の信頼境界が崩れる（誤検知/追跡不能）
- 何が"推定"できるか（推定の根拠/前提）：
  - どこにPII/secretが混入しやすいか（URL/ヘッダ/例外/外部連携）
  - マスキングは復元不能か、相関できる形か（目的で使い分け）
- 何は"言えない"か（不足情報・観測限界）：
  - すべてのログ経路を網羅した断定（観測範囲に依存）
  - すべての混入ポイントを網羅した断定（観測範囲に依存）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：secretがログに残る（漏えい時の被害が"横展開"に拡大） → 回収・失効運用が必須
  - パターンB：相関キーが弱い（追跡不能で、運用リスクが高い） → 検知・復旧が遅れる
  - パターンC：構造破壊が起きる（監査の信頼境界が崩れる） → 誤検知/追跡不能

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - まず"ログ閲覧"を狙う（クラウド権限・共有ダッシュボード・デバッグUI）
  - 次に"ログに秘密を吐かせる"条件を探す（例外誘発、presigned URL、エラー詳細）
  - 構造破壊が可能なら、追跡を難化（Defense Evasion）を狙う（成立は下流次第）
- 優先度の付け方（時間制約がある場合の順序）：
  1) secretがログに残る（漏えい時の被害が"横展開"に拡大） → 最優先で重大
  2) 相関キーが弱い（追跡不能で、運用リスクが高い） → 検知・復旧が遅れる
  3) 構造破壊が起きる（監査の信頼境界が崩れる） → 誤検知/追跡不能
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：過剰ログが原因（アプリ/ミドルで改善可能） → Authorization/Cookie/Token/PIIのマスキング規約を定義し、共通ミドルで適用。例外ログは"要約＋相関ID"にし、詳細は保護基盤へ。request_id/trace_idを必須化し、全層で繋げる
  - 攻め筋2：ログが第三者基盤へ転送される（データ境界が本質） → 転送前に最小化（必要最小限のみ）、PII/secretは原則送らない。閲覧権限・保持期間・監査（閲覧ログ）を要件化。相関のためのハッシュ化（復元不能）を使い分ける
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - ログは"複製される"（転送・集計・可視化）ので、漏えい面になりやすい

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：過剰ログが原因（アプリ/ミドルで改善可能）
  - 成立条件：
    - アプリ/ミドルで過剰ログが原因でPII/secretが混入している
  - 次の検証：
    - Authorization/Cookie/Token/PIIのマスキング規約を定義し、共通ミドルで適用
    - 例外ログは"要約＋相関ID"にし、詳細は保護基盤へ
    - request_id/trace_idを必須化し、全層で繋げる
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 成功：Authorization/Cookie/Token/PIIのマスキング規約を定義できる
    - 失敗：過剰ログが適切に制御されている
- 仮説B：ログが第三者基盤へ転送される（データ境界が本質）
  - 成立条件：
    - ログが第三者基盤へ転送される場合
  - 次の検証：
    - 転送前に最小化（必要最小限のみ）、PII/secretは原則送らない
    - 閲覧権限・保持期間・監査（閲覧ログ）を要件化
    - 相関のためのハッシュ化（復元不能）を使い分ける
  - 期待する観測：
    - 成功：転送前に最小化（必要最小限のみ）、PII/secretは原則送らない
    - 失敗：ログが第三者基盤へ転送されていない、または適切に保護されている

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/06_config/08_logging_pii_secret_masking/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - 返る相関IDがあるか（ヘッダ/レスポンスボディ）、例外時にログが過剰になっていないか（スタック/秘密）、ログ閲覧権限が広すぎないか（共有ダッシュボード/リンク共有）、ログ基盤が第三者SaaSなら、転送前に最小化されているか
- 観測の取り方（どの視点で差分を見るか）：
  - 視点1：混入ポイント（現実で刺さる順）
  - 視点2：相関設計（現実で回る最小セット）
  - 視点3：ログ構造の防衛（現実で起きる監査破綻）
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/logging_pii_secret 2>/dev/null
    cd ~/keda_evidence/logging_pii_secret
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（ログを意図的に大量に生成することはしない）
      - ログ/エラーによる情報漏えい、ログ注入耐性、監査ログの適切性（過剰/不足）とアクセス制御を評価する
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、混入ポイント（URL/Query/ヘッダ/例外/監査ログ）、相関設計（request_id/trace_id/user_id/tenant_id/action/result/target）、ログ構造の防衛（改行・制御文字/JSONログ/解析系）

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 重要：ログを見るときの観点は3つだけ

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：設定・運用、ログ・監査
  - 該当要件（可能ならID）：PII/秘密がログに混入すると、ログ基盤が新たな漏えい面になる。相関キー不足は監査を破綻させ、インシデント対応が成立しない。ログ注入（改行/構造破壊）で監査の信頼境界が崩れる。
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：PII/秘密がログに混入すると、ログ基盤が新たな漏えい面になる。相関キー不足は監査を破綻させ、インシデント対応が成立しない。ログ注入（改行/構造破壊）で監査の信頼境界が崩れる。
    - 満たす：最小化（必要最小限）、マスキング（復元不能＋相関可能の使い分け）、相関キー（request_id等）、アクセス制御・保持統制・監査（閲覧ログ）を要件化する。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Configuration/Deployment、Logging
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：ログ/エラーによる情報漏えい、ログ注入耐性、監査ログの適切性（過剰/不足）とアクセス制御を評価する。
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：脆弱性分析（情報漏えい面/監査破綻）→ 侵害評価（秘密が取れた場合の被害半径）→ 報告（運用要件：最小化/相関/統制）。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Collection/Credential Access/Defense Evasion
  - 攻撃者の目的（この技術が支える意図）：Collection/Credential Access/Defense Evasionの前提になり得る（ログが情報源、監査破壊が追跡回避）。ただし成立は環境依存。
  - 参照：https://attack.mitre.org/tactics/TA0009/（Collection）

## 参考（必要最小限）
- 親：`01_topics/02_web/06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- ログ注入（CRLF/下流影響）：`05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- 関連 topics：`06_config_11_secrets_rotation_運用（回収_失効）.md`
- 関連 topics：`06_config_07_error_pages_詳細表示と環境切替.md`

---

## 深掘りリンク（最大8）
- `06_config_11_secrets_rotation_運用（回収_失効）.md`
- `06_config_07_error_pages_詳細表示と環境切替.md`
- `06_config_12_s3_presigned_url_期限と権限境界.md`
- `05_input_20_crlf_injection_02_downstream（proxy_log_cache）.md`
- `06_config_03_security_headers（CSP_HSTS_XFO等）.md`
- `06_config_04_csp_実務設計（report-only_違反収集）.md`
- `06_config_10_cdn_waf_運用境界（ルール例外_バイパス）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`

---
