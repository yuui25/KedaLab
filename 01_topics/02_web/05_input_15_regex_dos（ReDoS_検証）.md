# 05_input_15_regex_dos（ReDoS_検証）
ReDoS（Regex DoS）：正規表現を「検証」ではなく「コスト境界」として扱い、少数リクエストでの劣化成立を詰める

---

## 目的（この技術で到達する状態）
- 次を、観測に基づく"成立根拠"として説明できる。
  1) どの入力がどの正規表現に到達しているか（入口・経路）
  2) その正規表現が「線形」か「バックトラッキングで非線形」か（エンジン差も含む）
  3) 入力長に対して応答時間（またはCPU）がどのように増えるか（コスト境界）
  4) 実害（ワーカ枯渇、タイムアウト連鎖、キュー滞留、監視アラート）としてどう現れるか
  5) 修正を「パターン修正」「エンジン置換」「ガード（制限/タイムアウト）」に分けて提案できる

## 前提（対象・範囲・想定）
- 対象：許可された範囲のWebアプリ/環境のみ。
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - バックトラッキング型エンジン（Java/.NET/Python/JS/PHP PCRE系）が一般的。
- できること/やらないこと（安全に検証する範囲）：
  - やらないこと：破壊的試験や過剰負荷。単発で非線形が見えたら、並列試験で落とす方向には進まない。
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/05_input_00_入力→実行境界（テンプレ デシリアライズ等）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：
    - ReDoS（正規表現の評価コストに起因するDoS）
    - バックトラッキング爆発（catastrophic backtracking）
    - 入力長・構造による多項式/指数的な探索増大
    - 正規表現の前後にあるガード（入力制限、タイムアウト、レート制限、キュー制御）
  - 扱わない（別ユニットへ接続）：
    - "巨大レスポンス生成"や"DBの重い検索"など、正規表現以外の性能劣化
    - WAF回避や特定のペイロード列挙（本プロジェクトは境界モデルと成立根拠を優先）

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 応答時間のスケーリング（入力長を段階的に増やしたときの応答時間）
  - サーバ側の兆候（request_id、endpoint、regex_name、engine/runtime、input_length、regex_eval_time、worker_id、queue_wait_time、timeout_type、cpu_usage）
  - タイムアウトの位置（アプリ、プロキシ、LB、クライアント）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：どこで評価されるか（入口：ログイン/検索/フィルタ/ルーティング/サニタイズ）
  - 信頼境界（外部連携・第三者・越境ポイント）：どのエンジンか（バックトラッキング型か、線形時間エンジンか）
  - 権限境界（権限の切替/伝播/委任）：ガードがどこにあるか（正規表現評価の前に抑えられているか）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 入力長に対する応答時間の増加パターン（線形/非線形）
  - タイムアウトの位置（アプリ/プロキシ/LB/クライアント）
  - 正規表現エンジンの種類（バックトラッキング型/線形時間）

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - どの入力がどの正規表現に到達しているか（入口・経路）
  - 入力長に対して応答時間がどのように増えるか（コスト境界）
- 何が"推定"できるか（推定の根拠/前提）：
  - その正規表現が「線形」か「バックトラッキングで非線形」か（エンジン差も含む）
  - 実害（ワーカ枯渇、タイムアウト連鎖、キュー滞留、監視アラート）としてどう現れるか
- 何は"言えない"か（不足情報・観測限界）：
  - すべての正規表現を網羅した断定（観測範囲に依存）
  - 実害の完全な再現（許可された検証環境でのみ実施）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：線形に近い（問題なし、または低リスク） → 入力長に対して応答が概ね比例、明確な閾値で拒否（サイズ制限）もある
  - パターンB：非線形の兆候（高リスク：修正対象） → ある長さを超えると応答が急増、タイムアウトに近づく
  - パターンC：単発でタイムアウト（極めて高リスク） → 少数リクエストでプロキシ/アプリのタイムアウトに到達

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - 外部入力 × 高頻度 × 同期処理 × 共有ワーカの組み合わせ
  - ログイン/登録/パスワードリセット周り（バリデーション）
  - 検索/フィルタ/正規表現検索機能
  - ルーティング/リバースプロキシ/ルールエンジン
- 優先度の付け方（時間制約がある場合の順序）：
  1) ルーティング/リバースプロキシ（影響半径が大きい：全エンドポイントに波及）
  2) ログイン/登録/パスワードリセット周り（高頻度経路）
  3) 検索/フィルタ（中頻度経路）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：バリデーションregexが原因 → その項目の最大長・許容文字種・正規化を設計として固定
  - 攻め筋2：検索/フィルタ/ルーティングのregexが原因 → 影響半径が大きいので優先度最大
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 原因がregexか不明（遅いが確定できない）場合、サーバログで「どの検証/処理に時間がかかったか」を取りに行く

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：バリデーションregexが原因
  - 次の検証：
    - その項目の最大長・許容文字種・正規化（trim/Unicode正規化）を設計として固定
    - "失敗側"で遅延が出るなら、失敗を早期に返せる構造へ置換（regexの順序・分割）
  - 期待する観測（成功/失敗時に何が見えるか）：
    - 非線形の兆候が観測できる（ある長さを超えると応答が急増）
- 仮説B：検索/フィルタ/ルーティングのregexが原因
  - 次の検証：
    - 影響半径が大きいので優先度最大（ルーティングは全体波及）
    - 対象regexの適用範囲を狭める（先頭一致、固定接頭辞、前処理で候補削減）
    - 同期経路から外す（キュー/非同期）か、隔離ワーカへ（ただしUXとの調整が必要）
  - 期待する観測：
    - 単発でタイムアウト（極めて高リスク）が観測できる
- 仮説C：原因がregexか不明（遅いが確定できない）
  - 次の検証：
    - サーバログで「どの検証/処理に時間がかかったか」を取りに行く
    - 入口を変えても遅いか（regex以外の可能性）を切り分ける
    - 依存ライブラリ（URL/HTML/Markdown/テンプレ）にregexが内在する可能性を検討し、呼び出し点を特定する
  - 期待する観測：
    - 原因が特定できるか、regex以外の可能性が示される

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_web/05_input/15_regex_dos_cost_boundary/`（追加候補）
- 取得する証跡（目的ベースで最小限）：
  - HTTPログ/har、サーバログ、応答時間の記録
  - 入力長と応答時間の対応表
- 観測の取り方（どの視点で差分を見るか）：
  - メモに必ず残す項目：入力長、応答時間、タイムアウト位置、正規表現エンジンの種類、ガードの有無
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/regex_dos 2>/dev/null
    cd ~/keda_evidence/regex_dos
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **最小限の差分セット** のみ（破壊的試験や過剰負荷は行わない）
      - 単発で非線形が見えたら、並列試験で落とす方向には進まない
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、Time、入力長、応答時間、タイムアウト位置、正規表現エンジンの種類、ガードの有無

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# ReDoSは「入力長を増やしたときの時間増加」を見る。
# - 短い入力 → 少し長い入力 → 境界が見えたらそこで停止
# - 同一条件で複数回測って中央値を見る
# - タイムアウト位置（アプリ/プロキシ/LB）を必ず記録する
~~~~

- この例で観測していること：
  - 入力長に対する応答時間の増加パターン（線形/非線形）
- 出力のどこを見るか（注目点）：
  - 応答時間、タイムアウト位置、サーバログ
- この例が使えないケース（前提が崩れるケース）：
  - 正規表現が評価されない経路の場合、観測できない

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：入力検証、可用性
  - 該当要件（可能ならID）：入力長制限、タイムアウト、レート制限
  - このファイルの内容が「満たす/破れる」ポイント：
    - 破れる：入力により正規表現の評価コストが非線形（指数/多項式）に増大し、CPU/スレッド/ワーカが枯渇して可用性が崩れる（DoS）。さらに、レート制限やタイムアウトが「正規表現の前」にないと、少数リクエストで劣化が成立する。
    - 満たす：線形時間の正規表現（RE2系）への置換、バックトラッキング回避（パターン設計・原子化/所有欲量指定等）、入力長・回数制限、評価タイムアウト、プリコンパイル、危険パターンの静的検出、重要経路からの正規表現排除。
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：「入力検証」だけではなく、正規表現を使う箇所（検索、フィルタ、ルーティング、WAF的検査、ログ整形、テンプレ/マークアップ変換）で、入力長を増やしたときの応答時間の増加を観測し、コスト境界を確定する。
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：正規表現の評価コスト境界の特定
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：脆弱性分析、侵害評価
  - 前後フェーズとの繋がり（1行）：脆弱性分析で入力→正規表現評価→資源枯渇の境界モデル化（どの入力がどのregexへ到達するか）。侵害評価で少数リクエストで再現できるか（ワーカ枯渇、キュー滞留、タイムアウト連鎖）を観測で固める。
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Impact：サービス妨害（DoS）
  - 攻撃者の目的（この技術が支える意図）：公開アプリ（T1190）から、少数のリクエストで劣化させる"低ノイズ型"の運用妨害に接続する。
  - 参照：https://attack.mitre.org/tactics/TA0040/（Impact）

## 参考（必要最小限）
- ReDoS（正規表現の評価コストに起因するDoS）の定義と解説
- バックトラッキング型エンジンと線形時間エンジンの違い
- 危険パターンの構造（入れ子の量指定、オーバーラップする選択肢、アンカー不在＋貪欲、lookaround/backreference）

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`05_input_14_prototype_pollution_01_sources（merge_parse）.md`
- 関連 topics：`05_input_14_prototype_pollution_02_sinks（authz_template_rce）.md`
- 関連 labs：`04_labs/02_web/05_input/15_regex_dos_cost_boundary/`（追加候補）

---

## 深掘りリンク（最大8）
- `05_input_14_prototype_pollution_01_sources（merge_parse）.md`
- `05_input_14_prototype_pollution_02_sinks（authz_template_rce）.md`
- `05_input_06_xss_01_反射_境界モデル.md`
- `05_input_06_xss_03_DOM_境界モデル.md`
- `04_api_09_error_model_情報漏えい（例外_スタック）.md`
- `06_config_00_設定・運用境界（CORS ヘッダ Secrets）.md`
- `02_playbooks/02_web_recon_入口→境界→検証方針.md`
- `04_labs/01_local/02_proxy_計測・改変ポイント設計.md`

---
