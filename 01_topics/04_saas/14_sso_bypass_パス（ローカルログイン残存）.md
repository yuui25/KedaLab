# 14_sso_bypass_パス（ローカルログイン残存）
SSO をバイパスする経路（ローカルアカウント・回復用フロー・例外URL）を観測し、封じ方を特定する。

## 目的（この技術で到達する状態）
- SSO 強制設定の例外（ローカルログイン、回復/招待リンク、サポート用アカウント）を列挙し、成立可否を Yes/No/Unknown で示せる
- ローカル認証が残る画面・API を特定し、適用/無効化設定を把握できる
- 監査ログでローカルログイン/例外利用を追えるか判断し、是正案を提示できる

## 前提（対象・範囲・想定）
- 対象：SaaS/IdP 連携を使うサービスでのローカル認証残存、サポート/非常用アカウント
- 想定環境：SSO 強制だが一部例外が存在する可能性
- できること/やらないこと：設定確認と許可されたログイン試験のみ。アカウント変更・削除は行わない
- 依存知識：SSO/IdP設定、招待/パスワードリセットフロー
- 扱う範囲：例外経路の特定、監査、是正
- 扱わない：IdP 側 MFA/CA 設定（別ユニット）

## 観測ポイント（プロトコル/データ/境界）
- ローカルログイン UI/API の有無、SSO 強制設定、外部IdP未設定時の挙動
- 特別アカウント：サポート/非常用/初期管理者、API キー、バックドアURL
- 回復フロー：パスワードリセット/招待リンクの要件（ドメイン制限/MFA）
- 監査：ローカルログインイベント、例外利用時のログ

## 結果の意味（何が言える/言えない）
- 確定できる：ローカルログイン可否、例外アカウント有無、回復フローの要件
- 推定できる：リンク流出や初期アカウント放置によるバイパス余地
- 言えない：アカウントの業務必要性（担当確認が必要）
- 状態パターン
  - A：SSO強制＋ローカル無効＋非常用もMFA/監査（良好）
  - B：初期管理者/招待リンクでローカルログイン可（高リスク）
  - C：SSO強制だがAPIキー発行で事実上バイパス（別経路）

## 攻撃者視点での利用（意思決定）
- 狙い目：初期管理者のローカルログイン、招待/パスワードリセットリンク、APIキー/トークン発行
- 優先度：1) ローカルログイン可否 2) 非常用アカウント 3) 回復リンク要件 4) ログ有無
- 攻め筋：初期アカウントや停止忘れのローカルユーザでログイン、招待リンク再利用
- 戦略変更：ローカルが閉じている場合は IdP 側例外（CAの信頼済み場所）を確認

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：ローカルログインが残存
  - 次の検証：SSO 強制設定を確認し、ログアウト状態でローカルログインページが利用できるか試行
  - 期待：利用可能ならバイパス経路
- 仮説B：招待/パスワードリセットでドメイン制限がない
  - 次の検証：外部メールで招待/リセットを試行（許可範囲で）
  - 期待：外部でも通るならリスク
- 仮説C：非常用アカウントが未管理
  - 次の検証：ローカル管理者一覧/パスワードローテーション/MFA有無を確認
  - 期待：MFA無効なら高リスク

## 手を動かす検証（Labs連動：観測点を明確に）
- 証跡ディレクトリ
~~~~
mkdir -p ~/keda_evidence/sso_bypass_14 2>/dev/null
cd ~/keda_evidence/sso_bypass_14
~~~~
- 取得する証跡：設定画面（SSO強制/ローカル無効化）、ログイン試行結果、監査ログ
- 相関キー：{User, AuthMethod(SSO/Local), SourceIP, Result, Time}

## コマンド/リクエスト例
- 管理 UI/設定エクスポートで SSO 強制/ローカル無効化を確認
- 監査 API でローカルログインイベントを取得（SaaS/IdP のログ）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：認証・セッションの一貫性を要求（ローカル例外を閉じる）。
  https://github.com/OWASP/ASVS
- WSTG：Authentication テストで SSO 強制とローカル例外を確認。
  https://owasp.org/www-project-web-security-testing-guide/
- PTES：情報収集→脆弱性分析で例外ログインを棚卸し。
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Valid Accounts、Authentication Bypass。
  https://attack.mitre.org/

## 参考（必要最小限）
- 各SaaSの SSO 強制/ローカル無効化設定ガイド
- 招待/リセットメールのドメイン制限設定

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`04_azuread_条件付きアクセス（CA）と例外パス.md`
- 関連 playbooks：なし
- 関連 labs / cases：任意

---

## 深掘りリンク（最大8）
- `01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- `10_saas_oauth_consent_phishing_成立条件.md`
- `15_token_lifetime_更新と失効（SaaS側）.md`
