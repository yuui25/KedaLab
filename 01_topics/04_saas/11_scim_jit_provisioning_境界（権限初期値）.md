# 11_scim_jit_provisioning_境界（権限初期値）
SCIM/JIT プロビジョニングの権限初期値と境界を観測し、過剰権限・なりすましの成立条件を特定する。

## 目的（この技術で到達する状態）
- SCIM/JIT で作成されるユーザの属性・ロール初期値を確認し、越権がないかを Yes/No/Unknown で示せる
- プロビジョニングのトリガ（IdP属性/グループ/ドメイン）と対象範囲を説明できる
- 監査ログでアカウント作成/ロール付与を追跡し、是正案を提示できる

## 前提（対象・範囲・想定）
- 対象：SCIM 連携（IdP→SaaS）、JIT（Just-In-Time）プロビジョニング、グループ/ロールマッピング
- 想定環境：IdP 属性/グループから SaaS ロールが決まる運用
- できること/やらないこと：設定確認とログ確認のみ。実際のユーザ作成はテストアカウントのみ
- 依存知識：SCIM schema、IdP 属性マッピング、SaaS ロールモデル
- 扱う範囲：権限初期値、マッピング、監査
- 扱わない：手動ユーザ作成のみの運用

## 観測ポイント（プロトコル/データ/境界）
- マッピング：IdP 属性/グループ → SaaS ロール/グループ/権限
- 初期値：デフォルトロール、プロジェクト/スペース/テナントのスコープ
- ドメイン：メールドメイン許可、ゲスト/外部ユーザの扱い
- 監査：アカウント作成/ロール変更/非アクティブ化イベント

## 結果の意味（何が言える/言えない）
- 確定できる：作成時のロール、マッピングルール、外部ドメインの扱い、監査ログ有無
- 推定できる：属性偽装やグループ誤設定による管理者化の余地
- 言えない：業務上の正当性（担当確認が必要）
- 状態パターン
  - A：最小ロール＋明示マッピング＋外部ドメイン不可＋監査有効（良好）
  - B：デフォルト管理者/編集者ロール＋外部ドメイン許可（高リスク）
  - C：マッピング不明瞭だが監査充実（可視化で緩和）

## 攻撃者視点での利用（意思決定）
- 狙い目：デフォルトが管理者、外部ドメイン許可、グループ名の衝突/偽装、SCIM トークン流出
- 優先度：1) 初期ロール 2) 属性/グループマッピング 3) 外部ドメイン扱い 4) 監査
- 攻め筋：属性偽装で高ロール獲得、SCIM エンドポイントへの不正呼び出し
- 戦略変更：マッピングが厳しい場合は停止/非アクティブ化の遅延を確認

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：デフォルトロールが高い  
  - 次の検証：新規ユーザ作成時のデフォルト権限を確認（テストユーザで）  
  - 期待：管理者/編集者なら要是正
- 仮説B：グループマッピングが曖昧  
  - 次の検証：IdP グループ変更で付与ロールが変わるか比較  
  - 期待：誤設定で昇格するなら所見
- 仮説C：外部ドメインもプロビジョニング対象  
  - 次の検証：許可ドメイン設定を確認し、外部メールで作成可否を確認（許可範囲で）  
  - 期待：可能ならリスク

## 手を動かす検証（Labs連動：観測点を明確に）
- 証跡ディレクトリ
~~~~
mkdir -p ~/keda_evidence/scim_jit_11 2>/dev/null
cd ~/keda_evidence/scim_jit_11
~~~~
- 取得する証跡：マッピング設定、テストユーザ作成ログ、監査ログ抜粋
- 相関キー：{User, Domain, Groups, AssignedRole, Source(IdP/SaaS), EventTime}

## コマンド/リクエスト例
~~~~
# SCIM エンドポイントに対するメタデータ取得（許可環境のみ）
curl -H "Authorization: Bearer <SCIM_TOKEN>" https://<saas>/scim/v2/ServiceProviderConfig
~~~~
- 注目点：対応 schema、ロール/グループ属性、認可モデル
- 使えないケース：SCIM 無効なSaaS、トークン権限不足

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：認証/アクセス制御の前提として、アカウント作成時の権限最小化。  
  https://github.com/OWASP/ASVS
- WSTG：Authorization/Configuration テストでプロビジョニング設定を確認。  
  https://owasp.org/www-project-web-security-testing-guide/
- PTES：情報収集→脆弱性分析で初期権限/マッピングを棚卸し。  
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Valid Accounts（SaaS）。  
  https://attack.mitre.org/

## 参考（必要最小限）
- SCIM 仕様：https://datatracker.ietf.org/doc/html/rfc7644
- 各SaaSの SCIM/JIT 設定ガイド（例：Okta/Entra/Google）

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- 関連 playbooks：なし
- 関連 labs / cases：任意

---

## 深掘りリンク（最大8）
- `02_saas_共有・外部連携・監査ログの勘所.md`
- `10_saas_oauth_consent_phishing_成立条件.md`
- `12_audit_logs_取得と相関（誰が何をいつ）.md`
