# 13_shadow_it_発見（DNS_CASB_ログ）
Shadow IT を DNS/CASB/プロキシ/EDR ログで発見し、リスクと対処を明確にする。

## 目的（この技術で到達する状態）
- 未承認SaaSや外部ストレージ利用をログから発見し、誰が何をどこへ送ったかを説明できる
- データ/トラフィックの特徴（ドメイン/カテゴリ/量/ユーザ）を抽出し、持ち出しリスクを Yes/No/Unknown で示せる
- 対応策（ブロック/許可リスト化/代替提示/監査強化）を提案できる

## 前提（対象・範囲・想定）
- 対象：DNS/Proxy/CASB/EDR ログ、クラウドアプリ検知機能（MCAS/Defender/CASB製品等）
- 想定環境：インターネット egress にログがある前提。SSL検査有無を考慮
- できること/やらないこと：ログ分析のみ。実際のブロック設定は別途合意
- 依存知識：ログ形式、ドメインカテゴリ、レピュテーション、ユーザ/端末識別
- 扱う範囲：検知・分類・対応
- 扱わない：個別アプリの詳細リスク評価

## 観測ポイント（プロトコル/データ/境界）
- ドメイン/URL：SaaS特有ドメイン（drive.google.com、dropbox.com 等）、新規/急増ドメイン
- カテゴリ/アプリ識別：CASB/Proxy のアプリ判定、SSL検査の有無
- ユーザ/端末：どのユーザ/ホストがどの量を送信したか
- イベント：アップロード/共有/ログイン/トークン発行などの検出可否
- 監査：ログ保持期間、相関先（IdP/EDR）

## 結果の意味（何が言える/言えない）
- 確定できる：検出したSaaSドメインと利用ユーザ、トラフィック量/頻度
- 推定できる：データ持ち出しリスク（カテゴリ・量・時間帯）や業務用途の可能性
- 言えない：コンテンツ内容（SSL検査無い場合）
- 状態パターン
  - A：許可リスト以外ブロック＋CASBで可視化（良好）
  - B：全許可＋ログのみ/保持短期（高リスク）
  - C：検出はできるがSSL検査なしで内容不明（部分的）

## 攻撃者視点での利用（意思決定）
- 狙い目：ログ保持短い環境、SSL検査なし、プロキシバイパス、許可リスト外のクラウドストレージ
- 優先度：1) ログ有無/保持 2) アプリ識別精度 3) バイパス経路 4) ブロック/許可ポリシー
- 攻め筋：新規ドメイン/外部ストレージで持ち出し、認証不要/匿名アップロードの利用
- 戦略変更：可視化が強い場合は許可アプリの例外やAPI経由を検討

## 次に試すこと（仮説A/Bの分岐と検証）
- 仮説A：ログ保持が短い  
  - 次の検証：DNS/Proxy/CASB の保持期間とエクスポート可否を確認  
  - 期待：短期ならアーカイブ/延長を提案
- 仮説B：アプリ識別が粗い  
  - 次の検証：アプリカテゴリ/識別結果を確認し、主要SaaSが区別できるかを確認  
  - 期待：粗い場合はSSL検査やカスタムカテゴリを検討
- 仮説C：プロキシバイパスがある  
  - 次の検証：Direct-to-Internet トラフィック有無（443直）を確認  
  - 期待：あるならブロック/監査強化を提案

## 手を動かす検証（Labs連動：観測点を明確に）
- 証跡ディレクトリ
~~~~
mkdir -p ~/keda_evidence/shadow_it_13 2>/dev/null
cd ~/keda_evidence/shadow_it_13
~~~~
- 取得する証跡：DNS/Proxy/CASB/EDR ログサンプル、保持設定
- 相関キー：{User, Host, Time, Domain/App, Bytes, Action(Allow/Block)}

## コマンド/リクエスト例
~~~~
# 例：DNSログから主要クラウドドメインを抽出（仮）
grep -Ei 'drive\\.google|dropbox|box\\.com|mega\\.nz' dns.log
~~~~
- 注目点：頻度/時間帯/ユーザ、アップロードイベントの有無
- 使えないケース：ログが取得されていない場合（まず収集を整備）

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK）
- ASVS：ログとモニタリング。  
  https://github.com/OWASP/ASVS
- WSTG：情報収集/構成確認で egress/監査を評価。  
  https://owasp.org/www-project-web-security-testing-guide/
- PTES：情報収集→報告で持ち出し経路を提示。  
  https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：Exfiltration Over Web Service、Valid Accounts（SaaS）。  
  https://attack.mitre.org/

## 参考（必要最小限）
- 各 CASB/Proxy 製品のアプリ識別・ログ出力仕様
- 主要クラウドストレージドメイン一覧

## リポジトリ内リンク（最大3つまで）
- 関連 topics：`28_exfiltration_持ち出し経路（DNS_HTTP_SMB）.md`
- 関連 playbooks：なし
- 関連 labs / cases：任意

---

## 深掘りリンク（最大8）
- `02_saas_共有・外部連携・監査ログの勘所.md`
- `12_audit_logs_取得と相関（誰が何をいつ）.md`
- `15_token_lifetime_更新と失効（SaaS側）.md`
