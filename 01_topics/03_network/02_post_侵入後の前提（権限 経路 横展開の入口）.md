# 02_post_侵入後の前提（権限 経路 横展開の入口）

## 目的（この技術で到達する状態）
- 侵入後（Post）の最初にやるべきことを、ツール手順ではなく **状態の確定** として整理し、次の一手を自分で決められる
  - 自分はいま何者か（権限）
  - どこに届くか（経路）
  - 次にどこへ行けるか（横展開の入口）
- Web起点（Webシェル/アプリRCE/SSRF/資格情報入手）でも、NW起点（VPN/端末侵入）でも共通で使える"初動モデル"を作る
- 侵入後の行動を「深掘り学習」できる単位に落とし、`03_creds` と `04_ad` へ繋げる

---

## 前提（対象・範囲・想定）
- 対象：許可された検証環境または許可範囲内の侵入後ホスト/セッションのみ
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - 侵入後は"できること"が一気に増えるが、無秩序に動くと再現性が崩れる
  - 監視/制限（EDR、ログ監査、セグメント分割）がある前提で、影響と証跡を制御する
- できること/やらないこと（安全に検証する範囲）：
  - できること：権限状態の確定、経路の確定、横展開入口の特定、認証情報の所在の兆候収集、証跡の取得と影響制御
  - やらないこと：不要なサービス停止、大量アクセス、範囲外への到達、"落とし穴"章は作らない、ツール羅列で終わらせない（必ず意味→判断→次の一手）
- 依存する前提知識（必要最小限）：
  - `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：侵入後の初動（権限/経路/横展開入口の確定）、状態の確定方法、次の一手の判断基準
  - 扱わない（別ユニットへ接続）：
    - 認証情報の深掘り → `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
    - AD地図の作成 → `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
    - 権限昇格の深掘り → `01_topics/03_network/24_linux_priv-esc_入口（sudo_capabilities）.md` / `01_topics/03_network/25_windows_priv-esc_入口（サービス権限_UAC）.md`

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 権限（Privilege）を"状態"として確定する
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - OSと実行主体（ユーザー/グループ/トークン）、権限レベル（管理者/特権）
  - どの操作が可能か（サービス管理、ファイルアクセス、資格情報領域、ネットワーク操作）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：どのホスト/サービスが管理下にあるか
  - 信頼境界（外部連携・第三者・越境ポイント）：どの認証基盤に接続しているか
  - 権限境界（権限の切替/伝播/委任）：現在の権限レベル、どの操作が可能か、権限昇格の可能性
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 権限レベル（管理者/特権/一般）で可能な操作が変わる
  - ドメイン参加の有無で権限伝播の範囲が変わる

### 2) 経路（Path）を"到達性"として確定する
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 侵入ホストから見えるネットワーク（サブネット、名前解決、到達可能サービス）
  - 外向き通信の可否（外部へ出られるか、プロキシ必須か）
  - どのインタフェース/ルートで到達しているか（ピボットの前提）
- 境界の観点：
  - 資産境界：どのサブネット/サービスが到達可能か
  - 信頼境界：外部への通信が可能か、プロキシ経由か
  - 権限境界：経路による到達可能範囲の差
- 重要なフィールド/差分/状態：
  - 経路の違い（VPN/踏み台/直接）で到達可能範囲が変わる
  - 外向き通信の可否で横展開の方向が変わる

### 3) 横展開の入口（Lateral Entry）を"認証と権限境界"として特定する
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - AD/認証基盤：ドメイン参加、Kerberos/NTLMの兆候
  - 管理プロトコル：SMB/RDP/WinRM/SSH
  - 共有資源：ファイル共有、管理共有、構成管理
- 境界の観点：
  - 信頼境界：どの認証基盤に接続しているか
  - 権限境界：横展開は「到達できる」だけでは成立しない。"認証が成立する入口"と"権限が乗る経路"が必要
- 重要なフィールド/差分/状態：
  - ドメイン参加の有無で横展開の可能性が変わる
  - 認証プロトコル（Kerberos/NTLM/SSH）の違いで横展開の方法が変わる

### 4) 認証情報（Credentials）の"所在"の兆候を集める（まだ深掘りはしない）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 設定ファイル、環境変数、サービス設定、履歴、共有、チケット/キャッシュの存在
- 境界の観点：
  - 権限境界：侵入後の勝負は"認証情報と権限伝播"。兆候があるなら最短で `03_creds` に移る
- 重要なフィールド/差分/状態：
  - 認証情報の所在の兆候の有無で次の一手が変わる

### 5) 証跡（再現性）と影響制御を維持する
- 取得する証跡（目的ベースで最小限）：
  - 何をしたか（コマンド/操作）より、どんな状態が変わったか（権限/経路/到達性/副作用）を残す
- 観測の取り方（どの視点で差分を見るか）：
  - 権限の違いでの差分
  - 経路の違いでの差分
  - 認証情報の所在の兆候の有無での差分
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/post_exploitation 2>/dev/null
    cd ~/keda_evidence/post_exploitation
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可された検証環境または許可範囲内** のみ
      - 観測は **状態の確定** のみ
      - 不要なサービス停止や大量アクセスは避ける
      - ラボでは snapshot/reset を前提に"巻き戻せる検証"にする
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、PrivilegeLevel、Route、ReachableNetwork、AuthBase、CredentialHint、Time

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - 現在の権限状態（何者で、何ができるか）
  - 現在の経路状態（どこに到達できるか、外へ出られるか）
  - 横展開の入口候補（どの認証が絡むサービスが近いか）
- 何が"推定"できるか（推定の根拠/前提）：
  - ドメイン参加の有無とAD依存の強さ（追加観測で強くなる）
  - 監視/制限の存在（検知されやすい行動の把握）
- 何は"言えない"か（不足情報・観測限界）：
  - 具体的な横展開が成立するか（認証情報が必要）
  - 権限昇格が可能か（材料の深掘りが必要）
  - 全体構造（複数ホストの地図）は段階的に作る必要がある
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：権限が弱い × 入口が近い → まず creds を取りに行く（横展開成立に寄せる）
  - パターンB：権限が強い × 経路が広い → 横展開候補を最短で絞り、影響の大きい突破点へ
  - パターンC：経路が狭い → ローカルの権限・creds・設定を深掘りして突破口を作る

---

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - 権限（今の自分の強さ）を確定
  - 経路（どこへ動けるか）を確定
  - 横展開入口（認証が絡むサービス）を絞る
  - 認証情報の所在を固めて取りに行く（`03_creds`）
  - AD地図が必要なら `04_ad` へ
- 優先度の付け方（時間制約がある場合の順序）：
  1) 権限（今の自分の強さ）を確定
  2) 経路（どこへ動けるか）を確定
  3) 横展開入口（認証が絡むサービス）を絞る
  4) 認証情報の所在を固めて取りに行く（`03_creds`）
  5) AD地図が必要なら `04_ad` へ
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：権限が弱い × 入口が近い → まず creds を取りに行く（横展開成立に寄せる）
  - 攻め筋2：権限が強い × 経路が広い → 横展開候補を最短で絞り、影響の大きい突破点へ
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 経路が狭い場合は、ローカルの権限・creds・設定を深掘りして突破口を作る
  - ドメイン環境が絡む場合は、AD地図が必要

---

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：ドメイン環境が絡む（ADの地図が必要）
- 次の検証：
  - `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md` へ進み、用語ではなく"地図（資産/信頼/権限境界）"を作る
- 期待する観測（成功/失敗時に何が見えるか）：
  - 成功：AD地図が作成でき、横展開の方向が明確になる
  - 失敗：AD地図が作成できず、横展開の方向が不明確なまま

### 仮説B：横展開の入口は見えるが、認証情報が足りない
- 次の検証：
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md` へ進み、所在→意味→次の一手を固める
- 期待する観測：
  - 成功：認証情報の所在が特定でき、横展開が成立する
  - 失敗：認証情報の所在が特定できず、横展開が成立しない

### 仮説C：権限が弱く、まず昇格の材料が必要
- 次の検証：
  - "どこに材料があるか" を creds/設定/サービスとして整理し、ラボで再現できる単位に落とす（実務では範囲と影響制御を厳守）
- 期待する観測：
  - 成功：権限昇格の材料が特定でき、昇格が成立する
  - 失敗：権限昇格の材料が特定できず、昇格が成立しない

---

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
    - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`
    - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
- 取得する証跡（目的ベースで最小限）：
  - 権限状態の記録（コマンド出力、トークン情報）
  - 経路情報（ネットワーク設定、ルーティング情報）
  - 横展開入口の候補（到達可能サービス、認証プロトコル）
  - 認証情報の所在の兆候（設定ファイル、環境変数、履歴）
- 観測の取り方（どの視点で差分を見るか）：
  - 権限の違いでの差分
  - 経路の違いでの差分
  - 認証情報の所在の兆候の有無での差分
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/post_exploitation 2>/dev/null
    cd ~/keda_evidence/post_exploitation
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可された検証環境または許可範囲内** のみ
      - 観測は **状態の確定** のみ
      - 不要なサービス停止や大量アクセスは避ける
      - ラボでは snapshot/reset を前提に"巻き戻せる検証"にする
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、User、PrivilegeLevel、Route、ReachableNetwork、AuthBase、CredentialHint、Time

---

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 例：権限状態の確認（Windows/Linuxで代表）
whoami
id

# 例：経路・到達性の手掛かり（概念）
ip a
ip route
~~~~

- この例で観測していること：権限状態（ユーザー/グループ/トークン）、経路（ネットワーク設定、ルーティング情報）、横展開入口（到達可能サービス、認証プロトコル）
- 出力のどこを見るか（注目点）：権限レベル、ドメイン参加の有無、到達可能ネットワーク、認証プロトコルの兆候
- この例が使えないケース（前提が崩れるケース）：完全に制限された環境でコマンド実行ができない場合

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：直接のNW規格ではないが、Webで得た足場（例：RCE/SSRF/認証突破）の"影響"は侵入後の権限/経路/横展開で決まるため、影響説明の前提として接続する
  - 該当要件（可能ならID）：該当なし（NW前提技術）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 満たす：Webテストの結果が、内部NWにどう繋がるか（境界越え）を整理する前提として位置づける
    - 破れる：侵入後の状態が不明確な場合、影響説明ができない
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Webテストの結果が、内部NWにどう繋がるか（境界越え）を整理する前提として位置づける
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：
    - Webテストの結果が、内部NWにどう繋がるか（境界越え）を整理する前提として位置づける
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：Post-Exploitation
  - 前後フェーズとの繋がり（1行）：Post-Exploitation：侵入後に最短で権限/経路/横展開入口を固め、次の行動を意思決定する
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Privilege Escalation、Lateral Movement、Credential Access、Discovery
  - 攻撃者の目的（この技術が支える意図）：本ファイルでは、分類より「状態遷移（次の一手）」として使う
  - 参照：https://attack.mitre.org/tactics/TA0004/（Privilege Escalation）

---

## 参考（必要最小限）
- `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
- `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

---

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
  - `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
- 関連 playbooks：
  - `02_playbooks/06_network_enum_to_post_列挙→侵入後の導線.md`
- 関連 labs / cases：
  - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

---

## 深掘りリンク（最大8）
- `01_topics/03_network/01_enum_到達性→サービス→認証→権限推定.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
- `01_topics/03_network/24_linux_priv-esc_入口（sudo_capabilities）.md`
- `01_topics/03_network/25_windows_priv-esc_入口（サービス権限_UAC）.md`
- `01_topics/03_network/07_pivot_tunneling（ssh_socks_chisel）.md`
- `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
- `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
