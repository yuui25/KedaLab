# 08_firewall_waf_検知と回避の境界（観測中心）
遮断/検知/制限を状態として観測し、次の一手を決める

## 目標（この技術で到達する状態）
- 「繋がらない/403が出る/途中で落ちる」を、感想ではなく **状態（state）** として説明できる
  - 例：「L4でDROP（無応答）」「L4でRST（能動拒否）」「L7で403（WAFブロックページ）」「429（レート制限）」「TLS握手段階で切断（SNI/JA3/ポリシー）」など
- その状態から、次の一手を**分岐（仮説A/B）**で選べる
  - A：観測点を変える（Pivot/別セグメント/許可IP）
  - B：手順を変える（速度・並列・対象ポート・プロトコル）
  - C：合意形成を先にする（WAFログ提供/一時許可/テストモード/ステージング）
- "回避"を「ルールの穴探し」ではなく、**診断を成立させるための正当な調整（影響制御・誤判定回避・観測点移動）**として定義し、境界（やってよい/だめ）を明確にする
- 最終的に、次ファイル（SMB/LDAP/AD等）やWeb側テストへ、誤解のない入力（到達性・制御点・制限条件）を渡す

---

## 前提・対象・範囲・想定
- 対象：Network Firewall / Security Group / NACL（L3/L4中心）、Host Firewall（Windows Firewall, iptables等）、IDS/IPS（シグネチャ/異常検知。ブロックする場合はinline）、WAF / Bot Mitigation（L7中心：HTTP/HTTPS。チャレンジ/403/JS/CAPTCHA等）、LB/CDN/Reverse Proxy（TLS終端・ALPN・HTTP/2・ヘッダ改変・キャッシュの境界）
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - 境界装置の配置が混在する環境
- できること/やらないこと（安全に検証する範囲）：
  - できること：遮断・検知・制限の観測、状態の分解、次の一手の判断、ログ合意での確証
  - やらないこと：防御装置の検知ルールをすり抜けるための具体的な変形・難読化・分割・偽装の手順、目的が「監視を逃げる」こと自体になっている行為、合意なしにブロック解除を狙う反復試行（運用事故の原因）
- 依存する前提知識（必要最小限）：
  - `01_topics/03_network/05_scanning_到達性把握（nmap_masscan）.md`
  - `01_topics/03_network/06_service_fingerprint（banner_tls_alpn）.md`
  - `01_topics/03_network/07_pivot_tunneling（ssh_socks_chisel）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：遮断・検知・制限の観測、状態の分解、次の一手の判断
  - 扱わない（別ユニットへ接続）：
    - サービス別の深掘り → `01_topics/03_network/09_smb_enum_共有・権限・匿名（null_session）.md` / `01_topics/03_network/11_ldap_enum_ディレクトリ境界（匿名_bind）.md` 等
    - Web層の深掘り → `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) L3/L4の観測（FW/SG/NACL/Host FWの影響を切り分ける）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - TCP：SYN→SYN/ACK（open（到達し、待受がいる））、SYN→RST（closed（到達したが拒否/待受無し。途中装置がRSTを返す場合もある））、SYN→無応答（filtered/dropped（FW/SG/経路/レート制御/ブラックホール））
  - ICMP：Echo reply（L3到達の根拠（ただしICMP遮断は一般的））、admin prohibited / unreachable（制御点の存在を示唆（返す設計の場合））
  - 重要な補助観測（"どこで止まったか"の手がかり）：TTL/RTTの変化（経路や中継点が変わった可能性）、TCPオプション/MSS/Window（中継装置（LB等）が終端している兆候になり得る）、"同一IP:portでも時間で揺れる"（レート制限・自動ブロック・負荷・フェイルオーバの兆候）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：経路上でドロップされている可能性が高い（FW/SG/NACL/Host FW/レート制御）
  - 信頼境界（外部連携・第三者・越境ポイント）：到達はしているが拒否されている（待受無し or 中継装置が拒否）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - L3/L4の状態で到達性が変わる

### 2) TLSハンドシェイク観測（WAF/LB/CDN境界の入口）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - TLSが成立するか（握手が通るか）、証明書（SAN/Issuer/期限）（終端点（LB/CDN/WAF）推定、内部名漏えいの手がかり）、ALPN（h2/http1.1）（HTTP層の前提確定（同じ443でも挙動が変わる））、SNI依存（servernameで返る証明書や挙動が変わるか（名前ベース終端））
- 境界の観点：
  - 信頼境界：「HTTPが見えない」時でも、TLS段階で境界装置の存在を確定できる、TLS段階で切断されるなら、HTTP以前（WAF/Proxyポリシー、mTLS要求、SNIポリシー等）の可能性
- 重要なフィールド/差分/状態：
  - TLS境界の違いでHTTP層への到達が変わる

### 3) HTTP/L7観測（WAF/Bot/アプリ/プロキシの境界を切り分ける）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - レスポンス：ステータス（403/406/429/503/30x 等（意味が違う））、レスポンスボディ（ブロックページ/チャレンジページ/エラーテンプレの有無）、ヘッダ（Server/Via/X-Cache/独自ヘッダ/Set-Cookieの挙動（境界装置の手がかり））、接続制御（同一リクエストでも、一定回数でブロック/遅延/切断が入るか（レート制限））
  - リクエスト側の条件：メソッド（GET/HEAD/OPTIONS）（境界装置が先に拒否する場合がある）、パスの違い（/ /robots.txt /favicon.ico /存在しないパス）、Host/SNI一致・不一致（名前ベースで別ポリシーが当たっていないか）、HTTP/1.1 vs HTTP/2（プロキシの実装差が出る）
- 境界の観点：
  - 信頼境界：HTTP層まで到達し、L7で拒否されている（WAF/アプリ/認可）
- 重要なフィールド/差分/状態：
  - HTTP/L7の状態で到達性が変わる

### 4) "検知"の観測（外形から見えないものを、診断で見える形にする）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 原則：外形観測だけでは「検知したか」は断言できない
  - ただし診断としては、次を合意して"観測可能にする"のが実務的：WAF/IDS/Firewallのログ抜粋（該当時刻、あなたの送信元IP、該当ルールID）、SOC/監視のアラート有無（「いつ」「何が」トリガになったか）、ブロック/緩和のポリシー（レート閾値、ブロック時間、例外条件）
- 境界の観点：
  - 信頼境界：これにより「止められた原因」を推測ではなく根拠で言えるようになる
- 重要なフィールド/差分/状態：
  - 検知の有無で次の一手が変わる

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - L3/L4の状態（open/closed/filtered）、TLS境界（TLS成立/不成立、SNI依存、ALPN）、HTTP/L7の状態（HTTP到達可否、ブロック/制限の種類）、制限条件（429/遅延/一時ブロックの有無）、推定制御点（FW/SG/Host FW/LB/WAF/アプリ）
- 何が"推定"できるか（推定の根拠/前提）：
  - L4 無応答（filtered/dropped）→ 経路上でドロップされている可能性が高い（FW/SG/NACL/Host FW/レート制御）、L4 RST（即時拒否）→ 到達はしているが拒否されている（待受無し or 中継装置が拒否）、TLS成立→HTTPで403/ブロックページ → HTTP層まで到達し、L7で拒否されている（WAF/アプリ/認可）、TLS成立→一定回数後に429/遅延/一時ブロック → レート制限/自動緩和が働いている（IP/UA/セッション単位の可能性）、TLS段階で失敗/切断 → HTTP以前のポリシー（mTLS要求、SNI制限、暗号スイート制限、プロキシの拒否等）
- 何は"言えない"か（不足情報・観測限界）：
  - 同じ"403"でも原因が違う。状態を固定しないと誤診する
  - アプリが拒否した、とは言えない（HTTPまで行っていない）、どの装置が返したRSTかは追加観測が必要、WAFかアプリかは、レスポンス特徴/ログ合意で確定する、閾値やキー（IPだけか、認証/トークン含むか）は追加観測が必要、アプリ側の認証・認可の問題とは別
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：外側でfilteredが多い → 外部からは面が小さい（または見えない）、内部経由（侵害端末/社内端末/SSRF/プロキシ/認証後導線）に寄せる
  - パターンB：443は開いているが、HTTPでブロックページ/チャレンジが出る → L7で制御されている（WAF/Bot/ポリシー）、まず"素の到達"を作り、認証後導線/別経路/内部直結を探す
  - パターンC：429/遅延が出る → 自動緩和が働いている（診断品質に直撃）、診断計画を"低速・少量・高価値"に変更（対象絞り込み、時間帯合意、ログ突合）

---

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - 外側でfilteredが多い：外部からは面が小さい（または見えない）、内部経由（侵害端末/社内端末/SSRF/プロキシ/認証後導線）に寄せる
  - 443は開いているが、HTTPでブロックページ/チャレンジが出る：L7で制御されている（WAF/Bot/ポリシー）、まず"素の到達"を作り、認証後導線/別経路/内部直結を探す
  - 429/遅延が出る：自動緩和が働いている（診断品質に直撃）、診断計画を"低速・少量・高価値"に変更（対象絞り込み、時間帯合意、ログ突合）
- 優先度の付け方（時間制約がある場合の順序）：
  1) L4で止まっている（filtered主体）→ 観測点移動（VPN内/踏み台/侵害端末）＝Pivotを作る、必要ポートに絞る（SMB/LDAP/RDP/WinRM等）→到達できるものから列挙へ
  2) TLSは通るがHTTPが制御される（403/チャレンジ）→ ログ合意で主体/ルールを確定、allowlist/テストモード/ステージングで観測可能にする、認証/認可の観測へ（Web側のAuthN/AuthZ、管理面導線の確認）
  3) 429/遅延が顕在化（レート制限）→ 診断計画を"低速・少量・高価値"に変更（対象絞り込み、時間帯合意、ログ突合）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：状態が攻め筋をどう変えるか → 外側でfilteredが多い → 内部経由（侵害端末/社内端末/SSRF/プロキシ/認証後導線）に寄せる、`07_pivot_tunneling（ssh_socks_chisel）.md` に接続し、観測点を移して"内部の地図"を作る
  - 攻め筋2：ログ合意で主体を確定し、テストモード/allowlist/ステージングで「アプリの挙動」を観測可能にする
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 診断としての次の一手：安全調整（速度/並列/対象絞り込み）を"回避"として扱い、誤検知と可用性影響を避けて進める

---

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：L4で止まっている（filtered主体）
- 次の検証：
  - 仮説A：セグメント/観測点の制約（外からは届かない） → 観測点移動（VPN内/踏み台/侵害端末）＝Pivotを作る
  - 仮説B：ポート/宛先単位のポリシー → 必要ポートに絞る（SMB/LDAP/RDP/WinRM等）→到達できるものから列挙へ
- 期待する観測（成功/失敗時に何が見えるか）：
  - 成功：L4の状態が明確になり、次の観測が決められる
  - 失敗：L4の状態が不明確なまま、次の観測が決められない

### 仮説B：TLSは通るがHTTPが制御される（403/チャレンジ）
- 次の検証：
  - 仮説A：WAF/Bot制御が主体（アプリまで届いていない） → ログ合意で主体/ルールを確定、allowlist/テストモード/ステージングで観測可能にする
  - 仮説B：アプリ認可が主体（到達はしている） → 認証/認可の観測へ（Web側のAuthN/AuthZ、管理面導線の確認）
- 期待する観測：
  - 成功：HTTP/L7の状態が明確になり、次の観測が決められる
  - 失敗：HTTP/L7の状態が不明確なまま、次の観測が決められない

### 仮説C：429/遅延が顕在化（レート制限）
- 次の検証：
  - 仮説A：WAF側の緩和（IP/UA/セッション依存） → 診断計画を"低速・少量・高価値"に変更（対象絞り込み、時間帯合意、ログ突合）
  - 仮説B：アプリ側のrate-limit（APIキー/ユーザ単位） → 認証後のキー設計/制限の妥当性評価へ（本ファイルでは"主体確定"まで）
- 期待する観測：
  - 成功：レート制限の条件が明確になり、次の観測が決められる
  - 失敗：レート制限の条件が不明確なまま、次の観測が決められない

---

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`
- 取得する証跡（目的ベースで最小限）：
  - L4状態（open/closed/filtered（根拠：nmap/pcap））、TLS（成立/不成立、SNI依存、ALPN（根拠：s_client））、L7（HTTP到達可否、ブロック/制限の種類（根拠：curl））、制限条件（429/遅延/一時ブロックの有無（根拠：小規模ループ））、推定制御点（FW/SG/Host FW/LB/WAF/アプリ（確度：高/中/低））
- 観測の取り方（どの視点で差分を見るか）：
  - L3/L4の状態での差分
  - TLS境界の違いでの差分
  - HTTP/L7の状態での差分
  - レート制限の有無での差分
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/firewall_waf 2>/dev/null
    cd ~/keda_evidence/firewall_waf
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可された診断/演習** のみ
      - 観測は **遮断・検知・制限の観測** のみ
      - 負荷を上げない（短い試行で曲線を掴む）
      - ログ合意で確証を取る
  - 相関キー（最低限）を作る（後で必ず効く）
    - SourceIP、TargetIP、Port、Protocol、Layer、State、ControlPoint、Time

---

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# Step 1：L4の状態を"最小トラフィック"で確定する
nmap -sS -Pn -n -p 80,443,445,389,3389 <target_ip> -oN 08_l4_baseline.txt

# Step 2：filtered の"性質"を切り分ける（pcap観測）
sudo tcpdump -i <iface> host <target_ip> and tcp port 443 -nn -vv

# Step 3：TLS境界を確定する（WAF/LB/CDNの入口観測）
openssl s_client -connect <ip>:443 -servername <fqdn> -alpn h2,http/1.1 -brief < /dev/null

# Step 4：HTTP/L7で「WAF/アプリ/認可」を分ける（ベースライン→差分）
curl -vkI --http1.1 https://<fqdn_or_ip>/

# Step 5：レート制限（429/遅延/一時ブロック）の"モデル"を作る
for i in $(seq 1 20); do
  curl -sk -o /dev/null -w "%{http_code} %{time_total}\n" https://<fqdn_or_ip>/healthz
  sleep 0.5
done
~~~~

- この例で観測していること：L3/L4の状態、TLS境界、HTTP/L7の状態、制限条件（429/遅延/一時ブロック）
- 出力のどこを見るか（注目点）：L4状態（open/closed/filtered）、TLS情報（証明書/SAN/ALPN/SNI）、HTTPステータス（403/429等）、レスポンスボディ、ヘッダ、レート制限の有無
- この例が使えないケース（前提が崩れるケース）：完全に制限された環境で観測ができない場合、または許可範囲外の場合

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：FW/WAFは「境界（資産・信頼・権限）」を実装で担保する層。ASVSの要件そのものというより、ASVSで求める安全性（認証強制、管理面保護、通信保護、監査）を"構成/運用で満たしているか"を外形から検証する前提になる
  - 該当要件（可能ならID）：該当なし（NW前提技術）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 満たす：到達性・制御・ログの実効性（許可/遮断/検知/レート制限）が、意図した境界で成立しているかを観測で言い切る
    - 破れる：FW/WAFが"あるだけ"ではなく、意図した境界で成立していることが重要
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：WSTGの多くのテストは「対象に到達できる」ことが前提。FW/WAFが介在すると、観測される挙動（403/429/チャレンジ/遮断）が"アプリの挙動"ではなく"境界装置の挙動"である可能性が高い
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：
    - WSTGの結果を誤解しないため、L4/TLS/L7の制御主体を確定し、テスト対象（アプリ）に到達できる条件を整える
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：Intelligence Gathering、Scanning、Vulnerability Analysis
  - 前後フェーズとの繋がり（1行）：Intelligence Gathering / Scanning の結果を、Vulnerability Analysis に接続するための「障害物（境界装置）」の解釈レイヤ。ブロックや検知でスキャンが進まない時に、闇雲に手数を増やさず、観測→解釈→次の一手（観測点移動/範囲縮小/合意形成）で前進させる
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Discovery、Defense Evasion
  - 攻撃者の目的（この技術が支える意図）：Discovery（T1046 Network Service Discovery（スキャンが"どこで止められるか"を含めて解釈する））、Defense Evasion（言及は境界の理解として）：防御回避は攻撃者の目的になり得るが、本ファイルは「回避テクニックの列挙」ではなく、**検知/遮断の成立点を観測で特定し、許可された診断を安全に成立させる**ことに集中する
  - 参照：https://attack.mitre.org/tactics/TA0007/（Discovery）

---

## 参考（必要最小限）
- `01_topics/03_network/05_scanning_到達性把握（nmap_masscan）.md`
- `01_topics/03_network/06_service_fingerprint（banner_tls_alpn）.md`
- `01_topics/03_network/07_pivot_tunneling（ssh_socks_chisel）.md`
- Nmap公式ドキュメント
- OpenSSL公式ドキュメント

---

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/03_network/05_scanning_到達性把握（nmap_masscan）.md`
  - `01_topics/03_network/07_pivot_tunneling（ssh_socks_chisel）.md`
  - `01_topics/03_network/09_smb_enum_共有・権限・匿名（null_session）.md`
- 関連 playbooks：
  - `02_playbooks/06_network_enum_to_post_列挙→侵入後の導線.md`
- 関連 labs / cases：
  - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`

---

## 深掘りリンク（最大8）
- `01_topics/03_network/05_scanning_到達性把握（nmap_masscan）.md`
- `01_topics/03_network/06_service_fingerprint（banner_tls_alpn）.md`
- `01_topics/03_network/07_pivot_tunneling（ssh_socks_chisel）.md`
- `01_topics/03_network/09_smb_enum_共有・権限・匿名（null_session）.md`
- `01_topics/03_network/11_ldap_enum_ディレクトリ境界（匿名_bind）.md`
- `01_topics/03_network/12_kerberos_asrep_kerberoast_成立条件.md`
- `01_topics/03_network/18_winrm_psremoting_到達性と権限.md`
- `01_topics/03_network/19_rdp_設定と認証（NLA）.md`
