# 03_creds_認証情報の所在と扱い（攻撃 検知の両面）

## 目的（この技術で到達する状態）
- 認証情報（Credentials）を「種類の暗記」ではなく、次の3点で説明できる状態にする
  1) どこに存在するか（所在：ファイル/メモリ/設定/外部）
  2) それが何を意味するか（権限/範囲/期限/境界）
  3) 次に何を試すべきか（成立条件と分岐）
- Web起点（APIトークン/Secrets/セッション）とNW起点（パスワード/ハッシュ/チケット）を統合し、横展開や越権の"導線"を作れる
- 攻撃観点だけでなく、検知・運用観点（どこが監査される/守るべき境界）も最低限で言語化できる

---

## 前提（対象・範囲・想定）
- 対象：許可範囲の環境のみ（特に資格情報は影響が大きい）
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - 資格情報は"単体で危険"ではなく、「どの境界を越えられるか」で価値が決まる
  - ローカル→ドメイン→クラウド/SaaS へ伝播し得る（逆もある）
- できること/やらないこと（安全に検証する範囲）：
  - できること：認証情報の所在の特定、意味の解釈、次の一手の判断、検知の観点の整理
  - やらないこと：ツール操作の手順書化（本ファイルは"所在→意味→次の一手"の地図）、"落とし穴"章は作らない、影響最大化の実証（許可範囲と安全性がある）
- 依存する前提知識（必要最小限）：
  - `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
  - `01_topics/02_web/02_authn_00_認証・セッション・トークン.md`（Web側の資格情報と統合）
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：認証情報の所在、意味、次の一手の判断、検知の観点
  - 扱わない（別ユニットへ接続）：
    - AD地図の作成 → `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
    - Web/APIトークンの深掘り → `01_topics/02_web/02_authn_00_認証・セッション・トークン.md` / `01_topics/02_web/04_api_00_権限伝播・入力・バックエンド連携.md`
    - SaaS/IdP連携の深掘り → `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 認証情報の分類（名前ではなく"境界"で分ける）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 本人性の材料（AuthN）：パスワード、秘密鍵、証明書、ワンタイム、MFA要素
  - 伝播する材料（Session/Token/Delegation）：セッションCookie、Bearerトークン、APIキー、Refreshトークン、STS/一時クレデンシャル
  - OS/ドメイン由来の材料（Windows/AD）：ハッシュ、チケット、キャッシュ、委任、サービスアカウントの権限
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：どのシステム/テナント/プロジェクト/サブネットに効くか
  - 信頼境界（外部連携・第三者・越境ポイント）：ローカル→ドメイン→クラウド/SaaS へ伝播し得る（逆もある）
  - 権限境界（権限の切替/伝播/委任）：何者として扱われるか（ユーザー/サービス/管理者）、その鍵は別の鍵を生むか（Refresh→Access、委任→他サービス、SSO→複数SaaS）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 種類より「どの境界（資産/信頼/権限）を越える鍵か」を見る
  - 期限（Lifetime）：いつまで使えるか（短命/長命、更新可能か）

### 2) 所在（Where）：どこに"残る"かを確定する
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - ディスク（設定・ファイル）：アプリ設定、環境変数ファイル、デプロイ設定、ジョブ設定、バックアップ
  - メモリ（実行中）：セッション/トークン、チケット、認証キャッシュ
  - ログ（観測・監査）：アプリログ、プロキシログ、監査ログ（意図せず漏れる/あるいは検知される）
  - ネットワーク（伝送）：認証ヘッダ、Cookie、トークン交換、SAML/OIDC/OAuthフロー
  - 外部（信頼境界）：IdP、SaaS、CI/CD、Vault、クラウドのメタデータ等
- 境界の観点：
  - 資産境界："所在"は、侵入後の動き（横展開/越権）を決める一次情報
  - 信頼境界：外部（信頼境界）に存在する場合、信頼境界の越境が必要
- 重要なフィールド/差分/状態：
  - 所在の違い（ディスク/メモリ/ログ/ネットワーク/外部）で取得方法が変わる

### 3) 意味（So what を使わずに）：その認証情報で何ができるか
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 権限境界：何者として扱われるか（ユーザー/サービス/管理者）
  - 範囲（Scope）：どのシステム/テナント/プロジェクト/サブネットに効くか
  - 期限（Lifetime）：いつまで使えるか（短命/長命、更新可能か）
  - 伝播（Propagation）：その鍵は別の鍵を生むか（Refresh→Access、委任→他サービス、SSO→複数SaaS）
- 境界の観点：
  - 権限境界：何者として扱われるか（ユーザー/サービス/管理者）
  - 信頼境界：伝播の連鎖（この鍵→別の鍵→別の境界）
- 重要なフィールド/差分/状態：
  - ここが"技術力の差"になる（見つけた鍵の価値を瞬時に判断できる）

### 4) 次の一手（Next move）：成立条件と分岐を作る
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - A：同一境界内での権限拡大（ローカル管理、サービス権限、設定改変）
  - B：隣接境界への横展開（同一NW内の他ホスト、共有、管理プロトコル）
  - C：信頼境界の越境（SaaS/クラウド/IdPへ、またはそこから戻る）
- 境界の観点：
  - 資産境界：同一境界内での権限拡大、隣接境界への横展開
  - 信頼境界：信頼境界の越境
- 重要なフィールド/差分/状態：
  - 分岐条件：経路（到達性）があるか、認証方式が合っているか（パスワード/鍵/トークン/チケット）、監査/検知の強さ（影響制御の必要度）

### 5) 検知の観点（最低限）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - どこでログが残りやすいか（認証試行、トークン交換、管理プロトコル）
  - "静かな行動"と"派手な行動"の差（例：情報取得（Discovery）と認証試行（Brute/Password spray）は検知特性が違う）
- 境界の観点：
  - 信頼境界：検知されやすさ（ログ/監査点の推定）
- 重要なフィールド/差分/状態：
  - 目的：防御の話を厚くするのではなく、攻撃検証の影響制御と再現性を上げる

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - どこに資格情報が存在するか（所在）
  - それが越えられる境界（権限/信頼/資産）と範囲/期限
  - 次の一手（横展開/越権/外部越境）の優先度
- 何が"推定"できるか（推定の根拠/前提）：
  - 伝播の連鎖（この鍵→別の鍵→別の境界）（追加観測で強くなる）
  - 検知されやすさ（ログ/監査点の推定）
- 何は"言えない"か（不足情報・観測限界）：
  - "確実に横展開できる"の断定（経路と相手側の設定が必要）
  - 影響最大化の断定（許可範囲と安全性がある）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：テナント/ドメインを跨ぐ鍵（SSO/IdP/クラウド権限） → 価値が高い
  - パターンB：管理権限に直結する鍵（管理者/サービスアカウント） → 価値が高い
  - パターンC：横展開を加速する鍵（共有/管理プロトコルに通るもの） → 価値が高い

---

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - テナント/ドメインを跨ぐ鍵（SSO/IdP/クラウド権限）
  - 管理権限に直結する鍵（管理者/サービスアカウント）
  - 横展開を加速する鍵（共有/管理プロトコルに通るもの）
  - 短命でも連鎖する鍵（Refresh/STS等）
- 優先度の付け方（時間制約がある場合の順序）：
  1) テナント/ドメインを跨ぐ鍵（SSO/IdP/クラウド権限）
  2) 管理権限に直結する鍵（管理者/サービスアカウント）
  3) 横展開を加速する鍵（共有/管理プロトコルに通るもの）
  4) 短命でも連鎖する鍵（Refresh/STS等）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：その鍵は「誰として」「どこまで」「いつまで」効くか → "使えるか"を最小確認するならどこか（read-only、影響の小さいAPI等）
  - 攻め筋2：経路がないなら、経路を作る（ピボット/踏み台）か、別の鍵を探すか
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - AD色が強い（Kerberos/ドメイン参加） → `04_ad` へ
  - Web/APIトークンが主戦場 → `02_web/02_authn` と `02_web/04_api` へ戻る
  - SaaS/IdP連携が鍵 → `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md` へ

---

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：Web側のSecrets/Tokenが"信頼境界越え"に繋がる
- 次の検証：
  - A：そのトークンが呼ぶ先（API/テナント/権限）を観測で確定
  - B：最小のread-only確認で"範囲と期限"を確定（許可範囲で）
- 期待する観測（成功/失敗時に何が見えるか）：
  - 成功：鍵の価値（越えられる境界）が説明でき、次の深掘り対象が絞れる
  - 失敗：鍵の価値が説明できず、次の深掘り対象が絞れない

### 仮説B：NW側の資格情報が横展開の燃料になる
- 次の検証：
  - A：経路（到達性）を確認し、成立する入口（SMB/RDP/SSH等）を絞る
  - B：権限境界（ローカル/ドメイン）を確認し、どこまで伝播するかを確定
- 期待する観測：
  - 成功："どの入口に対して、どの鍵が効くか"が説明できる
  - 失敗："どの入口に対して、どの鍵が効くか"が説明できない

### 仮説C：ADが関与し、チケット/委任/サービス権限が鍵になる
- 次の検証：
  - `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md` へ進み、用語ではなく地図（境界）を作る
- 期待する観測：
  - 成功：AD地図が作成でき、チケット/委任/サービス権限の価値が明確になる
  - 失敗：AD地図が作成できず、チケット/委任/サービス権限の価値が不明確なまま

---

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
    - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
- 取得する証跡（目的ベースで最小限）：
  - 認証情報の所在（設定ファイル、環境変数、メモリ、ログ）
  - 認証情報の意味（権限/範囲/期限/境界）
  - 次の一手の判断材料（成立条件と分岐）
- 観測の取り方（どの視点で差分を見るか）：
  - 所在の違い（ディスク/メモリ/ログ/ネットワーク/外部）での差分
  - 認証情報の種類（パスワード/ハッシュ/トークン/チケット）での差分
  - 権限/範囲/期限の違いでの差分
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/credentials 2>/dev/null
    cd ~/keda_evidence/credentials
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可範囲の環境** のみ
      - 観測は **所在→意味→次の一手** の判断のみ
      - 影響最大化の実証は避ける（許可範囲と安全性がある）
  - 相関キー（最低限）を作る（後で必ず効く）
    - Host、CredentialType、Location、Scope、PrivilegeLevel、Lifetime、Propagation、Time

---

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 例：環境変数に秘密が残っていないか（概念）
env | grep -i -E "token|secret|key|pass"

# 例：接続の証跡を残すための基本観測（概念）
whoami
ip route
~~~~

- この例で観測していること：認証情報の所在（環境変数、設定ファイル）、認証情報の意味（権限/範囲/期限/境界）、次の一手の判断材料（成立条件と分岐）
- 出力のどこを見るか（注目点）：認証情報の種類、所在、権限/範囲/期限、伝播の可能性
- この例が使えないケース（前提が崩れるケース）：完全に制限された環境でコマンド実行ができない場合

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：Webの認証・セッション・秘密情報管理はCredentialsの扱いが前提であり、破れるとAuthZ/データ保護が崩れるため"前提を支える技術"として接続する
  - 該当要件（可能ならID）：該当なし（NW前提技術）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 満たす：Webの認証・セッション・秘密情報管理はCredentialsの扱いが前提
    - 破れる：認証情報の扱いが不適切な場合、AuthZ/データ保護が崩れる
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：認証情報/セッション/秘密情報の観点を、NW側のCredentialsと統合し、境界越え（テナント/ロール/ドメイン）として扱う
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：
    - 認証情報/セッション/秘密情報の観点を、NW側のCredentialsと統合し、境界越え（テナント/ロール/ドメイン）として扱う
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：Post-Exploitation
  - 前後フェーズとの繋がり（1行）：Post-Exploitation：Credentialsの所在を確定し、横展開/越権の燃料として最短で意思決定する
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Credential Access、Lateral Movement、Privilege Escalation、Discovery
  - 攻撃者の目的（この技術が支える意図）：本ファイルでは、技術名より「どこにあり、何ができ、次に何をするか」を状態として整理する
  - 参照：https://attack.mitre.org/tactics/TA0006/（Credential Access）

---

## 参考（必要最小限）
- `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
- `01_topics/02_web/02_authn_00_認証・セッション・トークン.md`
- `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`

---

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
  - `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
  - `01_topics/02_web/02_authn_00_認証・セッション・トークン.md`
- 関連 playbooks：
  - `02_playbooks/06_network_enum_to_post_列挙→侵入後の導線.md`
- 関連 labs / cases：
  - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`

---

## 深掘りリンク（最大8）
- `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
- `01_topics/02_web/02_authn_00_認証・セッション・トークン.md`
- `01_topics/02_web/04_api_00_権限伝播・入力・バックエンド連携.md`
- `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- `01_topics/03_network/26_credential_dumping_所在（LSA_DPAPI）.md`
- `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
- `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
