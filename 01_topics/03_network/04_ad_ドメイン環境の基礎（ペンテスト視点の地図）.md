# 04_ad_ドメイン環境の基礎（ペンテスト視点の地図）

## 目的（この技術で到達する状態）
- ADを「難しい用語の集合」ではなく、ペンテストで必要な最小の地図として理解し、次を説明できる
  - 何が資産で、どこが境界か（資産境界）
  - どこから先が信頼で繋がっているか（信頼境界：信頼関係/委任/連携）
  - どこで権限が切り替わる/伝播するか（権限境界：グループ/委任/チケット）
- "なぜそれが攻撃面になるのか"を、観測→意味→次の一手で回せる
- Web/IdP/クラウドと繋がるADの位置づけを理解し、NW・Webの両側から検証を組み立てられる

---

## 前提（対象・範囲・想定）
- 対象：許可範囲のドメイン環境または検証ラボ（推奨）
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - ADは「認証」だけでなく「権限の配布と伝播」の仕組み
  - 侵入後はADが"最短で影響が広がる地図"になりやすい
- できること/やらないこと（安全に検証する範囲）：
  - できること：ADの地図（資産/信頼/権限境界）の作成、自分の位置の確定、横展開の入口の特定、認証とチケットの観測
  - やらないこと：典型攻撃の羅列（手法カタログ化）ではなく、地図（構造と導線）を作る、"落とし穴"章は作らない、具体攻撃の実証（材料と経路が必要）
- 依存する前提知識（必要最小限）：
  - `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：ADの地図（資産/信頼/権限境界）の作成、自分の位置の確定、横展開の入口の特定
  - 扱わない（別ユニットへ接続）：
    - 認証情報の深掘り → `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
    - 連携（IdP/クラウド同期）の深掘り → `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
    - 具体的な攻撃手法 → `01_topics/03_network/10_ntlm_relay_成立条件（SMB署名_LLMNR）.md` / `01_topics/03_network/12_kerberos_asrep_kerberoast_成立条件.md` 等

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) ADの資産（Asset）を"最小セット"で捉える
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - ドメインコントローラ（DC）：認証とディレクトリの中心
  - アカウント：ユーザー、サービスアカウント、管理者
  - グループ：権限の配布単位（誰が何をできるか）
  - コンピュータ：参加端末/サーバ（どこがドメイン内か）
  - ポリシー/設定：権限の形を決める（委任、アクセス制御）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：これらの関係が"権限境界"と"伝播"を作る
  - 権限境界（権限の切替/伝播/委任）：グループの権限（Domain Admins 等）、委任（Delegation）：特定操作を誰に任せているか、ローカル管理者権限の分布（端末/サーバで誰が管理者か）
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - グループの権限で可能な操作が変わる
  - 委任の有無で権限伝播の範囲が変わる

### 2) 信頼境界（Trust Boundary）を捉える：どこまでが同一の信頼か
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - フォレスト/ドメインの分割
  - ドメイン間/フォレスト間の信頼関係
  - 連携（IdP/SSO/クラウド同期：AAD Connect等の位置づけ）
- 境界の観点：
  - 信頼境界（外部連携・第三者・越境ポイント）：信頼境界を跨げると影響が急拡大する（逆に跨げないなら局所化する）
- 重要なフィールド/差分/状態：
  - 信頼関係の有無で横展開の可能性が変わる
  - 連携（IdP/クラウド同期）の有無で信頼境界の範囲が変わる

### 3) 権限境界（Privilege Boundary）を捉える：どこで権限が切り替わるか
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - グループの権限（Domain Admins 等）
  - 委任（Delegation）：特定操作を誰に任せているか
  - ローカル管理者権限の分布（端末/サーバで誰が管理者か）
- 境界の観点：
  - 権限境界（権限の切替/伝播/委任）："誰がどこを管理できるか" が横展開の最短導線を決める
- 重要なフィールド/差分/状態：
  - グループの権限で可能な操作が変わる
  - 委任の有無で権限伝播の範囲が変わる

### 4) 認証とチケット（Kerberos中心）を"伝播の仕組み"として捉える
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - Kerberos/NTLM のどちらが主か（環境の兆候）
  - チケットがどの境界を跨ぐ材料になっているか（委任/サービスアクセス）
- 境界の観点：
  - 信頼境界：チケットは"認証情報"であり、環境によっては横展開の燃料になる
- 重要なフィールド/差分/状態：
  - 認証方式（Kerberos/NTLM）の違いで横展開の方法が変わる
  - 委任の有無でチケットの価値が変わる

### 5) "地図"としての最小アウトプット（手法より先に作る）
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 最小の地図項目（これだけは埋める）：ドメイン名/フォレスト、DC候補、主要グループ（管理系）、サービスアカウントの存在、端末/サーバの役割（ファイル、業務、管理）、信頼関係/連携（あるなら）、自分の位置（どの端末で、どの権限）
- 境界の観点：
  - 資産境界：ドメイン名/フォレスト、DC候補、端末/サーバの役割
  - 信頼境界：信頼関係/連携
  - 権限境界：主要グループ（管理系）、サービスアカウントの存在、自分の位置
- 重要なフィールド/差分/状態：
  - 目的：以降の攻め筋（横展開/昇格/認証情報収集）を"迷わず"選べる

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - AD環境の最小地図（資産/信頼/権限境界の当たり）
  - 自分の位置（どこにいて、どの権限で、どこへ行けそうか）
  - 横展開の入口（認証が絡むサービスと権限境界）
- 何が"推定"できるか（推定の根拠/前提）：
  - 信頼関係の影響範囲（追加観測で強くなる）
  - 権限伝播の連鎖（委任・グループ・サービス）
- 何は"言えない"か（不足情報・観測限界）：
  - 具体攻撃が成立するか（材料と経路が必要）
  - 内部ポリシーの詳細（観測が必要）
  - 全体網羅（段階的に広げる）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：権限境界が見え、次に必要な材料が認証情報 → `03_creds` に戻り、"所在→意味→次の一手"で材料を確定する
  - パターンB：SSO/IdP/クラウド連携が越境点になりそう → SaaS/IdPの信頼境界へ：`01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
  - パターンC：ADの地図がまだ薄く、横展開先が決められない → 最小地図項目（ドメイン/DC/主要グループ/役割/自分の位置）を埋める観測を優先

---

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - 権限境界（管理系グループ/委任/ローカル管理者の分布）
  - 信頼境界（信頼関係/連携）— 越境点があれば最優先
  - 認証材料（チケット/キャッシュ/サービスアカウント）
  - 資産（DC/重要サーバ）への到達性
- 優先度の付け方（時間制約がある場合の順序）：
  1) 権限境界（管理系グループ/委任/ローカル管理者の分布）
  2) 信頼境界（信頼関係/連携）— 越境点があれば最優先
  3) 認証材料（チケット/キャッシュ/サービスアカウント）
  4) 資産（DC/重要サーバ）への到達性
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：地図が薄いなら → まず地図を埋める（観測の追加）
  - 攻め筋2：導線が見えたなら → 次に必要な材料（creds/権限）を特定する
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 連携（IdP/クラウド同期）が見える → `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md` へ接続
  - 侵入後の経路が課題 → `02_post` に戻って経路（ピボット/到達性）を固める
  - 認証材料が課題 → `03_creds` に戻って所在を固める

---

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：ADの地図がまだ薄く、横展開先が決められない
- 次の検証：
  - 最小地図項目（ドメイン/DC/主要グループ/役割/自分の位置）を埋める観測を優先
  - 観測は"差分"で：権限が変わると見えるものが変わるかを確認する
- 期待する観測（成功/失敗時に何が見えるか）：
  - 成功：ADの地図が作成でき、横展開先が決められる
  - 失敗：ADの地図が作成できず、横展開先が決められない

### 仮説B：権限境界が見え、次に必要な材料が認証情報だ
- 次の検証：
  - `03_creds` に戻り、"所在→意味→次の一手"で材料を確定する
- 期待する観測：
  - 成功：認証情報の所在が特定でき、横展開が成立する
  - 失敗：認証情報の所在が特定できず、横展開が成立しない

### 仮説C：SSO/IdP/クラウド連携が越境点になりそうだ
- 次の検証：
  - SaaS/IdPの信頼境界へ：`01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- 期待する観測：
  - 成功：SSO/IdP/クラウド連携の信頼境界が明確になり、越境点が特定できる
  - 失敗：SSO/IdP/クラウド連携の信頼境界が不明確なまま、越境点が特定できない

---

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/03_targets/03_ad_lab_検証用ドメイン構成.md`
    - `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
- 取得する証跡（目的ベースで最小限）：
  - ADの地図（資産/信頼/権限境界）
  - 自分の位置（どこにいて、どの権限で、どこへ行けそうか）
  - 横展開の入口（認証が絡むサービスと権限境界）
  - 認証とチケットの観測（Kerberos/NTLM、委任/サービスアクセス）
- 観測の取り方（どの視点で差分を見るか）：
  - 権限の違いでの差分
  - 信頼関係の有無での差分
  - 認証方式（Kerberos/NTLM）の違いでの差分
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/ad_mapping 2>/dev/null
    cd ~/keda_evidence/ad_mapping
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可範囲のドメイン環境または検証ラボ** のみ
      - 観測は **地図（構造と導線）** の作成のみ
      - 具体攻撃の実証は避ける（材料と経路が必要）
  - 相関キー（最低限）を作る（後で必ず効く）
    - Domain、Forest、DC、Account、Group、Computer、Trust、Delegation、PrivilegeLevel、AuthMethod、Time

---

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 例：自分の主体（権限）を確定（概念）
whoami

# 例：ドメイン参加の兆候を観測（概念）
# Windowsなら systeminfo / nltest 等の情報が手掛かりになるが、
# まずは「ドメインか、ローカルか」「どこに認証が依存しているか」を状態で確定する
~~~~

- この例で観測していること：ADの地図（資産/信頼/権限境界）、自分の位置（どこにいて、どの権限で、どこへ行けそうか）、横展開の入口（認証が絡むサービスと権限境界）
- 出力のどこを見るか（注目点）：ドメイン名/フォレスト、DC候補、主要グループ（管理系）、サービスアカウントの存在、端末/サーバの役割、信頼関係/連携、自分の位置
- この例が使えないケース（前提が崩れるケース）：完全に制限された環境でコマンド実行ができない場合、またはドメイン環境ではない場合

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：Webの認証・認可・セッションはAD/IdP連携に依存し得るため、背後の権限モデル（グループ/委任）を理解することがWeb検証の前提になる
  - 該当要件（可能ならID）：該当なし（NW前提技術）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 満たす：Webの認証・認可・セッションはAD/IdP連携に依存し得るため、背後の権限モデル（グループ/委任）を理解することがWeb検証の前提になる
    - 破れる：ADの地図が不明確な場合、Web検証の前提が崩れる
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：SSO/認証基盤の検証を行う際、AD側のアカウント/グループ/権限境界を地図として把握していると、誤設定/越権の観測が具体化する
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：
    - SSO/認証基盤の検証を行う際、AD側のアカウント/グループ/権限境界を地図として把握していると、誤設定/越権の観測が具体化する
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：Post-Exploitation、Lateral Movement
  - 前後フェーズとの繋がり（1行）：Post-Exploitation/Lateral Movement：ADを地図化し、次の一手（材料と導線）を意思決定する
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Discovery、Credential Access、Privilege Escalation、Lateral Movement
  - 攻撃者の目的（この技術が支える意図）：本ファイルは、技術の羅列ではなく「境界と導線」を状態として整理する
  - 参照：https://attack.mitre.org/tactics/TA0007/（Discovery）

---

## 参考（必要最小限）
- `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- `04_labs/03_targets/03_ad_lab_検証用ドメイン構成.md`

---

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
  - `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- 関連 playbooks：
  - `02_playbooks/06_network_enum_to_post_列挙→侵入後の導線.md`
- 関連 labs / cases：
  - `04_labs/03_targets/03_ad_lab_検証用ドメイン構成.md`

---

## 深掘りリンク（最大8）
- `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/03_network/10_ntlm_relay_成立条件（SMB署名_LLMNR）.md`
- `01_topics/03_network/12_kerberos_asrep_kerberoast_成立条件.md`
- `01_topics/03_network/14_delegation（unconstrained_constrained_RBCD）.md`
- `01_topics/04_saas/01_idp_連携（SAML OIDC OAuth）と信頼境界.md`
- `04_labs/03_targets/03_ad_lab_検証用ドメイン構成.md`
- `04_labs/05_automation/02_snapshots_reset_検証の巻き戻し.md`
