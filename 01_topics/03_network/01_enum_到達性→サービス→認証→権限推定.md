# 01_enum_到達性→サービス→認証→権限推定
到達性→サービス→認証→権限を順に確定し、次の検証仮説へ繋ぐための基盤を作る

## 目標（この技術で到達する状態）
- 列挙（Enum）を「スキャンして終わり」にせず、次の順で **検証可能な仮説** を作る
  1) 到達性（どこまで届くか）
  2) サービス（何が動いているか）
  3) 認証（どこで本人性が成立するか）
  4) 権限（何ができるか：越境点はどこか）
- Web/NW混在の現場でも、入口（VPN/VDI/OWA/SSO/社内Web/管理系）を"境界"として整理し、次に深掘りすべき対象を絞れる
- 低ノイズで、再現性のある証跡（スキャン結果・pcap・メモ）を残せる

---

## 前提・対象・範囲・想定
- 対象：許可された範囲のみ（IPレンジ、時間帯、負荷、禁止事項など）
  - ※RoEの詳細は最小限でよいが、範囲外への到達を防ぐ前提は厳守
- 想定する環境（例：クラウド/オンプレ、CDN/WAF有無、SSO/MFA有無）：
  - FW/IDS/EDR、レート制限、分割NW、NAT、踏み台、VPN、クラウドNW（VPC/VNet）
  - "見えない"ことがある（遮断/欺瞞/非同期）ため、断定せず差分観測で固める
- できること/やらないこと（安全に検証する範囲）：
  - できること：到達性の確定、サービスの列挙、認証成立点の特定、権限境界の推定、証跡の取得（スキャン結果・pcap・メモ）
  - やらないこと：範囲外への到達、過剰な並列スキャン、広域スキャン、高負荷をかける操作
- 依存する前提知識（必要最小限）：
  - `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`（入口の確定方法をNWにも適用）
- 扱う範囲（本ファイルの守備範囲）
  - 扱う：到達性→サービス→認証→権限推定の順序立てた観測、境界としての整理、証跡の取得方法
  - 扱わない（別ユニットへ接続）：
    - 侵入後の前提整理 → `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
    - 認証情報の整理 → `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`

---

## 観測ポイント（何を見ているか：プロトコル/データ/境界）
### 1) 到達性（Reachability）を"境界"として確定する
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - どの経路（自端末/踏み台/VPN）から、どの宛先に届くか
  - ICMPが通らなくてもTCPが通ることがある（逆もある）
  - DNSが見える/見えない（内部DNS、分割DNS）
- 境界の観点：
  - 資産境界（管理主体・委託先・対象範囲の線引き）：どのIPレンジ/サブネットが管理下にあるか、どの経路から到達可能か
  - 信頼境界（外部連携・第三者・越境ポイント）：VPN/VDI/OWA/SSOなどの入口、外部委託先との接続点
  - 権限境界（権限の切替/伝播/委任）：認証前後で見える範囲の変化、権限による到達可能範囲の差
- 重要なフィールド/差分/状態（「ここが変わると意味が変わる」点）：
  - 経路の違い（VPN有無、踏み台有無）で到達性が変わる
  - 認証前後で見える範囲が変わる
  - プロトコル（ICMP/TCP/UDP）で到達性が変わる

### 2) サービス（Service）を"入口"として確定する
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - ポート/プロトコル、暗号（TLSの有無/バージョン）、バナー/実装の痕跡
  - "管理系/基盤系/業務系" など用途の推定（勝負所の優先度付け）
- 境界の観点：
  - 資産境界：Web系（80/443）でも、背後にAPI/管理/認証基盤があるかを推定できる
  - 信頼境界：サービス＝攻撃面、認証が絡む入口の優先度
  - 権限境界：サービスごとに必要な権限が異なる
- 重要なフィールド/差分/状態：
  - ポート/プロトコルの組み合わせ
  - TLSの有無/バージョン/証明書情報
  - バナー/実装の痕跡（バージョン、ベンダー情報）

### 3) 認証（AuthN）を"成立点"として確定する
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - VPN/VDI/SSOポータル/OWA、RDP/SSH/SMB、管理コンソール
  - 認証方式の兆候：フォーム/SSOリダイレクト、証明書、Kerberos/NTLM、MFA/端末制限
- 境界の観点：
  - 信頼境界：認証がどこで成立するかが分かると、次の「権限がどう付与されるか」を推定できる
  - 権限境界：認証成立後の権限付与の起点
- 重要なフィールド/差分/状態：
  - 認証方式の違い（フォーム/SSO/証明書/Kerberos/NTLM）
  - 認証前後での見える範囲の変化

### 4) 権限推定（Privilege Estimation）を"操作可能範囲"として固める
- 観測対象（プロトコル/データ構造/やり取りの単位）：
  - 認証後に見えるネットワーク範囲の変化、見えるサービスの変化
  - 共有資源、管理機能、実行/操作が可能な入口
- 境界の観点：
  - 権限境界：権限境界がどこで切り替わる/伝播するか（横展開の入口）が見えてくる
- 重要なフィールド/差分/状態：
  - 認証前後での見える範囲の変化
  - 権限による到達可能範囲の差

### 5) 証跡（再現性）を最小セットで取る
- 取得する証跡（目的ベースで最小限）：
  - 実行した観測（何を、どの条件で、どの範囲に対して）
  - 主要出力（スキャン結果、サービスの要点）
  - 重要差分（ログイン前後、経路違い）
  - pcap（到達性/経路/暗号の切り分けが必要な時だけ）
- 観測の取り方（どの視点で差分を見るか）：
  - 経路の違い（VPN有無、踏み台有無）での差分
  - 認証前後での差分
  - 権限の違いでの差分
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/network_enum 2>/dev/null
    cd ~/keda_evidence/network_enum
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **代表点の抽出** のみ
      - 範囲外への到達は禁止
      - 過剰な並列スキャンは避ける
  - 相関キー（最低限）を作る（後で必ず効く）
    - IP、Port、Protocol、Time、Route、AuthStatus、PrivilegeLevel

---

## 結果の意味（その出力が示す状態：何が言える/言えない）
- 何が"確定"できるか：
  - どこまで届くか（到達性の境界）
  - 何が入口か（サービスの境界）
  - 認証の成立点（どこで本人性が成立するか）
  - 権限推定の手掛かり（ログイン前後差、見える範囲の差）
- 何が"推定"できるか（推定の根拠/前提）：
  - 遮断/欺瞞/分割NWの可能性（追加観測で強くなる）
  - 認証基盤（AD/IdP）の存在や連携構造（Web側と接続）
- 何は"言えない"か（不足情報・観測限界）：
  - "脆弱性がある"の断定（あくまで入口と境界の確定）
  - 内部構造の断定（観測が必要）
  - 全範囲の網羅（ノイズを増やさずに段階的に広げる）
- よくある状態パターン（正常/異常/境界がズレている等）：
  - パターンA：到達性が不確実で、列挙ノイズが多い → 経路/境界（VPN/踏み台/NAT/SG）を整理し、到達性のモデルを先に固める必要がある
  - パターンB：入口サービスは見えたが、認証成立点が不明 → "認証が起きている場所"を特定し、ログイン前後で見える範囲/サービス差を取る必要がある
  - パターンC：認証後の差分が取れ、権限境界が見え始めた → 侵入後の前提整理へ進むべき状態

---

## 攻撃者視点での利用（意思決定：優先度・攻め筋・次の仮説）
- この状態が示す"狙い目"：
  - 認証が絡む入口（VPN/SSO/管理系/リモート管理）
  - 権限が変わる地点（認証後に見える範囲が変わる入口）
  - 重要資産に近いサービス（AD、ファイル共有、管理系、業務DB等）
  - Web入口（API/管理画面が背後にある可能性を含む）
- 優先度の付け方（時間制約がある場合の順序）：
  1) 認証が絡む入口（VPN/SSO/管理系/リモート管理）
  2) 権限が変わる地点（認証後に見える範囲が変わる入口）
  3) 重要資産に近いサービス（AD、ファイル共有、管理系、業務DB等）
  4) Web入口（API/管理画面が背後にある可能性を含む）
- 代表的な攻め筋（この観測から自然に繋がるもの）：
  - 攻め筋1：変数を増やさずに差分を取る → 経路だけ変える（VPN有無、踏み台有無）、主体だけ変える（ユーザーA/B、権限差）、範囲だけ変える（小→中→大）
  - 攻め筋2：入口を"深掘り"する → 同じ入口でも、認証方式/暗号/バージョン/挙動を観測して攻め筋を絞る
- 「見える/見えない」による戦略変更（例：CDN配下、SSO前提、外部委託先など）：
  - 到達性が不確実な場合は、経路/境界を整理して到達性のモデルを先に固める
  - 認証成立点が不明な場合は、Web側（SSO/OWA等）が絡むなら `02_web/02_authn` と接続して観測する

---

## 次に試すこと（仮説A/Bの分岐と検証）
### 仮説A：まず"到達性"が不確実で、列挙ノイズが多い
- 次の検証：
  - 経路/境界（VPN/踏み台/NAT/SG）を整理し、到達性のモデルを先に固める
  - 必要なら pcap を取って、どこで落ちているかを切り分ける
- 期待する観測（成功/失敗時に何が見えるか）：
  - 成功：到達性の境界が明確になり、列挙ノイズが減る
  - 失敗：到達性が不確実なまま、列挙ノイズが続く

### 仮説B：入口サービスは見えたが、認証成立点が不明
- 次の検証：
  - "認証が起きている場所"を特定し、ログイン前後で見える範囲/サービス差を取る
  - Web側（SSO/OWA等）が絡むなら `02_web/02_authn` と接続して観測する
- 期待する観測：
  - 成功：認証成立点が特定でき、ログイン前後での差分が取れる
  - 失敗：認証成立点が不明なまま、権限境界が見えない

### 仮説C：認証後の差分が取れ、権限境界が見え始めた
- 次の検証：
  - 侵入後の前提整理へ：`01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- 期待する観測：
  - 成功：権限境界が明確になり、次の攻め筋が絞れる
  - 失敗：権限境界が不明なまま、次の攻め筋が絞れない

### 仮説D：認証情報が鍵になりそう（使い回し/配置/委任が疑える）
- 次の検証：
  - credsの整理へ：`01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- 期待する観測：
  - 成功：認証情報の所在と扱いが明確になり、攻め筋が絞れる
  - 失敗：認証情報の所在が不明なまま、攻め筋が絞れない

---

## 手を動かす検証（Labs連動：観測点を明確に）
- 検証環境（関連する `04_labs/`）
  - 参照ファイル：
    - `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
    - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`
- 取得する証跡（目的ベースで最小限）：
  - スキャン結果（nmap/masscan等の出力）
  - pcap（到達性/経路/暗号の切り分けが必要な時だけ）
  - メモ（実行した観測、主要出力、重要差分）
- 観測の取り方（どの視点で差分を見るか）：
  - 経路の違い（VPN有無、踏み台有無）での差分
  - 認証前後での差分
  - 権限の違いでの差分
- 実施方法（最高に具体的）：観測の準備と相関キー
  - 証跡ディレクトリ（必須）
    ~~~~
    mkdir -p ~/keda_evidence/network_enum 2>/dev/null
    cd ~/keda_evidence/network_enum
    ~~~~
  - 検証の前提を固定（スコープ事故を防ぐ）
    - 必須で決める（レポート先頭に書く）
      - 対象は **許可されたスコープ** のみ
      - 観測は **代表点の抽出** のみ
      - 範囲外への到達は禁止
      - 過剰な並列スキャンは避ける
  - 相関キー（最低限）を作る（後で必ず効く）
    - IP、Port、Protocol、Time、Route、AuthStatus、PrivilegeLevel

---

## コマンド/リクエスト例（例示は最小限・意味の説明が主）
> 例示は"手段"であり"結論"ではない。必ず「何を観測している例か」を添える。

~~~~
# 例：範囲を小さく切って到達性→サービス→認証の順で観測する（概念例）
# 実務ではRoE/負荷/範囲を厳守し、過剰な並列や広域スキャンは避ける

# 到達性の観測（ICMPが通らない前提もある）
ping -c 1 10.0.0.10

# サービスの観測（最小のポートから始める）
nmap -sS -Pn -p 22,80,443,445,3389 10.0.0.10
~~~~

- この例で観測していること：到達性（ICMP/TCP）、サービス（ポート/プロトコル）、認証（認証方式の兆候）
- 出力のどこを見るか（注目点）：到達性の有無、開いているポート、サービスのバナー/実装の痕跡、認証方式の兆候
- この例が使えないケース（前提が崩れるケース）：範囲外への到達が必要な場合、または完全に遮断されている環境

---

## ガイドライン対応（ASVS / WSTG / PTES / MITRE ATT&CK：毎回記載）
- ASVS：
  - 該当領域/章：直接のNW規格ではないが、Webの認証・認可・セッション・設定検証はNW前提（到達性/経路/権限境界）に依存するため、"前提を支える技術"として接続する
  - 該当要件（可能ならID）：該当なし（NW前提技術）
  - このファイルの内容が「満たす/破れる」ポイント：
    - 満たす：Web検証（AuthN/AuthZ/API）を成立させる前提として「到達性・サービス・認証・権限境界」を確定する技術ユニット
    - 破れる：到達性・サービス・認証・権限境界が不明確な場合、Web検証の前提が崩れる
  - 参照：https://github.com/OWASP/ASVS
- WSTG：
  - 該当カテゴリ/テスト観点：Webテストに入る前提（入口/境界/到達性）を作る工程として位置づける
  - 該当が薄い場合：この技術が支える前提（情報収集/境界特定/到達性推定 等）：
    - Webテストでも必要な前提（入口/境界/到達性/経路）を作る"準備工程"として接続する
  - 参照：https://owasp.org/www-project-web-security-testing-guide/
- PTES：
  - 該当フェーズ：Intelligence Gathering、Vulnerability Analysis
  - 前後フェーズとの繋がり（1行）：Intelligence Gathering：到達性とサービスを観測し入口を絞る、Vulnerability Analysis：認証成立点と権限境界を推定し優先度を決める。列挙の"量"ではなく"意味"で優先度を作る
  - 参照：https://pentest-standard.readthedocs.io/
- MITRE ATT&CK：
  - 該当戦術（必要なら技術）：Discovery（Network Service Discovery 等）、Credential Access（次段の前提）、Lateral Movement（次段の前提）
  - 攻撃者の目的（この技術が支える意図）：本ファイルは"発見を意思決定に変える"こと（次の一手を作る）に重点を置く
  - 参照：https://attack.mitre.org/tactics/TA0007/（Discovery）

---

## 参考（必要最小限）
- `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
- `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
- `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`

---

## リポジトリ内リンク（最大3つまで）
- 関連 topics：
  - `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
  - `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
  - `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- 関連 playbooks：
  - `02_playbooks/06_network_enum_to_post_列挙→侵入後の導線.md`
- 関連 labs / cases：
  - `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
  - `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`

---

## 深掘りリンク（最大8）
- `01_topics/02_web/01_web_00_recon_入口・境界・攻め筋の確定.md`
- `01_topics/03_network/02_post_侵入後の前提（権限 経路 横展開の入口）.md`
- `01_topics/03_network/03_creds_認証情報の所在と扱い（攻撃 検知の両面）.md`
- `01_topics/03_network/04_ad_ドメイン環境の基礎（ペンテスト視点の地図）.md`
- `01_topics/03_network/05_scanning_到達性把握（nmap_masscan）.md`
- `01_topics/03_network/06_service_fingerprint（banner_tls_alpn）.md`
- `04_labs/01_local/03_capture_証跡取得（pcap har log）.md`
- `04_labs/02_virtualization/03_networking_nat_hostonly_bridge.md`
